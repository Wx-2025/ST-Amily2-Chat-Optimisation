# 📘 记忆管理系统使用手册

> **设计老师**：繁华 & 可乐

**前言**：
本系统基于 Amily2 插件中的 `记忆管理`、`总结模块`、`表格模块` 功能进行联动实现。
*   **定位**：作为 Amily2 `超级记忆功能` 的替代方案。
*   **优势**：在记忆的细节（如曾经的心动瞬间、铭记一生的誓言）上表现优异。
*   **兼容性**：两者可以兼容！可以单独使用，也可以配合使用。

> ⚠️ **重要警告**
>
> 当你按照本教程使用记忆系统功能并进行设置后，**原来的剧情优化实际功能将被改变**（即大家理解的剧情推进被改为记忆管理）。
> 请不要再根据 Amily2 谷歌文档教程进行理解设置，请以本教程为准。
>
> **如何恢复？**
> 若后续不想使用本 `记忆管理系统` 功能，或想恢复原本的 `剧情优化` 功能，只需要：
> 1. 切换 `剧情优化预设`（路径：剧情优化功能页面 `提示词指令` → `提示词管理`）
> 2. 或分别点击 `恢复主提示词`、`恢复拦截任务`、`恢复注入指令` 三个按钮即可。

## 一、前置通用设置

无论使用 `总结流` 还是 `超级记忆` 适配，**必须**进行以下设置。

1.  **导入预设**
    *   请在群文件下载 `记忆管理系统可乐版-v1.17.2` 或 `剧情优化功能-记忆管理系统.json` 预设文件。
    *   **导入路径**：`amily2插件` → `剧情优化功能` → `提示词指令` → `提示词管理` → `导入预设`

2.  **参数设置**

    | 参数项 | 对应设置 | 建议值 | 说明 |
    | :--- | :--- | :--- | :--- |
    | 主线剧情 (sulv1) | 单次输出最大回忆记录数 | **5 - 20** | 控制每次返回的回忆条数 (范围: 0-无限) |
    | 个人线 (sulv2) | 记忆关联性阈值 | **0.3 - 0.5** | 控制回忆的关联性 (范围: 0.1-1)<br>0.1最准确/直接相关；1包含间接相关 |

3.  **标签提取与内容排除**
    *   **设置路径**：`amily2插件` → `总结模块` → `标签提取/内容排除`
    *   **提取 `正文标签`**：填写你的正文内包裹标签。
    *   **内容排除**：
        *   `<Plot_progression>` 到 `</Plot_progression>` (注意：不要复制反引号)
        *   `正文标签内` 可能出现的 `非正文内容标签`（例如用了正文优化后的思维连或者某些预设奇奇怪怪的功能）
        *   *若是可乐版*：`<details>` 到 `</details>`

## 二、记忆管理功能设置

请按照以下配置调整 `记忆管理功能` 页面：

### 1. 基础开关
*   剧情优化开关：🔴 **关闭** (防笨蛋，设置完全部后再开启)
*   EJS预处理：🔴 **关闭**
*   启用世界书：🟢 **开启**
*   启用表格：🟢 **开启**

### 2. 上下文与模型
*   上下文条数：`5` (建议设置单数 1、3、5)
*   世界书最大字符数：`120000` (DS V3或V3.2模型推荐此数值)
*   最大 Tokens：`4000` (建议默认)
*   温度：`1` (越小越准，建议1)

> **🤖 模型推荐**
> *   **DS V3**：稳定、聪明、简洁、快。
> *   **DS V3.2**：（推荐）需额外设置 `魔法棒` → `提示词链` → `剧情推进提示词` → `恢复默认` → `保存`。
> *   *注：不建议使用其他快速模型。*

## 三、总结使用方式

1.  **提示词恢复默认**
    *   插件版本达到 v1.7.4 版本及以上，总结模块中，大小总结的 `主要提示词` 与 `任务提示词` 需恢复默认并保存。
    *   **操作路径**：`amily2插件` → `总结模块` → `小总结功能（微言录）` / `大总结功能（宏史卷）`
    *   **操作**：分别点击 `恢复默认` 按钮，并点击 **保存**。
    *   💡 **建议操作：重新总结**
        *   恢复提示词后，最好进行一次重新总结。
        *   **推荐设置**：模型 2.5pro，温度 1，最大 Tokens 30000，总结阈值 50。
        *   **操作**：一次性批量总结完旧楼层。
        *   **注意**：中途若世界书字符数过多，可使用一次大总结后继续。

2.  **总结设置**
    *   **大总结**：当世界书 `【敕史局】对话流水总账` 对话流水总账达到了 4 万以上字符数。
    *   **小总结设置**：
        *   交互式巡录：🟢 **开启**
        *   静默总结：🟢 **开启**
        *   存世界书：🟢 **开启**
        *   上传向量：🔴 **关闭**
        *   总结阈值和保留层数：按个人情况或默认。（推荐10-20）
        *   **模型推荐**：哈基米2.5p。

3.  **设置总结世界书**
    *   **路径**：`amily2插件` → `插件首页下拉` → `总结与法律`
    *   **配置**：选择 `写入独立档案`、选择 `激活模式蓝灯`

4.  **初始化与启动**
    1.  **生成总结**：开始玩卡触发一次自动总结，已有聊天的直接手动总结一次（开始远征）。
    2.  **开启功能**：回到插件的 `剧情优化功能`，将 `剧情优化开关` 切换为 🟢 **开启**。
    3.  **关联世界书**：点击 `上下文设置` (启用世界书)，将世界书来源选择 `自定`，选择名为 `Amily2-Lore-char-...` 的世界书，勾选总结出来的世界书条目 `【敕史局】对话流水总帐`，并且 **勾选全选**（务必确认，世界书中就只有 `【敕史局】对话流水总帐` 这个条目）。

5.  **隐藏楼层**
    1.  **开启功能**：总结模块上方的 `皇家史册管理员`。
    2.  将 `按阈值隐藏` 切换为 🟢 **开启**。
    3.  下方数字设置为 `10及以下`。（此处推荐带摘要的预设，并且有X楼前只发送摘要。）

6.  **测试方式 (可选)**
    *   开启 `密折司` 功能 → 发送一条消息 → 等待 `剧情优化提示` 完成，自动弹出 `密折司` 页面 → 点击取消，查看 `用户消息` 确认效果。

## 四、搭配表格 (必须)

### 1. 开启表格支持
*   路径：剧情优化功能 → `上下文设置` → `启用表格`

### 2. 表格模块设置
*   路径：`amily2插件` → `表格模块` → `操作中心`
*   ✅ 表格系统总开关：🟢 **开启**
*   ❌ 启用表格注入：🔴 **关闭**
*   ✅ 启用上下文优化 (合并世界书)：🟢 **开启**
*   ⚙️ 上下文深度：`3` (建议设置单数 1、3、5)
*   ⚙️ 填表批次：`4` (若无总结表则使用0)
*   ⚙️ 保留楼层：`2` (若无总结表则使用0)

### 3. 注意事项
*   正常游玩即可。
*   ⚠️ **重要**：使用表格时，请注意每次填表后检查填写的准确性，否则回忆出来的内容也会是错误的。

---
*Designed for Amily2 Chat Optimisation*
