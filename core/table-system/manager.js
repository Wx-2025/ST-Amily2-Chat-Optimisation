const _0x16a5d7=_0x1220;(function(_0x14696e,_0x27dc8a){const _0xc5a7e0=_0x1220,_0x37402b=_0x14696e();while(!![]){try{const _0x15ccb0=-parseInt(_0xc5a7e0(0x1a9))/0x1+parseInt(_0xc5a7e0(0x1a8))/0x2*(parseInt(_0xc5a7e0(0x286))/0x3)+parseInt(_0xc5a7e0(0x1fc))/0x4*(-parseInt(_0xc5a7e0(0x1ca))/0x5)+parseInt(_0xc5a7e0(0x288))/0x6*(-parseInt(_0xc5a7e0(0x1c1))/0x7)+parseInt(_0xc5a7e0(0x20a))/0x8*(-parseInt(_0xc5a7e0(0x275))/0x9)+-parseInt(_0xc5a7e0(0x198))/0xa*(parseInt(_0xc5a7e0(0x1b3))/0xb)+-parseInt(_0xc5a7e0(0x1f5))/0xc*(-parseInt(_0xc5a7e0(0x1c0))/0xd);if(_0x15ccb0===_0x27dc8a)break;else _0x37402b['push'](_0x37402b['shift']());}catch(_0x3834b5){_0x37402b['push'](_0x37402b['shift']());}}}(_0xbc99,0xe35a6));import{getContext,extension_settings}from'/scripts/extensions.js';import{saveChat,saveSettingsDebounced}from'/script.js';import{log}from'./logger.js';import{fillWithSecondaryApi}from'./secondary-filler.js';import{getChatPiece,saveChatDebounced}from'../../utils/utils.js';import{extensionName}from'../../utils/settings.js';import{DEFAULT_AI_RULE_TEMPLATE,DEFAULT_AI_FLOW_TEMPLATE}from'./settings.js';import{renderTables}from'../../ui/table-bindings.js';import{updateOrInsertTableInChat}from'../../ui/message-table-renderer.js';const TABLE_DATA_KEY=_0x16a5d7(0x244);let currentTablesState=null,highlightedCells=new Set(),updatedTables=new Set();export function addHighlight(_0xf4b9d9,_0x3ee86a,_0x29313e){const _0x1241b1=_0x16a5d7,_0x3e9a14=_0xf4b9d9+'-'+_0x3ee86a+'-'+_0x29313e;highlightedCells[_0x1241b1(0x268)](_0x3e9a14);}export function getHighlights(){return highlightedCells;}export function clearHighlights(){const _0x3100e4=_0x16a5d7;highlightedCells[_0x3100e4(0x1eb)]>0x0&&(highlightedCells[_0x3100e4(0x223)](),log('已清除所有单元格高亮标记。','info'));}export function getUpdatedTables(){return updatedTables;}export function clearUpdatedTables(){const _0x14f821=_0x16a5d7;updatedTables[_0x14f821(0x1eb)]>0x0&&(updatedTables[_0x14f821(0x223)](),log(_0x14f821(0x17f),_0x14f821(0x259)));}export function setMemoryState(_0x24135d){currentTablesState=_0x24135d;}export function getMemoryState(){return currentTablesState;}const defaultTemplate={'tables':[{'name':_0x16a5d7(0x188),'headers':['日期','时段','时间','地点',_0x16a5d7(0x1cb)],'note':_0x16a5d7(0x25a),'rule_add':_0x16a5d7(0x1b8),'rule_delete':'【触发条件】任何时候，如果此表格的行数超过一行，必须删除旧的行，只保留最新、最准确的一行。','rule_update':_0x16a5d7(0x196),'charLimitRules':{},'rowLimitRule':0x1,'rows':[]},{'name':_0x16a5d7(0x218),'headers':[_0x16a5d7(0x210),'外貌','身形','衣着','性格','身份','职业',_0x16a5d7(0x265),'爱好','住所',_0x16a5d7(0x24f)],'note':_0x16a5d7(0x195),'rule_add':_0x16a5d7(0x206),'rule_delete':_0x16a5d7(0x250),'rule_update':_0x16a5d7(0x1dc),'charLimitRules':{'10':0x1e},'rowLimitRule':0x0,'rows':[]},{'name':_0x16a5d7(0x1d9),'headers':[_0x16a5d7(0x1c3),'类型','详情','状态','执行者','地点',_0x16a5d7(0x18d),'结果'],'note':_0x16a5d7(0x1db),'rule_add':_0x16a5d7(0x248),'rule_delete':_0x16a5d7(0x28c),'rule_update':_0x16a5d7(0x20b),'charLimitRules':{},'rowLimitRule':0xa,'rows':[]},{'name':_0x16a5d7(0x291),'headers':[_0x16a5d7(0x1cc),'类型','详情','状态','拥有者',_0x16a5d7(0x24e)],'note':_0x16a5d7(0x1bb),'rule_add':'【触发条件】当一个物品被明确赋予了特殊意义（如被赠予、在关键事件中扮演重要角色）或展示出独特功能时，应为其创建条目。','rule_delete':'【触发条件】当一个物品被彻底摧毁、消耗完毕或永久失去其特殊意义时，可以删除。','rule_update':_0x16a5d7(0x278),'charLimitRules':{},'rowLimitRule':0x0,'rows':[]},{'name':_0x16a5d7(0x22f),'headers':[_0x16a5d7(0x289),'技能效果'],'note':_0x16a5d7(0x20d),'rule_add':_0x16a5d7(0x1d8),'rule_delete':'【触发条件】如果发现表格中存在两个描述完全相同的重复技能，应删除其中一个。如果记录了非<user>的技能，应立即删除。','rule_update':_0x16a5d7(0x194),'charLimitRules':{},'rowLimitRule':0x0,'rows':[]},{'name':_0x16a5d7(0x19c),'headers':['类型',_0x16a5d7(0x23d)],'note':_0x16a5d7(0x1b2),'rule_add':_0x16a5d7(0x1c7),'rule_delete':_0x16a5d7(0x19f),'rule_update':'【触发条件】只能在<user>明确表示要修改某条设定时，才能更新对应行的描述。','charLimitRules':{},'rowLimitRule':0x0,'rows':[]}]};function getDefaultTables(){const _0x4125c0=_0x16a5d7;log(_0x4125c0(0x276),_0x4125c0(0x259));const _0xa73b56=JSON[_0x4125c0(0x26f)](JSON[_0x4125c0(0x270)](defaultTemplate[_0x4125c0(0x23a)]));return _0xa73b56[_0x4125c0(0x243)](_0xd5ad96=>{const _0x5e7e8a=_0x4125c0;_0xd5ad96[_0x5e7e8a(0x1df)]={'columnIndex':-0x1,'limit':0x0},_0xd5ad96[_0x5e7e8a(0x203)]=0x0,_0xd5ad96['columnWidths']=[];}),_0xa73b56;}export function loadTables(_0x23a21d=-0x1){const _0x488c88=_0x16a5d7,_0x2b747e=getContext();if(_0x2b747e&&_0x2b747e['chat']&&_0x2b747e[_0x488c88(0x254)][_0x488c88(0x18e)]>0x0){const _0x204f7e=_0x23a21d===-0x1?_0x2b747e[_0x488c88(0x254)]['length']-0x1:_0x23a21d-0x1;for(let _0x7453cd=_0x204f7e;_0x7453cd>=0x0;_0x7453cd--){const _0x45c274=_0x2b747e[_0x488c88(0x254)][_0x7453cd];if(_0x45c274[_0x488c88(0x217)]&&_0x45c274['extra'][TABLE_DATA_KEY]){log(_0x488c88(0x17e)+_0x7453cd+_0x488c88(0x1d1),_0x488c88(0x259));let _0x1cd6f9=JSON[_0x488c88(0x26f)](JSON[_0x488c88(0x270)](_0x45c274['extra'][TABLE_DATA_KEY]));return _0x1cd6f9[_0x488c88(0x243)](_0x152d82=>{const _0x266360=_0x488c88;if(_0x152d82['note']===undefined)_0x152d82[_0x266360(0x1f1)]='无';if(_0x152d82['rule_add']===undefined)_0x152d82[_0x266360(0x242)]='允许';if(_0x152d82[_0x266360(0x23c)]===undefined)_0x152d82[_0x266360(0x23c)]='允许';if(_0x152d82[_0x266360(0x1e6)]===undefined)_0x152d82[_0x266360(0x1e6)]='允许';_0x152d82[_0x266360(0x1df)]&&!_0x152d82[_0x266360(0x1de)]&&(_0x152d82[_0x266360(0x1de)]={},_0x152d82['charLimitRule'][_0x266360(0x27b)]!==-0x1&&_0x152d82[_0x266360(0x1df)][_0x266360(0x272)]>0x0&&(_0x152d82['charLimitRules'][_0x152d82[_0x266360(0x1df)][_0x266360(0x27b)]]=_0x152d82[_0x266360(0x1df)][_0x266360(0x272)]));delete _0x152d82[_0x266360(0x1df)];if(_0x152d82[_0x266360(0x203)]===undefined)_0x152d82[_0x266360(0x203)]=0x0;if(_0x152d82[_0x266360(0x224)]===undefined)_0x152d82[_0x266360(0x224)]=[];!_0x152d82[_0x266360(0x22a)]&&(_0x152d82[_0x266360(0x22a)]=Array(_0x152d82['rows'][_0x266360(0x18e)])[_0x266360(0x249)]('normal'));}),currentTablesState=_0x1cd6f9,currentTablesState;}}}if(extension_settings[extensionName]?.[_0x488c88(0x216)]){log(_0x488c88(0x261),_0x488c88(0x259));try{const _0x248c1b=extension_settings[extensionName][_0x488c88(0x216)];return currentTablesState=JSON[_0x488c88(0x26f)](JSON['stringify'](_0x248c1b['tables'])),_0x248c1b[_0x488c88(0x200)]!==undefined&&saveBatchFillerRuleTemplate(_0x248c1b[_0x488c88(0x200)]),_0x248c1b[_0x488c88(0x285)]!==undefined&&saveBatchFillerFlowTemplate(_0x248c1b[_0x488c88(0x285)]),currentTablesState;}catch(_0x253883){log(_0x488c88(0x1c8)+_0x253883[_0x488c88(0x21d)],_0x488c88(0x18a));}}return log(_0x488c88(0x21f),_0x488c88(0x259)),currentTablesState=getDefaultTables(),currentTablesState;}export function saveStateToMessage(_0xdcdfa5,_0x11bf07){const _0x50e968=_0x16a5d7;if(!_0xdcdfa5||!_0x11bf07)return log('缺少状态或目标消息，无法保存。','error'),![];return!_0x11bf07['extra']&&(_0x11bf07['extra']={}),_0x11bf07['extra'][TABLE_DATA_KEY]=JSON[_0x50e968(0x26f)](JSON['stringify'](_0xdcdfa5)),log(_0x50e968(0x1ad)+_0x11bf07[_0x50e968(0x269)][_0x50e968(0x238)](0x0,0x14)+_0x50e968(0x193),_0x50e968(0x259)),!![];}export function saveTables(_0x45d2e9='未知操作'){const _0x20c43b=_0x16a5d7;return log(_0x20c43b(0x1f4)+_0x45d2e9+_0x20c43b(0x260),'info'),!![];}export function deleteColumn(_0xc1a54e,_0x7bfb2d){const _0x151946=_0x16a5d7,_0x4b575b=getMemoryState();if(!_0x4b575b[_0xc1a54e]||_0x7bfb2d<0x0||_0x7bfb2d>=_0x4b575b[_0xc1a54e][_0x151946(0x208)][_0x151946(0x18e)]){log(_0x151946(0x1a5)+_0xc1a54e+_0x151946(0x1a6)+_0x7bfb2d+_0x151946(0x1ea),'error');return;}_0x4b575b[_0xc1a54e][_0x151946(0x208)][_0x151946(0x186)](_0x7bfb2d,0x1),_0x4b575b[_0xc1a54e]['rows'][_0x151946(0x243)](_0xddead0=>{const _0xe0cca2=_0x151946;_0xddead0[_0xe0cca2(0x18e)]>_0x7bfb2d&&_0xddead0[_0xe0cca2(0x186)](_0x7bfb2d,0x1);}),_0x4b575b[_0xc1a54e][_0x151946(0x224)]&&_0x4b575b[_0xc1a54e]['columnWidths'][_0x151946(0x18e)]>_0x7bfb2d&&_0x4b575b[_0xc1a54e][_0x151946(0x224)]['splice'](_0x7bfb2d,0x1),log(_0x151946(0x293)+_0xc1a54e+_0x151946(0x1b0)+(_0x7bfb2d+0x1)+_0x151946(0x1e7),_0x151946(0x25d)),saveTables(_0x4b575b);}export function moveRow(_0xd1828d,_0x36be42,_0x1a59d6){const _0x6053d7=_0x16a5d7,_0x265dfd=getMemoryState(),_0x4fbb0f=_0x265dfd[_0xd1828d];if(!_0x4fbb0f||_0x36be42<0x0||_0x36be42>=_0x4fbb0f[_0x6053d7(0x221)][_0x6053d7(0x18e)])return;const _0x55a08c=_0x1a59d6==='up'?_0x36be42-0x1:_0x36be42+0x1;if(_0x55a08c<0x0||_0x55a08c>=_0x4fbb0f[_0x6053d7(0x221)]['length'])return;const [_0x3e0a54]=_0x4fbb0f[_0x6053d7(0x221)]['splice'](_0x36be42,0x1);_0x4fbb0f[_0x6053d7(0x221)][_0x6053d7(0x186)](_0x55a08c,0x0,_0x3e0a54);if(_0x4fbb0f['rowStatuses']&&_0x4fbb0f[_0x6053d7(0x22a)]['length']===_0x4fbb0f[_0x6053d7(0x221)]['length']+0x1){const [_0x4b0d27]=_0x4fbb0f[_0x6053d7(0x22a)]['splice'](_0x36be42,0x1);_0x4fbb0f['rowStatuses']['splice'](_0x55a08c,0x0,_0x4b0d27);}log(_0x6053d7(0x1a4)+_0xd1828d+_0x6053d7(0x1b0)+(_0x36be42+0x1)+_0x6053d7(0x232)+(_0x55a08c+0x1)+_0x6053d7(0x27a),_0x6053d7(0x25d)),saveTables(_0x265dfd);}export function insertRow(_0x40ecea,_0x12dc27,_0x4fc6a2=_0x16a5d7(0x1aa)){const _0x4e73b4=_0x16a5d7,_0x449c6a=getMemoryState(),_0x12aa3e=_0x449c6a[_0x40ecea];if(!_0x12aa3e){log('插入行失败：找不到索引为\x20'+_0x40ecea+'\x20的表格。',_0x4e73b4(0x18a));return;}let _0x493804;typeof _0x12dc27===_0x4e73b4(0x1d4)?_0x493804=_0x4fc6a2==='above'?_0x12dc27:_0x12dc27+0x1:_0x493804=_0x12aa3e[_0x4e73b4(0x221)][_0x4e73b4(0x18e)];if(_0x493804<0x0)_0x493804=0x0;if(_0x493804>_0x12aa3e[_0x4e73b4(0x221)][_0x4e73b4(0x18e)])_0x493804=_0x12aa3e[_0x4e73b4(0x221)][_0x4e73b4(0x18e)];const _0x334fa4=new Array(_0x12aa3e[_0x4e73b4(0x208)][_0x4e73b4(0x18e)])[_0x4e73b4(0x249)]('');if(typeof _0x12dc27===_0x4e73b4(0x1c5)&&_0x12dc27!==null)for(const _0xb566d5 in _0x12dc27){const _0x575ff4=parseInt(_0xb566d5,0xa);!isNaN(_0x575ff4)&&_0x575ff4<_0x334fa4[_0x4e73b4(0x18e)]&&(_0x334fa4[_0x575ff4]=_0x12dc27[_0xb566d5],addHighlight(_0x40ecea,_0x493804,_0x575ff4));}_0x12aa3e[_0x4e73b4(0x221)][_0x4e73b4(0x186)](_0x493804,0x0,_0x334fa4);if(!_0x12aa3e[_0x4e73b4(0x22a)])_0x12aa3e[_0x4e73b4(0x22a)]=Array(_0x12aa3e[_0x4e73b4(0x221)][_0x4e73b4(0x18e)])[_0x4e73b4(0x249)](_0x4e73b4(0x292));_0x12aa3e[_0x4e73b4(0x22a)][_0x4e73b4(0x186)](_0x493804,0x0,_0x4e73b4(0x292)),updatedTables[_0x4e73b4(0x268)](_0x40ecea),log(_0x4e73b4(0x18f)+_0x12aa3e[_0x4e73b4(0x205)]+_0x4e73b4(0x256)+_0x40ecea+')\x20的第\x20'+(_0x493804+0x1)+_0x4e73b4(0x1e9),_0x4e73b4(0x25d));const _0x2fd96c=getContext();if(_0x2fd96c['chat']&&_0x2fd96c[_0x4e73b4(0x254)]['length']>0x0){const _0x46474f=_0x2fd96c['chat'][_0x2fd96c[_0x4e73b4(0x254)][_0x4e73b4(0x18e)]-0x1];if(saveStateToMessage(_0x449c6a,_0x46474f)){saveChat();return;}}saveChatDebounced();}export function addRow(_0x545454){const _0xbbc637=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x545454])return;const _0x2db000=currentTablesState[_0x545454],_0x505250=_0x2db000[_0xbbc637(0x208)][_0xbbc637(0x18e)],_0xf432cd=Array(_0x505250)[_0xbbc637(0x249)]('');_0x2db000[_0xbbc637(0x221)][_0xbbc637(0x27f)](_0xf432cd);if(!_0x2db000[_0xbbc637(0x22a)])_0x2db000[_0xbbc637(0x22a)]=Array(_0x2db000[_0xbbc637(0x221)]['length'])[_0xbbc637(0x249)]('normal');_0x2db000[_0xbbc637(0x22a)][_0xbbc637(0x27f)]('normal'),updatedTables[_0xbbc637(0x268)](_0x545454);const _0x5087a8='表格\x20['+_0x2db000[_0xbbc637(0x205)]+_0xbbc637(0x207);log(_0x5087a8,_0xbbc637(0x259));const _0x1a7257=getContext();if(_0x1a7257['chat']&&_0x1a7257['chat']['length']>0x0){const _0x5005c1=_0x1a7257[_0xbbc637(0x254)][_0x1a7257[_0xbbc637(0x254)][_0xbbc637(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x5005c1)){saveChat();return;}}saveChatDebounced();}export function addColumn(_0x264213){const _0x4f0585=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x264213])return;const _0x55495f=currentTablesState[_0x264213],_0xc75acf='新列\x20'+(_0x55495f['headers'][_0x4f0585(0x18e)]+0x1);_0x55495f['headers']['push'](_0xc75acf),_0x55495f[_0x4f0585(0x221)][_0x4f0585(0x243)](_0x155783=>_0x155783['push'](''));if(!_0x55495f['columnWidths'])_0x55495f[_0x4f0585(0x224)]=[];_0x55495f['columnWidths'][_0x4f0585(0x27f)](null);const _0xb95d46='表格\x20['+_0x55495f[_0x4f0585(0x205)]+_0x4f0585(0x1c2);log(_0xb95d46,_0x4f0585(0x259));const _0x59749b=getContext();if(_0x59749b[_0x4f0585(0x254)]&&_0x59749b[_0x4f0585(0x254)][_0x4f0585(0x18e)]>0x0){const _0x17b06f=_0x59749b['chat'][_0x59749b[_0x4f0585(0x254)][_0x4f0585(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x17b06f)){saveChat();return;}}saveChatDebounced();}export function updateHeader(_0x29eacc,_0x1e21b9,_0x3ac7e5){const _0x2dfe37=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x29eacc]||currentTablesState[_0x29eacc][_0x2dfe37(0x208)][_0x1e21b9]===undefined)return;const _0x29b0cb=currentTablesState[_0x29eacc][_0x2dfe37(0x205)],_0xdfe04e=currentTablesState[_0x29eacc][_0x2dfe37(0x208)][_0x1e21b9];currentTablesState[_0x29eacc]['headers'][_0x1e21b9]=_0x3ac7e5;const _0x4097a7='表格\x20['+_0x29b0cb+']\x20的表头“'+_0xdfe04e+_0x2dfe37(0x271)+_0x3ac7e5+'”。';log(_0x4097a7,_0x2dfe37(0x259));const _0x36aa5a=getContext();if(_0x36aa5a[_0x2dfe37(0x254)]&&_0x36aa5a[_0x2dfe37(0x254)][_0x2dfe37(0x18e)]>0x0){const _0x151c21=_0x36aa5a[_0x2dfe37(0x254)][_0x36aa5a[_0x2dfe37(0x254)][_0x2dfe37(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x151c21)){saveChat();return;}}saveChatDebounced();}export async function deleteRow(_0x12bc4b,_0x1684b5){const _0x395ea4=_0x16a5d7,_0x2e67e9=currentTablesState?.[_0x12bc4b];if(!_0x2e67e9||!_0x2e67e9['rows'][_0x1684b5])return;!_0x2e67e9[_0x395ea4(0x22a)]&&(_0x2e67e9[_0x395ea4(0x22a)]=Array(_0x2e67e9[_0x395ea4(0x221)][_0x395ea4(0x18e)])[_0x395ea4(0x249)](_0x395ea4(0x292)));_0x2e67e9['rowStatuses'][_0x1684b5]=_0x395ea4(0x181),updatedTables[_0x395ea4(0x268)](_0x12bc4b);const _0xe965a3=_0x395ea4(0x253)+_0x2e67e9[_0x395ea4(0x205)]+_0x395ea4(0x1ae)+(_0x1684b5+0x1)+_0x395ea4(0x23e);log(_0xe965a3,_0x395ea4(0x259));const _0x547b46=getContext();if(_0x547b46['chat']?.[_0x395ea4(0x18e)]>0x0){const _0x8ef4b9=_0x547b46[_0x395ea4(0x254)][_0x547b46[_0x395ea4(0x254)][_0x395ea4(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x8ef4b9)){await saveChat(),renderTables();return;}}await saveChatDebounced(),renderTables();}export async function restoreRow(_0x227286,_0x2e9ac7){const _0x2818da=_0x16a5d7,_0x558518=currentTablesState?.[_0x227286];if(!_0x558518||!_0x558518[_0x2818da(0x221)][_0x2e9ac7]||!_0x558518[_0x2818da(0x22a)])return;_0x558518['rowStatuses'][_0x2e9ac7]=_0x2818da(0x292),updatedTables['add'](_0x227286);const _0x1a5db9='表格\x20['+_0x558518[_0x2818da(0x205)]+_0x2818da(0x1ae)+(_0x2e9ac7+0x1)+'\x20行已恢复。';log(_0x1a5db9,_0x2818da(0x259));const _0x1ff3e6=getContext();if(_0x1ff3e6['chat']?.[_0x2818da(0x18e)]>0x0){const _0x235b1a=_0x1ff3e6[_0x2818da(0x254)][_0x1ff3e6['chat'][_0x2818da(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x235b1a)){await saveChat(),renderTables();return;}}await saveChatDebounced(),renderTables();}export function commitPendingDeletions(){const _0x517c27=_0x16a5d7;if(!currentTablesState)return![];let _0x3cf108=0x0;currentTablesState[_0x517c27(0x243)]((_0x441ca9,_0x3b447f)=>{const _0x46cf1f=_0x517c27;if(!_0x441ca9['rowStatuses']||_0x441ca9[_0x46cf1f(0x22a)][_0x46cf1f(0x18e)]===0x0)return;let _0x6dcee3=![];for(let _0x19e727=_0x441ca9[_0x46cf1f(0x221)][_0x46cf1f(0x18e)]-0x1;_0x19e727>=0x0;_0x19e727--){_0x441ca9[_0x46cf1f(0x22a)][_0x19e727]===_0x46cf1f(0x181)&&(_0x441ca9['rows'][_0x46cf1f(0x186)](_0x19e727,0x1),_0x441ca9[_0x46cf1f(0x22a)]['splice'](_0x19e727,0x1),_0x3cf108++,_0x6dcee3=!![]);}_0x6dcee3&&updatedTables[_0x46cf1f(0x268)](_0x3b447f);});if(_0x3cf108>0x0)return log(_0x517c27(0x274)+_0x3cf108+_0x517c27(0x27a),'info'),!![];return![];}export function insertColumn(_0x345e2c,_0x29873e,_0x1be415){const _0x358106=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x345e2c])return;const _0x33f02a=currentTablesState[_0x345e2c],_0x1f0a09=_0x1be415==='left'?_0x29873e:_0x29873e+0x1,_0x15381e='新列';_0x33f02a[_0x358106(0x208)][_0x358106(0x186)](_0x1f0a09,0x0,_0x15381e),_0x33f02a['rows']['forEach'](_0x1179c9=>_0x1179c9[_0x358106(0x186)](_0x1f0a09,0x0,''));if(!_0x33f02a[_0x358106(0x224)])_0x33f02a[_0x358106(0x224)]=[];_0x33f02a[_0x358106(0x224)][_0x358106(0x186)](_0x1f0a09,0x0,null);const _0x59b114=_0x358106(0x253)+_0x33f02a[_0x358106(0x205)]+_0x358106(0x245)+(_0x29873e+0x1)+_0x358106(0x255)+(_0x1be415==='left'?'左侧':'右侧')+_0x358106(0x1be);log(_0x59b114,'info');const _0x485613=getContext();if(_0x485613['chat']&&_0x485613[_0x358106(0x254)]['length']>0x0){const _0x37ceb8=_0x485613[_0x358106(0x254)][_0x485613['chat'][_0x358106(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x37ceb8)){saveChat();return;}}saveChatDebounced();}export function moveColumn(_0x256453,_0x14f007,_0x2ccab){const _0x314f7e=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x256453])return;const _0x3bc12d=currentTablesState[_0x256453],_0x44359f=_0x3bc12d['headers'],_0x3d9a19=_0x3bc12d[_0x314f7e(0x221)],_0x5ede0f=_0x2ccab==='left'?_0x14f007-0x1:_0x14f007+0x1;if(_0x5ede0f<0x0||_0x5ede0f>=_0x44359f[_0x314f7e(0x18e)]){log(_0x314f7e(0x229)+_0x14f007+_0x314f7e(0x220),_0x314f7e(0x231));return;}const [_0x213f3c]=_0x44359f[_0x314f7e(0x186)](_0x14f007,0x1);_0x44359f[_0x314f7e(0x186)](_0x5ede0f,0x0,_0x213f3c),_0x3d9a19[_0x314f7e(0x243)](_0x3e683d=>{const _0x47509e=_0x314f7e,[_0x49b3a7]=_0x3e683d['splice'](_0x14f007,0x1);_0x3e683d[_0x47509e(0x186)](_0x5ede0f,0x0,_0x49b3a7);});if(_0x3bc12d['columnWidths']&&_0x3bc12d[_0x314f7e(0x224)]['length']>_0x14f007){const [_0x552753]=_0x3bc12d[_0x314f7e(0x224)][_0x314f7e(0x186)](_0x14f007,0x1);_0x3bc12d[_0x314f7e(0x224)][_0x314f7e(0x186)](_0x5ede0f,0x0,_0x552753);}const _0x1e33cd='表格\x20['+_0x3bc12d[_0x314f7e(0x205)]+_0x314f7e(0x1e3)+_0x213f3c+_0x314f7e(0x219)+(_0x2ccab===_0x314f7e(0x204)?'左':'右')+_0x314f7e(0x20c);log(_0x1e33cd,_0x314f7e(0x259));const _0x85f4b3=getContext();if(_0x85f4b3[_0x314f7e(0x254)]&&_0x85f4b3[_0x314f7e(0x254)][_0x314f7e(0x18e)]>0x0){const _0x19deaf=_0x85f4b3[_0x314f7e(0x254)][_0x85f4b3[_0x314f7e(0x254)][_0x314f7e(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x19deaf)){saveChat();return;}}saveChatDebounced();}export function deleteTable(_0x4154af){const _0x2a4347=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x4154af])return;const _0xe756b5=currentTablesState[_0x4154af][_0x2a4347(0x205)];currentTablesState[_0x2a4347(0x186)](_0x4154af,0x1);const _0x1faf34=_0x2a4347(0x253)+_0xe756b5+_0x2a4347(0x209);log(_0x1faf34,_0x2a4347(0x25d));const _0x4c37eb=getContext();if(_0x4c37eb[_0x2a4347(0x254)]&&_0x4c37eb[_0x2a4347(0x254)][_0x2a4347(0x18e)]>0x0){const _0x59e219=_0x4c37eb[_0x2a4347(0x254)][_0x4c37eb['chat'][_0x2a4347(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x59e219)){saveChat(),log(_0x2a4347(0x1a1),_0x2a4347(0x25d));return;}}log(_0x2a4347(0x237),_0x2a4347(0x18a)),saveChatDebounced();}export function addTable(_0x4ec3fa){const _0x17a67f=_0x16a5d7;if(!_0x4ec3fa||!_0x4ec3fa[_0x17a67f(0x213)]()){log(_0x17a67f(0x28e),'error'),toastr[_0x17a67f(0x18a)](_0x17a67f(0x18b),_0x17a67f(0x1b6));return;}!currentTablesState&&loadTables();if(currentTablesState['some'](_0x2c8839=>_0x2c8839['name']===_0x4ec3fa[_0x17a67f(0x213)]())){log(_0x17a67f(0x191)+_0x4ec3fa+'\x22\x20的表格已存在。','error'),toastr[_0x17a67f(0x18a)](_0x17a67f(0x228)+_0x4ec3fa+_0x17a67f(0x27e),'创建失败');return;}const _0x1c1844={'name':_0x4ec3fa[_0x17a67f(0x213)](),'headers':[_0x17a67f(0x257)],'rows':[],'rowStatuses':[],'columnWidths':[],'note':_0x17a67f(0x214),'rule_add':'允许','rule_delete':'允许','rule_update':'允许','charLimitRules':{},'rowLimitRule':0x0};currentTablesState['push'](_0x1c1844);const _0x462c50='已成功创建新表格：['+_0x4ec3fa['trim']()+']。';log(_0x462c50,_0x17a67f(0x25d));const _0x31272e=getContext();if(_0x31272e[_0x17a67f(0x254)]&&_0x31272e[_0x17a67f(0x254)][_0x17a67f(0x18e)]>0x0){const _0x218dbe=_0x31272e[_0x17a67f(0x254)][_0x31272e[_0x17a67f(0x254)]['length']-0x1];if(saveStateToMessage(currentTablesState,_0x218dbe)){saveChat(),log(_0x17a67f(0x1a2),_0x17a67f(0x25d));return;}}log(_0x17a67f(0x24d),_0x17a67f(0x18a)),saveChatDebounced();}export function renameTable(_0x35e313,_0x510f8e){const _0x34d42e=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x35e313]){log(_0x34d42e(0x1da),_0x34d42e(0x18a)),toastr[_0x34d42e(0x18a)](_0x34d42e(0x1bd),_0x34d42e(0x19a));return;}const _0x15f56d=_0x510f8e['trim']();if(!_0x15f56d){log(_0x34d42e(0x1e2),_0x34d42e(0x18a)),toastr[_0x34d42e(0x18a)](_0x34d42e(0x18b),_0x34d42e(0x19a));return;}if(currentTablesState[_0x34d42e(0x1c4)]((_0x40c517,_0x4b32ae)=>_0x4b32ae!==_0x35e313&&_0x40c517['name']===_0x15f56d)){log('重命名失败：名为\x20\x22'+_0x15f56d+_0x34d42e(0x27e),_0x34d42e(0x18a)),toastr[_0x34d42e(0x18a)](_0x34d42e(0x228)+_0x15f56d+'\x22\x20的表格已存在。',_0x34d42e(0x19a));return;}const _0x5d322f=currentTablesState[_0x35e313][_0x34d42e(0x205)];currentTablesState[_0x35e313][_0x34d42e(0x205)]=_0x15f56d,log(_0x34d42e(0x1e5)+_0x5d322f+_0x34d42e(0x1c6)+_0x15f56d+'\x22。',_0x34d42e(0x25d));const _0x17cbb6=getContext();if(_0x17cbb6[_0x34d42e(0x254)]&&_0x17cbb6[_0x34d42e(0x254)]['length']>0x0){const _0x5d618c=_0x17cbb6[_0x34d42e(0x254)][_0x17cbb6['chat'][_0x34d42e(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x5d618c)){saveChat();return;}}saveChatDebounced();}function _0x1220(_0x199c46,_0x403574){const _0xbc990c=_0xbc99();return _0x1220=function(_0x1220f1,_0x5bf74d){_0x1220f1=_0x1220f1-0x17d;let _0x1c1492=_0xbc990c[_0x1220f1];return _0x1c1492;},_0x1220(_0x199c46,_0x403574);}export function moveTable(_0x3850db,_0x39d402){const _0x7fddc3=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x3850db])return;const _0x458cbc=_0x39d402==='up'?_0x3850db-0x1:_0x3850db+0x1;if(_0x458cbc<0x0||_0x458cbc>=currentTablesState[_0x7fddc3(0x18e)]){log(_0x7fddc3(0x182)+_0x3850db+_0x7fddc3(0x220),_0x7fddc3(0x231));return;}const _0x948371=currentTablesState[_0x3850db];currentTablesState[_0x3850db]=currentTablesState[_0x458cbc],currentTablesState[_0x458cbc]=_0x948371;const _0x1b2bc2=_0x7fddc3(0x253)+_0x948371[_0x7fddc3(0x205)]+_0x7fddc3(0x1d7);log(_0x1b2bc2,_0x7fddc3(0x25d));const _0x598331=getContext();if(_0x598331[_0x7fddc3(0x254)]&&_0x598331[_0x7fddc3(0x254)][_0x7fddc3(0x18e)]>0x0){const _0x5d086c=_0x598331['chat'][_0x598331[_0x7fddc3(0x254)][_0x7fddc3(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x5d086c)){saveChat(),log(_0x7fddc3(0x212),_0x7fddc3(0x25d));return;}}log('无法找到可锚定的消息或保存失败，顺序调整可能不会被持久化！',_0x7fddc3(0x18a)),saveChatDebounced();}export function updateTableRules(_0x33a244,_0xc59eb9){const _0x7e69bf=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x33a244])return;const _0x38361b=currentTablesState[_0x33a244];_0x38361b['note']=_0xc59eb9[_0x7e69bf(0x1f1)],_0x38361b[_0x7e69bf(0x242)]=_0xc59eb9[_0x7e69bf(0x242)],_0x38361b[_0x7e69bf(0x23c)]=_0xc59eb9['rule_delete'],_0x38361b[_0x7e69bf(0x1e6)]=_0xc59eb9[_0x7e69bf(0x1e6)],_0x38361b['charLimitRules']=_0xc59eb9['charLimitRules'],_0x38361b[_0x7e69bf(0x203)]=_0xc59eb9[_0x7e69bf(0x203)],delete _0x38361b['charLimitRule'];const _0x279e7b='表格\x20['+_0x38361b[_0x7e69bf(0x205)]+_0x7e69bf(0x26e);log(_0x279e7b,_0x7e69bf(0x259));const _0x46c0fd=getContext();if(_0x46c0fd['chat']&&_0x46c0fd['chat'][_0x7e69bf(0x18e)]>0x0){const _0x5532a5=_0x46c0fd[_0x7e69bf(0x254)][_0x46c0fd['chat'][_0x7e69bf(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x5532a5)){saveChat();return;}}saveChatDebounced();}export function updateRow(_0x44d290,_0x751d3d,_0x204572){const _0x165cc4=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x44d290]){log(_0x165cc4(0x283)+_0x44d290+_0x165cc4(0x266),_0x165cc4(0x18a));return;}const _0xbb44c6=currentTablesState[_0x44d290];if(_0x751d3d>=_0xbb44c6[_0x165cc4(0x221)]['length']){log('AI指令意图更新不存在的行\x20(rowIndex:\x20'+_0x751d3d+_0x165cc4(0x1cd)+_0xbb44c6[_0x165cc4(0x205)]+_0x165cc4(0x180),_0x165cc4(0x231)),insertRow(_0x44d290,_0x204572);return;}const _0x20132a=_0xbb44c6['rows'][_0x751d3d];for(const _0x3bf0c8 in _0x204572){const _0x4c2eaf=parseInt(_0x3bf0c8,0xa);_0x4c2eaf<_0x20132a['length']&&(_0x20132a[_0x4c2eaf]=_0x204572[_0x4c2eaf],addHighlight(_0x44d290,_0x751d3d,_0x4c2eaf));}updatedTables[_0x165cc4(0x268)](_0x44d290);const _0x4d1014=_0x165cc4(0x1b5)+_0xbb44c6[_0x165cc4(0x205)]+_0x165cc4(0x1ae)+(_0x751d3d+0x1)+_0x165cc4(0x27a);log(_0x4d1014,_0x165cc4(0x259));const _0x1fc6d2=getContext();if(_0x1fc6d2[_0x165cc4(0x254)]&&_0x1fc6d2['chat']['length']>0x0){const _0x25f5f5=_0x1fc6d2['chat'][_0x1fc6d2['chat']['length']-0x1];if(saveStateToMessage(currentTablesState,_0x25f5f5)){saveChat();return;}}saveChatDebounced();}export function clearAllTables(){const _0x12e72e=_0x16a5d7;if(!currentTablesState){log(_0x12e72e(0x1f7),_0x12e72e(0x18a));return;}currentTablesState['forEach']((_0x27c34d,_0x31d9ab)=>{const _0x4c08bb=_0x12e72e;_0x27c34d[_0x4c08bb(0x221)][_0x4c08bb(0x18e)]>0x0&&updatedTables[_0x4c08bb(0x268)](_0x31d9ab),_0x27c34d['rows']=[],_0x27c34d[_0x4c08bb(0x22a)]=[];}),log(_0x12e72e(0x201),'warn');const _0x585a70=getContext();if(_0x585a70[_0x12e72e(0x254)]&&_0x585a70['chat']['length']>0x0){const _0x5666c1=_0x585a70[_0x12e72e(0x254)][_0x585a70[_0x12e72e(0x254)]['length']-0x1];if(saveStateToMessage(currentTablesState,_0x5666c1)){saveChat(),log(_0x12e72e(0x1d2),_0x12e72e(0x25d)),toastr['success']('所有表格的剧情内容已清空。',_0x12e72e(0x28b));return;}}log('无法找到可锚定的消息或保存失败，清空操作可能不会被持久化！',_0x12e72e(0x18a)),saveChatDebounced();}function _0xbc99(){const _0x454916=['global_table_preset','extra','角色栏','”已向','导入的表格数据格式不正确:\x20','导入预设失败:\x20','constructor','message','accept','未找到任何表格数据或全局预设，使用默认模板。','\x20已在边界。','rows','replace','clear','columnWidths','input','用户取消了导入操作。','执行AI指令:\x20deleteRow(tableIndex=','名为\x20\x22','无法移动列：索引\x20','rowStatuses','表格系统总开关已关闭，无法执行回退填表。','状态回退失败，已中止操作。','状态回退成功，准备重新填表...','聊天记录不足，无法执行回退操作。','技能栏','\x20条表格操作指令...','warn','\x20行移动到第\x20','执行AI指令时出错:\x20','【增加】:\x20','confirm','target','无法找到可锚定的消息或保存失败，删除操作可能不会被持久化！','substring','）列，字符超出规定（','tables','回退状态保存失败，操作中止。','rule_delete','具体描述','\x20行已标记为待删除。','）超出规定（','用户取消了全局预设导入操作。','createObjectURL','rule_add','forEach','amily2_tables_data',']\x20在第\x20','全局预设已设置！新聊天将默认使用此预设。','\x20条消息加载表格状态...','【触发条件】当以下情况发生时，应添加新行：\x0a1.\x20角色接下一个明确的、有目标的委托或命令。\x0a2.\x20角色们达成一个具体的、需要在未来执行的约定。\x0a3.\x20角色为自己设定一个长期的、关键性的目标。','fill','toString','当前没有设置全局预设。','map','无法找到可锚定的消息或保存失败，新表格可能不会被持久化！','重要原因','其他重要信息','【触发条件】当一个角色被确认永久性死亡（非假死或失踪），且其存在不再对后续剧情有直接影响时，可以删除该行。','UI已更新以显示回退后的状态。','全局预设已被清除。','表格\x20[','chat','\x20列的','\x20(索引\x20','新列\x201','createElement','info','【核心作用】此表格用于精确追踪故事发生的即时时空背景，确保时间与空间的连续性。它应该始终只包含一行，代表当前的“镜头”位置。\x0a【字段详解】\x0a-\x20日期:\x20格式为\x27YYYY-MM-DD\x27。若日期未知，请根据上下文合理推断或设定一个初始日期，如\x27大夏3年-9月-10日\x27。\x0a-\x20时段:\x20严格遵循规定（凌晨：0-5时；早晨：5-8时；上午：8-11时；中午：11-13时；下午：13-16时；傍晚：16-19时；晚上：19-24时）。\x0a-\x20时间:\x20格式为\x27HH:MM\x27。若时间未知，可根据时段估算，如\x2708:30\x27。\x0a-\x20地点:\x20描述当前场景发生的具体位置，应尽可能精确，例如\x27XX街的咖啡馆\x27而非\x27城里\x27。\x0a-\x20此地角色:\x20列出当前场景中所有在场且参与互动的主要角色，用\x27/\x27分隔。','Amily2-Table-Preset-v2.0-clean','无需清除，当前未设置任何全局预设。','success','isArray','Amily2-Table-Preset-v2.0-full','\x22\x20已更新内存状态。','未在聊天记录中找到表格，正在加载全局预设...','function',',\x20rowIndex=','split','与<user>关系','\x20中操作。','已根据AI的指示成功更新表格！','add','mes','toISOString','用户取消了清除全局预设的操作。','操作已取消。','AI返回内容为空，无法更新表格。',']\x20的规则已更新。','parse','stringify','”已更新为“','limit','无法回退：聊天记录不足。','已提交并永久删除了\x20','7688151BshCHd','从预设模板生成默认表格...','【修改】:\x20','【触发条件】当物品的“状态”（如被损坏）、“拥有者”（如被转交或被盗）或“详情”（如发现了新功能）发生变化时，必须更新。','）字限制，请进行缩减。】','\x20行。','columnIndex','操作成功','未在AI返回内容中找到有效的\x20<Amily2Edit>\x20指令块。','\x22\x20的表格已存在。','push','（该表当前内容为空）\x0a','.json','onchange','AI指令错误：尝试在不存在的表格索引\x20','aiRuleTemplate','batchFillerFlowTemplate','5577783bAwxqL','AI指令块为空，无需执行任何操作。','6726WwnFiA','技能名','\x0a---\x0a','操作完成','【触发条件】当任务列表超过10行时，优先删除最早的、已经“已完成”且与当前剧情关联度最低的任务。如果存在内容完全重复的任务，应删除。','正在执行回退并重新填表...','无法创建表格：名称不能为空。','injectionFlowTemplate','表格系统总开关已关闭，跳过回退填表。','物品栏','normal','成功删除了表格\x20','无法导出：当前表格状态为空。','在第\x20','已清除所有表格的更新标记。',']\x20末尾新增一行。','pending-deletion','无法移动表格：索引\x20','】已开始下载。','aiFlowTemplate','未能在上一楼找到可用的表格状态。','splice','slice','时空栏','【删除】:\x20','error','表格名称不能为空。','】已成功导出。','开始时间/结束时间','length','成功在表格\x20','导入成功','无法创建表格：名为\x20\x22','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','...]','【触发条件】当一个已知技能的效果发生进化、变异或被添加了新的限制/效果时（例如，技能升级），必须更新其“技能效果”描述。','【核心作用】此表格是角色关系和状态的核心数据库，用于记录所有在故事中出现的重要角色的详细信息。\x0a【字段详解】\x0a-\x20角色名:\x20角色的唯一标识。\x0a-\x20外貌:\x20描述五官、发型、发色、肤色等面部特征。\x0a-\x20身形:\x20描述身高、体型、肌肉状况、特殊身体标记（如伤疤）等。\x0a-\x20衣着:\x20描述角色当前或标志性的穿着，包括服装、配饰等。\x0a-\x20性格:\x20概括角色的核心性格特质，使用1-3个关键词，如\x27勇敢/鲁莽/忠诚\x27。\x0a-\x20身份:\x20角色的社会背景或出身，如\x27贵族后裔\x27、\x27流浪者\x27。\x0a-\x20职业:\x20角色赖以谋生的工作或职责，如\x27佣兵\x27、\x27学者\x27。\x0a-\x20与<user>关系:\x20描述该角色与主角<user>之间的社会或情感关系，如\x27盟友\x27、\x27导师\x27、\x27敌人\x27。\x0a-\x20爱好:\x20角色的兴趣和消遣活动。\x0a-\x20住所:\x20角色的常住地。\x0a-\x20其他重要信息:\x20记录任何不属于以上类别但对角色至关重要的信息，如特殊能力、过去的经历等。','【触发条件】当以下任一情况发生时，必须更新此行：\x0a1.\x20时间发生显著跳跃（例如，\x27几小时后\x27、\x27第二天\x27）。\x0a2.\x20角色从一个地点移动到另一个地点。\x0a3.\x20场景中关键角色的出入导致在场人员发生变化。','join','110etKSUF','文件格式无效或缺少版本号/表格数据。','重命名失败','result','设定栏','\x20|\x20','填表完成','【触发条件】只能在<user>明确表示要移除或废弃某条设定时，才能删除对应行。',',\x20data=','废黜表格后的状态已强制写入最新消息并立即保存。','新表格状态已强制写入最新消息并立即保存。','amily2_ai_template','成功将表格\x20','删除列失败：在表格\x20','\x20中找不到索引为\x20','table_system_enabled','2wZoDNV','56189VBXsAJ','below','removeChild','type','表格状态已准备写入消息\x20[',']\x20的第\x20','已成功将回退后的状态保存至最新消息。','\x20的第\x20','导入失败：','【核心作用】此表格记录了来自<user>的、超越故事本身的“元指令”或世界观设定，拥有最高解释权。内容应被严格遵守，禁止AI自行修改。\x0a【字段详解】\x0a-\x20类型:\x20指令的分类，如\x27世界观设定\x27、\x27剧情走向要求\x27、\x27角色行为禁令\x27。\x0a-\x20具体描述:\x20完整、准确地记录<user>提出的具体要求。','1261997gYOsGP','href','AI\x20指令更新了表格\x20[','创建失败','click','【触发条件】当故事开始，且此表格为空时，必须立即根据初始场景创建第一行。','Amily2-','warning','【核心作用】记录那些在故事中具有特殊功能、背景或情感价值的关键物品。普通物品不应记录。\x0a【字段详解】\x0a-\x20物品名:\x20物品的名称。\x0a-\x20类型:\x20物品的分类，如\x27武器\x27、\x27道具\x27、\x27信物\x27、\x27关键物品\x27。\x0a-\x20详情:\x20描述物品的外观、材质和已知功能。\x0a-\x20状态:\x20物品的当前状况，如\x27完好\x27、\x27破损\x27、\x27能量耗尽\x27。\x0a-\x20拥有者:\x20当前持有该物品的角色名。\x0a-\x20重要原因:\x20解释该物品为何重要，例如\x27是解开谜题的钥匙\x27或\x27是母亲的遗物\x27。','执行AI指令:\x20updateRow(tableIndex=','表格不存在。','插入了新列。','导入的预设中缺少指令模板字段，模板将不会被更新。','26zRKlja','7854MvRZib',']\x20新增了一列。','任务名','some','object','\x22\x20已重命名为\x20\x22','【触发条件】当<user>通过括号、旁白或其他明确的“第四面墙”方式，提出关于故事背景、规则或未来走向的指令时，必须记录于此。','加载全局预设失败:\x20','filter','110JLfqsV','此地角色','物品名',')，已智能转换为在表格\x20[','未能保存回退状态，操作中止。','）行，请结合剧情缩减至（','导入操作已取消。','\x20条消息中找到基准表格数据。','清空行数据后的状态已强制写入最新消息并立即保存。','正在尝试从第\x20','number','导入的预设已强制写入最新消息并立即保存。','body',']\x20的顺序已调整。','【触发条件】当<user>在故事中首次成功施展或习得一个全新的、表格中未记录的技能时，必须添加。','任务栏','重命名失败：表格不存在。','【核心作用】追踪故事中的主要情节线、目标和挑战。只记录对剧情发展有重大影响的“任务”，忽略日常琐事。\x0a【字段详解】\x0a-\x20任务名:\x20任务的简洁概括，如\x27寻找失落的神器\x27。\x0a-\x20类型:\x20任务的分类，如\x27主线\x27、\x27支线\x27、\x27个人\x27、\x27约定\x27。\x0a-\x20详情:\x20对任务目标和背景的简要描述。\x0a-\x20状态:\x20任务的当前进展，如\x27未开始\x27、\x27进行中\x27、\x27已完成\x27、\x27已失败\x27、\x27已取消\x27。\x0a-\x20执行者:\x20负责完成此任务的角色名。\x0a-\x20地点:\x20任务关键环节发生的地点。\x0a-\x20开始时间/结束时间:\x20记录任务的起止时间，格式\x27YYYY-MM-DD\x27，若未结束则结束时间留空。\x0a-\x20结果:\x20任务完成或失败后的最终结果。','【触发条件】当角色的任何信息发生持久性或关键性变化时，必须更新对应单元格。例如：\x0a1.\x20外貌/身形/衣着发生永久性改变（如断肢、换上新装备）。\x0a2.\x20性格因重大事件而扭转。\x0a3.\x20身份或职业发生变更（如继承王位、被解雇）。\x0a4.\x20与<user>的关系发生根本性转变（如从敌人变为盟友）。','download','charLimitRules','charLimitRule','Amily2-Table-Preset-v3.0-separated_templates','getPrototypeOf','重命名失败：名称不能为空。',']\x20的列“','【清除全局预设】\x0a\x0a您确定要清除已设置的全局预设吗？\x0a\x0a清除后，新聊天将恢复使用扩展内置的默认表格模板。','表格\x20\x22','rule_update','\x20列。','【警告】\x0a\x0a导入操作将完全覆盖您当前的AI指令模板和所有表格（包括结构和内容）。\x0a\x0a此操作不可逆，是否确定要继续？','\x20行位置插入了新行。','\x20的列。','size','全局预设已成功导入并保存到扩展设置中。','aiTemplate','file','batch_filler_rule_template','rowIndex','note','files','【当前（','UI操作\x20\x22','16167588Npnqht','设置成功','无法清空：当前表格状态为空。','回退并重新填表操作完成。','---','application/json','预设已成功导入并应用。','34988uZGMLK','batch_filler_flow_template','readAsText','所有AI指令已成功执行完毕。','batchFillerRuleTemplate','所有表格的行数据已在内存中清空。','every','rowLimitRule','left','name','【触发条件】当一个有名有姓的角色首次出现，并与<user>或当前剧情发生有意义的互动时，必须为其创建新的一行。',']\x20新增了一行。','headers',']\x20已被成功废黜。','8qylUxQ','【触发条件】当任务的“状态”发生任何变化时，必须更新。例如，从\x27进行中\x27变为\x27已完成\x27。当任务的“详情”或“结果”有新的关键信息补充时，也应更新。','移动。','【核心作用】专门用于记录主角<user>掌握的各种技能、魔法、被动能力或特殊专长。\x0a【字段详解】\x0a-\x20技能名:\x20技能的正式名称。\x0a-\x20技能效果:\x20清晰、简洁地描述该技能使用时产生的具体效果、消耗和限制条件。','重新填表失败:\x20','导出成功','角色名','\x20|\x0a','表格顺序调整后的状态已强制写入最新消息并立即保存。','trim','这是一个新创建的表格。','version'];_0xbc99=function(){return _0x454916;};return _0xbc99();}function checkTableRules(_0x50454f){const _0x47425f=_0x16a5d7;let _0x3ace0a=[];_0x50454f[_0x47425f(0x203)]&&_0x50454f['rowLimitRule']>0x0&&_0x50454f[_0x47425f(0x221)]['length']>_0x50454f[_0x47425f(0x203)]&&_0x3ace0a['push'](_0x47425f(0x1f3)+_0x50454f[_0x47425f(0x205)]+_0x47425f(0x23f)+_0x50454f[_0x47425f(0x203)]+_0x47425f(0x1cf)+_0x50454f['rowLimitRule']+'）行以下，但切莫完全删除。】');const _0x185a44=_0x50454f[_0x47425f(0x1de)]||{};for(const _0x848444 in _0x185a44){const _0x462d64=parseInt(_0x848444,0xa),_0x4d41d4=_0x185a44[_0x462d64];if(_0x4d41d4>0x0&&_0x462d64>=0x0&&_0x462d64<_0x50454f['headers'][_0x47425f(0x18e)]){const _0x44be7e=_0x50454f['headers'][_0x462d64],_0x373c61=[];_0x50454f[_0x47425f(0x221)][_0x47425f(0x243)]((_0x2a6b2b,_0x26945b)=>{const _0x2896aa=_0x47425f;if(_0x50454f['rowStatuses']&&_0x50454f[_0x2896aa(0x22a)][_0x26945b]==='pending-deletion')return;const _0x443482=_0x2a6b2b[_0x462d64]||'';_0x443482[_0x2896aa(0x18e)]>_0x4d41d4&&_0x373c61[_0x2896aa(0x27f)](_0x26945b);});if(_0x373c61[_0x47425f(0x18e)]>0x0){const _0x248898=_0x373c61[_0x47425f(0x197)]('、');_0x3ace0a[_0x47425f(0x27f)]('【当前（'+_0x50454f[_0x47425f(0x205)]+'）第（'+_0x248898+'）行（'+_0x44be7e+_0x47425f(0x239)+_0x4d41d4+_0x47425f(0x279));}}}return _0x3ace0a[_0x47425f(0x197)]('\x0a');}export function convertTablesToCsvString(){const _0x16d2d3=_0x16a5d7;!currentTablesState&&loadTables();if(!currentTablesState)return'';let _0x272a11='';return currentTablesState[_0x16d2d3(0x243)]((_0x746834,_0x3376d8)=>{const _0x38a1f3=_0x16d2d3;_0x272a11+='\x0a*\x20'+_0x3376d8+':'+_0x746834[_0x38a1f3(0x205)]+'\x0a',_0x272a11+='【说明】:\x0a'+(_0x746834[_0x38a1f3(0x1f1)]||'无')+'\x0a';const _0x131fb1=_0x746834[_0x38a1f3(0x205)][_0x38a1f3(0x222)](/\s/g,'')+'内容';_0x272a11+='<'+_0x131fb1+'>\x0a';const _0xeeb06a=[_0x38a1f3(0x1f0),..._0x746834[_0x38a1f3(0x208)][_0x38a1f3(0x24c)]((_0x2aa599,_0x3ea949)=>_0x3ea949+':'+_0x2aa599)];_0x272a11+='|\x20'+_0xeeb06a[_0x38a1f3(0x197)]('\x20|\x20')+_0x38a1f3(0x211),_0x272a11+='|'+_0xeeb06a[_0x38a1f3(0x24c)](()=>_0x38a1f3(0x1f9))[_0x38a1f3(0x197)]('|')+'|\x0a';const _0x37ff12=_0x746834[_0x38a1f3(0x221)][_0x38a1f3(0x1c9)]((_0x33fe55,_0xd3e5d6)=>!_0x746834[_0x38a1f3(0x22a)]||_0x746834[_0x38a1f3(0x22a)][_0xd3e5d6]!==_0x38a1f3(0x181));_0x37ff12[_0x38a1f3(0x18e)]===0x0?_0x272a11+=_0x38a1f3(0x280):_0x746834[_0x38a1f3(0x221)]['forEach']((_0x1e6869,_0x399fc4)=>{const _0x59d088=_0x38a1f3;if(_0x746834[_0x59d088(0x22a)]&&_0x746834[_0x59d088(0x22a)][_0x399fc4]===_0x59d088(0x181))return;if(Array['isArray'](_0x1e6869)){const _0x18eb2f=_0x1e6869['map'](_0x1955e8=>{const _0x7d9420=_0x59d088,_0x2cf2e3=_0x1955e8===null||_0x1955e8===undefined||_0x1955e8===''?'未知':String(_0x1955e8);return _0x2cf2e3[_0x7d9420(0x222)](/\|/g,'｜');});_0x272a11+='|\x20'+_0x399fc4+'\x20|\x20'+_0x18eb2f[_0x59d088(0x197)](_0x59d088(0x19d))+_0x59d088(0x211);}});const _0x2de570=checkTableRules(_0x746834);_0x2de570&&(_0x272a11+=_0x2de570+'\x0a'),_0x272a11+='</'+_0x131fb1+'>\x0a',_0x272a11+=_0x38a1f3(0x234)+(_0x746834[_0x38a1f3(0x242)]||'允许')+'\x0a',_0x272a11+=_0x38a1f3(0x189)+(_0x746834[_0x38a1f3(0x23c)]||'允许')+'\x0a',_0x272a11+=_0x38a1f3(0x277)+(_0x746834[_0x38a1f3(0x1e6)]||'允许')+'\x0a',_0x3376d8<currentTablesState[_0x38a1f3(0x18e)]-0x1&&(_0x272a11+=_0x38a1f3(0x28a));}),_0x272a11;}export function convertTablesToCsvStringForContentOnly(){const _0x5971dd=_0x16a5d7,_0x2c7578=getMemoryState();if(!_0x2c7578||_0x2c7578[_0x5971dd(0x18e)]===0x0)return'';let _0x82afcd='';return _0x2c7578['forEach'](_0x5e6d5d=>{const _0xcf040=_0x5971dd;_0x82afcd+='\x0a<'+_0x5e6d5d[_0xcf040(0x205)]+'>\x0a';const _0x4bd3c1='|\x20'+_0x5e6d5d['headers'][_0xcf040(0x197)](_0xcf040(0x19d))+'\x20|';_0x82afcd+=_0x4bd3c1+'\x0a';const _0x31757c='|'+_0x5e6d5d['headers'][_0xcf040(0x24c)](()=>_0xcf040(0x1f9))['join']('|')+'|';_0x82afcd+=_0x31757c+'\x0a';const _0x582e30=_0x5e6d5d[_0xcf040(0x221)][_0xcf040(0x1c9)]((_0x508bc2,_0x51f7fa)=>!_0x5e6d5d[_0xcf040(0x22a)]||_0x5e6d5d[_0xcf040(0x22a)][_0x51f7fa]!==_0xcf040(0x181));_0x582e30[_0xcf040(0x18e)]>0x0?_0x582e30[_0xcf040(0x243)](_0x4510a4=>{const _0x2cde8c=_0xcf040;if(Array[_0x2cde8c(0x25e)](_0x4510a4)){const _0x264dd6=_0x4510a4[_0x2cde8c(0x24c)](_0x2a98cd=>_0x2a98cd===null||_0x2a98cd===undefined||_0x2a98cd===''?'\x20':_0x2a98cd[_0x2cde8c(0x24a)]()),_0x4f40e3='|\x20'+_0x264dd6[_0x2cde8c(0x197)](_0x2cde8c(0x19d))+'\x20|';_0x82afcd+=_0x4f40e3+'\x0a';}}):_0x82afcd+=_0xcf040(0x280),_0x82afcd+='</'+_0x5e6d5d[_0xcf040(0x205)]+'>\x0a';}),_0x82afcd[_0x5971dd(0x213)]();}loadTables();export function getBatchFillerRuleTemplate(){const _0x3461c9=_0x16a5d7;return extension_settings[extensionName]?.[_0x3461c9(0x1ef)]??DEFAULT_AI_RULE_TEMPLATE;}export function saveBatchFillerRuleTemplate(_0x281979){extension_settings[extensionName]['batch_filler_rule_template']=_0x281979,saveSettingsDebounced();}export function getBatchFillerFlowTemplate(){const _0x208c95=_0x16a5d7;return extension_settings[extensionName]?.[_0x208c95(0x1fd)]??DEFAULT_AI_FLOW_TEMPLATE;}export function saveBatchFillerFlowTemplate(_0x16e0dd){const _0x9a9a96=_0x16a5d7;extension_settings[extensionName][_0x9a9a96(0x1fd)]=_0x16e0dd,saveSettingsDebounced();}export function getAiFlowTemplateForInjection(){const _0x330646=_0x16a5d7;return extension_settings[extensionName]?.[_0x330646(0x1a3)]??DEFAULT_AI_FLOW_TEMPLATE;}export async function updateTableFromText(_0x519f50){const _0x2dedc0=_0x16a5d7,_0x2828c8=extension_settings[extensionName];if(_0x2828c8[_0x2dedc0(0x1a7)]===![]){log('表格系统总开关已关闭，跳过\x20<Amily2Edit>\x20标签处理。',_0x2dedc0(0x259));return;}if(!_0x519f50){log(_0x2dedc0(0x26d),_0x2dedc0(0x231));return;}const _0x22f75d=_0x519f50['match'](/<Amily2Edit>([\s\S]*?)<\/Amily2Edit>/);if(!_0x22f75d||!_0x22f75d[0x1]){log(_0x2dedc0(0x27d),_0x2dedc0(0x231));return;}let _0x21d034=_0x22f75d[0x1][_0x2dedc0(0x222)](/<!--|-->/g,'')[_0x2dedc0(0x213)]();if(!_0x21d034){log(_0x2dedc0(0x287),_0x2dedc0(0x259));return;}const _0x7102e0=_0x21d034[_0x2dedc0(0x264)]('\x0a')['filter'](_0x5a6571=>_0x5a6571[_0x2dedc0(0x213)]()!=='');log('准备执行从AI返回的\x20'+_0x7102e0[_0x2dedc0(0x18e)]+_0x2dedc0(0x230),_0x2dedc0(0x259));const _0x4d6a26={'insertRow':(_0x5e4e81,_0x463ff7)=>{const _0x39365a=_0x2dedc0;log('执行AI指令:\x20insertRow(tableIndex='+_0x5e4e81+_0x39365a(0x1a0)+JSON[_0x39365a(0x270)](_0x463ff7)+')',_0x39365a(0x259)),insertRow(_0x5e4e81,_0x463ff7);},'deleteRow':(_0x30dba3,_0xca2c30)=>{const _0x23aabe=_0x2dedc0;log(_0x23aabe(0x227)+_0x30dba3+_0x23aabe(0x263)+_0xca2c30+')',_0x23aabe(0x259)),deleteRow(_0x30dba3,_0xca2c30);},'updateRow':(_0x4a86bf,_0x31ccb2,_0x5742db)=>{const _0x5c5bb7=_0x2dedc0;log(_0x5c5bb7(0x1bc)+_0x4a86bf+_0x5c5bb7(0x263)+_0x31ccb2+_0x5c5bb7(0x1a0)+JSON[_0x5c5bb7(0x270)](_0x5742db)+')',_0x5c5bb7(0x259)),updateRow(_0x4a86bf,_0x31ccb2,_0x5742db);}};try{const _0x44c6fa=Object[_0x2dedc0(0x1e1)](async function(){})[_0x2dedc0(0x21c)],_0x55a36b=new _0x44c6fa('runner','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20const\x20{\x20insertRow,\x20deleteRow,\x20updateRow\x20}\x20=\x20runner;\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x21d034+_0x2dedc0(0x192));await _0x55a36b(_0x4d6a26),log(_0x2dedc0(0x1ff),_0x2dedc0(0x25d)),toastr[_0x2dedc0(0x25d)](_0x2dedc0(0x267),_0x2dedc0(0x19e)),document['dispatchEvent'](new CustomEvent('amily2-force-ui-reload'));}catch(_0x43a577){log('执行AI指令时发生错误:\x20'+_0x43a577[_0x2dedc0(0x21d)],'error'),toastr[_0x2dedc0(0x18a)](_0x2dedc0(0x233)+_0x43a577[_0x2dedc0(0x21d)],'执行失败');}}export function saveAiTemplate(_0x481054){extension_settings[extensionName]['amily2_ai_template']=_0x481054,saveSettingsDebounced();}export function getAiTemplate(){return getAiFlowTemplateForInjection();}function exportPresetBase(_0x52bcdd=![]){const _0x2a0be9=_0x16a5d7;if(!currentTablesState){log(_0x2a0be9(0x17d),_0x2a0be9(0x18a)),toastr[_0x2a0be9(0x18a)]('没有可导出的表格数据。');return;}let _0x5d3f24,_0x4e74af,_0x5baaea;_0x52bcdd?(_0x5d3f24=JSON[_0x2a0be9(0x26f)](JSON[_0x2a0be9(0x270)](currentTablesState)),_0x4e74af=_0x2a0be9(0x25f),_0x5baaea='完整备份'):(_0x5d3f24=currentTablesState['map'](_0x4cedbe=>({'name':_0x4cedbe['name'],'headers':_0x4cedbe[_0x2a0be9(0x208)],'columnWidths':_0x4cedbe[_0x2a0be9(0x224)]||[],'note':_0x4cedbe[_0x2a0be9(0x1f1)],'rule_add':_0x4cedbe[_0x2a0be9(0x242)],'rule_delete':_0x4cedbe[_0x2a0be9(0x23c)],'rule_update':_0x4cedbe[_0x2a0be9(0x1e6)],'charLimitRules':_0x4cedbe[_0x2a0be9(0x1de)]||{},'rowLimitRule':_0x4cedbe[_0x2a0be9(0x203)]||0x0,'rows':[],'rowStatuses':[]})),_0x4e74af=_0x2a0be9(0x25b),_0x5baaea='纯净预设');const _0x563b51={'version':_0x2a0be9(0x1e0),'batchFillerRuleTemplate':getBatchFillerRuleTemplate(),'batchFillerFlowTemplate':getBatchFillerFlowTemplate(),'tables':_0x5d3f24},_0x28ab56=new Blob([JSON[_0x2a0be9(0x270)](_0x563b51,null,0x2)],{'type':_0x2a0be9(0x1fa)}),_0x20c150=URL[_0x2a0be9(0x241)](_0x28ab56),_0x42a5ac=document[_0x2a0be9(0x258)]('a');_0x42a5ac[_0x2a0be9(0x1b4)]=_0x20c150,_0x42a5ac[_0x2a0be9(0x1dd)]=_0x2a0be9(0x1b9)+_0x5baaea+'-'+new Date()[_0x2a0be9(0x26a)]()[_0x2a0be9(0x187)](0x0,0xa)+_0x2a0be9(0x281),document[_0x2a0be9(0x1d6)]['appendChild'](_0x42a5ac),_0x42a5ac['click'](),document[_0x2a0be9(0x1d6)][_0x2a0be9(0x1ab)](_0x42a5ac),URL['revokeObjectURL'](_0x20c150),log('【'+_0x5baaea+_0x2a0be9(0x18c),_0x2a0be9(0x25d)),toastr[_0x2a0be9(0x25d)]('【'+_0x5baaea+_0x2a0be9(0x183),_0x2a0be9(0x20f));}export function exportPreset(){exportPresetBase(![]);}export function exportPresetFull(){exportPresetBase(!![]);}export function importPreset(_0x24b89e){const _0x582870=_0x16a5d7,_0x5a4edd=document[_0x582870(0x258)](_0x582870(0x225));_0x5a4edd['type']=_0x582870(0x1ee),_0x5a4edd[_0x582870(0x21e)]=_0x582870(0x281),_0x5a4edd[_0x582870(0x282)]=_0x490f0a=>{const _0x4ccf6a=_0x582870,_0x25bbeb=_0x490f0a[_0x4ccf6a(0x236)][_0x4ccf6a(0x1f2)][0x0];if(!_0x25bbeb)return;const _0x3cece2=new FileReader();_0x3cece2['onload']=_0x5a6916=>{const _0x11c4db=_0x4ccf6a;try{const _0x1ccda5=JSON[_0x11c4db(0x26f)](_0x5a6916[_0x11c4db(0x236)][_0x11c4db(0x19b)]);if(!_0x1ccda5[_0x11c4db(0x215)]||!Array[_0x11c4db(0x25e)](_0x1ccda5[_0x11c4db(0x23a)]))throw new Error(_0x11c4db(0x199));const _0x134202=window['confirm'](_0x11c4db(0x1e8));if(!_0x134202){log(_0x11c4db(0x226),_0x11c4db(0x259)),toastr['info'](_0x11c4db(0x1d0));return;}if(_0x1ccda5[_0x11c4db(0x215)]===_0x11c4db(0x1e0))saveBatchFillerRuleTemplate(_0x1ccda5['batchFillerRuleTemplate']||''),saveBatchFillerFlowTemplate(_0x1ccda5[_0x11c4db(0x285)]||''),saveAiTemplate(_0x1ccda5[_0x11c4db(0x28f)]||'');else{if(_0x1ccda5[_0x11c4db(0x284)]!==undefined&&_0x1ccda5[_0x11c4db(0x184)]!==undefined)saveBatchFillerRuleTemplate(_0x1ccda5[_0x11c4db(0x284)]||''),saveBatchFillerFlowTemplate(_0x1ccda5[_0x11c4db(0x184)]||''),saveAiTemplate(_0x1ccda5[_0x11c4db(0x184)]||'');else _0x1ccda5[_0x11c4db(0x1ed)]?(saveBatchFillerRuleTemplate(''),saveBatchFillerFlowTemplate(_0x1ccda5[_0x11c4db(0x1ed)]||''),saveAiTemplate(_0x1ccda5[_0x11c4db(0x1ed)]||'')):log(_0x11c4db(0x1bf),_0x11c4db(0x231));}const _0x435509=_0x1ccda5[_0x11c4db(0x23a)];_0x435509[_0x11c4db(0x243)](_0x2c2db0=>{const _0x4f44c9=_0x11c4db;if(_0x2c2db0['name']===undefined||_0x2c2db0[_0x4f44c9(0x208)]===undefined||_0x2c2db0[_0x4f44c9(0x221)]===undefined)throw new Error(_0x4f44c9(0x21a)+JSON[_0x4f44c9(0x270)](_0x2c2db0));if(_0x2c2db0['note']===undefined)_0x2c2db0[_0x4f44c9(0x1f1)]='无';if(_0x2c2db0[_0x4f44c9(0x242)]===undefined)_0x2c2db0[_0x4f44c9(0x242)]='允许';if(_0x2c2db0[_0x4f44c9(0x23c)]===undefined)_0x2c2db0[_0x4f44c9(0x23c)]='允许';if(_0x2c2db0[_0x4f44c9(0x1e6)]===undefined)_0x2c2db0[_0x4f44c9(0x1e6)]='允许';if(_0x2c2db0['charLimitRule']&&!_0x2c2db0[_0x4f44c9(0x1de)])_0x2c2db0[_0x4f44c9(0x1de)]={},_0x2c2db0['charLimitRule'][_0x4f44c9(0x27b)]!==-0x1&&_0x2c2db0['charLimitRule'][_0x4f44c9(0x272)]>0x0&&(_0x2c2db0[_0x4f44c9(0x1de)][_0x2c2db0[_0x4f44c9(0x1df)][_0x4f44c9(0x27b)]]=_0x2c2db0[_0x4f44c9(0x1df)][_0x4f44c9(0x272)]);else _0x2c2db0['charLimitRules']===undefined&&(_0x2c2db0[_0x4f44c9(0x1de)]={});delete _0x2c2db0['charLimitRule'],!_0x2c2db0[_0x4f44c9(0x22a)]&&(_0x2c2db0[_0x4f44c9(0x22a)]=Array(_0x2c2db0[_0x4f44c9(0x221)][_0x4f44c9(0x18e)])[_0x4f44c9(0x249)](_0x4f44c9(0x292))),_0x2c2db0[_0x4f44c9(0x203)]===undefined&&(_0x2c2db0[_0x4f44c9(0x203)]=0x0),_0x2c2db0[_0x4f44c9(0x224)]===undefined&&(_0x2c2db0['columnWidths']=[]);}),setMemoryState(_0x435509);const _0x4c5199=getContext();if(_0x4c5199[_0x11c4db(0x254)]&&_0x4c5199[_0x11c4db(0x254)][_0x11c4db(0x18e)]>0x0){const _0x4e8996=_0x4c5199[_0x11c4db(0x254)][_0x4c5199[_0x11c4db(0x254)][_0x11c4db(0x18e)]-0x1];saveStateToMessage(getMemoryState(),_0x4e8996)&&(saveChat(),log(_0x11c4db(0x1d5),_0x11c4db(0x25d)));}else saveChatDebounced();log(_0x11c4db(0x1fb),_0x11c4db(0x25d)),toastr[_0x11c4db(0x25d)]('预设已成功导入！',_0x11c4db(0x190)),typeof _0x24b89e===_0x11c4db(0x262)&&_0x24b89e();}catch(_0x1ed8e){log(_0x11c4db(0x21b)+_0x1ed8e['message'],_0x11c4db(0x18a)),toastr[_0x11c4db(0x18a)]('导入失败：'+_0x1ed8e['message'],'错误');}},_0x3cece2[_0x4ccf6a(0x1fe)](_0x25bbeb);},_0x5a4edd['click']();}export async function rollbackState(){const _0x470193=_0x16a5d7,_0x561437=getContext();if(!_0x561437||!_0x561437['chat']||_0x561437[_0x470193(0x254)][_0x470193(0x18e)]<0x2)return log(_0x470193(0x273),_0x470193(0x231)),toastr[_0x470193(0x1ba)](_0x470193(0x22e)),![];const _0x16daa2=_0x561437['chat'],_0x3555da=_0x16daa2[_0x470193(0x18e)]-0x1,_0x31f975=_0x16daa2[_0x3555da];log(_0x470193(0x1d3)+(_0x3555da-0x1)+_0x470193(0x247),_0x470193(0x259));const _0x3e5ac6=loadTables(_0x3555da);if(!_0x3e5ac6)return log('未能在上一楼找到可用的表格状态，无法回退。','error'),toastr[_0x470193(0x18a)](_0x470193(0x185)),![];setMemoryState(_0x3e5ac6);if(saveStateToMessage(_0x3e5ac6,_0x31f975))await saveChat(),log(_0x470193(0x1af),_0x470193(0x25d));else return log(_0x470193(0x23b),_0x470193(0x18a)),toastr['error'](_0x470193(0x1ce)),![];return renderTables(),updateOrInsertTableInChat(),log(_0x470193(0x251),_0x470193(0x259)),!![];}export async function rollbackAndRefill(){const _0x2033fa=_0x16a5d7,_0x47c80=extension_settings[extensionName];if(_0x47c80[_0x2033fa(0x1a7)]===![]){log(_0x2033fa(0x290),_0x2033fa(0x259)),toastr[_0x2033fa(0x259)](_0x2033fa(0x22b));return;}toastr[_0x2033fa(0x259)](_0x2033fa(0x28d));const _0x3de6f2=await rollbackState();if(!_0x3de6f2){toastr[_0x2033fa(0x18a)](_0x2033fa(0x22c));return;}toastr[_0x2033fa(0x25d)](_0x2033fa(0x22d));const _0x396739=getContext(),_0x24f132=_0x396739['chat'][_0x396739[_0x2033fa(0x254)][_0x2033fa(0x18e)]-0x1];try{await fillWithSecondaryApi(_0x24f132,!![]),log(_0x2033fa(0x1f8),_0x2033fa(0x25d));}catch(_0x378825){log('回退重填过程中发生错误:\x20'+_0x378825['message'],_0x2033fa(0x18a)),toastr[_0x2033fa(0x18a)](_0x2033fa(0x20e)+_0x378825[_0x2033fa(0x21d)]);}}export function updateColumnWidth(_0x107e7,_0xd5afbe,_0xce2b29){const _0x286709=_0x16a5d7;if(!currentTablesState||!currentTablesState[_0x107e7])return;const _0xfcb50c=currentTablesState[_0x107e7];!_0xfcb50c[_0x286709(0x224)]&&(_0xfcb50c[_0x286709(0x224)]=[]);while(_0xfcb50c['columnWidths'][_0x286709(0x18e)]<_0xfcb50c['headers'][_0x286709(0x18e)]){_0xfcb50c[_0x286709(0x224)][_0x286709(0x27f)](null);}_0xfcb50c[_0x286709(0x224)][_0xd5afbe]=_0xce2b29;const _0x5c9846=getContext();if(_0x5c9846[_0x286709(0x254)]&&_0x5c9846['chat'][_0x286709(0x18e)]>0x0){const _0x41c808=_0x5c9846[_0x286709(0x254)][_0x5c9846['chat'][_0x286709(0x18e)]-0x1];if(saveStateToMessage(currentTablesState,_0x41c808)){saveChat();return;}}saveChatDebounced();}export function isCurrentTablesEmpty(){const _0xb9931=_0x16a5d7,_0x55c880=getMemoryState();if(!_0x55c880||_0x55c880['length']===0x0)return!![];return _0x55c880[_0xb9931(0x202)](_0x7cc9c5=>!_0x7cc9c5[_0xb9931(0x221)]||_0x7cc9c5['rows']['length']===0x0);}export function clearGlobalPreset(){const _0x259147=_0x16a5d7;if(extension_settings[extensionName]&&extension_settings[extensionName][_0x259147(0x216)]){const _0x46262d=window[_0x259147(0x235)](_0x259147(0x1e4));_0x46262d?(delete extension_settings[extensionName][_0x259147(0x216)],saveSettingsDebounced(),log(_0x259147(0x252),'success'),toastr[_0x259147(0x25d)]('全局预设已清除，新聊天将使用默认模板。',_0x259147(0x27c))):(log(_0x259147(0x26b),_0x259147(0x259)),toastr[_0x259147(0x259)](_0x259147(0x26c)));}else log(_0x259147(0x25c),_0x259147(0x259)),toastr[_0x259147(0x259)](_0x259147(0x24b),'提示');}export function importGlobalPreset(_0x2da52c){const _0x409122=_0x16a5d7,_0x2f4810=document[_0x409122(0x258)]('input');_0x2f4810[_0x409122(0x1ac)]='file',_0x2f4810[_0x409122(0x21e)]='.json',_0x2f4810[_0x409122(0x282)]=_0x5da40d=>{const _0x48dcb7=_0x409122,_0x1abf1c=_0x5da40d[_0x48dcb7(0x236)][_0x48dcb7(0x1f2)][0x0];if(!_0x1abf1c)return;const _0x336ba7=new FileReader();_0x336ba7['onload']=_0x10326d=>{const _0x4bfadd=_0x48dcb7;try{const _0x3914d4=JSON[_0x4bfadd(0x26f)](_0x10326d['target'][_0x4bfadd(0x19b)]);if(!_0x3914d4['version']||!Array[_0x4bfadd(0x25e)](_0x3914d4[_0x4bfadd(0x23a)]))throw new Error(_0x4bfadd(0x199));const _0x1378b1=window[_0x4bfadd(0x235)]('【全局预设导入】\x0a\x0a这将把选定的预设设置为所有新聊天的默认表格。\x0a\x0a此操作将覆盖任何已存在的全局预设，是否确定？');if(!_0x1378b1){log(_0x4bfadd(0x240),'info'),toastr[_0x4bfadd(0x259)]('操作已取消。');return;}const _0x37e57f=_0x3914d4[_0x4bfadd(0x23a)][_0x4bfadd(0x24c)](_0x151a14=>({'name':_0x151a14[_0x4bfadd(0x205)],'headers':_0x151a14['headers'],'note':_0x151a14['note'],'rule_add':_0x151a14[_0x4bfadd(0x242)],'rule_delete':_0x151a14[_0x4bfadd(0x23c)],'rule_update':_0x151a14[_0x4bfadd(0x1e6)],'rows':[]}));!extension_settings[extensionName]&&(extension_settings[extensionName]={});extension_settings[extensionName]['global_table_preset']={'version':_0x3914d4[_0x4bfadd(0x215)],'tables':_0x37e57f,'batchFillerRuleTemplate':_0x3914d4[_0x4bfadd(0x200)],'batchFillerFlowTemplate':_0x3914d4[_0x4bfadd(0x285)]},saveSettingsDebounced();if(_0x3914d4[_0x4bfadd(0x215)]===_0x4bfadd(0x1e0))saveBatchFillerRuleTemplate(_0x3914d4[_0x4bfadd(0x200)]||''),saveBatchFillerFlowTemplate(_0x3914d4['batchFillerFlowTemplate']||''),saveAiTemplate(_0x3914d4[_0x4bfadd(0x28f)]||'');else{if(_0x3914d4[_0x4bfadd(0x284)]!==undefined&&_0x3914d4['aiFlowTemplate']!==undefined)saveBatchFillerRuleTemplate(_0x3914d4[_0x4bfadd(0x284)]||''),saveBatchFillerFlowTemplate(_0x3914d4['aiFlowTemplate']||''),saveAiTemplate(_0x3914d4['aiFlowTemplate']||'');else _0x3914d4['aiTemplate']&&(saveBatchFillerRuleTemplate(''),saveBatchFillerFlowTemplate(_0x3914d4['aiTemplate']||''),saveAiTemplate(_0x3914d4[_0x4bfadd(0x1ed)]||''));}log(_0x4bfadd(0x1ec),_0x4bfadd(0x25d)),toastr[_0x4bfadd(0x25d)](_0x4bfadd(0x246),_0x4bfadd(0x1f6)),typeof _0x2da52c==='function'&&_0x2da52c();}catch(_0x718264){log('导入全局预设失败:\x20'+_0x718264[_0x4bfadd(0x21d)],_0x4bfadd(0x18a)),toastr[_0x4bfadd(0x18a)](_0x4bfadd(0x1b1)+_0x718264[_0x4bfadd(0x21d)],'错误');}},_0x336ba7['readAsText'](_0x1abf1c);},_0x2f4810[_0x409122(0x1b7)]();}
