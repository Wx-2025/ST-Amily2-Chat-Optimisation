const _0x2b61df=_0x2780;(function(_0x3ceae6,_0x49c5aa){const _0x30ca3e=_0x2780,_0x4c9b97=_0x3ceae6();while(!![]){try{const _0x2d19c0=parseInt(_0x30ca3e(0x1bc))/0x1*(parseInt(_0x30ca3e(0xf7))/0x2)+parseInt(_0x30ca3e(0x1ce))/0x3+parseInt(_0x30ca3e(0x187))/0x4*(-parseInt(_0x30ca3e(0x140))/0x5)+parseInt(_0x30ca3e(0x180))/0x6+-parseInt(_0x30ca3e(0x19e))/0x7+parseInt(_0x30ca3e(0xd4))/0x8*(parseInt(_0x30ca3e(0x168))/0x9)+parseInt(_0x30ca3e(0x1cb))/0xa*(-parseInt(_0x30ca3e(0x155))/0xb);if(_0x2d19c0===_0x49c5aa)break;else _0x4c9b97['push'](_0x4c9b97['shift']());}catch(_0x538963){_0x4c9b97['push'](_0x4c9b97['shift']());}}}(_0x2a67,0xb011e));import{createDrawer}from'./ui/drawer.js';import'./PresetSettings/index.js';import'./PreOptimizationViewer/index.js';import'./WorldEditor/WorldEditor.js';import{registerSlashCommands}from'./core/commands.js';import{onMessageReceived,handleTableUpdate}from'./core/events.js';import{processPlotOptimization}from'./core/summarizer.js';import{getContext}from'/scripts/extensions.js';import{characters,this_chid}from'/script.js';import{injectTableData,generateTableContent}from'./core/table-system/injector.js';import{initialize as _0x2f6a1a}from'./core/rag-processor.js';import{loadTables,clearHighlights,rollbackAndRefill,rollbackState,commitPendingDeletions,saveStateToMessage,getMemoryState,clearUpdatedTables}from'./core/table-system/manager.js';import{fillWithSecondaryApi}from'./core/table-system/secondary-filler.js';import{renderTables}from'./ui/table-bindings.js';import{log}from'./core/table-system/logger.js';import{eventSource,event_types,saveSettingsDebounced}from'/script.js';import{checkForUpdates,fetchMessageBoardContent}from'./core/api.js';import{setUpdateInfo,applyUpdateIndicator}from'./ui/state.js';import{pluginVersion,extensionName,defaultSettings}from'./utils/settings.js';import{tableSystemDefaultSettings}from'./core/table-system/settings.js';import{extension_settings}from'/scripts/extensions.js';import{manageLorebookEntriesForChat}from'./core/lore.js';import{initializeCharacterWorldBook}from'./CharacterWorldBook/cwb_index.js';import{cwbDefaultSettings}from'./CharacterWorldBook/src/cwb_config.js';import{bindGlossaryEvents}from'./glossary/GT_bindings.js';import'./core/amily2-updater.js';import{updateOrInsertTableInChat,startContinuousRendering,stopContinuousRendering}from'./ui/message-table-renderer.js';function _0x2a67(){const _0x1a166a=['plotOpt_enabled','hanlinyuan.css','11887101zssoTH','setChatMessage','startsWith','createElement','preOptimizationTextUpdated','postMessage','0\x200\x205px\x20rgba(200,\x20200,\x20255,\x200.3)','[Amily2号-开国大典]\x20步骤六：智能冲突检测与注入策略...','无效的JSON格式。','[Amily2号]\x20部署失败：等待\x20','avatar','GENERATION_AFTER_COMMANDS','#sys-settings-button','/assets/','[Amily2-在线统计]\x20连接断开','[Amily2-剧情优化]\x20Skipping\x20due\x20to\x20conditions:','[Amily2号-开国大典]\x20角色世界书已成功构建并融入帝国。','<i\x20class=\x22fas\x20fa-users\x22\x20style=\x22color:\x20#4caf50;\x20font-size:\x2012px;\x20vertical-align:\x20middle;\x20margin-right:\x206px;\x22></i><span\x20id=\x22amily2-online-count\x22\x20style=\x22vertical-align:\x20middle;\x20font-weight:\x20bold;\x22>Connecting...</span>','message_id','CHAT_CHANGED','操作成功','主题已成功导入并应用！','[Amily2号-开国大典]\x20步骤五：初始化RAG处理器...','!!!【术语表事件绑定失败】:\x20等待面板\x20#amily2_glossary_panel\x20超时。','1896996uNMrSg','bold','message','[Amily2-剧情优化]\x20优化已启用，但Jqyh\x20API已禁用且主页API未配置。','rgba(0,\x200,\x200,\x200.3)\x20!important','[Amily2号-开国大典]\x20上下文优化器注册失败:','tavernProfile','8wfsLzg','OPEN','appendChild','[Amily2号-开国大典]\x20密折司加载失败:','amily2_custom_styles','amily2-iframe','!!!【角色世界书构建失败】:','super-memory.css','【Amily2号-情报部】捷报！发现新版本:\x20','剧情优化已完成并注入。','dispatchEvent','【监察系统】检测到“朝代更迭”(CHAT_CHANGED)，开始重修史书并刷新宫殿...','amily2-export-theme-btn','iframe-renderer.css','导入失败：','optimized','map','\x22\x20被点击','10px\x205px\x20!important','[Amily2-剧情优化]\x20优化流程已被用户中止。发送原始消息。','createObjectURL','严重错误','bookName','9303742rkeqCw','[Amily2号-版本系统]\x20正在启动版本检测器...','amily2-style-','rgba(172,\x20216,\x20255,\x200.25)','trim','rgba(172,\x20216,\x20255,\x200.1)','style.css','application/json','[Amily2-在线统计]\x20解析消息失败:','10px','Amily2-Theme-','text','split','onopen','【监察系统】检测到消息\x20','deleteChatMessages','amily2HanlinyuanInjector','amily2-glossary.css','【监察系统】检测到消息滑动\x20(SWIPED)，开始执行状态回退...','#9e8aff','input','【监察系统】滑动后填表完成，UI\x20已刷新。','MESSAGE_DELETED','/CharacterWorldBook/cwb_style.css?v=','title','getLastMessageId','[Amily2-API]\x20setChatMessage\x20收到参数:','1px\x20solid\x20#79b8ff','parse','addEventListener','1355297aocGas','rgba(144,\x20238,\x20144,\x200.3)','triggerSlash','\x20被删除，开始精确回滚UI状态。','[Amily2号-开国大典]\x20步骤二：皇家仪仗队就位...','index','historiography.css','main-api','rgba(0,0,0,0.2)','[Amily2-核心引擎]\x20已成功注册表格占位符宏:\x20{{Amily2EditContent}}','1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.2)','[Amily2号-版本系统]\x20版本检测器未找到，可能加载失败','GENERATION_STARTED','userCharacter','[Amily2-主窗口]\x20收到来自iframe的动作:\x20','4983610oRfjSi','source','file','2260725TmGLZD','[Amily2号-开国大典]\x20步骤0：优先注册上下文优化器...','[Amily2号-开国大典]\x20密折司模块已就位。','removeChild','[Amily2号-开国大典]\x20步骤四：部署帝国哨兵网络...','--am2-','hanlinyuanRagProcessor','options','.json','command','vectors_rearrangeChat','Amily2插件错误:\x20','html','race','swipes','1px\x20solid\x20#ffc107','length','initialize','version','AMILY2_MACRO_REPLACED','getPropertyValue','includes','setProperty','未知错误','showToast','<div\x20id=\x22amily2-online-tracker\x22\x20style=\x22text-align:\x20center;\x20padding:\x208px;\x20font-size:\x2013px;\x20color:\x20rgba(255,255,255,0.7);\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20margin-bottom:\x2010px;\x20background:\x20rgba(0,0,0,0.1);\x20border-radius:\x205px;\x22></div>','warn','now','[Amily2号-开国大典]\x20术语表事件已成功绑定。','cwb-feature-style','[Amily2-剧情优化]\x20Generation\x20after\x20commands\x20triggered','[Amily2-剧情优化]\x20处理发送前事件时出错:','characters','keys','rgba(255,\x20255,\x20255,\x200.1)','#send_textarea','avatars','8UOIdMb','setChatMessages','[Amily2号-皇家制衣局]\x20已为世界编辑器披上华服:\x20WorldEditor.css','sendMessage','accept','log','【监察系统】分步/优化模式，回退后强制二次填表最新消息。','[Amily2-策略]\x20采用“完全主导”策略，覆盖\x20`vectors_rearrangeChat`。','head','removeProperty','isXiaobaixEnabled','entries','[Amily2-核心引擎]\x20无法注册表格宏，可能是\x20SillyTavern\x20版本不兼容。','link','#amily2-online-tracker','[Amily2-核心引擎]\x20注册表格宏时发生错误:','info','#amily2-online-count','#amily2-cancel-optimization-btn','chat_updated','secondary-api','MESSAGE_RECEIVED','online_count','toISOString','[Amily2号-开国大典]\x20步骤3.8：注册表格占位符宏...','8px\x205px','error','messages','style','target','1.1em','stylesheet','amily2-host','amily2-reset-theme-btn','12px','2ODrWIe','createLorebookEntries','table.css','剧情优化处理失败。','trigger','【Amily2号-情报部】一切安好，帝国已是最新版本。情报已转交内务府备案。','function','40px','amily2-import-theme-btn','./MiZheSi/index.js','[Amily2-核心引擎]\x20执行内置RAG注入。','按钮\x20\x22','rel','onclose','onchange','wss://amilyservice.amily49.cc','[Amily2号-开国大典]\x20步骤3.5：侦测到角色世界书停泊位，开始构建...','close','warning','object','_comment','#e0e0e0','/characters/','readAsText','getAvatars','无法切换到开场白\x20','isCancelled','stack','getChatMessages','剧情优化','type','【Amily2号-内务府】获取留言板失败:','clear','[Amily2-内存储司]\x20表格注入失败:','[Amily2-主窗口]\x20已发送消息:\x20','[Amily2号-开国大典]\x20步骤三：开始召唤府邸...','rgba(255,\x20255,\x20172,\x200.1)','createChatMessages','setLorebookEntries','amily2_glossary_panel','is_user','【监察系统】滑动后最新消息是用户，跳过填表。','无法导出样式：找不到根元素。','getLorebooks','display','[Amily2号-开国大典]\x20步骤一：为宫殿披上华服...','val','【凤凰阁】内联主题系统已通过延迟加载成功初始化并绑定事件。','\x20超时。','ST-Amily2-Chat-Optimisation','/WorldEditor/WorldEditor.css?v=','none','[Amily2-核心引擎]\x20开始执行统一注入\x20(聊天长度:','scripts/extensions/third-party/','slice','IMPERSONATE_READY','rgba(255,\x20255,\x20172,\x200.25)','regenerate','[Amily2号-帝国枢密院]\x20开始执行开国大典...','getLorebookEntries','readyState','#amily2_memorisation_forms_panel','download','[Amily2-主窗口]\x20未知的动作类型:\x20','ids','#amily2_message_board','rearrangeChat','已切换至开场白\x20','renderer.css','href','chat','lastPreOptimizationResult','text/css','2992945hDtdsG','[Amily2-全局卫队]\x20捕获到严重错误:','#amily2_drawer_content','onerror','prepend','操作取消','getElementById','5px','。情报已转交内务府。','contentToAppend','registerMacro','#dfdff0','max','toastr','body','#amily2_message_content','success','[Amily2-翰林院]\x20RAG处理器初始化失败:','buttonClick','[Amily2-在线统计]\x20开始建立连接...','#amily2_character_world_book_panel','11MnVTtc','amily2Updater','!!!【角色世界书构建失败】:\x20等待面板\x20#amily2_character_world_book_panel\x20超时。','click','show','Optimization\x20cancelled\x20by\x20user','6px\x208px','data','【凤凰阁】内联主题系统初始化失败:\x20','isArray','getCharLorebooks','createLorebook','#send_but','switchSwipe','render_on_every_message','rgba(0,0,0,0.1)','[Amily2号-皇家制衣局]\x20已为帝国披上华服:\x20'];_0x2a67=function(){return _0x1a166a;};return _0x2a67();}import{initializeRenderer}from'./core/tavern-helper/renderer.js';import{initializeApiListener,registerApiHandler,amilyHelper,initializeAmilyHelper}from'./core/tavern-helper/main.js';import{registerContextOptimizerMacros,resetContextBuffer}from'./core/context-optimizer.js';import{initializeSuperMemory}from'./core/super-memory/manager.js';function _0x2780(_0x1ac417,_0x1f9a71){_0x1ac417=_0x1ac417-0xba;const _0x2a6767=_0x2a67();let _0x278082=_0x2a6767[_0x1ac417];return _0x278082;}const STYLE_SETTINGS_KEY=_0x2b61df(0x18b),STYLE_ROOT_SELECTOR=_0x2b61df(0x134);let styleRoot=null;function getStyleRoot(){return!styleRoot&&(styleRoot=document['querySelector'](STYLE_ROOT_SELECTOR)),styleRoot;}function applyStyles(_0x5774ef){const _0x1086ab=_0x2b61df,_0x42b145=getStyleRoot();if(!_0x42b145||!_0x5774ef)return;delete _0x5774ef[_0x1086ab(0x10b)];for(const [_0xd5007a,_0x2c948c]of Object['entries'](_0x5774ef)){_0xd5007a[_0x1086ab(0x16a)](_0x1086ab(0x1d3))&&_0x42b145[_0x1086ab(0xf0)][_0x1086ab(0xc5)](_0xd5007a,_0x2c948c);}}function loadAndApplyStyles(){const _0x25b43c=_0x2b61df,_0x3b889f=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];_0x3b889f&&typeof _0x3b889f===_0x25b43c(0x10a)&&Object[_0x25b43c(0xd0)](_0x3b889f)[_0x25b43c(0xbf)]>0x0&&applyStyles(_0x3b889f);}function saveStyles(_0x35090b){!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][STYLE_SETTINGS_KEY]=_0x35090b,saveSettingsDebounced();}function resetToDefaultStyles(){const _0x107b5a=_0x2b61df,_0x8fd4c9=getStyleRoot();if(!_0x8fd4c9)return;const _0x342b2a=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];if(_0x342b2a&&typeof _0x342b2a===_0x107b5a(0x10a))for(const _0x4ed83f of Object[_0x107b5a(0xd0)](_0x342b2a)){_0x4ed83f[_0x107b5a(0x16a)](_0x107b5a(0x1d3))&&_0x8fd4c9[_0x107b5a(0xf0)][_0x107b5a(0xdd)](_0x4ed83f);}saveStyles(null),toastr[_0x107b5a(0x150)]('已恢复默认界面样式。');}function getDefaultCssVars(){const _0x4f8a30=_0x2b61df;return{'--am2-font-size-base':'14px','--am2-gap-main':'10px','--am2-padding-main':_0x4f8a30(0xed),'--am2-container-bg':_0x4f8a30(0x164),'--am2-container-border':_0x4f8a30(0x1c6),'--am2-container-border-radius':_0x4f8a30(0xf6),'--am2-container-padding':'10px','--am2-container-shadow':'inset\x200\x200\x2015px\x20rgba(0,0,0,0.2)','--am2-title-font-size':_0x4f8a30(0xf2),'--am2-title-font-weight':_0x4f8a30(0x181),'--am2-title-text-shadow':_0x4f8a30(0x16e),'--am2-title-gradient-start':'#c0bde4','--am2-title-gradient-end':_0x4f8a30(0x14b),'--am2-title-icon-color':_0x4f8a30(0x1b1),'--am2-title-icon-margin':_0x4f8a30(0x1a7),'--am2-table-bg':_0x4f8a30(0x1c4),'--am2-table-border':'1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.25)','--am2-table-cell-padding':_0x4f8a30(0x15b),'--am2-table-cell-font-size':'0.95em','--am2-header-bg':_0x4f8a30(0xd1),'--am2-header-color':_0x4f8a30(0x10c),'--am2-header-editable-bg':_0x4f8a30(0x1a3),'--am2-header-editable-focus-bg':_0x4f8a30(0x1a1),'--am2-header-editable-focus-outline':_0x4f8a30(0x1b9),'--am2-cell-editable-bg':_0x4f8a30(0x11b),'--am2-cell-editable-focus-bg':_0x4f8a30(0x12f),'--am2-cell-editable-focus-outline':_0x4f8a30(0xbe),'--am2-index-col-bg':_0x4f8a30(0x184),'--am2-index-col-color':'#aaa\x20!important','--am2-index-col-width':_0x4f8a30(0xfe),'--am2-index-col-padding':_0x4f8a30(0x199),'--am2-controls-gap':_0x4f8a30(0x147),'--am2-controls-margin-bottom':'10px','--am2-cell-highlight-bg':_0x4f8a30(0x1bd)};}function exportStyles(){const _0x5e1ea6=_0x2b61df,_0x42ed46=getStyleRoot();if(!_0x42ed46){toastr[_0x5e1ea6(0xee)](_0x5e1ea6(0x121));return;}const _0x162620=getComputedStyle(_0x42ed46),_0x231a7d={},_0x476557=getDefaultCssVars();for(const _0xf9d9de of Object[_0x5e1ea6(0xd0)](_0x476557)){_0x231a7d[_0xf9d9de]=_0x162620[_0x5e1ea6(0xc3)](_0xf9d9de)[_0x5e1ea6(0x1a2)]();}const _0x24b955=new Blob([JSON['stringify'](_0x231a7d,null,0x2)],{'type':_0x5e1ea6(0x1a5)}),_0x5d97c4=URL[_0x5e1ea6(0x19b)](_0x24b955),_0x397f38=document[_0x5e1ea6(0x16b)]('a');_0x397f38[_0x5e1ea6(0x13c)]=_0x5d97c4,_0x397f38[_0x5e1ea6(0x135)]=_0x5e1ea6(0x1a8)+new Date()[_0x5e1ea6(0xeb)]()['slice'](0x0,0xa)+'.json',document[_0x5e1ea6(0x14e)][_0x5e1ea6(0x189)](_0x397f38),_0x397f38[_0x5e1ea6(0x158)](),document[_0x5e1ea6(0x14e)]['removeChild'](_0x397f38),URL['revokeObjectURL'](_0x5d97c4),toastr['success']('主题文件已开始下载。','导出成功');}function importStyles(){const _0x355cf0=_0x2b61df,_0x5b50ac=document['createElement'](_0x355cf0(0x1b2));_0x5b50ac[_0x355cf0(0x115)]=_0x355cf0(0x1cd),_0x5b50ac[_0x355cf0(0xd8)]=_0x355cf0(0x1d6),_0x5b50ac['style'][_0x355cf0(0x123)]=_0x355cf0(0x12a);const _0x3b5ec7=()=>{const _0xed1038=_0x355cf0;document[_0xed1038(0x14e)]['contains'](_0x5b50ac)&&document[_0xed1038(0x14e)][_0xed1038(0x1d1)](_0x5b50ac);};_0x5b50ac[_0x355cf0(0x105)]=_0x5cc7ba=>{const _0x16d008=_0x355cf0,_0x16458c=_0x5cc7ba[_0x16d008(0xf1)]['files'][0x0];if(!_0x16458c){_0x3b5ec7();return;}const _0x262a3b=new FileReader();_0x262a3b['onload']=_0x4eb7e0=>{const _0x1b2f16=_0x16d008;try{const _0x3840b9=JSON[_0x1b2f16(0x1ba)](_0x4eb7e0[_0x1b2f16(0xf1)]['result']);if(typeof _0x3840b9!=='object'||Array[_0x1b2f16(0x15e)](_0x3840b9))throw new Error(_0x1b2f16(0x170));applyStyles(_0x3840b9),saveStyles(_0x3840b9),toastr[_0x1b2f16(0x150)](_0x1b2f16(0x17d));}catch(_0x1514e1){toastr[_0x1b2f16(0xee)](_0x1b2f16(0x195)+_0x1514e1[_0x1b2f16(0x182)],'错误');}finally{_0x3b5ec7();}},_0x262a3b[_0x16d008(0x10e)](_0x16458c);},document['body'][_0x355cf0(0x189)](_0x5b50ac),_0x5b50ac[_0x355cf0(0x158)]();}function compareVersions(_0x3408ea,_0x115a19){const _0x5c17c4=_0x2b61df,_0x1405b9=_0x3408ea['split']('.')[_0x5c17c4(0x197)](Number),_0x1dd4f2=_0x115a19[_0x5c17c4(0x1aa)]('.')[_0x5c17c4(0x197)](Number),_0x5407f4=Math[_0x5c17c4(0x14c)](_0x1405b9['length'],_0x1dd4f2['length']);for(let _0x2df6d2=0x0;_0x2df6d2<_0x5407f4;_0x2df6d2++){const _0x26d983=_0x1405b9[_0x2df6d2]||0x0,_0x2dcee3=_0x1dd4f2[_0x2df6d2]||0x0;if(_0x26d983>_0x2dcee3)return!![];if(_0x26d983<_0x2dcee3)return![];}return![];}async function handleUpdateCheck(){const _0x7f726=_0x2b61df;console[_0x7f726(0xd9)]('【Amily2号】帝国已就绪，现派遣外交官，为陛下探查外界新情报...');const _0x30d6f0=await checkForUpdates();if(_0x30d6f0&&_0x30d6f0[_0x7f726(0xc1)]){const _0x444a3f=compareVersions(_0x30d6f0['version'],pluginVersion);_0x444a3f?console[_0x7f726(0xd9)](_0x7f726(0x18f)+_0x30d6f0[_0x7f726(0xc1)]+_0x7f726(0x148)):console[_0x7f726(0xd9)](_0x7f726(0xfc)),setUpdateInfo(_0x444a3f,_0x30d6f0),applyUpdateIndicator();}}async function handleMessageBoard(){const _0x47b9a7=async()=>{const _0x2d0970=_0x2780;try{const _0x3174c2=await fetchMessageBoardContent();if(_0x3174c2&&_0x3174c2[_0x2d0970(0x182)]){const _0x26d5fd=$(_0x2d0970(0x138)),_0xf834e4=$(_0x2d0970(0x14f));_0xf834e4[_0x2d0970(0xbb)](_0x3174c2[_0x2d0970(0x182)]),_0x26d5fd[_0x2d0970(0x159)](),console[_0x2d0970(0xd9)]('【Amily2号-内务府】已成功获取并展示来自陛下的最新圣谕。');}}catch(_0x13030b){console[_0x2d0970(0xee)](_0x2d0970(0x116),_0x13030b);}};await _0x47b9a7(),setInterval(_0x47b9a7,0x493e0);}function loadPluginStyles(){const _0x1cbd46=_0x2b61df,_0x1dab24=_0xd4ebbe=>{const _0x1d8378=_0x2780,_0xf149e5=_0x1d8378(0x1a0)+_0xd4ebbe[_0x1d8378(0x1aa)]('.')[0x0];if(document[_0x1d8378(0x146)](_0xf149e5))return;const _0x1e2164=_0x1d8378(0x12c)+extensionName+_0x1d8378(0x175)+_0xd4ebbe+'?v='+Date['now'](),_0x99780=document[_0x1d8378(0x16b)](_0x1d8378(0xe1));_0x99780['id']=_0xf149e5,_0x99780[_0x1d8378(0x103)]='stylesheet',_0x99780[_0x1d8378(0x115)]=_0x1d8378(0x13f),_0x99780['href']=_0x1e2164,document[_0x1d8378(0xdc)][_0x1d8378(0x189)](_0x99780),console[_0x1d8378(0xd9)](_0x1d8378(0x165)+_0xd4ebbe);};_0x1dab24(_0x1cbd46(0x1a4)),_0x1dab24(_0x1cbd46(0x1c2)),_0x1dab24(_0x1cbd46(0x167)),_0x1dab24(_0x1cbd46(0x1af)),_0x1dab24(_0x1cbd46(0xf9)),_0x1dab24('optimization.css'),_0x1dab24(_0x1cbd46(0x13b)),_0x1dab24(_0x1cbd46(0x194)),_0x1dab24(_0x1cbd46(0x18e));const _0x17b93e=_0x1cbd46(0xcc);if(!document[_0x1cbd46(0x146)](_0x17b93e)){const _0x30f28a=document[_0x1cbd46(0x16b)](_0x1cbd46(0xe1));_0x30f28a['id']=_0x17b93e,_0x30f28a[_0x1cbd46(0x103)]=_0x1cbd46(0xf3),_0x30f28a['type']=_0x1cbd46(0x13f),_0x30f28a[_0x1cbd46(0x13c)]='scripts/extensions/third-party/'+extensionName+_0x1cbd46(0x1b5)+Date[_0x1cbd46(0xca)](),document['head'][_0x1cbd46(0x189)](_0x30f28a),console['log']('[Amily2号-皇家制衣局]\x20已为角色世界书披上华服:\x20cwb_style.css');}const _0x801707='world-editor-style';if(!document['getElementById'](_0x801707)){const _0x248b03=document['createElement'](_0x1cbd46(0xe1));_0x248b03['id']=_0x801707,_0x248b03[_0x1cbd46(0x103)]=_0x1cbd46(0xf3),_0x248b03[_0x1cbd46(0x115)]=_0x1cbd46(0x13f),_0x248b03[_0x1cbd46(0x13c)]=_0x1cbd46(0x12c)+extensionName+_0x1cbd46(0x129)+Date['now'](),document[_0x1cbd46(0xdc)][_0x1cbd46(0x189)](_0x248b03),console[_0x1cbd46(0xd9)](_0x1cbd46(0xd6));}}window['addEventListener'](_0x2b61df(0x182),function(_0x4fb208){const _0x3eaa40=_0x2b61df;if(_0x4fb208['data']&&_0x4fb208[_0x3eaa40(0x15c)][_0x3eaa40(0x115)]===_0x3eaa40(0x10f)){if(window[_0x3eaa40(0xde)])return;const _0x1d50c9=_0x3eaa40(0x10d)+(getContext()[_0x3eaa40(0x1c9)]?.['avatar']??''),_0x507367='/characters/'+(getContext()[_0x3eaa40(0xcf)][this_chid]?.[_0x3eaa40(0x172)]??'');_0x4fb208[_0x3eaa40(0x1cc)][_0x3eaa40(0x16d)]({'source':_0x3eaa40(0xf4),'type':_0x3eaa40(0xd3),'urls':{'user':_0x1d50c9,'char':_0x507367}},'*');return;}if(_0x4fb208['data']&&_0x4fb208[_0x3eaa40(0x15c)][_0x3eaa40(0x1cc)]===_0x3eaa40(0x18c)){const {action:_0x5de7be,detail:_0x455d76}=_0x4fb208[_0x3eaa40(0x15c)];console[_0x3eaa40(0xd9)](_0x3eaa40(0x1ca)+_0x5de7be,_0x455d76);switch(_0x5de7be){case _0x3eaa40(0xd7):_0x455d76&&_0x455d76[_0x3eaa40(0x182)]&&($('#send_textarea')['val'](_0x455d76['message'])[_0x3eaa40(0xfb)](_0x3eaa40(0x1b2)),$(_0x3eaa40(0x161))[_0x3eaa40(0xfb)](_0x3eaa40(0x158)),console['log'](_0x3eaa40(0x119)+_0x455d76[_0x3eaa40(0x182)]));break;case _0x3eaa40(0xc7):if(_0x455d76&&_0x455d76[_0x3eaa40(0x182)]&&window[_0x3eaa40(0x14d)]){const _0x4927c0=_0x455d76['type']||'info';typeof window[_0x3eaa40(0x14d)][_0x4927c0]==='function'&&window[_0x3eaa40(0x14d)][_0x4927c0](_0x455d76[_0x3eaa40(0x182)],_0x455d76[_0x3eaa40(0x1b6)]||'通知');}break;case _0x3eaa40(0x152):console[_0x3eaa40(0xd9)]('[Amily2-主窗口]\x20按钮被点击:',_0x455d76);window[_0x3eaa40(0x14d)]&&window[_0x3eaa40(0x14d)][_0x3eaa40(0xe4)](_0x3eaa40(0x102)+(_0x455d76['buttonId']||'未知')+_0x3eaa40(0x198),'iframe交互');break;default:console[_0x3eaa40(0xc9)](_0x3eaa40(0x136)+_0x5de7be);}}}),window['addEventListener']('error',_0x290bbb=>{const _0x6ad467=_0x2b61df,_0x156e11=_0x290bbb[_0x6ad467(0xee)]?.[_0x6ad467(0x112)]||'';_0x156e11[_0x6ad467(0xc4)](_0x6ad467(0x128))&&(console[_0x6ad467(0xee)](_0x6ad467(0x141),_0x290bbb[_0x6ad467(0xee)]),toastr['error'](_0x6ad467(0xba)+(_0x290bbb[_0x6ad467(0xee)]?.[_0x6ad467(0x182)]||_0x6ad467(0xc6)),_0x6ad467(0x19c),{'timeOut':0x2710}));}),jQuery(async()=>{const _0x4c2e71=_0x2b61df;console[_0x4c2e71(0xd9)](_0x4c2e71(0x131));try{console[_0x4c2e71(0xd9)](_0x4c2e71(0x1cf)),registerContextOptimizerMacros();}catch(_0x452703){console['error'](_0x4c2e71(0x185),_0x452703);}try{await import(_0x4c2e71(0x100)),console['log'](_0x4c2e71(0x1d0));}catch(_0x5c7d0e){console['error'](_0x4c2e71(0x18a),_0x5c7d0e);}initializeApiListener(),registerApiHandler('getChatMessages',async _0x11c59c=>{const _0x38621f=_0x4c2e71;return amilyHelper[_0x38621f(0x113)](_0x11c59c['range'],_0x11c59c['options']);}),registerApiHandler(_0x4c2e71(0xd5),async _0x2f9756=>{const _0xe4d6f2=_0x4c2e71;return await amilyHelper[_0xe4d6f2(0xd5)](_0x2f9756[_0xe4d6f2(0xef)],_0x2f9756[_0xe4d6f2(0x1d5)]);}),registerApiHandler(_0x4c2e71(0x169),async _0x201090=>{const _0x44f519=_0x4c2e71,_0x2ed1ab=_0x201090['field_values']||_0x201090['content'],_0x17520f=_0x201090['message_id']!==undefined?_0x201090[_0x44f519(0x17a)]:_0x201090[_0x44f519(0x1c1)],_0x49e6ec=_0x201090[_0x44f519(0x1d5)]||{};return console[_0x44f519(0xd9)](_0x44f519(0x1b8),{'field_values':_0x2ed1ab,'message_id':_0x17520f,'options':_0x49e6ec,'raw_data':_0x201090}),await amilyHelper[_0x44f519(0x169)](_0x2ed1ab,_0x17520f,_0x49e6ec);}),registerApiHandler(_0x4c2e71(0x11c),async _0x20d516=>{const _0x118e05=_0x4c2e71;return await amilyHelper['createChatMessages'](_0x20d516[_0x118e05(0xef)],_0x20d516[_0x118e05(0x1d5)]);}),registerApiHandler('deleteChatMessages',async _0x185490=>{const _0x1e8c16=_0x4c2e71;return await amilyHelper[_0x1e8c16(0x1ad)](_0x185490[_0x1e8c16(0x137)],_0x185490[_0x1e8c16(0x1d5)]);}),registerApiHandler(_0x4c2e71(0x122),async _0x502f0f=>{return await amilyHelper['getLorebooks']();}),registerApiHandler(_0x4c2e71(0x15f),async _0x59dc3b=>{const _0x3cf25d=_0x4c2e71;return await amilyHelper['getCharLorebooks'](_0x59dc3b[_0x3cf25d(0x1d5)]);}),registerApiHandler(_0x4c2e71(0x132),async _0x15d3a8=>{const _0x56e34c=_0x4c2e71;return await amilyHelper[_0x56e34c(0x132)](_0x15d3a8[_0x56e34c(0x19d)]);}),registerApiHandler(_0x4c2e71(0x11d),async _0x360d24=>{const _0x127aec=_0x4c2e71;return await amilyHelper['setLorebookEntries'](_0x360d24[_0x127aec(0x19d)],_0x360d24[_0x127aec(0xdf)]);}),registerApiHandler(_0x4c2e71(0xf8),async _0x3ad0a9=>{return await amilyHelper['createLorebookEntries'](_0x3ad0a9['bookName'],_0x3ad0a9['entries']);}),registerApiHandler('createLorebook',async _0x33fce8=>{const _0x4c29ea=_0x4c2e71;return await amilyHelper[_0x4c29ea(0x160)](_0x33fce8['bookName']);}),registerApiHandler(_0x4c2e71(0x1be),async _0x14a12d=>{const _0x5cd8ad=_0x4c2e71;return await amilyHelper[_0x5cd8ad(0x1be)](_0x14a12d[_0x5cd8ad(0x1d7)]);}),registerApiHandler(_0x4c2e71(0x1b7),async _0xc53b05=>{const _0x4fdc2b=_0x4c2e71;return amilyHelper[_0x4fdc2b(0x1b7)]();}),registerApiHandler(_0x4c2e71(0x14d),async _0x3f35f5=>{const _0x275f3e=_0x4c2e71;return window[_0x275f3e(0x14d)]&&typeof window[_0x275f3e(0x14d)][_0x3f35f5[_0x275f3e(0x115)]]===_0x275f3e(0xfd)&&window[_0x275f3e(0x14d)][_0x3f35f5['type']](_0x3f35f5[_0x275f3e(0x182)],_0x3f35f5['title']),!![];}),registerApiHandler(_0x4c2e71(0x162),async _0x21795e=>{const _0x4b4156=_0x4c2e71,{messageIndex:_0x14d670,swipeIndex:_0x5b088b}=_0x21795e,_0x324cb4=await amilyHelper[_0x4b4156(0x113)](_0x14d670,{'include_swipes':!![]});if(_0x324cb4&&_0x324cb4[_0x4b4156(0xbf)]>0x0&&_0x324cb4[0x0][_0x4b4156(0xbd)]){const _0x16070d=_0x324cb4[0x0][_0x4b4156(0xbd)][_0x5b088b];if(_0x16070d!==undefined){await amilyHelper[_0x4b4156(0xd5)]([{'message_id':_0x14d670,'message':_0x16070d}],{'refresh':'affected'});const _0x578c54=getContext();return _0x578c54[_0x4b4156(0x13d)][_0x14d670]&&(_0x578c54[_0x4b4156(0x13d)][_0x14d670]['swipe_id']=_0x5b088b),{'success':!![],'message':_0x4b4156(0x13a)+_0x5b088b};}}throw new Error(_0x4b4156(0x110)+_0x5b088b);}),initializeAmilyHelper(),console[_0x4c2e71(0xd9)](_0x4c2e71(0x131));!extension_settings[extensionName]&&(extension_settings[extensionName]={});const _0x311726={...defaultSettings,...tableSystemDefaultSettings,...cwbDefaultSettings,'render_on_every_message':![],'amily_render_enabled':![]};for(const _0xf9dbc3 in _0x311726){extension_settings[extensionName][_0xf9dbc3]===undefined&&(extension_settings[extensionName][_0xf9dbc3]=_0x311726[_0xf9dbc3]);}console[_0x4c2e71(0xd9)]('[Amily2号-帝国枢密院]\x20帝国基本法已确认，档案室已与国库对接完毕。');let _0x25da9b=0x0;const _0x3a1fab=0x64,_0x2fafab=0x64,_0x27dd95=_0x4c2e71(0x174),_0x464ba7=setInterval(async()=>{const _0x5b44db=_0x4c2e71;if($(_0x27dd95)[_0x5b44db(0xbf)]>0x0){clearInterval(_0x464ba7),console[_0x5b44db(0xd9)]('[Amily2号-帝国枢密院]\x20SillyTavern宫殿主体已确认，开国大典正式开始！');try{console['log'](_0x5b44db(0x124)),loadPluginStyles(),console[_0x5b44db(0xd9)](_0x5b44db(0x1c0)),await registerSlashCommands(),console[_0x5b44db(0xd9)](_0x5b44db(0x11a)),createDrawer();function _0x448c62(){let _0x439e2a=0x0;const _0x517bec=0x32,_0x45ed22=0x64,_0x38a9cc=setInterval(()=>{const _0x4df800=_0x2780,_0x57226f=document[_0x4df800(0x146)](_0x4df800(0x11e));if(_0x57226f){clearInterval(_0x38a9cc);try{console['log']('[Amily2号-开国大典]\x20步骤3.6：侦测到术语表停泊位，开始绑定事件...'),bindGlossaryEvents(),console[_0x4df800(0xd9)](_0x4df800(0xcb));}catch(_0x25386d){console[_0x4df800(0xee)]('!!!【术语表事件绑定失败】:',_0x25386d);}}else _0x439e2a++,_0x439e2a>=_0x517bec&&(clearInterval(_0x38a9cc),console[_0x4df800(0xee)](_0x4df800(0x17f)));},_0x45ed22);}_0x448c62();function _0x31c344(){let _0x51156a=0x0;const _0x361536=0x32,_0xe64df5=0x64,_0x1f3022=setInterval(async()=>{const _0x9e8a26=_0x2780,_0x172848=$(_0x9e8a26(0x154));if(_0x172848[_0x9e8a26(0xbf)]>0x0){clearInterval(_0x1f3022);try{console[_0x9e8a26(0xd9)](_0x9e8a26(0x107)),await initializeCharacterWorldBook(_0x172848),console['log'](_0x9e8a26(0x178));}catch(_0x5d25ef){console[_0x9e8a26(0xee)](_0x9e8a26(0x18d),_0x5d25ef);}}else _0x51156a++,_0x51156a>=_0x361536&&(clearInterval(_0x1f3022),console[_0x9e8a26(0xee)](_0x9e8a26(0x157)));},_0xe64df5);}_0x31c344(),console['log'](_0x5b44db(0xec));try{eventSource['on'](event_types[_0x5b44db(0x1c8)],()=>{resetContextBuffer();});const _0x80a4a5=getContext();_0x80a4a5&&typeof _0x80a4a5[_0x5b44db(0x14a)]==='function'?(_0x80a4a5[_0x5b44db(0x14a)]('Amily2EditContent',()=>{const _0x32cc81=_0x5b44db,_0x59eefa=generateTableContent();return _0x59eefa&&(window[_0x32cc81(0xc2)]=!![]),_0x59eefa;}),console[_0x5b44db(0xd9)](_0x5b44db(0x1c5))):console[_0x5b44db(0xc9)](_0x5b44db(0xe0));}catch(_0x17913a){console['error'](_0x5b44db(0xe3),_0x17913a);}console[_0x5b44db(0xd9)](_0x5b44db(0x1d2));let _0x1a0cbe=![];async function _0x4d3ff4(_0x4d9c7b,_0x36bb0c,_0x3dacfa){const _0x3232d4=_0x5b44db;clearUpdatedTables(),console[_0x3232d4(0xd9)](_0x3232d4(0xcd),{'type':_0x4d9c7b,'params':_0x36bb0c,'dryRun':_0x3dacfa,'isProcessing':_0x1a0cbe});if(_0x4d9c7b===_0x3232d4(0x130)||_0x1a0cbe||_0x3dacfa){console[_0x3232d4(0xd9)](_0x3232d4(0x177),{'type':_0x4d9c7b,'isProcessing':_0x1a0cbe,'dryRun':_0x3dacfa});return;}const _0x1a796d=extension_settings[extensionName];if(_0x1a796d?.[_0x3232d4(0x166)]===![])return;const _0x2827f9=_0x1a796d?.['jqyhEnabled']===!![],_0x37b17c=!!_0x1a796d?.['apiUrl']||!!_0x1a796d?.[_0x3232d4(0x186)];if(!_0x2827f9&&!_0x37b17c){console[_0x3232d4(0xd9)](_0x3232d4(0x183));return;}_0x1a0cbe=!![];let _0x72570e=null;const _0x158d76={'isCancelled':![]};try{const _0x144f48=$(_0x3232d4(0xd2))[_0x3232d4(0x125)]();if(!_0x144f48)return _0x1a0cbe=![],![];const _0xc57f1='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20正在进行剧情优化...\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22amily2-cancel-optimization-btn\x22\x20class=\x22menu_button\x20danger_button\x22\x20style=\x22margin-left:\x2010px;\x20padding:\x202px\x208px;\x20font-size:\x200.8em;\x22>中止</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20';let _0x3d188f;const _0x59764d=new Promise((_0x1c613a,_0x4f3cb0)=>{_0x3d188f=_0x4f3cb0;});_0x72570e=toastr[_0x3232d4(0xe4)](_0xc57f1,_0x3232d4(0x114),{'timeOut':0x0,'extendedTimeOut':0x0,'tapToDismiss':![],'onclick':null,'escapeHtml':![],'onShown':function(){const _0x55ca0e=_0x3232d4;$(_0x55ca0e(0xe6))['one'](_0x55ca0e(0x158),function(_0x4b3152){const _0x57b90f=_0x55ca0e;_0x4b3152['stopPropagation'](),_0x72570e&&(_0x72570e['remove'](),_0x72570e=null),_0x158d76[_0x57b90f(0x111)]=!![],_0x3d188f(new Error(_0x57b90f(0x15a)));});}});const _0x6dc67d=getContext(),_0xeee992=_0x1a796d['plotOpt_contextLimit']||0xa;let _0x3f511b=[];_0xeee992>0x0&&(_0x3f511b=_0x6dc67d[_0x3232d4(0x13d)][_0x3232d4(0x12d)](-_0xeee992));const _0x5492f5=processPlotOptimization({'mes':_0x144f48},_0x3f511b,_0x158d76),_0x373c95=await Promise[_0x3232d4(0xbc)]([_0x5492f5,_0x59764d]);if(_0x373c95&&_0x373c95[_0x3232d4(0x149)]){const _0x10ec47=$(_0x3232d4(0xd2))[_0x3232d4(0x125)](),_0x50f950=_0x10ec47+'\x0a'+_0x373c95[_0x3232d4(0x149)];$(_0x3232d4(0xd2))[_0x3232d4(0x125)](_0x50f950)[_0x3232d4(0xfb)](_0x3232d4(0x1b2)),toastr['success'](_0x3232d4(0x190),_0x3232d4(0x17c));}else console['log']('[Amily2-剧情优化]\x20Plot\x20optimization\x20returned\x20no\x20result.\x20Sending\x20original\x20message.');return![];}catch(_0x8653bc){return _0x8653bc[_0x3232d4(0x182)]===_0x3232d4(0x15a)?(console[_0x3232d4(0xd9)](_0x3232d4(0x19a)),toastr[_0x3232d4(0x109)]('剧情优化任务已中止...',_0x3232d4(0x145),{'timeOut':0x7d0})):(console[_0x3232d4(0xee)](_0x3232d4(0xce),_0x8653bc),toastr[_0x3232d4(0xee)](_0x3232d4(0xfa),'错误')),![];}finally{_0x1a0cbe=![],_0x72570e&&(toastr[_0x3232d4(0x117)](_0x72570e),_0x72570e=null);}}!window['amily2EventsRegistered']&&(eventSource['on'](event_types[_0x5b44db(0x173)],_0x4d3ff4),eventSource['on'](event_types[_0x5b44db(0xe9)],onMessageReceived),eventSource['on'](event_types[_0x5b44db(0x12e)],onMessageReceived),eventSource['on'](event_types['MESSAGE_RECEIVED'],_0x4d5a09=>handleTableUpdate(_0x4d5a09)),eventSource['on'](event_types['MESSAGE_SWIPED'],async _0x39c7b7=>{const _0x2b07bd=_0x5b44db,_0x15b9c9=getContext();if(_0x15b9c9[_0x2b07bd(0x13d)][_0x2b07bd(0xbf)]<0x2){log('【监察系统】检测到消息滑动，但聊天记录不足，已跳过状态回退。',_0x2b07bd(0xe4));return;}log(_0x2b07bd(0x1b0),_0x2b07bd(0xc9)),rollbackState();const _0x4cdf13=_0x15b9c9['chat'][_0x39c7b7]||_0x15b9c9[_0x2b07bd(0x13d)][_0x15b9c9[_0x2b07bd(0x13d)][_0x2b07bd(0xbf)]-0x1];if(_0x4cdf13[_0x2b07bd(0x11f)]){log(_0x2b07bd(0x120),_0x2b07bd(0xe4)),renderTables();return;}const _0x3a7816=extension_settings[extensionName],_0x2a33f2=_0x3a7816['filling_mode']||_0x2b07bd(0x1c3);if(_0x2a33f2===_0x2b07bd(0x1c3))log('【监察系统】主填表模式，回退后强制刷新消息ID:\x20'+_0x39c7b7+'。',_0x2b07bd(0xe4)),await handleTableUpdate(_0x39c7b7,!![]);else _0x2a33f2===_0x2b07bd(0xe8)||_0x2a33f2===_0x2b07bd(0x196)?(log(_0x2b07bd(0xda),_0x2b07bd(0xe4)),await fillWithSecondaryApi(_0x4cdf13,!![])):log('【监察系统】未配置填表模式，跳过填表。',_0x2b07bd(0xe4));renderTables(),log(_0x2b07bd(0x1b3),_0x2b07bd(0x150));}),eventSource['on'](event_types['MESSAGE_EDITED'],_0x593b96=>{handleTableUpdate(_0x593b96),updateOrInsertTableInChat();}),eventSource['on'](event_types[_0x5b44db(0x17b)],()=>{const _0x469ca1=_0x5b44db;window[_0x469ca1(0x13e)]=null,document[_0x469ca1(0x191)](new CustomEvent(_0x469ca1(0x16c))),manageLorebookEntriesForChat(),setTimeout(()=>{const _0x5628b2=_0x469ca1;log(_0x5628b2(0x192),_0x5628b2(0xe4)),clearHighlights(),clearUpdatedTables(),loadTables(),renderTables(),extension_settings[extensionName][_0x5628b2(0x163)]?startContinuousRendering():stopContinuousRendering();},0x64);}),eventSource['on'](event_types[_0x5b44db(0x1b4)],(_0x5990bd,_0x368b16)=>{const _0x42a694=_0x5b44db;log(_0x42a694(0x1ac)+_0x368b16+_0x42a694(0x1bf),_0x42a694(0xc9)),clearHighlights(),loadTables(_0x368b16),renderTables();}),eventSource['on'](event_types[_0x5b44db(0xe9)],updateOrInsertTableInChat),eventSource['on'](event_types[_0x5b44db(0xe7)],updateOrInsertTableInChat),window['amily2EventsRegistered']=!![]);console[_0x5b44db(0xd9)](_0x5b44db(0x17e));try{_0x2f6a1a(),console[_0x5b44db(0xd9)]('[Amily2-翰林院]\x20RAG处理器已成功初始化');}catch(_0x32fa69){console[_0x5b44db(0xee)](_0x5b44db(0x151),_0x32fa69);}console[_0x5b44db(0xd9)](_0x5b44db(0x16f));async function _0xe7e3fe(..._0x522d5a){const _0x465fee=_0x5b44db;console[_0x465fee(0xd9)](_0x465fee(0x12b),_0x522d5a[0x0]?.[_0x465fee(0xbf)]||0x0,')');try{await injectTableData(..._0x522d5a);}catch(_0x36fc2e){console['error'](_0x465fee(0x118),_0x36fc2e);}if(window['hanlinyuanRagProcessor']&&typeof window[_0x465fee(0x1d4)][_0x465fee(0x139)]===_0x465fee(0xfd))try{console[_0x465fee(0xd9)](_0x465fee(0x101)),await window[_0x465fee(0x1d4)]['rearrangeChat'](..._0x522d5a);}catch(_0x20aa72){console[_0x465fee(0xee)]('[Amily2-翰林院]\x20RAG注入失败:',_0x20aa72);}}console['log'](_0x5b44db(0xdb)),window[_0x5b44db(0x1d8)]=_0xe7e3fe,window[_0x5b44db(0x1ae)]&&(window[_0x5b44db(0x1ae)]=null),console[_0x5b44db(0xd9)]('【Amily2号】帝国秩序已完美建立。Amily2号的府邸已恭候陛下的莅临。'),console[_0x5b44db(0xd9)]('[Amily2号-开国大典]\x20步骤七：初始化版本显示系统...'),typeof window['amily2Updater']!=='undefined'?setTimeout(()=>{const _0x151f19=_0x5b44db;console['log'](_0x151f19(0x19f)),window[_0x151f19(0x156)][_0x151f19(0xc0)]();},0x7d0):console[_0x5b44db(0xc9)](_0x5b44db(0x1c7)),handleUpdateCheck(),handleMessageBoard(),initializeOnlineTracker(),setTimeout(()=>{initializeSuperMemory();},0xbb8),initializeRenderer(),extension_settings[extensionName][_0x5b44db(0x163)]&&startContinuousRendering(),setTimeout(()=>{const _0x7c0ca9=_0x5b44db;try{loadAndApplyStyles();const _0xcb5114=document[_0x7c0ca9(0x146)](_0x7c0ca9(0xff)),_0x2898a2=document[_0x7c0ca9(0x146)](_0x7c0ca9(0x193)),_0x9076ad=document[_0x7c0ca9(0x146)](_0x7c0ca9(0xf5));if(_0xcb5114)_0xcb5114[_0x7c0ca9(0x1bb)](_0x7c0ca9(0x158),importStyles);if(_0x2898a2)_0x2898a2[_0x7c0ca9(0x1bb)](_0x7c0ca9(0x158),exportStyles);if(_0x9076ad)_0x9076ad[_0x7c0ca9(0x1bb)](_0x7c0ca9(0x158),resetToDefaultStyles);log(_0x7c0ca9(0x126),_0x7c0ca9(0x150));}catch(_0x3fc35d){log(_0x7c0ca9(0x15d)+_0x3fc35d,_0x7c0ca9(0xee));}},0x1f4);}catch(_0x4b2813){console['error']('!!!【开国大典失败】在执行系列法令时发生严重错误:',_0x4b2813);}}else _0x25da9b++,_0x25da9b>=_0x3a1fab&&(clearInterval(_0x464ba7),console[_0x5b44db(0xee)](_0x5b44db(0x171)+_0x27dd95+_0x5b44db(0x127)));},_0x2fafab);});function initializeOnlineTracker(){const _0x3aac6a=_0x2b61df,_0x4e55f3=_0x3aac6a(0x106);let _0x570178=null,_0x42746b=null,_0x37d4d4=![];function _0x394f0e(){const _0x1817ac=_0x3aac6a,_0x1c4886=$(_0x1817ac(0x142));if(_0x1c4886[_0x1817ac(0xbf)]===0x0||!_0x1c4886[_0x1817ac(0x15c)]('initialized')){setTimeout(_0x394f0e,0x3e8);return;}if($(_0x1817ac(0xe2))[_0x1817ac(0xbf)]>0x0)return;const _0x313198=$(_0x1817ac(0xc8));_0x313198[_0x1817ac(0xbb)](_0x1817ac(0x179)),_0x1c4886[_0x1817ac(0x144)](_0x313198),_0x1beb48();}function _0x1beb48(){const _0x12620d=_0x3aac6a;if(_0x570178&&(_0x570178[_0x12620d(0x133)]===WebSocket['CONNECTING']||_0x570178[_0x12620d(0x133)]===WebSocket[_0x12620d(0x188)])){console[_0x12620d(0xd9)]('[Amily2-在线统计]\x20连接已存在，跳过创建');return;}if(_0x37d4d4)return;_0x37d4d4=!![];if(_0x570178){try{_0x570178[_0x12620d(0x108)]();}catch(_0x13935c){}_0x570178=null;}try{console[_0x12620d(0xd9)](_0x12620d(0x153)),_0x570178=new WebSocket(_0x4e55f3),_0x570178[_0x12620d(0x1ab)]=()=>{const _0x4ae573=_0x12620d;console[_0x4ae573(0xd9)]('[Amily2-在线统计]\x20已连接到服务器'),_0x37d4d4=![],_0x42746b&&(clearTimeout(_0x42746b),_0x42746b=null);},_0x570178['onmessage']=_0x32db37=>{const _0x4338ed=_0x12620d;try{const _0x278cd6=JSON[_0x4338ed(0x1ba)](_0x32db37[_0x4338ed(0x15c)]);_0x278cd6[_0x4338ed(0x115)]===_0x4338ed(0xea)&&$(_0x4338ed(0xe5))[_0x4338ed(0x1a9)](_0x278cd6['count']+'\x20人在线');}catch(_0x1fbaf0){console[_0x4338ed(0xee)](_0x4338ed(0x1a6),_0x1fbaf0);}},_0x570178[_0x12620d(0x104)]=()=>{const _0x3fe35a=_0x12620d;console[_0x3fe35a(0xd9)](_0x3fe35a(0x176)),$(_0x3fe35a(0xe5))[_0x3fe35a(0x1a9)]('离线'),_0x37d4d4=![],_0x570178=null,!_0x42746b&&(_0x42746b=setTimeout(()=>{_0x42746b=null,_0x1beb48();},0x1388));},_0x570178[_0x12620d(0x143)]=_0xe16114=>{const _0x4bd61f=_0x12620d;console[_0x4bd61f(0xc9)]('[Amily2-在线统计]\x20连接错误:',_0xe16114);};}catch(_0x4d9ae8){console[_0x12620d(0xee)]('[Amily2-在线统计]\x20初始化失败:',_0x4d9ae8),_0x37d4d4=![],!_0x42746b&&(_0x42746b=setTimeout(()=>{_0x42746b=null,_0x1beb48();},0x1388));}}_0x394f0e();}
