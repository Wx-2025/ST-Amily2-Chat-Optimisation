const _0x2b2b58=_0x10c0;(function(_0x193e06,_0x2b5b9b){const _0x115971=_0x10c0,_0x4d3d6b=_0x193e06();while(!![]){try{const _0x5383c7=parseInt(_0x115971(0x119))/0x1*(parseInt(_0x115971(0x159))/0x2)+parseInt(_0x115971(0x1d5))/0x3*(parseInt(_0x115971(0x134))/0x4)+parseInt(_0x115971(0x14b))/0x5+parseInt(_0x115971(0x147))/0x6+parseInt(_0x115971(0x186))/0x7*(parseInt(_0x115971(0x131))/0x8)+-parseInt(_0x115971(0x20e))/0x9+-parseInt(_0x115971(0x216))/0xa;if(_0x5383c7===_0x2b5b9b)break;else _0x4d3d6b['push'](_0x4d3d6b['shift']());}catch(_0x192083){_0x4d3d6b['push'](_0x4d3d6b['shift']());}}}(_0x25ca,0x18e5c));import{createDrawer}from'./ui/drawer.js';import'./PresetSettings/index.js';import'./PreOptimizationViewer/index.js';import'./WorldEditor/WorldEditor.js';import{registerSlashCommands}from'./core/commands.js';import{onMessageReceived,handleTableUpdate}from'./core/events.js';function _0x10c0(_0x2ad06c,_0x5d2480){const _0x25ca75=_0x25ca();return _0x10c0=function(_0x10c0c5,_0xb14043){_0x10c0c5=_0x10c0c5-0x115;let _0x2cd82d=_0x25ca75[_0x10c0c5];return _0x2cd82d;},_0x10c0(_0x2ad06c,_0x5d2480);}import{processPlotOptimization}from'./core/summarizer.js';import{getContext}from'/scripts/extensions.js';import{characters,this_chid}from'/script.js';function _0x25ca(){const _0xa000f8=['contentToAppend','iframe交互','主题文件已开始下载。','vectors_rearrangeChat','14913cBNKDQ','amily2HanlinyuanInjector','appendChild','5px','remove','ST-Amily2-Chat-Optimisation','affected','[Amily2号-帝国枢密院]\x20开始执行开国大典...','【监察系统】检测到消息滑动\x20(SWIPED)，开始执行状态回退...','amily2-iframe','GENERATION_STARTED','onchange','MESSAGE_DELETED','entries','[Amily2号]\x20部署失败：等待\x20','【Amily2号-情报部】捷报！发现新版本:\x20','tavernProfile','【监察系统】检测到消息滑动，但聊天记录不足，已跳过状态回退。','rgba(172,\x20216,\x20255,\x200.25)','bold','8px\x205px','style','avatar','按钮\x20\x22','24xtSaQH','isArray','【监察系统】分步/优化模式，回退后强制二次填表最新消息。','216268ZnuhmA','info','clear','[Amily2-翰林院]\x20RAG处理器已成功初始化','inset\x200\x200\x2015px\x20rgba(0,0,0,0.2)','[Amily2-核心引擎]\x20开始执行统一注入\x20(聊天长度:','readAsText','[Amily2号-帝国枢密院]\x20SillyTavern宫殿主体已确认，开国大典正式开始！','download','amily2-import-theme-btn','无法导出样式：找不到根元素。','#e0e0e0','object','onopen','<div\x20id=\x22amily2-online-tracker\x22\x20style=\x22text-align:\x20center;\x20padding:\x208px;\x20font-size:\x2013px;\x20color:\x20rgba(255,255,255,0.7);\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20margin-bottom:\x2010px;\x20background:\x20rgba(0,0,0,0.1);\x20border-radius:\x205px;\x22></div>','[Amily2-剧情优化]\x20优化流程已被用户中止。发送原始消息。','[Amily2-翰林院]\x20RAG注入失败:','max','[Amily2号-开国大典]\x20步骤3.6：侦测到术语表停泊位，开始绑定事件...','674244yANhLy','addEventListener','chat_updated','剧情优化已完成并注入。','449890pdqljA','[Amily2-主窗口]\x20按钮被点击:','triggerSlash','chat','accept','#dfdff0','querySelector','[Amily2号-开国大典]\x20密折司加载失败:','createObjectURL','split','dispatchEvent','./MiZheSi/index.js','regenerate','已切换至开场白\x20','18XybbaD','\x20人在线','iframe-renderer.css','parse','【Amily2号-情报部】一切安好，帝国已是最新版本。情报已转交内务府备案。','rel','--am2-','#send_but','10px','log','createLorebookEntries','message_id','options','renderer.css','deleteChatMessages','style.css','MESSAGE_RECEIVED','plotOpt_contextLimit','setChatMessages','已恢复默认界面样式。','getElementById','cwb-feature-style','/CharacterWorldBook/cwb_style.css?v=','rgba(255,\x20255,\x20172,\x200.1)','getChatMessages','plotOpt_enabled','showToast','removeProperty','[Amily2号-开国大典]\x20步骤3.5：侦测到角色世界书停泊位，开始构建...','count','1.1em','amily2EventsRegistered','contains','[Amily2号-开国大典]\x20步骤七：初始化版本显示系统...','Amily2-Theme-','<i\x20class=\x22fas\x20fa-users\x22\x20style=\x22color:\x20#4caf50;\x20font-size:\x2012px;\x20vertical-align:\x20middle;\x20margin-right:\x206px;\x22></i><span\x20id=\x22amily2-online-count\x22\x20style=\x22vertical-align:\x20middle;\x20font-weight:\x20bold;\x22>Connecting...</span>','click','link','0.95em','MESSAGE_EDITED','keys','onclose','characters','操作成功','[Amily2-在线统计]\x20初始化失败:','323197haWsGx','trigger','warn','【Amily2号】帝国已就绪，现派遣外交官，为陛下探查外界新情报...','?v=','/characters/','#amily2-cancel-optimization-btn','message','【监察系统】检测到消息\x20','swipe_id','super-memory.css','IMPERSONATE_READY','/assets/','map','amily2-export-theme-btn','!!!【术语表事件绑定失败】:\x20等待面板\x20#amily2_glossary_panel\x20超时。','head','12px','ids','[Amily2-API]\x20setChatMessage\x20收到参数:','[Amily2号-开国大典]\x20步骤3.8：注册表格占位符宏...','index','amily2-reset-theme-btn','[Amily2号-开国大典]\x20术语表事件已成功绑定。','!!!【术语表事件绑定失败】:','【监察系统】未配置填表模式，跳过填表。','warning','createElement','!!!【开国大典失败】在执行系列法令时发生严重错误:','#sys-settings-button','filling_mode','\x20被删除，开始精确回滚UI状态。','source','[Amily2-主窗口]\x20未知的动作类型:\x20','rgba(0,0,0,0.1)','jqyhEnabled','#amily2_drawer_content','error','secondary-api','[Amily2-全局卫队]\x20捕获到严重错误:','html','[Amily2-在线统计]\x20连接错误:','length','input','主题已成功导入并应用！','val','AMILY2_MACRO_REPLACED','[Amily2号-开国大典]\x20密折司模块已就位。','[Amily2号-皇家制衣局]\x20已为世界编辑器披上华服:\x20WorldEditor.css','剧情优化处理失败。','hanlinyuanRagProcessor','【监察系统】滑动后填表完成，UI\x20已刷新。','14px','[Amily2号-皇家制衣局]\x20已为帝国披上华服:\x20','!!!【角色世界书构建失败】:\x20等待面板\x20#amily2_character_world_book_panel\x20超时。','[Amily2-主窗口]\x20已发送消息:\x20','#amily2-online-count','1px\x20solid\x20#79b8ff','[Amily2号-开国大典]\x20角色世界书已成功构建并融入帝国。','[Amily2-策略]\x20采用“完全主导”策略，覆盖\x20`vectors_rearrangeChat`。','getPropertyValue','body','main-api','text','!!!【角色世界书构建失败】:','isCancelled','Optimization\x20cancelled\x20by\x20user','postMessage','#aaa\x20!important','none','getLorebooks','#send_textarea','Amily2EditContent','setChatMessage','[Amily2-在线统计]\x20连接断开，尝试重连...','buttonClick','swipes','avatars','#amily2_message_board','6UeIqzO','amily2-style-','success','sendMessage','。情报已转交内务府。','function','剧情优化','getLastMessageId','removeChild','【监察系统】主填表模式，回退后强制刷新消息ID:\x20','#9e8aff','undefined','registerMacro','historiography.css','[Amily2-剧情优化]\x20优化已启用，但Jqyh\x20API已禁用且主页API未配置。','【Amily2号-内务府】获取留言板失败:','CHAT_CHANGED','amily2Updater','1px\x20solid\x20#ffc107','[Amily2-内存储司]\x20表格注入失败:','getCharLorebooks','prepend','toastr','rearrangeChat','title','includes','href','messages','render_on_every_message','操作取消','text/css','Amily2插件错误:\x20','严重错误','files','target','optimized','version','world-editor-style','revokeObjectURL','setLorebookEntries','data','[Amily2号-开国大典]\x20步骤三：开始召唤府邸...','apiUrl','10px\x205px\x20!important','【监察系统】检测到“朝代更迭”(CHAT_CHANGED)，开始重修史书并刷新宫殿...','preOptimizationTextUpdated','6px\x208px','[Amily2号-开国大典]\x20步骤一：为宫殿披上华服...','table.css','rgba(255,\x20255,\x20172,\x200.25)','[Amily2号-开国大典]\x20步骤四：部署帝国哨兵网络...','isXiaobaixEnabled','display','setProperty','slice','buttonId','1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.2)','1206675hoOsoM','show','【Amily2号】帝国秩序已完美建立。Amily2号的府邸已恭候陛下的莅临。','bookName','startsWith','lastPreOptimizationResult','rgba(255,\x20255,\x20255,\x200.1)','[Amily2-核心引擎]\x20无法注册表格宏，可能是\x20SillyTavern\x20版本不兼容。','3471610Tbqeur','[Amily2-核心引擎]\x20已成功注册表格占位符宏:\x20{{Amily2EditContent}}','onmessage','getLorebookEntries','race','stylesheet','[Amily2号-版本系统]\x20版本检测器未找到，可能加载失败','/WorldEditor/WorldEditor.css?v=','scripts/extensions/third-party/','[Amily2-在线统计]\x20解析消息失败:','onload','[Amily2号-开国大典]\x20步骤二：皇家仪仗队就位...','\x22\x20被点击','rgba(0,0,0,0.2)','.json','[Amily2号-开国大典]\x20步骤五：初始化RAG处理器...','toISOString','now','【Amily2号-内务府】已成功获取并展示来自陛下的最新圣谕。','type','amily2-host','rgba(144,\x20238,\x20144,\x200.3)','trim','[Amily2-翰林院]\x20RAG处理器初始化失败:'];_0x25ca=function(){return _0xa000f8;};return _0x25ca();}import{injectTableData,generateTableContent}from'./core/table-system/injector.js';import{initialize as _0xdbe26c}from'./core/rag-processor.js';import{loadTables,clearHighlights,rollbackAndRefill,rollbackState,commitPendingDeletions,saveStateToMessage,getMemoryState,clearUpdatedTables}from'./core/table-system/manager.js';import{fillWithSecondaryApi}from'./core/table-system/secondary-filler.js';import{renderTables}from'./ui/table-bindings.js';import{log}from'./core/table-system/logger.js';import{eventSource,event_types,saveSettingsDebounced}from'/script.js';import{checkForUpdates,fetchMessageBoardContent}from'./core/api.js';import{setUpdateInfo,applyUpdateIndicator}from'./ui/state.js';import{pluginVersion,extensionName,defaultSettings}from'./utils/settings.js';import{tableSystemDefaultSettings}from'./core/table-system/settings.js';import{extension_settings}from'/scripts/extensions.js';import{manageLorebookEntriesForChat}from'./core/lore.js';import{initializeCharacterWorldBook}from'./CharacterWorldBook/cwb_index.js';import{cwbDefaultSettings}from'./CharacterWorldBook/src/cwb_config.js';import{bindGlossaryEvents}from'./glossary/GT_bindings.js';import'./core/amily2-updater.js';import{updateOrInsertTableInChat,startContinuousRendering,stopContinuousRendering}from'./ui/message-table-renderer.js';import{initializeRenderer}from'./core/tavern-helper/renderer.js';import{initializeApiListener,registerApiHandler,amilyHelper,initializeAmilyHelper}from'./core/tavern-helper/main.js';import{registerContextOptimizerMacros,resetContextBuffer}from'./core/context-optimizer.js';import{initializeSuperMemory}from'./core/super-memory/manager.js';const STYLE_SETTINGS_KEY='amily2_custom_styles',STYLE_ROOT_SELECTOR='#amily2_memorisation_forms_panel';let styleRoot=null;function getStyleRoot(){const _0x161d33=_0x10c0;return!styleRoot&&(styleRoot=document[_0x161d33(0x151)](STYLE_ROOT_SELECTOR)),styleRoot;}function applyStyles(_0x29b14a){const _0x16f861=_0x10c0,_0x44fb8c=getStyleRoot();if(!_0x44fb8c||!_0x29b14a)return;delete _0x29b14a['_comment'];for(const [_0x10d4e6,_0x3d7f9b]of Object[_0x16f861(0x126)](_0x29b14a)){_0x10d4e6[_0x16f861(0x212)](_0x16f861(0x15f))&&_0x44fb8c[_0x16f861(0x12e)][_0x16f861(0x20a)](_0x10d4e6,_0x3d7f9b);}}function loadAndApplyStyles(){const _0x1bd983=_0x10c0,_0x5a7a5e=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];_0x5a7a5e&&typeof _0x5a7a5e===_0x1bd983(0x140)&&Object[_0x1bd983(0x181)](_0x5a7a5e)[_0x1bd983(0x1b0)]>0x0&&applyStyles(_0x5a7a5e);}function saveStyles(_0x3d8c59){!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][STYLE_SETTINGS_KEY]=_0x3d8c59,saveSettingsDebounced();}function resetToDefaultStyles(){const _0x6571b3=_0x10c0,_0x261699=getStyleRoot();if(!_0x261699)return;const _0x475a48=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];if(_0x475a48&&typeof _0x475a48===_0x6571b3(0x140))for(const _0xe8f5b1 of Object[_0x6571b3(0x181)](_0x475a48)){_0xe8f5b1[_0x6571b3(0x212)](_0x6571b3(0x15f))&&_0x261699['style'][_0x6571b3(0x174)](_0xe8f5b1);}saveStyles(null),toastr[_0x6571b3(0x1d7)](_0x6571b3(0x16c));}function getDefaultCssVars(){const _0x2f905a=_0x10c0;return{'--am2-font-size-base':_0x2f905a(0x1ba),'--am2-gap-main':_0x2f905a(0x161),'--am2-padding-main':_0x2f905a(0x12d),'--am2-container-bg':_0x2f905a(0x1a8),'--am2-container-border':_0x2f905a(0x20d),'--am2-container-border-radius':_0x2f905a(0x197),'--am2-container-padding':'10px','--am2-container-shadow':_0x2f905a(0x138),'--am2-title-font-size':_0x2f905a(0x177),'--am2-title-font-weight':_0x2f905a(0x12c),'--am2-title-text-shadow':'0\x200\x205px\x20rgba(200,\x20200,\x20255,\x200.3)','--am2-title-gradient-start':'#c0bde4','--am2-title-gradient-end':_0x2f905a(0x150),'--am2-title-icon-color':_0x2f905a(0x1df),'--am2-title-icon-margin':_0x2f905a(0x161),'--am2-table-bg':_0x2f905a(0x223),'--am2-table-border':'1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.25)','--am2-table-cell-padding':_0x2f905a(0x203),'--am2-table-cell-font-size':_0x2f905a(0x17f),'--am2-header-bg':_0x2f905a(0x214),'--am2-header-color':_0x2f905a(0x13f),'--am2-header-editable-bg':'rgba(172,\x20216,\x20255,\x200.1)','--am2-header-editable-focus-bg':_0x2f905a(0x12b),'--am2-header-editable-focus-outline':_0x2f905a(0x1bf),'--am2-cell-editable-bg':_0x2f905a(0x170),'--am2-cell-editable-focus-bg':_0x2f905a(0x206),'--am2-cell-editable-focus-outline':_0x2f905a(0x1e7),'--am2-index-col-bg':'rgba(0,\x200,\x200,\x200.3)\x20!important','--am2-index-col-color':_0x2f905a(0x1ca),'--am2-index-col-width':'40px','--am2-index-col-padding':_0x2f905a(0x200),'--am2-controls-gap':_0x2f905a(0x11c),'--am2-controls-margin-bottom':_0x2f905a(0x161),'--am2-cell-highlight-bg':_0x2f905a(0x22b)};}function exportStyles(){const _0x5a1d63=_0x10c0,_0xc449cf=getStyleRoot();if(!_0xc449cf){toastr['error'](_0x5a1d63(0x13e));return;}const _0x1b2c29=getComputedStyle(_0xc449cf),_0x56121f={},_0x5212e1=getDefaultCssVars();for(const _0x40b176 of Object[_0x5a1d63(0x181)](_0x5212e1)){_0x56121f[_0x40b176]=_0x1b2c29[_0x5a1d63(0x1c2)](_0x40b176)[_0x5a1d63(0x22c)]();}const _0x403575=new Blob([JSON['stringify'](_0x56121f,null,0x2)],{'type':'application/json'}),_0x2592eb=URL[_0x5a1d63(0x153)](_0x403575),_0x255536=document[_0x5a1d63(0x1a1)]('a');_0x255536[_0x5a1d63(0x1ef)]=_0x2592eb,_0x255536[_0x5a1d63(0x13c)]=_0x5a1d63(0x17b)+new Date()[_0x5a1d63(0x226)]()['slice'](0x0,0xa)+_0x5a1d63(0x224),document[_0x5a1d63(0x1c3)]['appendChild'](_0x255536),_0x255536['click'](),document['body'][_0x5a1d63(0x1dd)](_0x255536),URL[_0x5a1d63(0x1fb)](_0x2592eb),toastr[_0x5a1d63(0x1d7)](_0x5a1d63(0x117),'导出成功');}function importStyles(){const _0x2cc2ad=_0x10c0,_0x1f7e2f=document[_0x2cc2ad(0x1a1)]('input');_0x1f7e2f[_0x2cc2ad(0x229)]='file',_0x1f7e2f[_0x2cc2ad(0x14f)]=_0x2cc2ad(0x224),_0x1f7e2f[_0x2cc2ad(0x12e)][_0x2cc2ad(0x209)]=_0x2cc2ad(0x1cb);const _0x538e21=()=>{const _0x324b96=_0x2cc2ad;document['body'][_0x324b96(0x179)](_0x1f7e2f)&&document[_0x324b96(0x1c3)][_0x324b96(0x1dd)](_0x1f7e2f);};_0x1f7e2f[_0x2cc2ad(0x124)]=_0xe719b7=>{const _0x49ae04=_0x2cc2ad,_0x42edb2=_0xe719b7[_0x49ae04(0x1f7)][_0x49ae04(0x1f6)][0x0];if(!_0x42edb2){_0x538e21();return;}const _0x4ecf1b=new FileReader();_0x4ecf1b[_0x49ae04(0x220)]=_0x3ab6a1=>{const _0x2be2af=_0x49ae04;try{const _0x2cd763=JSON[_0x2be2af(0x15c)](_0x3ab6a1[_0x2be2af(0x1f7)]['result']);if(typeof _0x2cd763!=='object'||Array[_0x2be2af(0x132)](_0x2cd763))throw new Error('无效的JSON格式。');applyStyles(_0x2cd763),saveStyles(_0x2cd763),toastr['success'](_0x2be2af(0x1b2));}catch(_0x1ed4b7){toastr[_0x2be2af(0x1ab)]('导入失败：'+_0x1ed4b7[_0x2be2af(0x18d)],'错误');}finally{_0x538e21();}},_0x4ecf1b[_0x49ae04(0x13a)](_0x42edb2);},document[_0x2cc2ad(0x1c3)][_0x2cc2ad(0x11b)](_0x1f7e2f),_0x1f7e2f['click']();}function compareVersions(_0x4c04ef,_0x3057b6){const _0x63673=_0x10c0,_0x5e6695=_0x4c04ef[_0x63673(0x154)]('.')[_0x63673(0x193)](Number),_0x468644=_0x3057b6['split']('.')[_0x63673(0x193)](Number),_0x375449=Math[_0x63673(0x145)](_0x5e6695[_0x63673(0x1b0)],_0x468644[_0x63673(0x1b0)]);for(let _0x226dd9=0x0;_0x226dd9<_0x375449;_0x226dd9++){const _0x2c8a1c=_0x5e6695[_0x226dd9]||0x0,_0x59b694=_0x468644[_0x226dd9]||0x0;if(_0x2c8a1c>_0x59b694)return!![];if(_0x2c8a1c<_0x59b694)return![];}return![];}async function handleUpdateCheck(){const _0x4e9355=_0x10c0;console[_0x4e9355(0x162)](_0x4e9355(0x189));const _0x768457=await checkForUpdates();if(_0x768457&&_0x768457[_0x4e9355(0x1f9)]){const _0x262dd3=compareVersions(_0x768457[_0x4e9355(0x1f9)],pluginVersion);_0x262dd3?console[_0x4e9355(0x162)](_0x4e9355(0x128)+_0x768457[_0x4e9355(0x1f9)]+_0x4e9355(0x1d9)):console[_0x4e9355(0x162)](_0x4e9355(0x15d)),setUpdateInfo(_0x262dd3,_0x768457),applyUpdateIndicator();}}async function handleMessageBoard(){const _0x3d8175=async()=>{const _0x1ae517=_0x10c0;try{const _0x4673f2=await fetchMessageBoardContent();if(_0x4673f2&&_0x4673f2['message']){const _0x142e16=$(_0x1ae517(0x1d4)),_0x2a79a1=$('#amily2_message_content');_0x2a79a1[_0x1ae517(0x1ae)](_0x4673f2['message']),_0x142e16[_0x1ae517(0x20f)](),console[_0x1ae517(0x162)](_0x1ae517(0x228));}}catch(_0x14b277){console[_0x1ae517(0x1ab)](_0x1ae517(0x1e4),_0x14b277);}};await _0x3d8175(),setInterval(_0x3d8175,0x493e0);}function loadPluginStyles(){const _0x118e20=_0x10c0,_0x340ad8=_0x4159e0=>{const _0x54e786=_0x10c0,_0x4665b8=_0x54e786(0x1d6)+_0x4159e0[_0x54e786(0x154)]('.')[0x0];if(document[_0x54e786(0x16d)](_0x4665b8))return;const _0x1c0f51=_0x54e786(0x21e)+extensionName+_0x54e786(0x192)+_0x4159e0+_0x54e786(0x18a)+Date[_0x54e786(0x227)](),_0x53bdc8=document[_0x54e786(0x1a1)](_0x54e786(0x17e));_0x53bdc8['id']=_0x4665b8,_0x53bdc8[_0x54e786(0x15e)]=_0x54e786(0x21b),_0x53bdc8['type']=_0x54e786(0x1f3),_0x53bdc8[_0x54e786(0x1ef)]=_0x1c0f51,document['head']['appendChild'](_0x53bdc8),console['log'](_0x54e786(0x1bb)+_0x4159e0);};_0x340ad8(_0x118e20(0x168)),_0x340ad8(_0x118e20(0x1e2)),_0x340ad8('hanlinyuan.css'),_0x340ad8('amily2-glossary.css'),_0x340ad8(_0x118e20(0x205)),_0x340ad8('optimization.css'),_0x340ad8(_0x118e20(0x166)),_0x340ad8(_0x118e20(0x15b)),_0x340ad8(_0x118e20(0x190));const _0x38dc12=_0x118e20(0x16e);if(!document['getElementById'](_0x38dc12)){const _0x403ded=document[_0x118e20(0x1a1)](_0x118e20(0x17e));_0x403ded['id']=_0x38dc12,_0x403ded[_0x118e20(0x15e)]='stylesheet',_0x403ded[_0x118e20(0x229)]=_0x118e20(0x1f3),_0x403ded['href']=_0x118e20(0x21e)+extensionName+_0x118e20(0x16f)+Date[_0x118e20(0x227)](),document[_0x118e20(0x196)][_0x118e20(0x11b)](_0x403ded),console['log']('[Amily2号-皇家制衣局]\x20已为角色世界书披上华服:\x20cwb_style.css');}const _0x8f09cf=_0x118e20(0x1fa);if(!document[_0x118e20(0x16d)](_0x8f09cf)){const _0x7bac4c=document[_0x118e20(0x1a1)]('link');_0x7bac4c['id']=_0x8f09cf,_0x7bac4c[_0x118e20(0x15e)]='stylesheet',_0x7bac4c['type']='text/css',_0x7bac4c[_0x118e20(0x1ef)]=_0x118e20(0x21e)+extensionName+_0x118e20(0x21d)+Date[_0x118e20(0x227)](),document['head'][_0x118e20(0x11b)](_0x7bac4c),console[_0x118e20(0x162)](_0x118e20(0x1b6));}}window[_0x2b2b58(0x148)](_0x2b2b58(0x18d),function(_0x2da08f){const _0x3a3c0c=_0x2b2b58;if(_0x2da08f[_0x3a3c0c(0x1fd)]&&_0x2da08f[_0x3a3c0c(0x1fd)][_0x3a3c0c(0x229)]==='getAvatars'){if(window[_0x3a3c0c(0x208)])return;const _0x236e7f=_0x3a3c0c(0x18b)+(getContext()['userCharacter']?.[_0x3a3c0c(0x12f)]??''),_0x468621='/characters/'+(getContext()[_0x3a3c0c(0x183)][this_chid]?.[_0x3a3c0c(0x12f)]??'');_0x2da08f[_0x3a3c0c(0x1a6)][_0x3a3c0c(0x1c9)]({'source':_0x3a3c0c(0x22a),'type':_0x3a3c0c(0x1d3),'urls':{'user':_0x236e7f,'char':_0x468621}},'*');return;}if(_0x2da08f['data']&&_0x2da08f[_0x3a3c0c(0x1fd)][_0x3a3c0c(0x1a6)]===_0x3a3c0c(0x122)){const {action:_0x2f0d7d,detail:_0x79d763}=_0x2da08f['data'];console[_0x3a3c0c(0x162)]('[Amily2-主窗口]\x20收到来自iframe的动作:\x20'+_0x2f0d7d,_0x79d763);switch(_0x2f0d7d){case _0x3a3c0c(0x1d8):_0x79d763&&_0x79d763['message']&&($(_0x3a3c0c(0x1cd))[_0x3a3c0c(0x1b3)](_0x79d763[_0x3a3c0c(0x18d)])[_0x3a3c0c(0x187)](_0x3a3c0c(0x1b1)),$(_0x3a3c0c(0x160))[_0x3a3c0c(0x187)]('click'),console[_0x3a3c0c(0x162)](_0x3a3c0c(0x1bd)+_0x79d763[_0x3a3c0c(0x18d)]));break;case _0x3a3c0c(0x173):if(_0x79d763&&_0x79d763[_0x3a3c0c(0x18d)]&&window[_0x3a3c0c(0x1eb)]){const _0x4aa862=_0x79d763['type']||'info';typeof window[_0x3a3c0c(0x1eb)][_0x4aa862]==='function'&&window[_0x3a3c0c(0x1eb)][_0x4aa862](_0x79d763[_0x3a3c0c(0x18d)],_0x79d763[_0x3a3c0c(0x1ed)]||'通知');}break;case _0x3a3c0c(0x1d1):console[_0x3a3c0c(0x162)](_0x3a3c0c(0x14c),_0x79d763);window[_0x3a3c0c(0x1eb)]&&window['toastr']['info'](_0x3a3c0c(0x130)+(_0x79d763[_0x3a3c0c(0x20c)]||'未知')+_0x3a3c0c(0x222),_0x3a3c0c(0x116));break;default:console[_0x3a3c0c(0x188)](_0x3a3c0c(0x1a7)+_0x2f0d7d);}}}),window[_0x2b2b58(0x148)]('error',_0x44fa1c=>{const _0x19d96c=_0x2b2b58,_0x2abd57=_0x44fa1c[_0x19d96c(0x1ab)]?.['stack']||'';_0x2abd57[_0x19d96c(0x1ee)](_0x19d96c(0x11e))&&(console[_0x19d96c(0x1ab)](_0x19d96c(0x1ad),_0x44fa1c[_0x19d96c(0x1ab)]),toastr[_0x19d96c(0x1ab)](_0x19d96c(0x1f4)+(_0x44fa1c[_0x19d96c(0x1ab)]?.['message']||'未知错误'),_0x19d96c(0x1f5),{'timeOut':0x2710}));}),jQuery(async()=>{const _0x6c486a=_0x2b2b58;console[_0x6c486a(0x162)](_0x6c486a(0x120));try{console[_0x6c486a(0x162)]('[Amily2号-开国大典]\x20步骤0：优先注册上下文优化器...'),registerContextOptimizerMacros();}catch(_0x4dca6e){console[_0x6c486a(0x1ab)]('[Amily2号-开国大典]\x20上下文优化器注册失败:',_0x4dca6e);}try{await import(_0x6c486a(0x156)),console[_0x6c486a(0x162)](_0x6c486a(0x1b5));}catch(_0x4eb298){console[_0x6c486a(0x1ab)](_0x6c486a(0x152),_0x4eb298);}initializeApiListener(),registerApiHandler(_0x6c486a(0x171),async _0x134441=>{const _0x39e804=_0x6c486a;return amilyHelper['getChatMessages'](_0x134441['range'],_0x134441[_0x39e804(0x165)]);}),registerApiHandler(_0x6c486a(0x16b),async _0x3b6edb=>{const _0x4feb21=_0x6c486a;return await amilyHelper[_0x4feb21(0x16b)](_0x3b6edb[_0x4feb21(0x1f0)],_0x3b6edb[_0x4feb21(0x165)]);}),registerApiHandler(_0x6c486a(0x1cf),async _0x183cba=>{const _0x5eb2c5=_0x6c486a,_0x393ed1=_0x183cba['field_values']||_0x183cba['content'],_0x4daad8=_0x183cba[_0x5eb2c5(0x164)]!==undefined?_0x183cba[_0x5eb2c5(0x164)]:_0x183cba[_0x5eb2c5(0x19b)],_0xa9cfeb=_0x183cba[_0x5eb2c5(0x165)]||{};return console[_0x5eb2c5(0x162)](_0x5eb2c5(0x199),{'field_values':_0x393ed1,'message_id':_0x4daad8,'options':_0xa9cfeb,'raw_data':_0x183cba}),await amilyHelper[_0x5eb2c5(0x1cf)](_0x393ed1,_0x4daad8,_0xa9cfeb);}),registerApiHandler('createChatMessages',async _0x476221=>{const _0x4fd296=_0x6c486a;return await amilyHelper['createChatMessages'](_0x476221['messages'],_0x476221[_0x4fd296(0x165)]);}),registerApiHandler(_0x6c486a(0x167),async _0x1b6363=>{const _0x525d1f=_0x6c486a;return await amilyHelper['deleteChatMessages'](_0x1b6363[_0x525d1f(0x198)],_0x1b6363['options']);}),registerApiHandler('getLorebooks',async _0x1961bf=>{const _0x404743=_0x6c486a;return await amilyHelper[_0x404743(0x1cc)]();}),registerApiHandler(_0x6c486a(0x1e9),async _0x14e04b=>{const _0x366415=_0x6c486a;return await amilyHelper[_0x366415(0x1e9)](_0x14e04b[_0x366415(0x165)]);}),registerApiHandler(_0x6c486a(0x219),async _0x2de7dd=>{const _0x30880f=_0x6c486a;return await amilyHelper['getLorebookEntries'](_0x2de7dd[_0x30880f(0x211)]);}),registerApiHandler(_0x6c486a(0x1fc),async _0x5ef030=>{const _0x5ea82b=_0x6c486a;return await amilyHelper[_0x5ea82b(0x1fc)](_0x5ef030[_0x5ea82b(0x211)],_0x5ef030[_0x5ea82b(0x126)]);}),registerApiHandler(_0x6c486a(0x163),async _0x4d5967=>{const _0x30123d=_0x6c486a;return await amilyHelper['createLorebookEntries'](_0x4d5967[_0x30123d(0x211)],_0x4d5967[_0x30123d(0x126)]);}),registerApiHandler('createLorebook',async _0x2e2952=>{const _0x15809d=_0x6c486a;return await amilyHelper['createLorebook'](_0x2e2952[_0x15809d(0x211)]);}),registerApiHandler('triggerSlash',async _0x24ecda=>{const _0x3a5801=_0x6c486a;return await amilyHelper[_0x3a5801(0x14d)](_0x24ecda['command']);}),registerApiHandler(_0x6c486a(0x1dc),async _0x7393b8=>{const _0x3b0f0b=_0x6c486a;return amilyHelper[_0x3b0f0b(0x1dc)]();}),registerApiHandler(_0x6c486a(0x1eb),async _0xaf763f=>{const _0x13cf16=_0x6c486a;return window['toastr']&&typeof window[_0x13cf16(0x1eb)][_0xaf763f[_0x13cf16(0x229)]]===_0x13cf16(0x1da)&&window[_0x13cf16(0x1eb)][_0xaf763f['type']](_0xaf763f['message'],_0xaf763f[_0x13cf16(0x1ed)]),!![];}),registerApiHandler('switchSwipe',async _0x438f11=>{const _0x5d9253=_0x6c486a,{messageIndex:_0x37f819,swipeIndex:_0x1afce9}=_0x438f11,_0x118ee9=await amilyHelper[_0x5d9253(0x171)](_0x37f819,{'include_swipes':!![]});if(_0x118ee9&&_0x118ee9[_0x5d9253(0x1b0)]>0x0&&_0x118ee9[0x0]['swipes']){const _0x3436b7=_0x118ee9[0x0][_0x5d9253(0x1d2)][_0x1afce9];if(_0x3436b7!==undefined){await amilyHelper['setChatMessages']([{'message_id':_0x37f819,'message':_0x3436b7}],{'refresh':_0x5d9253(0x11f)});const _0x9cb1dc=getContext();return _0x9cb1dc['chat'][_0x37f819]&&(_0x9cb1dc[_0x5d9253(0x14e)][_0x37f819][_0x5d9253(0x18f)]=_0x1afce9),{'success':!![],'message':_0x5d9253(0x158)+_0x1afce9};}}throw new Error('无法切换到开场白\x20'+_0x1afce9);}),initializeAmilyHelper(),console['log'](_0x6c486a(0x120));!extension_settings[extensionName]&&(extension_settings[extensionName]={});const _0x21861d={...defaultSettings,...tableSystemDefaultSettings,...cwbDefaultSettings,'render_on_every_message':![],'amily_render_enabled':![]};for(const _0x51f7fa in _0x21861d){extension_settings[extensionName][_0x51f7fa]===undefined&&(extension_settings[extensionName][_0x51f7fa]=_0x21861d[_0x51f7fa]);}console[_0x6c486a(0x162)]('[Amily2号-帝国枢密院]\x20帝国基本法已确认，档案室已与国库对接完毕。');let _0x1654cf=0x0;const _0x247b11=0x64,_0x19de4b=0x64,_0x731071=_0x6c486a(0x1a3),_0x1c7d77=setInterval(async()=>{const _0xa2603f=_0x6c486a;if($(_0x731071)[_0xa2603f(0x1b0)]>0x0){clearInterval(_0x1c7d77),console[_0xa2603f(0x162)](_0xa2603f(0x13b));try{console[_0xa2603f(0x162)](_0xa2603f(0x204)),loadPluginStyles(),console[_0xa2603f(0x162)](_0xa2603f(0x221)),await registerSlashCommands(),console[_0xa2603f(0x162)](_0xa2603f(0x1fe)),createDrawer();function _0x55e622(){let _0x2dc99b=0x0;const _0x1f507f=0x32,_0x15b67c=0x64,_0x4d1c9a=setInterval(()=>{const _0x1f8eff=_0x10c0,_0x2bd7a3=document[_0x1f8eff(0x16d)]('amily2_glossary_panel');if(_0x2bd7a3){clearInterval(_0x4d1c9a);try{console[_0x1f8eff(0x162)](_0x1f8eff(0x146)),bindGlossaryEvents(),console[_0x1f8eff(0x162)](_0x1f8eff(0x19d));}catch(_0x172d01){console[_0x1f8eff(0x1ab)](_0x1f8eff(0x19e),_0x172d01);}}else _0x2dc99b++,_0x2dc99b>=_0x1f507f&&(clearInterval(_0x4d1c9a),console['error'](_0x1f8eff(0x195)));},_0x15b67c);}_0x55e622();function _0x1ae041(){let _0x5a277a=0x0;const _0x3fc25f=0x32,_0x15ca3f=0x64,_0x55f9b9=setInterval(async()=>{const _0x38fe9a=_0x10c0,_0x46b6ee=$('#amily2_character_world_book_panel');if(_0x46b6ee[_0x38fe9a(0x1b0)]>0x0){clearInterval(_0x55f9b9);try{console[_0x38fe9a(0x162)](_0x38fe9a(0x175)),await initializeCharacterWorldBook(_0x46b6ee),console[_0x38fe9a(0x162)](_0x38fe9a(0x1c0));}catch(_0x55a71c){console[_0x38fe9a(0x1ab)](_0x38fe9a(0x1c6),_0x55a71c);}}else _0x5a277a++,_0x5a277a>=_0x3fc25f&&(clearInterval(_0x55f9b9),console[_0x38fe9a(0x1ab)](_0x38fe9a(0x1bc)));},_0x15ca3f);}_0x1ae041(),console[_0xa2603f(0x162)](_0xa2603f(0x19a));try{eventSource['on'](event_types[_0xa2603f(0x123)],()=>{resetContextBuffer();});const _0xf7705c=getContext();_0xf7705c&&typeof _0xf7705c[_0xa2603f(0x1e1)]===_0xa2603f(0x1da)?(_0xf7705c['registerMacro'](_0xa2603f(0x1ce),()=>{const _0x3b0563=_0xa2603f,_0x8e10e7=generateTableContent();return _0x8e10e7&&(window[_0x3b0563(0x1b4)]=!![]),_0x8e10e7;}),console[_0xa2603f(0x162)](_0xa2603f(0x217))):console[_0xa2603f(0x188)](_0xa2603f(0x215));}catch(_0x437968){console['error']('[Amily2-核心引擎]\x20注册表格宏时发生错误:',_0x437968);}console['log'](_0xa2603f(0x207));let _0x451570=![];async function _0xad1ddc(_0x148e3a,_0x3b7045,_0x143d49){const _0x13534f=_0xa2603f;clearUpdatedTables(),console['log']('[Amily2-剧情优化]\x20Generation\x20after\x20commands\x20triggered',{'type':_0x148e3a,'params':_0x3b7045,'dryRun':_0x143d49,'isProcessing':_0x451570});if(_0x148e3a===_0x13534f(0x157)||_0x451570||_0x143d49){console['log']('[Amily2-剧情优化]\x20Skipping\x20due\x20to\x20conditions:',{'type':_0x148e3a,'isProcessing':_0x451570,'dryRun':_0x143d49});return;}const _0x5506af=extension_settings[extensionName];if(_0x5506af?.[_0x13534f(0x172)]===![])return;const _0x199c40=_0x5506af?.[_0x13534f(0x1a9)]===!![],_0x4d68ba=!!_0x5506af?.[_0x13534f(0x1ff)]||!!_0x5506af?.[_0x13534f(0x129)];if(!_0x199c40&&!_0x4d68ba){console['log'](_0x13534f(0x1e3));return;}_0x451570=!![];let _0x29915e=null;const _0xfa3a45={'isCancelled':![]};try{const _0x4c2f=$(_0x13534f(0x1cd))[_0x13534f(0x1b3)]();if(!_0x4c2f)return _0x451570=![],![];const _0x1c3166='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20正在进行剧情优化...\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22amily2-cancel-optimization-btn\x22\x20class=\x22menu_button\x20danger_button\x22\x20style=\x22margin-left:\x2010px;\x20padding:\x202px\x208px;\x20font-size:\x200.8em;\x22>中止</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20';let _0x191521;const _0x41ec12=new Promise((_0x4f91ed,_0x3fa0ae)=>{_0x191521=_0x3fa0ae;});_0x29915e=toastr[_0x13534f(0x135)](_0x1c3166,_0x13534f(0x1db),{'timeOut':0x0,'extendedTimeOut':0x0,'tapToDismiss':![],'onclick':null,'escapeHtml':![],'onShown':function(){const _0x3af548=_0x13534f;$(_0x3af548(0x18c))['one']('click',function(_0x4a35e9){const _0x345e60=_0x3af548;_0x4a35e9['stopPropagation'](),_0x29915e&&(_0x29915e[_0x345e60(0x11d)](),_0x29915e=null),_0xfa3a45[_0x345e60(0x1c7)]=!![],_0x191521(new Error(_0x345e60(0x1c8)));});}});const _0x52f09a=getContext(),_0x478d20=_0x5506af[_0x13534f(0x16a)]||0xa;let _0xced176=[];_0x478d20>0x0&&(_0xced176=_0x52f09a[_0x13534f(0x14e)][_0x13534f(0x20b)](-_0x478d20));const _0x45f1ca=processPlotOptimization({'mes':_0x4c2f},_0xced176,_0xfa3a45),_0xe73b25=await Promise[_0x13534f(0x21a)]([_0x45f1ca,_0x41ec12]);if(_0xe73b25&&_0xe73b25[_0x13534f(0x115)]){const _0x59c33b=$(_0x13534f(0x1cd))[_0x13534f(0x1b3)](),_0xe8d1a2=_0x59c33b+'\x0a'+_0xe73b25['contentToAppend'];$(_0x13534f(0x1cd))[_0x13534f(0x1b3)](_0xe8d1a2)['trigger'](_0x13534f(0x1b1)),toastr[_0x13534f(0x1d7)](_0x13534f(0x14a),_0x13534f(0x184));}else console[_0x13534f(0x162)]('[Amily2-剧情优化]\x20Plot\x20optimization\x20returned\x20no\x20result.\x20Sending\x20original\x20message.');return![];}catch(_0x58c0b2){return _0x58c0b2[_0x13534f(0x18d)]===_0x13534f(0x1c8)?(console['log'](_0x13534f(0x143)),toastr[_0x13534f(0x1a0)]('剧情优化任务已中止...',_0x13534f(0x1f2),{'timeOut':0x7d0})):(console[_0x13534f(0x1ab)]('[Amily2-剧情优化]\x20处理发送前事件时出错:',_0x58c0b2),toastr['error'](_0x13534f(0x1b7),'错误')),![];}finally{_0x451570=![],_0x29915e&&(toastr[_0x13534f(0x136)](_0x29915e),_0x29915e=null);}}!window[_0xa2603f(0x178)]&&(eventSource['on'](event_types['GENERATION_AFTER_COMMANDS'],_0xad1ddc),eventSource['on'](event_types[_0xa2603f(0x169)],onMessageReceived),eventSource['on'](event_types[_0xa2603f(0x191)],onMessageReceived),eventSource['on'](event_types['MESSAGE_RECEIVED'],_0x230a0d=>handleTableUpdate(_0x230a0d)),eventSource['on'](event_types['MESSAGE_SWIPED'],async _0x1b08eb=>{const _0x3e6034=_0xa2603f,_0x1cce71=getContext();if(_0x1cce71[_0x3e6034(0x14e)][_0x3e6034(0x1b0)]<0x2){log(_0x3e6034(0x12a),_0x3e6034(0x135));return;}log(_0x3e6034(0x121),_0x3e6034(0x188)),rollbackState();const _0x3bd473=_0x1cce71[_0x3e6034(0x14e)][_0x1b08eb]||_0x1cce71[_0x3e6034(0x14e)][_0x1cce71[_0x3e6034(0x14e)][_0x3e6034(0x1b0)]-0x1];if(_0x3bd473['is_user']){log('【监察系统】滑动后最新消息是用户，跳过填表。','info'),renderTables();return;}const _0x5437dc=extension_settings[extensionName],_0x165da9=_0x5437dc[_0x3e6034(0x1a4)]||_0x3e6034(0x1c4);if(_0x165da9===_0x3e6034(0x1c4))log(_0x3e6034(0x1de)+_0x1b08eb+'。',_0x3e6034(0x135)),await handleTableUpdate(_0x1b08eb,!![]);else _0x165da9===_0x3e6034(0x1ac)||_0x165da9===_0x3e6034(0x1f8)?(log(_0x3e6034(0x133),_0x3e6034(0x135)),await fillWithSecondaryApi(_0x3bd473,!![])):log(_0x3e6034(0x19f),_0x3e6034(0x135));renderTables(),log(_0x3e6034(0x1b9),_0x3e6034(0x1d7));}),eventSource['on'](event_types[_0xa2603f(0x180)],_0x18d83d=>{handleTableUpdate(_0x18d83d),updateOrInsertTableInChat();}),eventSource['on'](event_types[_0xa2603f(0x1e5)],()=>{const _0x30ee36=_0xa2603f;window[_0x30ee36(0x213)]=null,document[_0x30ee36(0x155)](new CustomEvent(_0x30ee36(0x202))),manageLorebookEntriesForChat(),setTimeout(()=>{const _0x2ec400=_0x30ee36;log(_0x2ec400(0x201),'info'),clearHighlights(),clearUpdatedTables(),loadTables(),renderTables(),extension_settings[extensionName][_0x2ec400(0x1f1)]?startContinuousRendering():stopContinuousRendering();},0x64);}),eventSource['on'](event_types[_0xa2603f(0x125)],(_0x5dfd87,_0x173981)=>{const _0x18cff8=_0xa2603f;log(_0x18cff8(0x18e)+_0x173981+_0x18cff8(0x1a5),'warn'),clearHighlights(),loadTables(_0x173981),renderTables();}),eventSource['on'](event_types['MESSAGE_RECEIVED'],updateOrInsertTableInChat),eventSource['on'](event_types[_0xa2603f(0x149)],updateOrInsertTableInChat),window['amily2EventsRegistered']=!![]);console[_0xa2603f(0x162)](_0xa2603f(0x225));try{_0xdbe26c(),console[_0xa2603f(0x162)](_0xa2603f(0x137));}catch(_0x4be765){console['error'](_0xa2603f(0x22d),_0x4be765);}console['log']('[Amily2号-开国大典]\x20步骤六：智能冲突检测与注入策略...');async function _0x4d2f3e(..._0x20d9bc){const _0x4c1c53=_0xa2603f;console[_0x4c1c53(0x162)](_0x4c1c53(0x139),_0x20d9bc[0x0]?.[_0x4c1c53(0x1b0)]||0x0,')');try{await injectTableData(..._0x20d9bc);}catch(_0xf917d7){console[_0x4c1c53(0x1ab)](_0x4c1c53(0x1e8),_0xf917d7);}if(window[_0x4c1c53(0x1b8)]&&typeof window['hanlinyuanRagProcessor'][_0x4c1c53(0x1ec)]===_0x4c1c53(0x1da))try{console['log']('[Amily2-核心引擎]\x20执行内置RAG注入。'),await window[_0x4c1c53(0x1b8)]['rearrangeChat'](..._0x20d9bc);}catch(_0x46a084){console[_0x4c1c53(0x1ab)](_0x4c1c53(0x144),_0x46a084);}}console[_0xa2603f(0x162)](_0xa2603f(0x1c1)),window[_0xa2603f(0x118)]=_0x4d2f3e,window[_0xa2603f(0x11a)]&&(window[_0xa2603f(0x11a)]=null),console[_0xa2603f(0x162)](_0xa2603f(0x210)),console[_0xa2603f(0x162)](_0xa2603f(0x17a)),typeof window['amily2Updater']!==_0xa2603f(0x1e0)?setTimeout(()=>{const _0x315126=_0xa2603f;console[_0x315126(0x162)]('[Amily2号-版本系统]\x20正在启动版本检测器...'),window[_0x315126(0x1e6)]['initialize']();},0x7d0):console['warn'](_0xa2603f(0x21c)),handleUpdateCheck(),handleMessageBoard(),initializeOnlineTracker(),setTimeout(()=>{initializeSuperMemory();},0xbb8),initializeRenderer(),extension_settings[extensionName][_0xa2603f(0x1f1)]&&startContinuousRendering(),setTimeout(()=>{const _0x2360f3=_0xa2603f;try{loadAndApplyStyles();const _0x1f209b=document[_0x2360f3(0x16d)](_0x2360f3(0x13d)),_0xecb29b=document[_0x2360f3(0x16d)](_0x2360f3(0x194)),_0x50eb52=document[_0x2360f3(0x16d)](_0x2360f3(0x19c));if(_0x1f209b)_0x1f209b['addEventListener'](_0x2360f3(0x17d),importStyles);if(_0xecb29b)_0xecb29b[_0x2360f3(0x148)](_0x2360f3(0x17d),exportStyles);if(_0x50eb52)_0x50eb52[_0x2360f3(0x148)](_0x2360f3(0x17d),resetToDefaultStyles);log('【凤凰阁】内联主题系统已通过延迟加载成功初始化并绑定事件。',_0x2360f3(0x1d7));}catch(_0x24ccd1){log('【凤凰阁】内联主题系统初始化失败:\x20'+_0x24ccd1,'error');}},0x1f4);}catch(_0x941797){console['error'](_0xa2603f(0x1a2),_0x941797);}}else _0x1654cf++,_0x1654cf>=_0x247b11&&(clearInterval(_0x1c7d77),console[_0xa2603f(0x1ab)](_0xa2603f(0x127)+_0x731071+'\x20超时。'));},_0x19de4b);});function initializeOnlineTracker(){const _0x1c8cc6='wss://amilyservice.amily49.cc';let _0x110c19,_0x348fc3;function _0x5bc827(){const _0x529a66=_0x10c0,_0x453723=$(_0x529a66(0x1aa));if(_0x453723['length']===0x0||!_0x453723['data']('initialized')){setTimeout(_0x5bc827,0x3e8);return;}if($('#amily2-online-tracker')[_0x529a66(0x1b0)]>0x0)return;const _0x1f13c0=$(_0x529a66(0x142));_0x1f13c0[_0x529a66(0x1ae)](_0x529a66(0x17c)),_0x453723[_0x529a66(0x1ea)](_0x1f13c0),_0x25eb79();}function _0x25eb79(){const _0x271548=_0x10c0;try{_0x110c19=new WebSocket(_0x1c8cc6),_0x110c19[_0x271548(0x141)]=()=>{const _0x4e0d57=_0x271548;console[_0x4e0d57(0x162)]('[Amily2-在线统计]\x20已连接到服务器'),_0x348fc3&&(clearInterval(_0x348fc3),_0x348fc3=null);},_0x110c19[_0x271548(0x218)]=_0x24ed37=>{const _0x8f8cf4=_0x271548;try{const _0x4aa984=JSON['parse'](_0x24ed37['data']);_0x4aa984['type']==='online_count'&&$('#amily2-online-count')[_0x8f8cf4(0x1c5)](_0x4aa984[_0x8f8cf4(0x176)]+_0x8f8cf4(0x15a));}catch(_0x22f9eb){console[_0x8f8cf4(0x1ab)](_0x8f8cf4(0x21f),_0x22f9eb);}},_0x110c19[_0x271548(0x182)]=()=>{const _0x42772a=_0x271548;console[_0x42772a(0x162)](_0x42772a(0x1d0)),$(_0x42772a(0x1be))['text']('离线'),!_0x348fc3&&(_0x348fc3=setInterval(_0x25eb79,0x1388));},_0x110c19['onerror']=_0x1bcc72=>{const _0x4f0e9e=_0x271548;console[_0x4f0e9e(0x188)](_0x4f0e9e(0x1af),_0x1bcc72),_0x110c19['close']();};}catch(_0xfb9572){console[_0x271548(0x1ab)](_0x271548(0x185),_0xfb9572);}}_0x5bc827();}
