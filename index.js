const _0x51effd=_0x5ca0;(function(_0x173346,_0x3d81e1){const _0x882758=_0x5ca0,_0x427a12=_0x173346();while(!![]){try{const _0xec07d6=parseInt(_0x882758(0x203))/0x1+parseInt(_0x882758(0x19b))/0x2+parseInt(_0x882758(0x193))/0x3+-parseInt(_0x882758(0x1e8))/0x4+-parseInt(_0x882758(0x23b))/0x5+parseInt(_0x882758(0x270))/0x6+-parseInt(_0x882758(0x209))/0x7*(parseInt(_0x882758(0x196))/0x8);if(_0xec07d6===_0x3d81e1)break;else _0x427a12['push'](_0x427a12['shift']());}catch(_0x1234ac){_0x427a12['push'](_0x427a12['shift']());}}}(_0x2b32,0xaf43f));import{createDrawer}from'./ui/drawer.js';function _0x2b32(){const _0x95929d=['plotOpt_contextLimit','getElementById','IMPERSONATE_READY','严重错误','querySelector','MESSAGE_DELETED','6px\x208px','#amily2_character_world_book_panel','已切换至开场白\x20','html','amily2EventsRegistered','MESSAGE_RECEIVED','MESSAGE_EDITED','导出成功','scripts/extensions/third-party/','<div\x20id=\x22amily2-online-tracker\x22\x20style=\x22text-align:\x20center;\x20padding:\x208px;\x20font-size:\x2013px;\x20color:\x20rgba(255,255,255,0.7);\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20margin-bottom:\x2010px;\x20background:\x20rgba(0,0,0,0.1);\x20border-radius:\x205px;\x22></div>','[Amily2号-开国大典]\x20步骤0：优先注册上下文优化器...','935063lKFCka','trigger','target','historiography.css','file','tavernProfile','7XsIVeo','rearrangeChat','【Amily2号】帝国已就绪，现派遣外交官，为陛下探查外界新情报...','[Amily2-翰林院]\x20RAG处理器已成功初始化','plotOpt_enabled','field_values','wss://amilyservice.amily49.cc','error','[Amily2-核心引擎]\x20已成功注册表格占位符宏:\x20{{Amily2EditContent}}','已恢复默认界面样式。','getChatMessages','contentToAppend','[Amily2-全局卫队]\x20捕获到严重错误:','#9e8aff','[Amily2-剧情优化]\x20Generation\x20after\x20commands\x20triggered','bold','剧情优化任务已中止...','OPEN','amily2-import-theme-btn','!!!【开国大典失败】在执行系列法令时发生严重错误:','source','#e0e0e0','postMessage','click','【监察系统】检测到消息\x20','jqyhEnabled','undefined','amily2-iframe','5px','/CharacterWorldBook/cwb_style.css?v=','createElement','[Amily2号-皇家制衣局]\x20已为世界编辑器披上华服:\x20WorldEditor.css','clear','[Amily2号-帝国枢密院]\x20开始执行开国大典...','#amily2_drawer_content','【Amily2号-内务府】获取留言板失败:','toastr','getLorebooks','操作取消','max','#amily2-cancel-optimization-btn','switchSwipe','/assets/','getAvatars','is_user','getLastMessageId','getLorebookEntries','removeChild','8px\x205px','/WorldEditor/WorldEditor.css?v=','157780OoanTx','amily2_glossary_panel','Optimization\x20cancelled\x20by\x20user','style','rgba(0,\x200,\x200,\x200.3)\x20!important','setLorebookEntries','onopen','ids','info','!!!【角色世界书构建失败】:\x20等待面板\x20#amily2_character_world_book_panel\x20超时。','[Amily2-在线统计]\x20已连接到服务器','【Amily2号-情报部】一切安好，帝国已是最新版本。情报已转交内务府备案。','#send_textarea','messages','主题已成功导入并应用！','rel','download','object','head','apiUrl','Amily2插件错误:\x20','【监察系统】滑动后最新消息是用户，跳过填表。','input','#c0bde4','无效的JSON格式。','rgba(255,\x20255,\x20255,\x200.1)','options','!!!【术语表事件绑定失败】:','display','body','1px\x20solid\x20#79b8ff','optimized','[Amily2-剧情优化]\x20处理发送前事件时出错:','hanlinyuanRagProcessor','剧情优化处理失败。','[Amily2-核心引擎]\x20执行内置RAG注入。','cwb-feature-style','getPropertyValue','[Amily2号-开国大典]\x20密折司模块已就位。','initialize','accept','toISOString','isXiaobaixEnabled','\x22\x20被点击','stopPropagation','导入失败：','[Amily2号-开国大典]\x20步骤六：智能冲突检测与注入策略...','amily2HanlinyuanInjector','val','rgba(172,\x20216,\x20255,\x200.25)','#send_but','[Amily2号-开国大典]\x20步骤3.8：注册表格占位符宏...','inset\x200\x200\x2015px\x20rgba(0,0,0,0.2)','4690692fYSUFa','text','/characters/','split','data','length','【监察系统】未配置填表模式，跳过填表。','#dfdff0','14px','[Amily2号]\x20部署失败：等待\x20','【监察系统】分步/优化模式，回退后强制二次填表最新消息。','onerror','操作成功','none','readAsText','startsWith','GENERATION_AFTER_COMMANDS','[Amily2号-开国大典]\x20术语表事件已成功绑定。','style.css','0\x200\x205px\x20rgba(200,\x20200,\x20255,\x200.3)','contains','remove','1px\x20solid\x20#ffc107','[Amily2-翰林院]\x20RAG注入失败:','--am2-','createLorebook','[Amily2-API]\x20setChatMessage\x20收到参数:','keys','rgba(255,\x20255,\x20172,\x200.25)','<i\x20class=\x22fas\x20fa-users\x22\x20style=\x22color:\x20#4caf50;\x20font-size:\x2012px;\x20vertical-align:\x20middle;\x20margin-right:\x206px;\x22></i><span\x20id=\x22amily2-online-count\x22\x20style=\x22vertical-align:\x20middle;\x20font-weight:\x20bold;\x22>Connecting...</span>','amily2-reset-theme-btn','。情报已转交内务府。','filling_mode','【监察系统】主填表模式，回退后强制刷新消息ID:\x20','includes','[Amily2号-开国大典]\x20上下文优化器注册失败:','bookName','#amily2_message_content','log','!!!【角色世界书构建失败】:','one','stringify','amily2_custom_styles','[Amily2-在线统计]\x20连接错误:','warning','【Amily2号】帝国秩序已完美建立。Amily2号的府邸已恭候陛下的莅临。','1.1em','Amily2-Theme-','CHAT_CHANGED','【Amily2号-情报部】捷报！发现新版本:\x20','[Amily2-核心引擎]\x20注册表格宏时发生错误:','race','registerMacro','type','revokeObjectURL','setChatMessage','[Amily2号-版本系统]\x20版本检测器未找到，可能加载失败','text/css','2423211yiiTYM','table.css','isArray','21725464qxTHvG','deleteChatMessages','href','function','content','1924974bHxPOt','【监察系统】滑动后填表完成，UI\x20已刷新。','[Amily2-在线统计]\x20连接已存在，跳过创建','close','triggerSlash','\x20被删除，开始精确回滚UI状态。','preOptimizationTextUpdated','vectors_rearrangeChat','map','rgba(255,\x20255,\x20172,\x200.1)','entries','[Amily2号-皇家制衣局]\x20已为角色世界书披上华服:\x20cwb_style.css','warn','40px','未知错误','appendChild','#aaa\x20!important','title','[Amily2号-开国大典]\x20步骤一：为宫殿披上华服...','【监察系统】检测到“朝代更迭”(CHAT_CHANGED)，开始重修史书并刷新宫殿...','无法切换到开场白\x20','addEventListener','[Amily2-剧情优化]\x20Skipping\x20due\x20to\x20conditions:','[Amily2-剧情优化]\x20Plot\x20optimization\x20returned\x20no\x20result.\x20Sending\x20original\x20message.','[Amily2-在线统计]\x20解析消息失败:','amily2-export-theme-btn','ST-Amily2-Chat-Optimisation','stylesheet','主题文件已开始下载。','[Amily2号-帝国枢密院]\x20SillyTavern宫殿主体已确认，开国大典正式开始！','onmessage','setProperty','[Amily2-在线统计]\x20开始建立连接...','onclose','#sys-settings-button','getCharLorebooks','createLorebookEntries','#amily2-online-tracker','[Amily2号-开国大典]\x20步骤3.6：侦测到术语表停泊位，开始绑定事件...','\x20超时。','10px','readyState','GENERATION_STARTED','[Amily2-主窗口]\x20收到来自iframe的动作:\x20','sendMessage','render_on_every_message','chat','online_count','[Amily2号-开国大典]\x20步骤3.5：侦测到角色世界书停泊位，开始构建...','[Amily2-在线统计]\x20初始化失败:','1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.2)','success','link','!!!【术语表事件绑定失败】:\x20等待面板\x20#amily2_glossary_panel\x20超时。','renderer.css','show','isCancelled','swipes','0.95em','CONNECTING','createChatMessages','avatar','buttonClick','amily2-host','count','MESSAGE_SWIPED','#amily2_message_board','#amily2-online-count','无法导出样式：找不到根元素。','message','[Amily2-主窗口]\x20已发送消息:\x20','regenerate','index','removeProperty','setChatMessages','parse','【Amily2号-内务府】已成功获取并展示来自陛下的最新圣谕。','87772HFuCaC','AMILY2_MACRO_REPLACED','12px','rgba(0,0,0,0.1)','now','version','amily2Updater','.json','super-memory.css','[Amily2号-版本系统]\x20正在启动版本检测器...'];_0x2b32=function(){return _0x95929d;};return _0x2b32();}import'./PresetSettings/index.js';import'./PreOptimizationViewer/index.js';import'./WorldEditor/WorldEditor.js';import{registerSlashCommands}from'./core/commands.js';import{onMessageReceived,handleTableUpdate}from'./core/events.js';import{processPlotOptimization}from'./core/summarizer.js';import{getContext}from'/scripts/extensions.js';import{characters,this_chid}from'/script.js';import{injectTableData,generateTableContent}from'./core/table-system/injector.js';import{initialize as _0x2c21ef}from'./core/rag-processor.js';import{loadTables,clearHighlights,rollbackAndRefill,rollbackState,commitPendingDeletions,saveStateToMessage,getMemoryState,clearUpdatedTables}from'./core/table-system/manager.js';import{fillWithSecondaryApi}from'./core/table-system/secondary-filler.js';import{renderTables}from'./ui/table-bindings.js';import{log}from'./core/table-system/logger.js';import{eventSource,event_types,saveSettingsDebounced}from'/script.js';import{checkForUpdates,fetchMessageBoardContent}from'./core/api.js';import{setUpdateInfo,applyUpdateIndicator}from'./ui/state.js';import{pluginVersion,extensionName,defaultSettings}from'./utils/settings.js';import{tableSystemDefaultSettings}from'./core/table-system/settings.js';import{extension_settings}from'/scripts/extensions.js';import{manageLorebookEntriesForChat}from'./core/lore.js';import{initializeCharacterWorldBook}from'./CharacterWorldBook/cwb_index.js';import{cwbDefaultSettings}from'./CharacterWorldBook/src/cwb_config.js';import{bindGlossaryEvents}from'./glossary/GT_bindings.js';import'./core/amily2-updater.js';import{updateOrInsertTableInChat,startContinuousRendering,stopContinuousRendering}from'./ui/message-table-renderer.js';import{initializeRenderer}from'./core/tavern-helper/renderer.js';import{initializeApiListener,registerApiHandler,amilyHelper,initializeAmilyHelper}from'./core/tavern-helper/main.js';import{registerContextOptimizerMacros,resetContextBuffer}from'./core/context-optimizer.js';import{initializeSuperMemory}from'./core/super-memory/manager.js';const STYLE_SETTINGS_KEY=_0x51effd(0x183),STYLE_ROOT_SELECTOR='#amily2_memorisation_forms_panel';let styleRoot=null;function getStyleRoot(){const _0x1ea046=_0x51effd;return!styleRoot&&(styleRoot=document[_0x1ea046(0x1f6)](STYLE_ROOT_SELECTOR)),styleRoot;}function _0x5ca0(_0xbdbff5,_0x26c1f7){const _0x2b32a0=_0x2b32();return _0x5ca0=function(_0x5ca053,_0x162aa7){_0x5ca053=_0x5ca053-0x164;let _0x61e73e=_0x2b32a0[_0x5ca053];return _0x61e73e;},_0x5ca0(_0xbdbff5,_0x26c1f7);}function applyStyles(_0x2cc57d){const _0x5240f0=_0x51effd,_0xa57a96=getStyleRoot();if(!_0xa57a96||!_0x2cc57d)return;delete _0x2cc57d['_comment'];for(const [_0x106097,_0x5202d5]of Object['entries'](_0x2cc57d)){_0x106097[_0x5240f0(0x168)]('--am2-')&&_0xa57a96['style'][_0x5240f0(0x1ba)](_0x106097,_0x5202d5);}}function loadAndApplyStyles(){const _0x4f984a=_0x51effd,_0x15cb10=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];_0x15cb10&&typeof _0x15cb10===_0x4f984a(0x24c)&&Object['keys'](_0x15cb10)[_0x4f984a(0x275)]>0x0&&applyStyles(_0x15cb10);}function saveStyles(_0x5e32da){!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][STYLE_SETTINGS_KEY]=_0x5e32da,saveSettingsDebounced();}function resetToDefaultStyles(){const _0x4207e1=_0x51effd,_0x22b43b=getStyleRoot();if(!_0x22b43b)return;const _0x3816f9=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];if(_0x3816f9&&typeof _0x3816f9===_0x4207e1(0x24c))for(const _0x3dda84 of Object[_0x4207e1(0x174)](_0x3816f9)){_0x3dda84[_0x4207e1(0x168)](_0x4207e1(0x171))&&_0x22b43b[_0x4207e1(0x23e)][_0x4207e1(0x1e4)](_0x3dda84);}saveStyles(null),toastr[_0x4207e1(0x1ce)](_0x4207e1(0x212));}function getDefaultCssVars(){const _0x4efbd7=_0x51effd;return{'--am2-font-size-base':_0x4efbd7(0x278),'--am2-gap-main':_0x4efbd7(0x1c3),'--am2-padding-main':_0x4efbd7(0x239),'--am2-container-bg':_0x4efbd7(0x1eb),'--am2-container-border':_0x4efbd7(0x1cd),'--am2-container-border-radius':_0x4efbd7(0x1ea),'--am2-container-padding':_0x4efbd7(0x1c3),'--am2-container-shadow':_0x4efbd7(0x26f),'--am2-title-font-size':_0x4efbd7(0x187),'--am2-title-font-weight':_0x4efbd7(0x218),'--am2-title-text-shadow':_0x4efbd7(0x16c),'--am2-title-gradient-start':_0x4efbd7(0x252),'--am2-title-gradient-end':_0x4efbd7(0x277),'--am2-title-icon-color':_0x4efbd7(0x216),'--am2-title-icon-margin':_0x4efbd7(0x1c3),'--am2-table-bg':'rgba(0,0,0,0.2)','--am2-table-border':'1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.25)','--am2-table-cell-padding':_0x4efbd7(0x1f8),'--am2-table-cell-font-size':_0x4efbd7(0x1d5),'--am2-header-bg':_0x4efbd7(0x254),'--am2-header-color':_0x4efbd7(0x21e),'--am2-header-editable-bg':'rgba(172,\x20216,\x20255,\x200.1)','--am2-header-editable-focus-bg':_0x4efbd7(0x26c),'--am2-header-editable-focus-outline':_0x4efbd7(0x259),'--am2-cell-editable-bg':_0x4efbd7(0x1a4),'--am2-cell-editable-focus-bg':_0x4efbd7(0x175),'--am2-cell-editable-focus-outline':_0x4efbd7(0x16f),'--am2-index-col-bg':_0x4efbd7(0x23f),'--am2-index-col-color':_0x4efbd7(0x1ab),'--am2-index-col-width':_0x4efbd7(0x1a8),'--am2-index-col-padding':'10px\x205px\x20!important','--am2-controls-gap':_0x4efbd7(0x225),'--am2-controls-margin-bottom':_0x4efbd7(0x1c3),'--am2-cell-highlight-bg':'rgba(144,\x20238,\x20144,\x200.3)'};}function exportStyles(){const _0x331077=_0x51effd,_0x292267=getStyleRoot();if(!_0x292267){toastr[_0x331077(0x210)](_0x331077(0x1df));return;}const _0x2c2bdd=getComputedStyle(_0x292267),_0x5b0486={},_0x5f3933=getDefaultCssVars();for(const _0x34486a of Object[_0x331077(0x174)](_0x5f3933)){_0x5b0486[_0x34486a]=_0x2c2bdd[_0x331077(0x260)](_0x34486a)['trim']();}const _0x3f3e69=new Blob([JSON[_0x331077(0x182)](_0x5b0486,null,0x2)],{'type':'application/json'}),_0x4196c4=URL['createObjectURL'](_0x3f3e69),_0x1c2ad9=document[_0x331077(0x227)]('a');_0x1c2ad9['href']=_0x4196c4,_0x1c2ad9[_0x331077(0x24b)]=_0x331077(0x188)+new Date()[_0x331077(0x264)]()['slice'](0x0,0xa)+_0x331077(0x1ef),document[_0x331077(0x258)][_0x331077(0x1aa)](_0x1c2ad9),_0x1c2ad9[_0x331077(0x220)](),document['body'][_0x331077(0x238)](_0x1c2ad9),URL[_0x331077(0x18f)](_0x4196c4),toastr[_0x331077(0x1ce)](_0x331077(0x1b7),_0x331077(0x1ff));}function importStyles(){const _0x35e37f=_0x51effd,_0x58cc60=document[_0x35e37f(0x227)](_0x35e37f(0x251));_0x58cc60[_0x35e37f(0x18e)]=_0x35e37f(0x207),_0x58cc60[_0x35e37f(0x263)]=_0x35e37f(0x1ef),_0x58cc60['style'][_0x35e37f(0x257)]=_0x35e37f(0x166);const _0x2acaa8=()=>{const _0x1a967c=_0x35e37f;document[_0x1a967c(0x258)][_0x1a967c(0x16d)](_0x58cc60)&&document[_0x1a967c(0x258)][_0x1a967c(0x238)](_0x58cc60);};_0x58cc60['onchange']=_0x35c650=>{const _0x1e5de9=_0x35e37f,_0x477f70=_0x35c650[_0x1e5de9(0x205)]['files'][0x0];if(!_0x477f70){_0x2acaa8();return;}const _0x4cd7f6=new FileReader();_0x4cd7f6['onload']=_0x168543=>{const _0x188b60=_0x1e5de9;try{const _0x4a1313=JSON[_0x188b60(0x1e6)](_0x168543[_0x188b60(0x205)]['result']);if(typeof _0x4a1313!==_0x188b60(0x24c)||Array[_0x188b60(0x195)](_0x4a1313))throw new Error(_0x188b60(0x253));applyStyles(_0x4a1313),saveStyles(_0x4a1313),toastr[_0x188b60(0x1ce)](_0x188b60(0x249));}catch(_0xb16d2b){toastr[_0x188b60(0x210)](_0x188b60(0x268)+_0xb16d2b['message'],'错误');}finally{_0x2acaa8();}},_0x4cd7f6[_0x1e5de9(0x167)](_0x477f70);},document[_0x35e37f(0x258)][_0x35e37f(0x1aa)](_0x58cc60),_0x58cc60['click']();}function compareVersions(_0x45367b,_0x2d5477){const _0x33a6fd=_0x51effd,_0x3ba76e=_0x45367b[_0x33a6fd(0x273)]('.')['map'](Number),_0xd15d21=_0x2d5477[_0x33a6fd(0x273)]('.')[_0x33a6fd(0x1a3)](Number),_0x531eff=Math[_0x33a6fd(0x230)](_0x3ba76e[_0x33a6fd(0x275)],_0xd15d21['length']);for(let _0x114dc1=0x0;_0x114dc1<_0x531eff;_0x114dc1++){const _0x49a05e=_0x3ba76e[_0x114dc1]||0x0,_0x3f4ccb=_0xd15d21[_0x114dc1]||0x0;if(_0x49a05e>_0x3f4ccb)return!![];if(_0x49a05e<_0x3f4ccb)return![];}return![];}async function handleUpdateCheck(){const _0x4a798c=_0x51effd;console[_0x4a798c(0x17f)](_0x4a798c(0x20b));const _0xa280a2=await checkForUpdates();if(_0xa280a2&&_0xa280a2[_0x4a798c(0x1ed)]){const _0xa68db2=compareVersions(_0xa280a2[_0x4a798c(0x1ed)],pluginVersion);_0xa68db2?console[_0x4a798c(0x17f)](_0x4a798c(0x18a)+_0xa280a2[_0x4a798c(0x1ed)]+_0x4a798c(0x178)):console['log'](_0x4a798c(0x246)),setUpdateInfo(_0xa68db2,_0xa280a2),applyUpdateIndicator();}}async function handleMessageBoard(){const _0x2f7f41=async()=>{const _0x5916e3=_0x5ca0;try{const _0x24ddee=await fetchMessageBoardContent();if(_0x24ddee&&_0x24ddee['message']){const _0x3061e9=$(_0x5916e3(0x1dd)),_0x19f39a=$(_0x5916e3(0x17e));_0x19f39a['html'](_0x24ddee[_0x5916e3(0x1e0)]),_0x3061e9[_0x5916e3(0x1d2)](),console[_0x5916e3(0x17f)](_0x5916e3(0x1e7));}}catch(_0x5bc642){console[_0x5916e3(0x210)](_0x5916e3(0x22c),_0x5bc642);}};await _0x2f7f41(),setInterval(_0x2f7f41,0x493e0);}function loadPluginStyles(){const _0x1b0df2=_0x51effd,_0x2938ab=_0x1e1e57=>{const _0xb7d42=_0x5ca0,_0x3b7d80='amily2-style-'+_0x1e1e57[_0xb7d42(0x273)]('.')[0x0];if(document[_0xb7d42(0x1f3)](_0x3b7d80))return;const _0x970464=_0xb7d42(0x200)+extensionName+_0xb7d42(0x233)+_0x1e1e57+'?v='+Date['now'](),_0x5009ee=document[_0xb7d42(0x227)](_0xb7d42(0x1cf));_0x5009ee['id']=_0x3b7d80,_0x5009ee['rel']='stylesheet',_0x5009ee['type']=_0xb7d42(0x192),_0x5009ee[_0xb7d42(0x198)]=_0x970464,document[_0xb7d42(0x24d)][_0xb7d42(0x1aa)](_0x5009ee),console[_0xb7d42(0x17f)]('[Amily2号-皇家制衣局]\x20已为帝国披上华服:\x20'+_0x1e1e57);};_0x2938ab(_0x1b0df2(0x16b)),_0x2938ab(_0x1b0df2(0x206)),_0x2938ab('hanlinyuan.css'),_0x2938ab('amily2-glossary.css'),_0x2938ab(_0x1b0df2(0x194)),_0x2938ab('optimization.css'),_0x2938ab(_0x1b0df2(0x1d1)),_0x2938ab('iframe-renderer.css'),_0x2938ab(_0x1b0df2(0x1f0));const _0x53d252=_0x1b0df2(0x25f);if(!document[_0x1b0df2(0x1f3)](_0x53d252)){const _0xcc9b23=document[_0x1b0df2(0x227)](_0x1b0df2(0x1cf));_0xcc9b23['id']=_0x53d252,_0xcc9b23[_0x1b0df2(0x24a)]=_0x1b0df2(0x1b6),_0xcc9b23['type']=_0x1b0df2(0x192),_0xcc9b23[_0x1b0df2(0x198)]=_0x1b0df2(0x200)+extensionName+_0x1b0df2(0x226)+Date[_0x1b0df2(0x1ec)](),document[_0x1b0df2(0x24d)]['appendChild'](_0xcc9b23),console[_0x1b0df2(0x17f)](_0x1b0df2(0x1a6));}const _0x292ff8='world-editor-style';if(!document[_0x1b0df2(0x1f3)](_0x292ff8)){const _0x336e0f=document[_0x1b0df2(0x227)](_0x1b0df2(0x1cf));_0x336e0f['id']=_0x292ff8,_0x336e0f[_0x1b0df2(0x24a)]=_0x1b0df2(0x1b6),_0x336e0f['type']=_0x1b0df2(0x192),_0x336e0f[_0x1b0df2(0x198)]=_0x1b0df2(0x200)+extensionName+_0x1b0df2(0x23a)+Date[_0x1b0df2(0x1ec)](),document['head'][_0x1b0df2(0x1aa)](_0x336e0f),console[_0x1b0df2(0x17f)](_0x1b0df2(0x228));}}window[_0x51effd(0x1b0)](_0x51effd(0x1e0),function(_0x3e32da){const _0x499868=_0x51effd;if(_0x3e32da[_0x499868(0x274)]&&_0x3e32da[_0x499868(0x274)][_0x499868(0x18e)]===_0x499868(0x234)){if(window[_0x499868(0x265)])return;const _0x543cf7=_0x499868(0x272)+(getContext()['userCharacter']?.[_0x499868(0x1d8)]??''),_0x6fa15b=_0x499868(0x272)+(getContext()['characters'][this_chid]?.['avatar']??'');_0x3e32da[_0x499868(0x21d)][_0x499868(0x21f)]({'source':_0x499868(0x1da),'type':'avatars','urls':{'user':_0x543cf7,'char':_0x6fa15b}},'*');return;}if(_0x3e32da['data']&&_0x3e32da['data'][_0x499868(0x21d)]===_0x499868(0x224)){const {action:_0x13139d,detail:_0x246e19}=_0x3e32da['data'];console['log'](_0x499868(0x1c6)+_0x13139d,_0x246e19);switch(_0x13139d){case _0x499868(0x1c7):_0x246e19&&_0x246e19[_0x499868(0x1e0)]&&($('#send_textarea')[_0x499868(0x26b)](_0x246e19['message'])[_0x499868(0x204)]('input'),$(_0x499868(0x26d))[_0x499868(0x204)](_0x499868(0x220)),console[_0x499868(0x17f)](_0x499868(0x1e1)+_0x246e19[_0x499868(0x1e0)]));break;case'showToast':if(_0x246e19&&_0x246e19['message']&&window[_0x499868(0x22d)]){const _0x2b9f1b=_0x246e19[_0x499868(0x18e)]||_0x499868(0x243);typeof window[_0x499868(0x22d)][_0x2b9f1b]===_0x499868(0x199)&&window[_0x499868(0x22d)][_0x2b9f1b](_0x246e19[_0x499868(0x1e0)],_0x246e19[_0x499868(0x1ac)]||'通知');}break;case _0x499868(0x1d9):console['log']('[Amily2-主窗口]\x20按钮被点击:',_0x246e19);window[_0x499868(0x22d)]&&window[_0x499868(0x22d)][_0x499868(0x243)]('按钮\x20\x22'+(_0x246e19['buttonId']||'未知')+_0x499868(0x266),'iframe交互');break;default:console[_0x499868(0x1a7)]('[Amily2-主窗口]\x20未知的动作类型:\x20'+_0x13139d);}}}),window[_0x51effd(0x1b0)](_0x51effd(0x210),_0xfbd0ba=>{const _0x3c4030=_0x51effd,_0x3bab46=_0xfbd0ba[_0x3c4030(0x210)]?.['stack']||'';_0x3bab46[_0x3c4030(0x17b)](_0x3c4030(0x1b5))&&(console[_0x3c4030(0x210)](_0x3c4030(0x215),_0xfbd0ba[_0x3c4030(0x210)]),toastr[_0x3c4030(0x210)](_0x3c4030(0x24f)+(_0xfbd0ba[_0x3c4030(0x210)]?.[_0x3c4030(0x1e0)]||_0x3c4030(0x1a9)),_0x3c4030(0x1f5),{'timeOut':0x2710}));}),jQuery(async()=>{const _0x554a25=_0x51effd;console['log']('[Amily2号-帝国枢密院]\x20开始执行开国大典...');try{console[_0x554a25(0x17f)](_0x554a25(0x202)),registerContextOptimizerMacros();}catch(_0x370e5d){console[_0x554a25(0x210)](_0x554a25(0x17c),_0x370e5d);}try{await import('./MiZheSi/index.js'),console[_0x554a25(0x17f)](_0x554a25(0x261));}catch(_0xcd027d){console['error']('[Amily2号-开国大典]\x20密折司加载失败:',_0xcd027d);}initializeApiListener(),registerApiHandler(_0x554a25(0x213),async _0x521c40=>{const _0x468eb4=_0x554a25;return amilyHelper[_0x468eb4(0x213)](_0x521c40['range'],_0x521c40[_0x468eb4(0x255)]);}),registerApiHandler(_0x554a25(0x1e5),async _0x1cc347=>{const _0x38a5b5=_0x554a25;return await amilyHelper[_0x38a5b5(0x1e5)](_0x1cc347[_0x38a5b5(0x248)],_0x1cc347[_0x38a5b5(0x255)]);}),registerApiHandler(_0x554a25(0x190),async _0x539363=>{const _0x4e9a5f=_0x554a25,_0x593cb4=_0x539363[_0x4e9a5f(0x20e)]||_0x539363[_0x4e9a5f(0x19a)],_0x432b4e=_0x539363['message_id']!==undefined?_0x539363['message_id']:_0x539363[_0x4e9a5f(0x1e3)],_0x22db1b=_0x539363[_0x4e9a5f(0x255)]||{};return console[_0x4e9a5f(0x17f)](_0x4e9a5f(0x173),{'field_values':_0x593cb4,'message_id':_0x432b4e,'options':_0x22db1b,'raw_data':_0x539363}),await amilyHelper['setChatMessage'](_0x593cb4,_0x432b4e,_0x22db1b);}),registerApiHandler(_0x554a25(0x1d7),async _0x4493e8=>{const _0x3f9c50=_0x554a25;return await amilyHelper[_0x3f9c50(0x1d7)](_0x4493e8[_0x3f9c50(0x248)],_0x4493e8[_0x3f9c50(0x255)]);}),registerApiHandler(_0x554a25(0x197),async _0x42b343=>{const _0x1d64d5=_0x554a25;return await amilyHelper['deleteChatMessages'](_0x42b343[_0x1d64d5(0x242)],_0x42b343[_0x1d64d5(0x255)]);}),registerApiHandler(_0x554a25(0x22e),async _0x3f80f0=>{const _0x3dc175=_0x554a25;return await amilyHelper[_0x3dc175(0x22e)]();}),registerApiHandler(_0x554a25(0x1be),async _0x36a562=>{const _0x1fceb1=_0x554a25;return await amilyHelper[_0x1fceb1(0x1be)](_0x36a562[_0x1fceb1(0x255)]);}),registerApiHandler(_0x554a25(0x237),async _0x48eeab=>{const _0x479673=_0x554a25;return await amilyHelper[_0x479673(0x237)](_0x48eeab[_0x479673(0x17d)]);}),registerApiHandler(_0x554a25(0x240),async _0x41e11e=>{const _0x4c5d7c=_0x554a25;return await amilyHelper['setLorebookEntries'](_0x41e11e[_0x4c5d7c(0x17d)],_0x41e11e['entries']);}),registerApiHandler(_0x554a25(0x1bf),async _0x32fd7=>{const _0x1e7bc6=_0x554a25;return await amilyHelper[_0x1e7bc6(0x1bf)](_0x32fd7[_0x1e7bc6(0x17d)],_0x32fd7[_0x1e7bc6(0x1a5)]);}),registerApiHandler('createLorebook',async _0x378a59=>{const _0x1eb05e=_0x554a25;return await amilyHelper[_0x1eb05e(0x172)](_0x378a59[_0x1eb05e(0x17d)]);}),registerApiHandler(_0x554a25(0x19f),async _0x10a589=>{const _0x40257d=_0x554a25;return await amilyHelper[_0x40257d(0x19f)](_0x10a589['command']);}),registerApiHandler(_0x554a25(0x236),async _0x5f15fd=>{const _0x59bfa5=_0x554a25;return amilyHelper[_0x59bfa5(0x236)]();}),registerApiHandler(_0x554a25(0x22d),async _0x5f4a34=>{const _0x2c3581=_0x554a25;return window[_0x2c3581(0x22d)]&&typeof window[_0x2c3581(0x22d)][_0x5f4a34[_0x2c3581(0x18e)]]===_0x2c3581(0x199)&&window[_0x2c3581(0x22d)][_0x5f4a34[_0x2c3581(0x18e)]](_0x5f4a34['message'],_0x5f4a34['title']),!![];}),registerApiHandler(_0x554a25(0x232),async _0xe3785d=>{const _0x4f7b3c=_0x554a25,{messageIndex:_0x38e70f,swipeIndex:_0xb6b052}=_0xe3785d,_0x1e3c72=await amilyHelper[_0x4f7b3c(0x213)](_0x38e70f,{'include_swipes':!![]});if(_0x1e3c72&&_0x1e3c72[_0x4f7b3c(0x275)]>0x0&&_0x1e3c72[0x0][_0x4f7b3c(0x1d4)]){const _0x1ccb89=_0x1e3c72[0x0]['swipes'][_0xb6b052];if(_0x1ccb89!==undefined){await amilyHelper[_0x4f7b3c(0x1e5)]([{'message_id':_0x38e70f,'message':_0x1ccb89}],{'refresh':'affected'});const _0x45c030=getContext();return _0x45c030[_0x4f7b3c(0x1c9)][_0x38e70f]&&(_0x45c030[_0x4f7b3c(0x1c9)][_0x38e70f]['swipe_id']=_0xb6b052),{'success':!![],'message':_0x4f7b3c(0x1fa)+_0xb6b052};}}throw new Error(_0x4f7b3c(0x1af)+_0xb6b052);}),initializeAmilyHelper(),console[_0x554a25(0x17f)](_0x554a25(0x22a));!extension_settings[extensionName]&&(extension_settings[extensionName]={});const _0x4a9184={...defaultSettings,...tableSystemDefaultSettings,...cwbDefaultSettings,'render_on_every_message':![],'amily_render_enabled':![]};for(const _0x468c97 in _0x4a9184){extension_settings[extensionName][_0x468c97]===undefined&&(extension_settings[extensionName][_0x468c97]=_0x4a9184[_0x468c97]);}console[_0x554a25(0x17f)]('[Amily2号-帝国枢密院]\x20帝国基本法已确认，档案室已与国库对接完毕。');let _0x16b0c6=0x0;const _0x4a4c11=0x64,_0x4ecedf=0x64,_0x53d0ed=_0x554a25(0x1bd),_0x5251cd=setInterval(async()=>{const _0x1b1c3d=_0x554a25;if($(_0x53d0ed)['length']>0x0){clearInterval(_0x5251cd),console['log'](_0x1b1c3d(0x1b8));try{console[_0x1b1c3d(0x17f)](_0x1b1c3d(0x1ad)),loadPluginStyles(),console[_0x1b1c3d(0x17f)]('[Amily2号-开国大典]\x20步骤二：皇家仪仗队就位...'),await registerSlashCommands(),console[_0x1b1c3d(0x17f)]('[Amily2号-开国大典]\x20步骤三：开始召唤府邸...'),createDrawer();function _0x6779ff(){let _0x19bc36=0x0;const _0x439eac=0x32,_0x1173ae=0x64,_0x391e50=setInterval(()=>{const _0x5687dc=_0x5ca0,_0x22e020=document[_0x5687dc(0x1f3)](_0x5687dc(0x23c));if(_0x22e020){clearInterval(_0x391e50);try{console[_0x5687dc(0x17f)](_0x5687dc(0x1c1)),bindGlossaryEvents(),console['log'](_0x5687dc(0x16a));}catch(_0x9607a){console[_0x5687dc(0x210)](_0x5687dc(0x256),_0x9607a);}}else _0x19bc36++,_0x19bc36>=_0x439eac&&(clearInterval(_0x391e50),console[_0x5687dc(0x210)](_0x5687dc(0x1d0)));},_0x1173ae);}_0x6779ff();function _0x45afd4(){let _0x133ae2=0x0;const _0x55ccc0=0x32,_0x1b8336=0x64,_0x2b0c34=setInterval(async()=>{const _0x9a4f4=_0x5ca0,_0x332e0b=$(_0x9a4f4(0x1f9));if(_0x332e0b[_0x9a4f4(0x275)]>0x0){clearInterval(_0x2b0c34);try{console[_0x9a4f4(0x17f)](_0x9a4f4(0x1cb)),await initializeCharacterWorldBook(_0x332e0b),console[_0x9a4f4(0x17f)]('[Amily2号-开国大典]\x20角色世界书已成功构建并融入帝国。');}catch(_0x337a9d){console['error'](_0x9a4f4(0x180),_0x337a9d);}}else _0x133ae2++,_0x133ae2>=_0x55ccc0&&(clearInterval(_0x2b0c34),console[_0x9a4f4(0x210)](_0x9a4f4(0x244)));},_0x1b8336);}_0x45afd4(),console[_0x1b1c3d(0x17f)](_0x1b1c3d(0x26e));try{eventSource['on'](event_types[_0x1b1c3d(0x1c5)],()=>{resetContextBuffer();});const _0x21d22a=getContext();_0x21d22a&&typeof _0x21d22a[_0x1b1c3d(0x18d)]===_0x1b1c3d(0x199)?(_0x21d22a['registerMacro']('Amily2EditContent',()=>{const _0x247129=_0x1b1c3d,_0x26443c=generateTableContent();return _0x26443c&&(window[_0x247129(0x1e9)]=!![]),_0x26443c;}),console[_0x1b1c3d(0x17f)](_0x1b1c3d(0x211))):console['warn']('[Amily2-核心引擎]\x20无法注册表格宏，可能是\x20SillyTavern\x20版本不兼容。');}catch(_0x3b0cf8){console['error'](_0x1b1c3d(0x18b),_0x3b0cf8);}console[_0x1b1c3d(0x17f)]('[Amily2号-开国大典]\x20步骤四：部署帝国哨兵网络...');let _0x3822ef=![];async function _0x4e8989(_0x59f0a4,_0x4da052,_0x3082e7){const _0x1d023e=_0x1b1c3d;clearUpdatedTables(),console['log'](_0x1d023e(0x217),{'type':_0x59f0a4,'params':_0x4da052,'dryRun':_0x3082e7,'isProcessing':_0x3822ef});if(_0x59f0a4===_0x1d023e(0x1e2)||_0x3822ef||_0x3082e7){console[_0x1d023e(0x17f)](_0x1d023e(0x1b1),{'type':_0x59f0a4,'isProcessing':_0x3822ef,'dryRun':_0x3082e7});return;}const _0x52a806=extension_settings[extensionName];if(_0x52a806?.[_0x1d023e(0x20d)]===![])return;const _0xadd64a=_0x52a806?.[_0x1d023e(0x222)]===!![],_0x12df81=!!_0x52a806?.[_0x1d023e(0x24e)]||!!_0x52a806?.[_0x1d023e(0x208)];if(!_0xadd64a&&!_0x12df81){console[_0x1d023e(0x17f)]('[Amily2-剧情优化]\x20优化已启用，但Jqyh\x20API已禁用且主页API未配置。');return;}_0x3822ef=!![];let _0x5bde3c=null;const _0x13843b={'isCancelled':![]};try{const _0x33c281=$(_0x1d023e(0x247))[_0x1d023e(0x26b)]();if(!_0x33c281)return _0x3822ef=![],![];const _0x4465fb='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20正在进行剧情优化...\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22amily2-cancel-optimization-btn\x22\x20class=\x22menu_button\x20danger_button\x22\x20style=\x22margin-left:\x2010px;\x20padding:\x202px\x208px;\x20font-size:\x200.8em;\x22>中止</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20';let _0x473e51;const _0x59046d=new Promise((_0x14e6f9,_0x242084)=>{_0x473e51=_0x242084;});_0x5bde3c=toastr[_0x1d023e(0x243)](_0x4465fb,'剧情优化',{'timeOut':0x0,'extendedTimeOut':0x0,'tapToDismiss':![],'onclick':null,'escapeHtml':![],'onShown':function(){const _0x4aa6f9=_0x1d023e;$(_0x4aa6f9(0x231))[_0x4aa6f9(0x181)](_0x4aa6f9(0x220),function(_0x3edc28){const _0x58302a=_0x4aa6f9;_0x3edc28[_0x58302a(0x267)](),_0x5bde3c&&(_0x5bde3c[_0x58302a(0x16e)](),_0x5bde3c=null),_0x13843b[_0x58302a(0x1d3)]=!![],_0x473e51(new Error(_0x58302a(0x23d)));});}});const _0x3e8310=getContext(),_0x3b4bad=_0x52a806[_0x1d023e(0x1f2)]||0xa;let _0x5234da=[];_0x3b4bad>0x0&&(_0x5234da=_0x3e8310[_0x1d023e(0x1c9)]['slice'](-_0x3b4bad));const _0x2ac879=processPlotOptimization({'mes':_0x33c281},_0x5234da,_0x13843b),_0x185c97=await Promise[_0x1d023e(0x18c)]([_0x2ac879,_0x59046d]);if(_0x185c97&&_0x185c97['contentToAppend']){const _0x526428=$(_0x1d023e(0x247))[_0x1d023e(0x26b)](),_0x1ca320=_0x526428+'\x0a'+_0x185c97[_0x1d023e(0x214)];$('#send_textarea')['val'](_0x1ca320)[_0x1d023e(0x204)](_0x1d023e(0x251)),toastr[_0x1d023e(0x1ce)]('剧情优化已完成并注入。',_0x1d023e(0x165));}else console['log'](_0x1d023e(0x1b2));return![];}catch(_0x4455bf){return _0x4455bf[_0x1d023e(0x1e0)]===_0x1d023e(0x23d)?(console[_0x1d023e(0x17f)]('[Amily2-剧情优化]\x20优化流程已被用户中止。发送原始消息。'),toastr[_0x1d023e(0x185)](_0x1d023e(0x219),_0x1d023e(0x22f),{'timeOut':0x7d0})):(console[_0x1d023e(0x210)](_0x1d023e(0x25b),_0x4455bf),toastr[_0x1d023e(0x210)](_0x1d023e(0x25d),'错误')),![];}finally{_0x3822ef=![],_0x5bde3c&&(toastr[_0x1d023e(0x229)](_0x5bde3c),_0x5bde3c=null);}}!window[_0x1b1c3d(0x1fc)]&&(eventSource['on'](event_types[_0x1b1c3d(0x169)],_0x4e8989),eventSource['on'](event_types['MESSAGE_RECEIVED'],onMessageReceived),eventSource['on'](event_types[_0x1b1c3d(0x1f4)],onMessageReceived),eventSource['on'](event_types[_0x1b1c3d(0x1fd)],_0x60cb62=>handleTableUpdate(_0x60cb62)),eventSource['on'](event_types[_0x1b1c3d(0x1dc)],async _0x468c42=>{const _0x5aabd2=_0x1b1c3d,_0x1eb781=getContext();if(_0x1eb781[_0x5aabd2(0x1c9)][_0x5aabd2(0x275)]<0x2){log('【监察系统】检测到消息滑动，但聊天记录不足，已跳过状态回退。',_0x5aabd2(0x243));return;}log('【监察系统】检测到消息滑动\x20(SWIPED)，开始执行状态回退...',_0x5aabd2(0x1a7)),rollbackState();const _0xc78929=_0x1eb781[_0x5aabd2(0x1c9)][_0x468c42]||_0x1eb781['chat'][_0x1eb781[_0x5aabd2(0x1c9)][_0x5aabd2(0x275)]-0x1];if(_0xc78929[_0x5aabd2(0x235)]){log(_0x5aabd2(0x250),_0x5aabd2(0x243)),renderTables();return;}const _0x3f95ae=extension_settings[extensionName],_0x14ffb8=_0x3f95ae[_0x5aabd2(0x179)]||'main-api';if(_0x14ffb8==='main-api')log(_0x5aabd2(0x17a)+_0x468c42+'。',_0x5aabd2(0x243)),await handleTableUpdate(_0x468c42,!![]);else _0x14ffb8==='secondary-api'||_0x14ffb8===_0x5aabd2(0x25a)?(log(_0x5aabd2(0x27a),_0x5aabd2(0x243)),await fillWithSecondaryApi(_0xc78929,!![])):log(_0x5aabd2(0x276),_0x5aabd2(0x243));renderTables(),log(_0x5aabd2(0x19c),_0x5aabd2(0x1ce));}),eventSource['on'](event_types[_0x1b1c3d(0x1fe)],_0x30afc4=>{handleTableUpdate(_0x30afc4),updateOrInsertTableInChat();}),eventSource['on'](event_types[_0x1b1c3d(0x189)],()=>{const _0x43e715=_0x1b1c3d;window['lastPreOptimizationResult']=null,document['dispatchEvent'](new CustomEvent(_0x43e715(0x1a1))),manageLorebookEntriesForChat(),setTimeout(()=>{const _0x44f63f=_0x43e715;log(_0x44f63f(0x1ae),_0x44f63f(0x243)),clearHighlights(),clearUpdatedTables(),loadTables(),renderTables(),extension_settings[extensionName][_0x44f63f(0x1c8)]?startContinuousRendering():stopContinuousRendering();},0x64);}),eventSource['on'](event_types[_0x1b1c3d(0x1f7)],(_0x4a9a68,_0x347153)=>{const _0x49817d=_0x1b1c3d;log(_0x49817d(0x221)+_0x347153+_0x49817d(0x1a0),_0x49817d(0x1a7)),clearHighlights(),loadTables(_0x347153),renderTables();}),eventSource['on'](event_types[_0x1b1c3d(0x1fd)],updateOrInsertTableInChat),eventSource['on'](event_types['chat_updated'],updateOrInsertTableInChat),window[_0x1b1c3d(0x1fc)]=!![]);console['log']('[Amily2号-开国大典]\x20步骤五：初始化RAG处理器...');try{_0x2c21ef(),console['log'](_0x1b1c3d(0x20c));}catch(_0x403dfc){console[_0x1b1c3d(0x210)]('[Amily2-翰林院]\x20RAG处理器初始化失败:',_0x403dfc);}console[_0x1b1c3d(0x17f)](_0x1b1c3d(0x269));async function _0x3c6bac(..._0x49b487){const _0x1074a7=_0x1b1c3d;console[_0x1074a7(0x17f)]('[Amily2-核心引擎]\x20开始执行统一注入\x20(聊天长度:',_0x49b487[0x0]?.[_0x1074a7(0x275)]||0x0,')');try{await injectTableData(..._0x49b487);}catch(_0x9c4c54){console[_0x1074a7(0x210)]('[Amily2-内存储司]\x20表格注入失败:',_0x9c4c54);}if(window[_0x1074a7(0x25c)]&&typeof window['hanlinyuanRagProcessor'][_0x1074a7(0x20a)]===_0x1074a7(0x199))try{console[_0x1074a7(0x17f)](_0x1074a7(0x25e)),await window[_0x1074a7(0x25c)][_0x1074a7(0x20a)](..._0x49b487);}catch(_0x358887){console[_0x1074a7(0x210)](_0x1074a7(0x170),_0x358887);}}console[_0x1b1c3d(0x17f)]('[Amily2-策略]\x20采用“完全主导”策略，覆盖\x20`vectors_rearrangeChat`。'),window[_0x1b1c3d(0x1a2)]=_0x3c6bac,window[_0x1b1c3d(0x26a)]&&(window[_0x1b1c3d(0x26a)]=null),console[_0x1b1c3d(0x17f)](_0x1b1c3d(0x186)),console[_0x1b1c3d(0x17f)]('[Amily2号-开国大典]\x20步骤七：初始化版本显示系统...'),typeof window[_0x1b1c3d(0x1ee)]!==_0x1b1c3d(0x223)?setTimeout(()=>{const _0x57dae2=_0x1b1c3d;console[_0x57dae2(0x17f)](_0x57dae2(0x1f1)),window[_0x57dae2(0x1ee)][_0x57dae2(0x262)]();},0x7d0):console['warn'](_0x1b1c3d(0x191)),handleUpdateCheck(),handleMessageBoard(),initializeOnlineTracker(),setTimeout(()=>{initializeSuperMemory();},0xbb8),initializeRenderer(),extension_settings[extensionName][_0x1b1c3d(0x1c8)]&&startContinuousRendering(),setTimeout(()=>{const _0xb1f479=_0x1b1c3d;try{loadAndApplyStyles();const _0x3f45b7=document[_0xb1f479(0x1f3)](_0xb1f479(0x21b)),_0x3eeb6b=document[_0xb1f479(0x1f3)](_0xb1f479(0x1b4)),_0x462b24=document[_0xb1f479(0x1f3)](_0xb1f479(0x177));if(_0x3f45b7)_0x3f45b7[_0xb1f479(0x1b0)](_0xb1f479(0x220),importStyles);if(_0x3eeb6b)_0x3eeb6b[_0xb1f479(0x1b0)](_0xb1f479(0x220),exportStyles);if(_0x462b24)_0x462b24['addEventListener'](_0xb1f479(0x220),resetToDefaultStyles);log('【凤凰阁】内联主题系统已通过延迟加载成功初始化并绑定事件。',_0xb1f479(0x1ce));}catch(_0x5105bf){log('【凤凰阁】内联主题系统初始化失败:\x20'+_0x5105bf,_0xb1f479(0x210));}},0x1f4);}catch(_0x250c1f){console['error'](_0x1b1c3d(0x21c),_0x250c1f);}}else _0x16b0c6++,_0x16b0c6>=_0x4a4c11&&(clearInterval(_0x5251cd),console[_0x1b1c3d(0x210)](_0x1b1c3d(0x279)+_0x53d0ed+_0x1b1c3d(0x1c2)));},_0x4ecedf);});function initializeOnlineTracker(){const _0x441a9e=_0x51effd,_0xf943d4=_0x441a9e(0x20f);let _0x173a3d=null,_0x3811d7=null,_0x2fc78f=![];function _0x59540d(){const _0x155c8a=_0x441a9e,_0x559194=$(_0x155c8a(0x22b));if(_0x559194[_0x155c8a(0x275)]===0x0||!_0x559194['data']('initialized')){setTimeout(_0x59540d,0x3e8);return;}if($(_0x155c8a(0x1c0))[_0x155c8a(0x275)]>0x0)return;const _0x487a1f=$(_0x155c8a(0x201));_0x487a1f[_0x155c8a(0x1fb)](_0x155c8a(0x176)),_0x559194['prepend'](_0x487a1f),_0xf69a45();}function _0xf69a45(){const _0x111b67=_0x441a9e;if(_0x173a3d&&(_0x173a3d[_0x111b67(0x1c4)]===WebSocket[_0x111b67(0x1d6)]||_0x173a3d[_0x111b67(0x1c4)]===WebSocket[_0x111b67(0x21a)])){console[_0x111b67(0x17f)](_0x111b67(0x19d));return;}if(_0x2fc78f)return;_0x2fc78f=!![];if(_0x173a3d){try{_0x173a3d[_0x111b67(0x19e)]();}catch(_0x48a06a){}_0x173a3d=null;}try{console['log'](_0x111b67(0x1bb)),_0x173a3d=new WebSocket(_0xf943d4),_0x173a3d[_0x111b67(0x241)]=()=>{const _0x51fe09=_0x111b67;console[_0x51fe09(0x17f)](_0x51fe09(0x245)),_0x2fc78f=![],_0x3811d7&&(clearTimeout(_0x3811d7),_0x3811d7=null);},_0x173a3d[_0x111b67(0x1b9)]=_0x125324=>{const _0x2fc303=_0x111b67;try{const _0x4a5d5c=JSON[_0x2fc303(0x1e6)](_0x125324[_0x2fc303(0x274)]);_0x4a5d5c[_0x2fc303(0x18e)]===_0x2fc303(0x1ca)&&$(_0x2fc303(0x1de))[_0x2fc303(0x271)](_0x4a5d5c[_0x2fc303(0x1db)]+'\x20人在线');}catch(_0x98f603){console['error'](_0x2fc303(0x1b3),_0x98f603);}},_0x173a3d[_0x111b67(0x1bc)]=()=>{const _0x27e84c=_0x111b67;console[_0x27e84c(0x17f)]('[Amily2-在线统计]\x20连接断开'),$(_0x27e84c(0x1de))[_0x27e84c(0x271)]('离线'),_0x2fc78f=![],_0x173a3d=null,!_0x3811d7&&(_0x3811d7=setTimeout(()=>{_0x3811d7=null,_0xf69a45();},0x1388));},_0x173a3d[_0x111b67(0x164)]=_0x29f77d=>{const _0x194114=_0x111b67;console[_0x194114(0x1a7)](_0x194114(0x184),_0x29f77d);};}catch(_0x230fd4){console['error'](_0x111b67(0x1cc),_0x230fd4),_0x2fc78f=![],!_0x3811d7&&(_0x3811d7=setTimeout(()=>{_0x3811d7=null,_0xf69a45();},0x1388));}}_0x59540d();}
