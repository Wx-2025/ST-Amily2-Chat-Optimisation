const _0x5726fb=_0x2f48;(function(_0x57dc64,_0x2781b5){const _0x44695c=_0x2f48,_0x3b6063=_0x57dc64();while(!![]){try{const _0x287ea7=-parseInt(_0x44695c(0x275))/0x1*(parseInt(_0x44695c(0x29b))/0x2)+-parseInt(_0x44695c(0x270))/0x3+parseInt(_0x44695c(0x29f))/0x4*(parseInt(_0x44695c(0x279))/0x5)+-parseInt(_0x44695c(0x2d0))/0x6*(-parseInt(_0x44695c(0x23e))/0x7)+-parseInt(_0x44695c(0x2e6))/0x8*(parseInt(_0x44695c(0x1ef))/0x9)+-parseInt(_0x44695c(0x231))/0xa+parseInt(_0x44695c(0x216))/0xb;if(_0x287ea7===_0x2781b5)break;else _0x3b6063['push'](_0x3b6063['shift']());}catch(_0x4cbdaa){_0x3b6063['push'](_0x3b6063['shift']());}}}(_0x526a,0x6e173));import{createDrawer}from'./ui/drawer.js';import'./PresetSettings/index.js';import'./PreOptimizationViewer/index.js';import'./WorldEditor/WorldEditor.js';function _0x2f48(_0x2359f1,_0x60f5af){_0x2359f1=_0x2359f1-0x1df;const _0x526a24=_0x526a();let _0x2f4839=_0x526a24[_0x2359f1];return _0x2f4839;}import{registerSlashCommands}from'./core/commands.js';import{onMessageReceived,handleTableUpdate}from'./core/events.js';import{processPlotOptimization}from'./core/summarizer.js';import{getContext}from'/scripts/extensions.js';import{characters,this_chid}from'/script.js';import{injectTableData,generateTableContent}from'./core/table-system/injector.js';import{initialize as _0x49c4a9}from'./core/rag-processor.js';import{loadTables,clearHighlights,rollbackAndRefill,rollbackState,commitPendingDeletions,saveStateToMessage,getMemoryState,clearUpdatedTables}from'./core/table-system/manager.js';import{fillWithSecondaryApi}from'./core/table-system/secondary-filler.js';function _0x526a(){const _0xeb7d21=['input','max','is_user','text/css','type','[Amily2-在线统计]\x20连接已存在，跳过创建','rgba(0,0,0,0.1)','#dfdff0','click','Amily2插件错误:\x20','#c0bde4','CHAT_CHANGED','[Amily2-核心引擎]\x20执行内置RAG注入。','info','content','setChatMessage','\x20超时。','split','initialize','chat','initialized','[Amily2号-帝国枢密院]\x20开始执行开国大典...','characters','message','#e0e0e0','ST-Amily2-Chat-Optimisation','readAsText','getLastMessageId','close','file','getChatMessages','function','!!!【开国大典失败】在执行系列法令时发生严重错误:','\x22\x20被点击','text','#aaa\x20!important','主题已成功导入并应用！','[Amily2-主窗口]\x20按钮被点击:','vectors_rearrangeChat','head','\x20人在线','createLorebook','1422IdFDaN','[Amily2-内存储司]\x20表格注入失败:','bold','appendChild','bookName','【Amily2号-情报部】一切安好，帝国已是最新版本。情报已转交内务府备案。','[Amily2号-开国大典]\x20步骤六：智能冲突检测与注入策略...','sendMessage','rgba(0,\x200,\x200,\x200.3)\x20!important','[Amily2-主窗口]\x20未知的动作类型:\x20','target','剧情优化处理失败。','display','AMILY2_MACRO_REPLACED','[Amily2号-开国大典]\x20步骤二：皇家仪仗队就位...','trigger','[Amily2-在线统计]\x20解析消息失败:','/CharacterWorldBook/cwb_style.css?v=','super-memory.css','[Amily2-在线统计]\x20已连接到服务器','[Amily2号-开国大典]\x20术语表事件已成功绑定。','showToast','2112FIqtRQ','[Amily2号-开国大典]\x20步骤3.6：侦测到术语表停泊位，开始绑定事件...','now','--am2-','warn','postMessage','OPEN','messages','CONNECTING','historiography.css','html','revokeObjectURL','data','10px','source','#amily2-cancel-optimization-btn','rgba(0,0,0,0.2)','?v=','secondary-api','plotOpt_enabled','无法导出样式：找不到根元素。','未知错误','querySelector','triggerSlash','buttonClick','[Amily2-全局卫队]\x20捕获到严重错误:','getLorebookEntries','[Amily2号-开国大典]\x20步骤七：初始化版本显示系统...','40px','#amily2-online-count','#send_but','entries','#amily2_message_board','application/json','[Amily2号-帝国枢密院]\x20帝国基本法已确认，档案室已与国库对接完毕。','剧情优化已完成并注入。','!!!【角色世界书构建失败】:','amily2_custom_styles','[Amily2号-版本系统]\x20版本检测器未找到，可能加载失败','#send_textarea','Amily2EditContent','[Amily2-在线统计]\x20初始化失败:','setLorebookEntries','主题文件已开始下载。','error','[Amily2-API]\x20setChatMessage\x20收到参数:','contains','16641KAukqp','rel','object','field_values','MESSAGE_DELETED','val','[Amily2-主窗口]\x20已发送消息:\x20','createElement','createChatMessages','严重错误','swipes','includes','stylesheet','/assets/','options','[Amily2号-版本系统]\x20正在启动版本检测器...','[Amily2-核心引擎]\x20注册表格宏时发生错误:','deleteChatMessages','[Amily2号-帝国枢密院]\x20SillyTavern宫殿主体已确认，开国大典正式开始！','show','MESSAGE_RECEIVED','avatars','[Amily2-核心引擎]\x20已成功注册表格占位符宏:\x20{{Amily2EditContent}}','removeChild','1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.2)','toastr','ids','stack','world-editor-style','【监察系统】检测到消息滑动\x20(SWIPED)，开始执行状态回退...','trim','download','buttonId','<div\x20id=\x22amily2-online-tracker\x22\x20style=\x22text-align:\x20center;\x20padding:\x208px;\x20font-size:\x2013px;\x20color:\x20rgba(255,255,255,0.7);\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.1);\x20margin-bottom:\x2010px;\x20background:\x20rgba(0,0,0,0.1);\x20border-radius:\x205px;\x22></div>','剧情优化任务已中止...','[Amily2号-皇家制衣局]\x20已为世界编辑器披上华服:\x20WorldEditor.css','getItem','isArray','hanlinyuanRagProcessor','20697930BNbJfC','length','\x20被删除，开始精确回滚UI状态。','amily2-export-theme-btn','addEventListener','map','onchange','【Amily2号-内务府】获取留言板失败:','[Amily2-剧情优化]\x20处理发送前事件时出错:','version','contentToAppend','!!!【术语表事件绑定失败】:\x20等待面板\x20#amily2_glossary_panel\x20超时。','wss://amilyservice.amily49.cc','parse','导入失败：','getElementById','[Amily2-翰林院]\x20RAG处理器初始化失败:','#amily2_memorisation_forms_panel','无效的JSON格式。','[Amily2号]\x20部署失败：等待\x20','10px\x205px\x20!important','MESSAGE_SWIPED','createObjectURL','none','#amily2_character_world_book_panel','race','readyState','7198110XFUKah','cwb-feature-style','index','0.95em','[Amily2-在线统计]\x20连接断开','[Amily2号-开国大典]\x20步骤3.5：侦测到角色世界书停泊位，开始构建...','【监察系统】检测到消息\x20','【监察系统】分步/优化模式，回退后强制二次填表最新消息。','keys','isCancelled','【监察系统】检测到“朝代更迭”(CHAT_CHANGED)，开始重修史书并刷新宫殿...','IMPERSONATE_READY','Optimization\x20cancelled\x20by\x20user','10213xGcuyA','jqyhEnabled','_comment','amily2HanlinyuanInjector','amily2EventsRegistered','amily2Updater','optimized','Amily2\x20插件已就绪','【监察系统】滑动后填表完成，UI\x20已刷新。','undefined','.json','rgba(255,\x20255,\x20172,\x200.25)','amily2-iframe','switchSwipe','!!!【术语表事件绑定失败】:','onopen','1px\x20solid\x20rgba(255,\x20255,\x20255,\x200.25)','8px\x205px','amily2-style-','avatar','[Amily2-策略]\x20采用“完全主导”策略，覆盖\x20`vectors_rearrangeChat`。','setProperty','/characters/','1px\x20solid\x20#ffc107','[Amily2-剧情优化]\x20优化已启用，但Jqyh\x20API已禁用且主页API未配置。','render_on_every_message','lastPreOptimizationResult','【监察系统】检测到消息滑动，但聊天记录不足，已跳过状态回退。','iframe交互','[Amily2号-开国大典]\x20上下文优化器注册失败:','欢迎回来！授权状态有效\x20(用户:\x20','table.css','rgba(255,\x20255,\x20255,\x200.1)','success','note','[Amily2号-开国大典]\x20角色世界书已成功构建并融入帝国。','href','regenerate','createLorebookEntries','已切换至开场白\x20','[Amily2-剧情优化]\x20Skipping\x20due\x20to\x20conditions:','[Amily2号-开国大典]\x20步骤3.8：注册表格占位符宏...','amily2-reset-theme-btn','/WorldEditor/WorldEditor.css?v=','link','scripts/extensions/third-party/','[Amily2-核心引擎]\x20无法注册表格宏，可能是\x20SillyTavern\x20版本不兼容。','./MiZheSi/index.js','getAvatars','rgba(172,\x20216,\x20255,\x200.25)','1470042vMwEVA','<i\x20class=\x22fas\x20fa-users\x22\x20style=\x22color:\x20#4caf50;\x20font-size:\x2012px;\x20vertical-align:\x20middle;\x20margin-right:\x206px;\x22></i><span\x20id=\x22amily2-online-count\x22\x20style=\x22vertical-align:\x20middle;\x20font-weight:\x20bold;\x22>Connecting...</span>','rgba(255,\x20255,\x20172,\x200.1)','startsWith','one','267ZouLDB','[Amily2号-开国大典]\x20步骤三：开始召唤府邸...','14px','[Amily2号-开国大典]\x20步骤四：部署帝国哨兵网络...','3187865qrCQJa','log','style.css','【监察系统】滑动后最新消息是用户，跳过填表。','stopPropagation','[Amily2号-开国大典]\x20步骤0：优先注册上下文优化器...','。情报已转交内务府。','6px\x208px','plugin_user_note','rgba(172,\x20216,\x20255,\x200.1)','【监察系统】主填表模式，回退后强制刷新消息ID:\x20','操作成功','registerMacro','renderer.css','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20正在进行剧情优化...\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22amily2-cancel-optimization-btn\x22\x20class=\x22menu_button\x20danger_button\x22\x20style=\x22margin-left:\x2010px;\x20padding:\x202px\x208px;\x20font-size:\x200.8em;\x22>中止</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','body','amily2-glossary.css','[Amily2号-皇家制衣局]\x20已为帝国披上华服:\x20','[Amily2号-开国大典]\x20密折司模块已就位。','[Amily2-在线统计]\x20连接错误:','range','iframe-renderer.css','getLorebooks','#amily2-online-tracker','rgba(144,\x20238,\x20144,\x200.3)','title','GENERATION_STARTED','setChatMessages','rearrangeChat','[Amily2号-皇家制衣局]\x20已为角色世界书披上华服:\x20cwb_style.css','result','【Amily2号-内务府】已成功获取并展示来自陛下的最新圣谕。','[Amily2-剧情优化]\x20优化流程已被用户中止。发送原始消息。','count','5364qIzXhW','操作取消','slice','【凤凰阁】内联主题系统初始化失败:\x20','4wPFfCX','[Amily2-剧情优化]\x20Plot\x20optimization\x20returned\x20no\x20result.\x20Sending\x20original\x20message.','style','prepend','onload','plugin_user_type','[Amily2-翰林院]\x20RAG处理器已成功初始化'];_0x526a=function(){return _0xeb7d21;};return _0x526a();}import{renderTables}from'./ui/table-bindings.js';import{log}from'./core/table-system/logger.js';import{eventSource,event_types,saveSettingsDebounced}from'/script.js';import{checkForUpdates,fetchMessageBoardContent}from'./core/api.js';import{setUpdateInfo,applyUpdateIndicator}from'./ui/state.js';import{pluginVersion,extensionName,defaultSettings}from'./utils/settings.js';import{checkAuthorization,refreshUserInfo}from'./utils/auth.js';import{tableSystemDefaultSettings}from'./core/table-system/settings.js';import{extension_settings}from'/scripts/extensions.js';import{manageLorebookEntriesForChat}from'./core/lore.js';import{initializeCharacterWorldBook}from'./CharacterWorldBook/cwb_index.js';import{cwbDefaultSettings}from'./CharacterWorldBook/src/cwb_config.js';import{bindGlossaryEvents}from'./glossary/GT_bindings.js';import'./core/amily2-updater.js';import{updateOrInsertTableInChat,startContinuousRendering,stopContinuousRendering}from'./ui/message-table-renderer.js';import{initializeRenderer}from'./core/tavern-helper/renderer.js';import{initializeApiListener,registerApiHandler,amilyHelper,initializeAmilyHelper}from'./core/tavern-helper/main.js';import{registerContextOptimizerMacros,resetContextBuffer}from'./core/context-optimizer.js';import{initializeSuperMemory}from'./core/super-memory/manager.js';const STYLE_SETTINGS_KEY=_0x5726fb(0x1e5),STYLE_ROOT_SELECTOR=_0x5726fb(0x227);let styleRoot=null;function getStyleRoot(){const _0x266d02=_0x5726fb;return!styleRoot&&(styleRoot=document[_0x266d02(0x2fc)](STYLE_ROOT_SELECTOR)),styleRoot;}function applyStyles(_0x287c02){const _0x4891c5=_0x5726fb,_0x49f268=getStyleRoot();if(!_0x49f268||!_0x287c02)return;delete _0x287c02[_0x4891c5(0x240)];for(const [_0x24340f,_0x5867ef]of Object['entries'](_0x287c02)){_0x24340f[_0x4891c5(0x273)](_0x4891c5(0x2e9))&&_0x49f268['style'][_0x4891c5(0x253)](_0x24340f,_0x5867ef);}}function loadAndApplyStyles(){const _0x682f3e=_0x5726fb,_0x2e9a60=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];_0x2e9a60&&typeof _0x2e9a60===_0x682f3e(0x1f1)&&Object['keys'](_0x2e9a60)[_0x682f3e(0x217)]>0x0&&applyStyles(_0x2e9a60);}function saveStyles(_0xdda8da){!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][STYLE_SETTINGS_KEY]=_0xdda8da,saveSettingsDebounced();}function resetToDefaultStyles(){const _0x32c969=_0x5726fb,_0x42e454=getStyleRoot();if(!_0x42e454)return;const _0x168584=extension_settings[extensionName]?.[STYLE_SETTINGS_KEY];if(_0x168584&&typeof _0x168584==='object')for(const _0x2d63ab of Object[_0x32c969(0x239)](_0x168584)){_0x2d63ab[_0x32c969(0x273)](_0x32c969(0x2e9))&&_0x42e454[_0x32c969(0x2a1)]['removeProperty'](_0x2d63ab);}saveStyles(null),toastr[_0x32c969(0x25f)]('已恢复默认界面样式。');}function getDefaultCssVars(){const _0x4e058c=_0x5726fb;return{'--am2-font-size-base':_0x4e058c(0x277),'--am2-gap-main':_0x4e058c(0x2f3),'--am2-padding-main':_0x4e058c(0x24f),'--am2-container-bg':_0x4e058c(0x2ac),'--am2-container-border':_0x4e058c(0x207),'--am2-container-border-radius':'12px','--am2-container-padding':_0x4e058c(0x2f3),'--am2-container-shadow':'inset\x200\x200\x2015px\x20rgba(0,0,0,0.2)','--am2-title-font-size':'1.1em','--am2-title-font-weight':_0x4e058c(0x2d2),'--am2-title-text-shadow':'0\x200\x205px\x20rgba(200,\x20200,\x20255,\x200.3)','--am2-title-gradient-start':_0x4e058c(0x2b0),'--am2-title-gradient-end':_0x4e058c(0x2ad),'--am2-title-icon-color':'#9e8aff','--am2-title-icon-margin':'10px','--am2-table-bg':_0x4e058c(0x2f6),'--am2-table-border':_0x4e058c(0x24e),'--am2-table-cell-padding':_0x4e058c(0x280),'--am2-table-cell-font-size':_0x4e058c(0x234),'--am2-header-bg':_0x4e058c(0x25e),'--am2-header-color':_0x4e058c(0x2be),'--am2-header-editable-bg':_0x4e058c(0x282),'--am2-header-editable-focus-bg':_0x4e058c(0x26f),'--am2-header-editable-focus-outline':'1px\x20solid\x20#79b8ff','--am2-cell-editable-bg':_0x4e058c(0x272),'--am2-cell-editable-focus-bg':_0x4e058c(0x249),'--am2-cell-editable-focus-outline':_0x4e058c(0x255),'--am2-index-col-bg':_0x4e058c(0x2d8),'--am2-index-col-color':_0x4e058c(0x2c9),'--am2-index-col-width':_0x4e058c(0x302),'--am2-index-col-padding':_0x4e058c(0x22a),'--am2-controls-gap':'5px','--am2-controls-margin-bottom':_0x4e058c(0x2f3),'--am2-cell-highlight-bg':_0x4e058c(0x291)};}function exportStyles(){const _0x57de59=_0x5726fb,_0x3fa5cd=getStyleRoot();if(!_0x3fa5cd){toastr[_0x57de59(0x1ec)](_0x57de59(0x2fa));return;}const _0x34cf41=getComputedStyle(_0x3fa5cd),_0x1693fd={},_0x4a1348=getDefaultCssVars();for(const _0x501075 of Object[_0x57de59(0x239)](_0x4a1348)){_0x1693fd[_0x501075]=_0x34cf41['getPropertyValue'](_0x501075)[_0x57de59(0x20d)]();}const _0x2afe8d=new Blob([JSON['stringify'](_0x1693fd,null,0x2)],{'type':_0x57de59(0x1e1)}),_0x15bdac=URL[_0x57de59(0x22c)](_0x2afe8d),_0x3f34d3=document[_0x57de59(0x1f6)]('a');_0x3f34d3[_0x57de59(0x262)]=_0x15bdac,_0x3f34d3[_0x57de59(0x20e)]='Amily2-Theme-'+new Date()['toISOString']()[_0x57de59(0x29d)](0x0,0xa)+_0x57de59(0x248),document[_0x57de59(0x288)][_0x57de59(0x2d3)](_0x3f34d3),_0x3f34d3[_0x57de59(0x2ae)](),document['body'][_0x57de59(0x206)](_0x3f34d3),URL[_0x57de59(0x2f1)](_0x15bdac),toastr['success'](_0x57de59(0x1eb),'导出成功');}function importStyles(){const _0x41ea5b=_0x5726fb,_0x2b09bc=document[_0x41ea5b(0x1f6)](_0x41ea5b(0x2a6));_0x2b09bc[_0x41ea5b(0x2aa)]=_0x41ea5b(0x2c3),_0x2b09bc['accept']='.json',_0x2b09bc['style'][_0x41ea5b(0x2dc)]=_0x41ea5b(0x22d);const _0x594c31=()=>{const _0x3390f0=_0x41ea5b;document[_0x3390f0(0x288)][_0x3390f0(0x1ee)](_0x2b09bc)&&document[_0x3390f0(0x288)][_0x3390f0(0x206)](_0x2b09bc);};_0x2b09bc[_0x41ea5b(0x21c)]=_0x2ee61e=>{const _0x473ebd=_0x41ea5b,_0xf3b212=_0x2ee61e[_0x473ebd(0x2da)]['files'][0x0];if(!_0xf3b212){_0x594c31();return;}const _0x18195f=new FileReader();_0x18195f[_0x473ebd(0x2a3)]=_0x4c0bd8=>{const _0x4ec2ee=_0x473ebd;try{const _0xaef7e1=JSON[_0x4ec2ee(0x223)](_0x4c0bd8[_0x4ec2ee(0x2da)][_0x4ec2ee(0x297)]);if(typeof _0xaef7e1!==_0x4ec2ee(0x1f1)||Array[_0x4ec2ee(0x214)](_0xaef7e1))throw new Error(_0x4ec2ee(0x228));applyStyles(_0xaef7e1),saveStyles(_0xaef7e1),toastr[_0x4ec2ee(0x25f)](_0x4ec2ee(0x2ca));}catch(_0x1f723c){toastr['error'](_0x4ec2ee(0x224)+_0x1f723c[_0x4ec2ee(0x2bd)],'错误');}finally{_0x594c31();}},_0x18195f[_0x473ebd(0x2c0)](_0xf3b212);},document['body'][_0x41ea5b(0x2d3)](_0x2b09bc),_0x2b09bc[_0x41ea5b(0x2ae)]();}function compareVersions(_0x2ddd83,_0x2dad4f){const _0x2f17d4=_0x5726fb,_0x5aac0b=_0x2ddd83['split']('.')[_0x2f17d4(0x21b)](Number),_0x7c4fe9=_0x2dad4f['split']('.')[_0x2f17d4(0x21b)](Number),_0x4af834=Math[_0x2f17d4(0x2a7)](_0x5aac0b[_0x2f17d4(0x217)],_0x7c4fe9[_0x2f17d4(0x217)]);for(let _0x347304=0x0;_0x347304<_0x4af834;_0x347304++){const _0x33f40a=_0x5aac0b[_0x347304]||0x0,_0x115a49=_0x7c4fe9[_0x347304]||0x0;if(_0x33f40a>_0x115a49)return!![];if(_0x33f40a<_0x115a49)return![];}return![];}async function handleUpdateCheck(){const _0x1e96c8=_0x5726fb;console['log']('【Amily2号】帝国已就绪，现派遣外交官，为陛下探查外界新情报...');const _0x974956=await checkForUpdates();if(_0x974956&&_0x974956['version']){const _0x217669=compareVersions(_0x974956[_0x1e96c8(0x21f)],pluginVersion);_0x217669?console[_0x1e96c8(0x27a)]('【Amily2号-情报部】捷报！发现新版本:\x20'+_0x974956[_0x1e96c8(0x21f)]+_0x1e96c8(0x27f)):console['log'](_0x1e96c8(0x2d5)),setUpdateInfo(_0x217669,_0x974956),applyUpdateIndicator();}}async function handleMessageBoard(){const _0x2ee84d=async()=>{const _0x44538d=_0x2f48;try{const _0x2cfdfc=await fetchMessageBoardContent();if(_0x2cfdfc&&_0x2cfdfc[_0x44538d(0x2bd)]){const _0x395641=$(_0x44538d(0x1e0)),_0x35667f=$('#amily2_message_content');_0x35667f['html'](_0x2cfdfc['message']),_0x395641[_0x44538d(0x202)](),console['log'](_0x44538d(0x298));}}catch(_0x27c0da){console['error'](_0x44538d(0x21d),_0x27c0da);}};await _0x2ee84d(),setInterval(_0x2ee84d,0x493e0);}function loadPluginStyles(){const _0x1b4d76=_0x5726fb,_0xa825fe=_0xf672ee=>{const _0xa24d00=_0x2f48,_0x17f62d=_0xa24d00(0x250)+_0xf672ee[_0xa24d00(0x2b7)]('.')[0x0];if(document[_0xa24d00(0x225)](_0x17f62d))return;const _0xe2c263=_0xa24d00(0x26b)+extensionName+_0xa24d00(0x1fc)+_0xf672ee+_0xa24d00(0x2f7)+Date[_0xa24d00(0x2e8)](),_0x271d70=document[_0xa24d00(0x1f6)](_0xa24d00(0x26a));_0x271d70['id']=_0x17f62d,_0x271d70[_0xa24d00(0x1f0)]=_0xa24d00(0x1fb),_0x271d70[_0xa24d00(0x2aa)]='text/css',_0x271d70[_0xa24d00(0x262)]=_0xe2c263,document[_0xa24d00(0x2cd)][_0xa24d00(0x2d3)](_0x271d70),console[_0xa24d00(0x27a)](_0xa24d00(0x28a)+_0xf672ee);};_0xa825fe(_0x1b4d76(0x27b)),_0xa825fe(_0x1b4d76(0x2ef)),_0xa825fe('hanlinyuan.css'),_0xa825fe(_0x1b4d76(0x289)),_0xa825fe(_0x1b4d76(0x25d)),_0xa825fe('optimization.css'),_0xa825fe(_0x1b4d76(0x286)),_0xa825fe(_0x1b4d76(0x28e)),_0xa825fe(_0x1b4d76(0x2e2));const _0x195670=_0x1b4d76(0x232);if(!document['getElementById'](_0x195670)){const _0x87fd86=document['createElement']('link');_0x87fd86['id']=_0x195670,_0x87fd86['rel']=_0x1b4d76(0x1fb),_0x87fd86[_0x1b4d76(0x2aa)]='text/css',_0x87fd86['href']=_0x1b4d76(0x26b)+extensionName+_0x1b4d76(0x2e1)+Date['now'](),document['head'][_0x1b4d76(0x2d3)](_0x87fd86),console['log'](_0x1b4d76(0x296));}const _0x483cac=_0x1b4d76(0x20b);if(!document['getElementById'](_0x483cac)){const _0x4ecd6a=document[_0x1b4d76(0x1f6)](_0x1b4d76(0x26a));_0x4ecd6a['id']=_0x483cac,_0x4ecd6a[_0x1b4d76(0x1f0)]=_0x1b4d76(0x1fb),_0x4ecd6a[_0x1b4d76(0x2aa)]=_0x1b4d76(0x2a9),_0x4ecd6a[_0x1b4d76(0x262)]=_0x1b4d76(0x26b)+extensionName+_0x1b4d76(0x269)+Date[_0x1b4d76(0x2e8)](),document[_0x1b4d76(0x2cd)]['appendChild'](_0x4ecd6a),console[_0x1b4d76(0x27a)](_0x1b4d76(0x212));}}window[_0x5726fb(0x21a)](_0x5726fb(0x2bd),function(_0x54f648){const _0x862431=_0x5726fb;if(_0x54f648[_0x862431(0x2f2)]&&_0x54f648[_0x862431(0x2f2)][_0x862431(0x2aa)]===_0x862431(0x26e)){if(window['isXiaobaixEnabled'])return;const _0x379e85=_0x862431(0x254)+(getContext()['userCharacter']?.[_0x862431(0x251)]??''),_0xdf16af=_0x862431(0x254)+(getContext()[_0x862431(0x2bc)][this_chid]?.[_0x862431(0x251)]??'');_0x54f648['source'][_0x862431(0x2eb)]({'source':'amily2-host','type':_0x862431(0x204),'urls':{'user':_0x379e85,'char':_0xdf16af}},'*');return;}if(_0x54f648[_0x862431(0x2f2)]&&_0x54f648[_0x862431(0x2f2)][_0x862431(0x2f4)]===_0x862431(0x24a)){const {action:_0x1d4475,detail:_0x483c1e}=_0x54f648['data'];console[_0x862431(0x27a)]('[Amily2-主窗口]\x20收到来自iframe的动作:\x20'+_0x1d4475,_0x483c1e);switch(_0x1d4475){case _0x862431(0x2d7):_0x483c1e&&_0x483c1e['message']&&($(_0x862431(0x1e7))['val'](_0x483c1e[_0x862431(0x2bd)])[_0x862431(0x2df)](_0x862431(0x2a6)),$(_0x862431(0x304))['trigger'](_0x862431(0x2ae)),console[_0x862431(0x27a)](_0x862431(0x1f5)+_0x483c1e[_0x862431(0x2bd)]));break;case _0x862431(0x2e5):if(_0x483c1e&&_0x483c1e['message']&&window[_0x862431(0x208)]){const _0xca5ce=_0x483c1e['type']||_0x862431(0x2b3);typeof window[_0x862431(0x208)][_0xca5ce]==='function'&&window[_0x862431(0x208)][_0xca5ce](_0x483c1e[_0x862431(0x2bd)],_0x483c1e[_0x862431(0x292)]||'通知');}break;case _0x862431(0x2fe):console[_0x862431(0x27a)](_0x862431(0x2cb),_0x483c1e);window['toastr']&&window[_0x862431(0x208)][_0x862431(0x2b3)]('按钮\x20\x22'+(_0x483c1e[_0x862431(0x20f)]||'未知')+_0x862431(0x2c7),_0x862431(0x25a));break;default:console[_0x862431(0x2ea)](_0x862431(0x2d9)+_0x1d4475);}}}),window[_0x5726fb(0x21a)](_0x5726fb(0x1ec),_0xc2cab0=>{const _0x4f7a60=_0x5726fb,_0x55f646=_0xc2cab0[_0x4f7a60(0x1ec)]?.[_0x4f7a60(0x20a)]||'';_0x55f646[_0x4f7a60(0x1fa)](_0x4f7a60(0x2bf))&&(console[_0x4f7a60(0x1ec)](_0x4f7a60(0x2ff),_0xc2cab0['error']),toastr[_0x4f7a60(0x1ec)](_0x4f7a60(0x2af)+(_0xc2cab0['error']?.[_0x4f7a60(0x2bd)]||_0x4f7a60(0x2fb)),_0x4f7a60(0x1f8),{'timeOut':0x2710}));}),jQuery(async()=>{const _0x19686d=_0x5726fb;console[_0x19686d(0x27a)](_0x19686d(0x2bb));try{console[_0x19686d(0x27a)](_0x19686d(0x27e)),registerContextOptimizerMacros();}catch(_0x582c45){console['error'](_0x19686d(0x25b),_0x582c45);}try{await import(_0x19686d(0x26d)),console['log'](_0x19686d(0x28b));}catch(_0x1df7c7){console['error']('[Amily2号-开国大典]\x20密折司加载失败:',_0x1df7c7);}initializeApiListener(),registerApiHandler(_0x19686d(0x2c4),async _0x29e41c=>{const _0x31b323=_0x19686d;return amilyHelper[_0x31b323(0x2c4)](_0x29e41c[_0x31b323(0x28d)],_0x29e41c[_0x31b323(0x1fd)]);}),registerApiHandler(_0x19686d(0x294),async _0x5a9dee=>{const _0x417912=_0x19686d;return await amilyHelper[_0x417912(0x294)](_0x5a9dee[_0x417912(0x2ed)],_0x5a9dee[_0x417912(0x1fd)]);}),registerApiHandler('setChatMessage',async _0x50458c=>{const _0x1c88a7=_0x19686d,_0x148f36=_0x50458c[_0x1c88a7(0x1f2)]||_0x50458c[_0x1c88a7(0x2b4)],_0x570643=_0x50458c['message_id']!==undefined?_0x50458c['message_id']:_0x50458c[_0x1c88a7(0x233)],_0x2c6166=_0x50458c[_0x1c88a7(0x1fd)]||{};return console[_0x1c88a7(0x27a)](_0x1c88a7(0x1ed),{'field_values':_0x148f36,'message_id':_0x570643,'options':_0x2c6166,'raw_data':_0x50458c}),await amilyHelper[_0x1c88a7(0x2b5)](_0x148f36,_0x570643,_0x2c6166);}),registerApiHandler('createChatMessages',async _0x5379c7=>{const _0x1c0349=_0x19686d;return await amilyHelper[_0x1c0349(0x1f7)](_0x5379c7[_0x1c0349(0x2ed)],_0x5379c7['options']);}),registerApiHandler(_0x19686d(0x200),async _0x58a1ce=>{const _0x16dd4a=_0x19686d;return await amilyHelper[_0x16dd4a(0x200)](_0x58a1ce[_0x16dd4a(0x209)],_0x58a1ce[_0x16dd4a(0x1fd)]);}),registerApiHandler(_0x19686d(0x28f),async _0x51b554=>{const _0xfb2f02=_0x19686d;return await amilyHelper[_0xfb2f02(0x28f)]();}),registerApiHandler('getCharLorebooks',async _0x12b0ed=>{const _0x4dea7e=_0x19686d;return await amilyHelper['getCharLorebooks'](_0x12b0ed[_0x4dea7e(0x1fd)]);}),registerApiHandler(_0x19686d(0x300),async _0x237828=>{const _0xedaa7e=_0x19686d;return await amilyHelper['getLorebookEntries'](_0x237828[_0xedaa7e(0x2d4)]);}),registerApiHandler(_0x19686d(0x1ea),async _0xa72981=>{const _0x49abc0=_0x19686d;return await amilyHelper['setLorebookEntries'](_0xa72981[_0x49abc0(0x2d4)],_0xa72981[_0x49abc0(0x1df)]);}),registerApiHandler('createLorebookEntries',async _0x2486f4=>{const _0x7131d2=_0x19686d;return await amilyHelper[_0x7131d2(0x264)](_0x2486f4[_0x7131d2(0x2d4)],_0x2486f4[_0x7131d2(0x1df)]);}),registerApiHandler(_0x19686d(0x2cf),async _0x94a7b6=>{const _0x413668=_0x19686d;return await amilyHelper['createLorebook'](_0x94a7b6[_0x413668(0x2d4)]);}),registerApiHandler(_0x19686d(0x2fd),async _0xd4cda4=>{const _0x3f1b76=_0x19686d;return await amilyHelper[_0x3f1b76(0x2fd)](_0xd4cda4['command']);}),registerApiHandler(_0x19686d(0x2c1),async _0x662b41=>{const _0x48b62a=_0x19686d;return amilyHelper[_0x48b62a(0x2c1)]();}),registerApiHandler(_0x19686d(0x208),async _0x5cdfba=>{const _0xc72a2a=_0x19686d;return window[_0xc72a2a(0x208)]&&typeof window[_0xc72a2a(0x208)][_0x5cdfba['type']]===_0xc72a2a(0x2c5)&&window[_0xc72a2a(0x208)][_0x5cdfba['type']](_0x5cdfba[_0xc72a2a(0x2bd)],_0x5cdfba[_0xc72a2a(0x292)]),!![];}),registerApiHandler(_0x19686d(0x24b),async _0x3b2b17=>{const _0x256d65=_0x19686d,{messageIndex:_0xd6a692,swipeIndex:_0x121150}=_0x3b2b17,_0x368de6=await amilyHelper[_0x256d65(0x2c4)](_0xd6a692,{'include_swipes':!![]});if(_0x368de6&&_0x368de6['length']>0x0&&_0x368de6[0x0][_0x256d65(0x1f9)]){const _0x3a7fc0=_0x368de6[0x0]['swipes'][_0x121150];if(_0x3a7fc0!==undefined){await amilyHelper[_0x256d65(0x294)]([{'message_id':_0xd6a692,'message':_0x3a7fc0}],{'refresh':'affected'});const _0x5f4589=getContext();return _0x5f4589['chat'][_0xd6a692]&&(_0x5f4589[_0x256d65(0x2b9)][_0xd6a692]['swipe_id']=_0x121150),{'success':!![],'message':_0x256d65(0x265)+_0x121150};}}throw new Error('无法切换到开场白\x20'+_0x121150);}),initializeAmilyHelper(),console[_0x19686d(0x27a)]('[Amily2号-帝国枢密院]\x20开始执行开国大典...');!extension_settings[extensionName]&&(extension_settings[extensionName]={});const _0x3e96f5={...defaultSettings,...tableSystemDefaultSettings,...cwbDefaultSettings,'render_on_every_message':![],'amily_render_enabled':![]};for(const _0xd94ef0 in _0x3e96f5){extension_settings[extensionName][_0xd94ef0]===undefined&&(extension_settings[extensionName][_0xd94ef0]=_0x3e96f5[_0xd94ef0]);}console[_0x19686d(0x27a)](_0x19686d(0x1e2));let _0x12752b=0x0;const _0x3e8d11=0x64,_0x5de00e=0x64,_0x277c61='#sys-settings-button',_0x4bd68c=setInterval(async()=>{const _0x6d7fd5=_0x19686d;if($(_0x277c61)[_0x6d7fd5(0x217)]>0x0){clearInterval(_0x4bd68c),console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x201));try{console[_0x6d7fd5(0x27a)]('[Amily2号-开国大典]\x20步骤一：为宫殿披上华服...'),loadPluginStyles(),console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x2de)),await registerSlashCommands(),console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x276)),createDrawer();function _0x36b2c2(){let _0x28ceb4=0x0;const _0x3773f6=0x32,_0x1e7a09=0x64,_0x4f00c1=setInterval(()=>{const _0x35688f=_0x2f48,_0x465265=document[_0x35688f(0x225)]('amily2_glossary_panel');if(_0x465265){clearInterval(_0x4f00c1);try{console[_0x35688f(0x27a)](_0x35688f(0x2e7)),bindGlossaryEvents(),console[_0x35688f(0x27a)](_0x35688f(0x2e4));}catch(_0x3f61df){console['error'](_0x35688f(0x24c),_0x3f61df);}}else _0x28ceb4++,_0x28ceb4>=_0x3773f6&&(clearInterval(_0x4f00c1),console['error'](_0x35688f(0x221)));},_0x1e7a09);}_0x36b2c2();function _0x39cf06(){let _0x4c5719=0x0;const _0xa6aa98=0x32,_0x3c23dd=0x64,_0x50e1d2=setInterval(async()=>{const _0x5eb532=_0x2f48,_0x2f3c4f=$(_0x5eb532(0x22e));if(_0x2f3c4f[_0x5eb532(0x217)]>0x0){clearInterval(_0x50e1d2);try{console[_0x5eb532(0x27a)](_0x5eb532(0x236)),await initializeCharacterWorldBook(_0x2f3c4f),console[_0x5eb532(0x27a)](_0x5eb532(0x261));}catch(_0x101b3e){console[_0x5eb532(0x1ec)](_0x5eb532(0x1e4),_0x101b3e);}}else _0x4c5719++,_0x4c5719>=_0xa6aa98&&(clearInterval(_0x50e1d2),console[_0x5eb532(0x1ec)]('!!!【角色世界书构建失败】:\x20等待面板\x20#amily2_character_world_book_panel\x20超时。'));},_0x3c23dd);}_0x39cf06(),console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x267));try{eventSource['on'](event_types[_0x6d7fd5(0x293)],()=>{resetContextBuffer();});const _0x5e8158=getContext();_0x5e8158&&typeof _0x5e8158[_0x6d7fd5(0x285)]===_0x6d7fd5(0x2c5)?(_0x5e8158['registerMacro'](_0x6d7fd5(0x1e8),()=>{const _0x2765b9=_0x6d7fd5,_0x347677=generateTableContent();return _0x347677&&(window[_0x2765b9(0x2dd)]=!![]),_0x347677;}),console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x205))):console[_0x6d7fd5(0x2ea)](_0x6d7fd5(0x26c));}catch(_0x28d2ed){console['error'](_0x6d7fd5(0x1ff),_0x28d2ed);}console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x278));let _0x33c593=![];async function _0x68548(_0x4709b8,_0x26a1bd,_0x4b359b){const _0x1f3c6f=_0x6d7fd5;clearUpdatedTables(),console[_0x1f3c6f(0x27a)]('[Amily2-剧情优化]\x20Generation\x20after\x20commands\x20triggered',{'type':_0x4709b8,'params':_0x26a1bd,'dryRun':_0x4b359b,'isProcessing':_0x33c593});if(_0x4709b8===_0x1f3c6f(0x263)||_0x33c593||_0x4b359b){console[_0x1f3c6f(0x27a)](_0x1f3c6f(0x266),{'type':_0x4709b8,'isProcessing':_0x33c593,'dryRun':_0x4b359b});return;}const _0xf5c446=extension_settings[extensionName];if(_0xf5c446?.[_0x1f3c6f(0x2f9)]===![])return;const _0x3950b2=_0xf5c446?.[_0x1f3c6f(0x23f)]===!![],_0x4e6535=!!_0xf5c446?.['apiUrl']||!!_0xf5c446?.['tavernProfile'];if(!_0x3950b2&&!_0x4e6535){console[_0x1f3c6f(0x27a)](_0x1f3c6f(0x256));return;}_0x33c593=!![];let _0x18ab93=null;const _0x55561d={'isCancelled':![]};try{const _0x19bc37=$(_0x1f3c6f(0x1e7))[_0x1f3c6f(0x1f4)]();if(!_0x19bc37)return _0x33c593=![],![];const _0x326c5a=_0x1f3c6f(0x287);let _0x4ba926;const _0x3bf742=new Promise((_0x5dcc41,_0x4ee049)=>{_0x4ba926=_0x4ee049;});_0x18ab93=toastr[_0x1f3c6f(0x2b3)](_0x326c5a,'剧情优化',{'timeOut':0x0,'extendedTimeOut':0x0,'tapToDismiss':![],'onclick':null,'escapeHtml':![],'onShown':function(){const _0x5b8083=_0x1f3c6f;$(_0x5b8083(0x2f5))[_0x5b8083(0x274)](_0x5b8083(0x2ae),function(_0x1b0950){const _0x379d26=_0x5b8083;_0x1b0950[_0x379d26(0x27d)](),_0x18ab93&&(_0x18ab93['remove'](),_0x18ab93=null),_0x55561d[_0x379d26(0x23a)]=!![],_0x4ba926(new Error(_0x379d26(0x23d)));});}});const _0x432db7=getContext(),_0x32fa76=_0xf5c446['plotOpt_contextLimit']||0xa;let _0x29d892=[];_0x32fa76>0x0&&(_0x29d892=_0x432db7[_0x1f3c6f(0x2b9)]['slice'](-_0x32fa76));const _0x4e630e=processPlotOptimization({'mes':_0x19bc37},_0x29d892,_0x55561d),_0x5e1c12=await Promise[_0x1f3c6f(0x22f)]([_0x4e630e,_0x3bf742]);if(_0x5e1c12&&_0x5e1c12[_0x1f3c6f(0x220)]){const _0x469739=$('#send_textarea')[_0x1f3c6f(0x1f4)](),_0x50f81d=_0x469739+'\x0a'+_0x5e1c12[_0x1f3c6f(0x220)];$(_0x1f3c6f(0x1e7))[_0x1f3c6f(0x1f4)](_0x50f81d)[_0x1f3c6f(0x2df)](_0x1f3c6f(0x2a6)),toastr['success'](_0x1f3c6f(0x1e3),_0x1f3c6f(0x284));}else console[_0x1f3c6f(0x27a)](_0x1f3c6f(0x2a0));return![];}catch(_0x3088e5){return _0x3088e5[_0x1f3c6f(0x2bd)]==='Optimization\x20cancelled\x20by\x20user'?(console['log'](_0x1f3c6f(0x299)),toastr['warning'](_0x1f3c6f(0x211),_0x1f3c6f(0x29c),{'timeOut':0x7d0})):(console[_0x1f3c6f(0x1ec)](_0x1f3c6f(0x21e),_0x3088e5),toastr[_0x1f3c6f(0x1ec)](_0x1f3c6f(0x2db),'错误')),![];}finally{_0x33c593=![],_0x18ab93&&(toastr['clear'](_0x18ab93),_0x18ab93=null);}}!window[_0x6d7fd5(0x242)]&&(eventSource['on'](event_types['GENERATION_AFTER_COMMANDS'],_0x68548),eventSource['on'](event_types[_0x6d7fd5(0x203)],onMessageReceived),eventSource['on'](event_types[_0x6d7fd5(0x23c)],onMessageReceived),eventSource['on'](event_types[_0x6d7fd5(0x203)],_0x139900=>handleTableUpdate(_0x139900)),eventSource['on'](event_types[_0x6d7fd5(0x22b)],async _0x39edd6=>{const _0x5cb663=_0x6d7fd5,_0x40ccea=getContext();if(_0x40ccea[_0x5cb663(0x2b9)][_0x5cb663(0x217)]<0x2){log(_0x5cb663(0x259),_0x5cb663(0x2b3));return;}log(_0x5cb663(0x20c),_0x5cb663(0x2ea)),rollbackState();const _0x3b342c=_0x40ccea[_0x5cb663(0x2b9)][_0x39edd6]||_0x40ccea[_0x5cb663(0x2b9)][_0x40ccea[_0x5cb663(0x2b9)][_0x5cb663(0x217)]-0x1];if(_0x3b342c[_0x5cb663(0x2a8)]){log(_0x5cb663(0x27c),_0x5cb663(0x2b3)),renderTables();return;}const _0x278165=extension_settings[extensionName],_0x4b0443=_0x278165['filling_mode']||'main-api';if(_0x4b0443==='main-api')log(_0x5cb663(0x283)+_0x39edd6+'。','info'),await handleTableUpdate(_0x39edd6,!![]);else _0x4b0443===_0x5cb663(0x2f8)||_0x4b0443===_0x5cb663(0x244)?(log(_0x5cb663(0x238),'info'),await fillWithSecondaryApi(_0x3b342c,!![])):log('【监察系统】未配置填表模式，跳过填表。',_0x5cb663(0x2b3));renderTables(),log(_0x5cb663(0x246),_0x5cb663(0x25f));}),eventSource['on'](event_types['MESSAGE_EDITED'],_0x2f120b=>{handleTableUpdate(_0x2f120b),updateOrInsertTableInChat();}),eventSource['on'](event_types[_0x6d7fd5(0x2b1)],()=>{const _0x214297=_0x6d7fd5;window[_0x214297(0x258)]=null,document['dispatchEvent'](new CustomEvent('preOptimizationTextUpdated')),manageLorebookEntriesForChat(),setTimeout(()=>{const _0x46809a=_0x214297;log(_0x46809a(0x23b),_0x46809a(0x2b3)),clearHighlights(),clearUpdatedTables(),loadTables(),renderTables(),extension_settings[extensionName][_0x46809a(0x257)]?startContinuousRendering():stopContinuousRendering();},0x64);}),eventSource['on'](event_types[_0x6d7fd5(0x1f3)],(_0x315a2f,_0x2c4473)=>{const _0x5cc922=_0x6d7fd5;log(_0x5cc922(0x237)+_0x2c4473+_0x5cc922(0x218),_0x5cc922(0x2ea)),clearHighlights(),loadTables(_0x2c4473),renderTables();}),eventSource['on'](event_types[_0x6d7fd5(0x203)],updateOrInsertTableInChat),eventSource['on'](event_types['chat_updated'],updateOrInsertTableInChat),window['amily2EventsRegistered']=!![]);console[_0x6d7fd5(0x27a)]('[Amily2号-开国大典]\x20步骤五：初始化RAG处理器...');try{_0x49c4a9(),console['log'](_0x6d7fd5(0x2a5));}catch(_0x3e665a){console[_0x6d7fd5(0x1ec)](_0x6d7fd5(0x226),_0x3e665a);}console[_0x6d7fd5(0x27a)](_0x6d7fd5(0x2d6));async function _0xd1f754(..._0x3e11a9){const _0x456dfb=_0x6d7fd5;console[_0x456dfb(0x27a)]('[Amily2-核心引擎]\x20开始执行统一注入\x20(聊天长度:',_0x3e11a9[0x0]?.['length']||0x0,')');try{await injectTableData(..._0x3e11a9);}catch(_0x35960f){console[_0x456dfb(0x1ec)](_0x456dfb(0x2d1),_0x35960f);}if(window[_0x456dfb(0x215)]&&typeof window[_0x456dfb(0x215)][_0x456dfb(0x295)]==='function')try{console[_0x456dfb(0x27a)](_0x456dfb(0x2b2)),await window[_0x456dfb(0x215)][_0x456dfb(0x295)](..._0x3e11a9);}catch(_0x43d6af){console[_0x456dfb(0x1ec)]('[Amily2-翰林院]\x20RAG注入失败:',_0x43d6af);}}console['log'](_0x6d7fd5(0x252)),window[_0x6d7fd5(0x2cc)]=_0xd1f754;window[_0x6d7fd5(0x241)]&&(window['amily2HanlinyuanInjector']=null);console[_0x6d7fd5(0x27a)]('【Amily2号】帝国秩序已完美建立。Amily2号的府邸已恭候陛下的莅临。');if(checkAuthorization()){const _0x4d1ff0=localStorage[_0x6d7fd5(0x213)](_0x6d7fd5(0x2a4))||'未知',_0x3f11aa=localStorage[_0x6d7fd5(0x213)](_0x6d7fd5(0x281));_0x3f11aa?toastr['success'](_0x6d7fd5(0x25c)+_0x3f11aa+')','Amily2\x20插件已就绪'):refreshUserInfo()['then'](_0x3302cf=>{const _0x14690c=_0x6d7fd5;_0x3302cf&&_0x3302cf[_0x14690c(0x260)]?toastr[_0x14690c(0x25f)](_0x14690c(0x25c)+_0x3302cf['note']+')',_0x14690c(0x245)):toastr[_0x14690c(0x25f)](_0x14690c(0x25c)+_0x4d1ff0+')',_0x14690c(0x245));})['catch'](_0x40a8a1=>{const _0x55b88c=_0x6d7fd5;toastr['success'](_0x55b88c(0x25c)+_0x4d1ff0+')',_0x55b88c(0x245));});}console['log'](_0x6d7fd5(0x301)),typeof window[_0x6d7fd5(0x243)]!==_0x6d7fd5(0x247)?setTimeout(()=>{const _0xa1d05b=_0x6d7fd5;console[_0xa1d05b(0x27a)](_0xa1d05b(0x1fe)),window['amily2Updater'][_0xa1d05b(0x2b8)]();},0x7d0):console[_0x6d7fd5(0x2ea)](_0x6d7fd5(0x1e6)),handleUpdateCheck(),handleMessageBoard(),initializeOnlineTracker(),setTimeout(()=>{initializeSuperMemory();},0xbb8),initializeRenderer(),extension_settings[extensionName][_0x6d7fd5(0x257)]&&startContinuousRendering(),setTimeout(()=>{const _0x3c001f=_0x6d7fd5;try{loadAndApplyStyles();const _0x467571=document[_0x3c001f(0x225)]('amily2-import-theme-btn'),_0x4312fb=document['getElementById'](_0x3c001f(0x219)),_0xcfc25e=document[_0x3c001f(0x225)](_0x3c001f(0x268));if(_0x467571)_0x467571[_0x3c001f(0x21a)]('click',importStyles);if(_0x4312fb)_0x4312fb['addEventListener'](_0x3c001f(0x2ae),exportStyles);if(_0xcfc25e)_0xcfc25e['addEventListener'](_0x3c001f(0x2ae),resetToDefaultStyles);log('【凤凰阁】内联主题系统已通过延迟加载成功初始化并绑定事件。',_0x3c001f(0x25f));}catch(_0x108767){log(_0x3c001f(0x29e)+_0x108767,_0x3c001f(0x1ec));}},0x1f4);}catch(_0x1663af){console[_0x6d7fd5(0x1ec)](_0x6d7fd5(0x2c6),_0x1663af);}}else _0x12752b++,_0x12752b>=_0x3e8d11&&(clearInterval(_0x4bd68c),console[_0x6d7fd5(0x1ec)](_0x6d7fd5(0x229)+_0x277c61+_0x6d7fd5(0x2b6)));},_0x5de00e);});function initializeOnlineTracker(){const _0x113ecf=_0x5726fb,_0x26a2a5=_0x113ecf(0x222);let _0x52496e=null,_0x9e5abd=null,_0xbd4a5e=![];function _0x1ae27c(){const _0x37128f=_0x113ecf,_0x4ab858=$('#amily2_drawer_content');if(_0x4ab858[_0x37128f(0x217)]===0x0||!_0x4ab858[_0x37128f(0x2f2)](_0x37128f(0x2ba))){setTimeout(_0x1ae27c,0x3e8);return;}if($(_0x37128f(0x290))[_0x37128f(0x217)]>0x0)return;const _0x24dd8c=$(_0x37128f(0x210));_0x24dd8c[_0x37128f(0x2f0)](_0x37128f(0x271)),_0x4ab858[_0x37128f(0x2a2)](_0x24dd8c),_0x1646db();}function _0x1646db(){const _0x5f1444=_0x113ecf;if(_0x52496e&&(_0x52496e[_0x5f1444(0x230)]===WebSocket[_0x5f1444(0x2ee)]||_0x52496e[_0x5f1444(0x230)]===WebSocket[_0x5f1444(0x2ec)])){console[_0x5f1444(0x27a)](_0x5f1444(0x2ab));return;}if(_0xbd4a5e)return;_0xbd4a5e=!![];if(_0x52496e){try{_0x52496e[_0x5f1444(0x2c2)]();}catch(_0x31b91b){}_0x52496e=null;}try{console[_0x5f1444(0x27a)]('[Amily2-在线统计]\x20开始建立连接...'),_0x52496e=new WebSocket(_0x26a2a5),_0x52496e[_0x5f1444(0x24d)]=()=>{const _0x1de4d7=_0x5f1444;console[_0x1de4d7(0x27a)](_0x1de4d7(0x2e3)),_0xbd4a5e=![],_0x9e5abd&&(clearTimeout(_0x9e5abd),_0x9e5abd=null);},_0x52496e['onmessage']=_0x4924ac=>{const _0x19cfd0=_0x5f1444;try{const _0x42e936=JSON[_0x19cfd0(0x223)](_0x4924ac[_0x19cfd0(0x2f2)]);_0x42e936[_0x19cfd0(0x2aa)]==='online_count'&&$(_0x19cfd0(0x303))[_0x19cfd0(0x2c8)](_0x42e936[_0x19cfd0(0x29a)]+_0x19cfd0(0x2ce));}catch(_0x4d4ae1){console[_0x19cfd0(0x1ec)](_0x19cfd0(0x2e0),_0x4d4ae1);}},_0x52496e['onclose']=()=>{const _0xa6dfe=_0x5f1444;console[_0xa6dfe(0x27a)](_0xa6dfe(0x235)),$(_0xa6dfe(0x303))['text']('离线'),_0xbd4a5e=![],_0x52496e=null,!_0x9e5abd&&(_0x9e5abd=setTimeout(()=>{_0x9e5abd=null,_0x1646db();},0x1388));},_0x52496e['onerror']=_0x59d7bc=>{const _0x4de51f=_0x5f1444;console[_0x4de51f(0x2ea)](_0x4de51f(0x28c),_0x59d7bc);};}catch(_0x5d8bea){console['error'](_0x5f1444(0x1e9),_0x5d8bea),_0xbd4a5e=![],!_0x9e5abd&&(_0x9e5abd=setTimeout(()=>{_0x9e5abd=null,_0x1646db();},0x1388));}}_0x1ae27c();}
