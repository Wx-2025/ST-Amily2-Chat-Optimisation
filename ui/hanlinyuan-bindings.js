function _0x3c62(_0x36035f,_0x1aa11a){const _0x4fc256=_0x4fc2();return _0x3c62=function(_0x3c622f,_0x1263d9){_0x3c622f=_0x3c622f-0xbb;let _0x41a3cc=_0x4fc256[_0x3c622f];return _0x41a3cc;},_0x3c62(_0x36035f,_0x1aa11a);}(function(_0x14cf00,_0xd78b88){const _0x1924e0=_0x3c62,_0x2ef673=_0x14cf00();while(!![]){try{const _0x2dc66d=parseInt(_0x1924e0(0xd1))/0x1+-parseInt(_0x1924e0(0xd2))/0x2*(-parseInt(_0x1924e0(0x141))/0x3)+-parseInt(_0x1924e0(0xc4))/0x4*(parseInt(_0x1924e0(0x127))/0x5)+parseInt(_0x1924e0(0xc0))/0x6*(-parseInt(_0x1924e0(0xc3))/0x7)+-parseInt(_0x1924e0(0x16e))/0x8+-parseInt(_0x1924e0(0x147))/0x9*(parseInt(_0x1924e0(0xc2))/0xa)+parseInt(_0x1924e0(0xda))/0xb;if(_0x2dc66d===_0xd78b88)break;else _0x2ef673['push'](_0x2ef673['shift']());}catch(_0x136c0f){_0x2ef673['push'](_0x2ef673['shift']());}}}(_0x4fc2,0x7d3e7));import{extension_settings,getContext}from'/scripts/extensions.js';import{extensionName,defaultSettings,saveSettings}from'../utils/settings.js';function _0x4fc2(){const _0x1f7aca=['preset','[Amily2-Ngms录]\x20[','请先选择一个要回溯的史册！','input','html','selected','圣谕有误','已镌刻！','_value','val','amily2_mhb_large_lore_selector','append','获取模型失败:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22historiography-exclusion-rules-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22hly-notes\x22>在这里定义需要从提取内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符为\x20`<!--`，结束字符为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22historiography-rules-list\x22>','成功获取\x20','ngmsApiKey','[Amily2-Ngms]\x20已选择模型:\x20','key','forEach','className','addEventListener','.hly-exclusion-rule-row','圣谕不明','amily2_ngms_model_select','<i\x20class=\x22fas\x20fa-flag-checkered\x22></i>\x20开始远征','display','dataset','idle','[Amily2号-工部]\x20【敕史局】的专属工匠已就位...','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20测试中','.popup-button-ok','编辑内容排除规则','option','1725736GmQwAo','jailbreak','createElement','find','ngmsApiUrl','Ngms\x20模型获取','2195862bUdaYy','圣谕不全','440OtMsmK','7dMIhUu','732msmmJH','historiographySmallTriggerThreshold','<option\x20value=\x22\x22>请先选择国史馆</option>','textContent','amily2_ngms_max_tokens','.hly-delete-rule-btn','block','historiography-tag-input-container','[Amily2号-Ngms]\x20测试连接失败:','historiography_retention_count','push','amily2_mhb_','closest','247431ZnlZJx','10yPmuJg','start','[Amily2号-Ngms]\x20获取模型列表失败:','text','extensionSettings','amily2_ngms_tavern_profile','openai_test','historiographyIngestToRag','11582230KTRIFB','远征阈值必须是大于0的数字。已重置。','[Amily2号-Ngms工部]\x20正在绑定Ngms\x20API事件...','amily2_mhb_small_expedition_execute','remove','historiographySmallJailbreakPrompt','<option\x20value=\x22\x22>正在翻阅旧档...</option>','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-exclusion-rule-row\x22\x20data-index=\x22','showModal','ngmsTemperature','ngmsEnabled','target','close','amily2_mhb_small_start_floor','textarea','<option\x20value=\x22\x22>此国史馆为空</option>','log','amily2-expedition-state-change','historiographyWriteToLorebook','historiographyVectorizeSummary','historiography-tag-input','name','<option\x20value=\x22\x22>未发现任何国史馆</option>','error','success','amily2_ngms_compatible_config','amily2_mhb_restore_archive','_restore_button','amily2_ngms_api_key','amily2_mhb_archive_selector','圣旨已达','<option\x20value=\x22\x22>加载失败</option>','change','amily2_mhb_small_auto_enabled','historiographyTags','amily2_mhb_large_worldbook_selector','prop','[Amily2号-Ngms]\x20加载SillyTavern预设失败:','historiographyRetentionCount','none','amily2_ngms_model','innerHTML','宏史卷','comment','保留层数必须是大于或等于0的数字。已重置。','historiographyLargeRefinePrompt','small','内容排除规则已保存。','\x20个模型','_editor','trim','historiographySmallSummaryPrompt','body','amily2_vectorize_summary_content','#historiography-add-rule-btn','historiography-exclusion-rules-btn','menu_button\x20small_button\x20interactable\x20success','disabled','请先选择一个国史馆及其中的史册条目！','破限谕旨','historiography-tag-extraction-toggle','historiography_auto_summary_interactive',']\x20设置为\x20->','amily2_mhb_small_trigger_count','amily2_mhb_small_manual_execute','已恢复为默认谕旨，请点击“保存当前”以确认。','amily2_ngms_content','微言录','amily2_ngms_test_connection','click',']\x20的新状态已保存。','warning','<i\x20class=\x22fas\x20fa-spinner\x20fa-spin\x22></i>\x20获取中','sillytavern_preset','<option\x20value=\x22\x22>--\x20加载中\x20--</option>','historiographyExclusionRules','_save_button','12710FrZdHM','info','historiographyTagExtractionEnabled','.popup-button-cancel','amily2_ngms_fetch_models','api','amily2_mhb_large_refresh_worldbooks','running','amily2_ngms_api_mode','dispatchEvent','state','getElementById','defaultValue','checked','<option\x20value=\x22\x22>正在检阅史册...</option>','<i\x20class=\x22fas\x20fa-play-circle\x22></i>\x20继续远征','value','style','amily2_mhb_large_refine_execute','_prompt_selector','appendChild','detail','historiographySmallAutoEnable','[Amily2-Ngms令]\x20收到指令:\x20将\x20[','amily2_ngms_preset_config','selectedIndex','335838ToGJKC','ngmsModel','amily2_mhb_archive_current','已保存！','ngmsApiMode','ngmsMaxTokens','61407hHgIzJ','ngmsTavernProfile','historiographyAutoSummaryInteractive','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22','map','length'];_0x4fc2=function(){return _0x1f7aca;};return _0x4fc2();}import{showHtmlModal}from'./page-window.js';import{applyExclusionRules,extractBlocksByTags}from'../core/utils/rag-tag-extractor.js';import{getAvailableWorldbooks,getLoresForWorldbook,executeManualSummary,executeRefinement,executeExpedition,stopExpedition,archiveCurrentLedger,getArchivedLedgers,restoreArchivedLedger}from'../core/historiographer.js';import{getNgmsApiSettings,testNgmsApiConnection,fetchNgmsModels}from'../core/api/Ngms_api.js';function setupPromptEditor(_0x5d93af){const _0x36d8ce=_0x3c62,_0x46de4a=document['getElementById']('amily2_mhb_'+_0x5d93af+_0x36d8ce(0x13a)),_0x3f42c6=document[_0x36d8ce(0x132)]('amily2_mhb_'+_0x5d93af+_0x36d8ce(0x10b)),_0x4b1252=document['getElementById'](_0x36d8ce(0xcf)+_0x5d93af+_0x36d8ce(0x126)),_0xdd61bc=document[_0x36d8ce(0x132)](_0x36d8ce(0xcf)+_0x5d93af+_0x36d8ce(0xf5)),_0x40d2dc=_0x5d93af==='small'?_0x36d8ce(0xdf):'historiographyLargeJailbreakPrompt',_0x5d2a3f=_0x5d93af==='small'?_0x36d8ce(0x10d):_0x36d8ce(0x107),_0x35f613=()=>{const _0x25c5a1=_0x36d8ce,_0x16ffc6=_0x46de4a[_0x25c5a1(0x137)];_0x16ffc6===_0x25c5a1(0xbb)?_0x3f42c6[_0x25c5a1(0x137)]=extension_settings[extensionName][_0x40d2dc]:_0x3f42c6['value']=extension_settings[extensionName][_0x5d2a3f];};_0x46de4a[_0x36d8ce(0x161)](_0x36d8ce(0xfa),_0x35f613),_0x4b1252[_0x36d8ce(0x161)](_0x36d8ce(0x11f),()=>{const _0x13227f=_0x36d8ce,_0x2e1062=_0x46de4a[_0x13227f(0x137)];_0x2e1062===_0x13227f(0xbb)?extension_settings[extensionName][_0x40d2dc]=_0x3f42c6[_0x13227f(0x137)]:extension_settings[extensionName][_0x5d2a3f]=_0x3f42c6['value'],saveSettings()&&toastr[_0x13227f(0xf2)]((_0x5d93af===_0x13227f(0x108)?'微言录':_0x13227f(0x104))+'的'+(_0x2e1062==='jailbreak'?_0x13227f(0x115):'纲要')+_0x13227f(0x144));}),_0xdd61bc['addEventListener'](_0x36d8ce(0x11f),()=>{const _0x26980e=_0x36d8ce,_0x1aee6f=_0x46de4a[_0x26980e(0x137)];_0x1aee6f===_0x26980e(0xbb)?_0x3f42c6[_0x26980e(0x137)]=defaultSettings[_0x40d2dc]:_0x3f42c6[_0x26980e(0x137)]=defaultSettings[_0x5d2a3f],toastr[_0x26980e(0x128)](_0x26980e(0x11b));}),_0x35f613();const _0x578bd1=document[_0x36d8ce(0x132)](_0x36d8ce(0xcf)+_0x5d93af+'_expand_editor');_0x578bd1['addEventListener'](_0x36d8ce(0x11f),()=>{const _0xe9535b=_0x36d8ce,_0x5c9d50=_0x46de4a[_0xe9535b(0x137)],_0xc43bd=_0x46de4a['options'][_0x46de4a[_0xe9535b(0x140)]][_0xe9535b(0xd5)],_0x56b90b=_0x3f42c6['value'],_0xa8ef58='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<dialog\x20class=\x22popup\x20wide_dialogue_popup\x20large_dialogue_popup\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-body\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20style=\x22margin-top:0;\x20color:\x20#eee;\x20border-bottom:\x201px\x20solid\x20rgba(255,255,255,0.2);\x20padding-bottom:\x2010px;\x22>正在编辑:\x20'+_0xc43bd+'</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-content\x22\x20style=\x22height:\x2070vh;\x22><div\x20class=\x22height100p\x20wide100p\x20flex-container\x22><textarea\x20class=\x22height100p\x20wide100p\x20maximized_textarea\x20text_pole\x22></textarea></div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22popup-controls\x22><div\x20class=\x22popup-button-ok\x20menu_button\x20menu_button_primary\x20interactable\x22>保存并关闭</div><div\x20class=\x22popup-button-cancel\x20menu_button\x20interactable\x22\x20style=\x22margin-left:\x2010px;\x22>取消</div></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</dialog>',_0xf2e50b=$(_0xa8ef58)['appendTo'](_0xe9535b(0x10e)),_0xbb3df3=_0xf2e50b[_0xe9535b(0xbd)](_0xe9535b(0xe8));_0xbb3df3[_0xe9535b(0x156)](_0x56b90b);const _0x41169c=()=>{const _0x506b70=_0xe9535b;_0xf2e50b[0x0][_0x506b70(0xe6)](),_0xf2e50b[_0x506b70(0xde)]();};_0xf2e50b[_0xe9535b(0xbd)](_0xe9535b(0x16b))['on'](_0xe9535b(0x11f),()=>{const _0x1aad73=_0xe9535b,_0x40684f=_0xbb3df3['val']();_0x3f42c6[_0x1aad73(0x137)]=_0x40684f,_0x5c9d50===_0x1aad73(0xbb)?extension_settings[extensionName][_0x40d2dc]=_0x40684f:extension_settings[extensionName][_0x5d2a3f]=_0x40684f,saveSettings()&&toastr['success']((_0x5d93af===_0x1aad73(0x108)?_0x1aad73(0x11d):_0x1aad73(0x104))+'的'+_0xc43bd+_0x1aad73(0x154)),_0x41169c();}),_0xf2e50b[_0xe9535b(0xbd)](_0xe9535b(0x12a))['on'](_0xe9535b(0x11f),_0x41169c),_0xf2e50b[0x0][_0xe9535b(0xe2)]();});}export function bindHistoriographyEvents(){const _0x10cc7e=_0x3c62;console['log'](_0x10cc7e(0x169)),setupPromptEditor(_0x10cc7e(0x108)),setupPromptEditor('large'),bindNgmsApiEvents();const _0x55c074=document[_0x10cc7e(0x132)](_0x10cc7e(0xe7)),_0x2e5c92=document[_0x10cc7e(0x132)]('amily2_mhb_small_end_floor'),_0x287dc9=document[_0x10cc7e(0x132)](_0x10cc7e(0x11a)),_0x51ca72=document[_0x10cc7e(0x132)](_0x10cc7e(0xfb)),_0x2200a3=document[_0x10cc7e(0x132)](_0x10cc7e(0x119)),_0x2b747f=document[_0x10cc7e(0x132)]('historiography_write_to_lorebook'),_0x3cab35=document[_0x10cc7e(0x132)]('historiography_ingest_to_rag');_0x287dc9[_0x10cc7e(0x161)](_0x10cc7e(0x11f),()=>{const _0x3dda42=_0x10cc7e,_0x28e2ce=parseInt(_0x55c074['value'],0xa),_0x2787e7=parseInt(_0x2e5c92[_0x3dda42(0x137)],0xa);if(isNaN(_0x28e2ce)||isNaN(_0x2787e7)||_0x28e2ce<=0x0||_0x2787e7<=0x0||_0x28e2ce>_0x2787e7){toastr['error']('请输入有效的起始和结束楼层！',_0x3dda42(0x153));return;}executeManualSummary(_0x28e2ce,_0x2787e7);}),_0x51ca72[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x39fa87=>{const _0x2a309f=_0x10cc7e;extension_settings[extensionName]['historiographySmallAutoEnable']=_0x39fa87[_0x2a309f(0xe5)][_0x2a309f(0x134)],saveSettings();}),_0x2200a3[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x592c8b=>{const _0x3066d7=_0x10cc7e,_0x414e36=parseInt(_0x592c8b[_0x3066d7(0xe5)][_0x3066d7(0x137)],0xa);if(isNaN(_0x414e36)||_0x414e36<0x1){_0x592c8b[_0x3066d7(0xe5)][_0x3066d7(0x137)]=defaultSettings[_0x3066d7(0xc5)],toastr[_0x3066d7(0x121)](_0x3066d7(0xdb),_0x3066d7(0x153));return;}extension_settings[extensionName][_0x3066d7(0xc5)]=_0x414e36,saveSettings();});const _0x5b6e62=document[_0x10cc7e(0x132)](_0x10cc7e(0xcd));_0x5b6e62['addEventListener'](_0x10cc7e(0xfa),_0x43f112=>{const _0x1c3a78=_0x10cc7e,_0x3c294a=parseInt(_0x43f112['target'][_0x1c3a78(0x137)],0xa);if(isNaN(_0x3c294a)||_0x3c294a<0x0){_0x43f112[_0x1c3a78(0xe5)][_0x1c3a78(0x137)]=defaultSettings[_0x1c3a78(0x100)],toastr[_0x1c3a78(0x121)](_0x1c3a78(0x106),'圣谕有误');return;}extension_settings[extensionName]['historiographyRetentionCount']=_0x3c294a,saveSettings();}),_0x2b747f[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x23b734=>{const _0x390794=_0x10cc7e;extension_settings[extensionName][_0x390794(0xec)]=_0x23b734[_0x390794(0xe5)][_0x390794(0x134)],saveSettings();}),_0x3cab35[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x45e0b=>{const _0x3ebea4=_0x10cc7e;extension_settings[extensionName]['historiographyIngestToRag']=_0x45e0b[_0x3ebea4(0xe5)]['checked'],saveSettings();}),_0x51ca72['checked']=extension_settings[extensionName][_0x10cc7e(0x13d)]??![],_0x2200a3[_0x10cc7e(0x137)]=extension_settings[extensionName][_0x10cc7e(0xc5)]??0x1e,_0x5b6e62[_0x10cc7e(0x137)]=extension_settings[extensionName][_0x10cc7e(0x100)]??0x5,_0x2b747f[_0x10cc7e(0x134)]=extension_settings[extensionName][_0x10cc7e(0xec)]??!![],_0x3cab35[_0x10cc7e(0x134)]=extension_settings[extensionName][_0x10cc7e(0xd9)]??![];const _0x337329=document[_0x10cc7e(0x132)](_0x10cc7e(0x117));_0x337329[_0x10cc7e(0x134)]=extension_settings[extensionName][_0x10cc7e(0x149)]??![],_0x337329['addEventListener']('change',_0x2f4b47=>{const _0x308fe5=_0x10cc7e;extension_settings[extensionName][_0x308fe5(0x149)]=_0x2f4b47[_0x308fe5(0xe5)]['checked'],saveSettings();});const _0x3b176b=document[_0x10cc7e(0x132)](_0x10cc7e(0x116)),_0x97688=document['getElementById'](_0x10cc7e(0xcb)),_0x3e4a73=document[_0x10cc7e(0x132)](_0x10cc7e(0xee)),_0x28079b=document[_0x10cc7e(0x132)](_0x10cc7e(0x111));_0x3b176b[_0x10cc7e(0x134)]=extension_settings[extensionName]['historiographyTagExtractionEnabled']??![],_0x3e4a73[_0x10cc7e(0x137)]=extension_settings[extensionName]['historiographyTags']??'',_0x97688[_0x10cc7e(0x138)][_0x10cc7e(0x166)]=_0x3b176b[_0x10cc7e(0x134)]?'block':'none',_0x3b176b[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x39d4f1=>{const _0x100687=_0x10cc7e,_0x23484c=_0x39d4f1[_0x100687(0xe5)][_0x100687(0x134)];extension_settings[extensionName][_0x100687(0x129)]=_0x23484c,_0x97688[_0x100687(0x138)]['display']=_0x23484c?_0x100687(0xca):_0x100687(0x101),saveSettings();}),_0x3e4a73[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x594751=>{const _0x3a1e01=_0x10cc7e;extension_settings[extensionName][_0x3a1e01(0xfc)]=_0x594751[_0x3a1e01(0xe5)][_0x3a1e01(0x137)],saveSettings();}),_0x28079b[_0x10cc7e(0x161)](_0x10cc7e(0x11f),showHistoriographyExclusionRulesModal);const _0x57993f=document[_0x10cc7e(0x132)](_0x10cc7e(0xdd)),_0x6e242c=_0x51939c=>{const _0x4de8a4=_0x10cc7e;_0x57993f[_0x4de8a4(0x167)][_0x4de8a4(0x131)]=_0x51939c;switch(_0x51939c){case'running':_0x57993f[_0x4de8a4(0x103)]='<i\x20class=\x22fas\x20fa-stop-circle\x22></i>\x20停止远征',_0x57993f[_0x4de8a4(0x160)]='menu_button\x20small_button\x20interactable\x20danger';break;case'paused':_0x57993f[_0x4de8a4(0x103)]=_0x4de8a4(0x136),_0x57993f[_0x4de8a4(0x160)]=_0x4de8a4(0x112);break;case _0x4de8a4(0x168):default:_0x57993f['innerHTML']=_0x4de8a4(0x165),_0x57993f[_0x4de8a4(0x160)]='menu_button\x20small_button\x20interactable';break;}};document[_0x10cc7e(0x161)](_0x10cc7e(0xeb),_0x455465=>{const _0x40f908=_0x10cc7e,{isRunning:_0x1689be,manualStop:_0x286acd}=_0x455465[_0x40f908(0x13c)];if(_0x1689be)_0x6e242c(_0x40f908(0x12e));else _0x286acd?_0x6e242c('paused'):_0x6e242c(_0x40f908(0x168));}),_0x57993f[_0x10cc7e(0x161)](_0x10cc7e(0x11f),()=>{const _0x43cc16=_0x10cc7e,_0x3e57a6=_0x57993f['dataset'][_0x43cc16(0x131)]||'idle';_0x3e57a6==='running'?stopExpedition():executeExpedition();}),_0x6e242c(_0x10cc7e(0x168));const _0x17c9a1=document[_0x10cc7e(0x132)](_0x10cc7e(0x143)),_0xb9b59=document[_0x10cc7e(0x132)](_0x10cc7e(0xf7)),_0x475be3=document['getElementById']('amily2_mhb_refresh_archives'),_0x2ca2db=document['getElementById'](_0x10cc7e(0xf4)),_0x96d273=async()=>{const _0x7f2b73=_0x10cc7e;_0xb9b59[_0x7f2b73(0x103)]=_0x7f2b73(0xe0);const _0x4f614f=await getArchivedLedgers();_0xb9b59[_0x7f2b73(0x103)]='',_0x4f614f&&_0x4f614f[_0x7f2b73(0x14c)]>0x0?_0x4f614f[_0x7f2b73(0x15f)](_0x507862=>{const _0x5f8c7a=_0x7f2b73,_0x32fd42=document[_0x5f8c7a(0xbc)](_0x5f8c7a(0x16d));_0x32fd42[_0x5f8c7a(0x137)]=_0x507862[_0x5f8c7a(0x15e)],_0x32fd42[_0x5f8c7a(0xc7)]=_0x507862[_0x5f8c7a(0x105)],_0xb9b59[_0x5f8c7a(0x13b)](_0x32fd42);}):_0xb9b59[_0x7f2b73(0x103)]='<option\x20value=\x22\x22>未发现归档史册</option>';};_0x17c9a1[_0x10cc7e(0x161)](_0x10cc7e(0x11f),async()=>{if(confirm('确定要归档当前的【对话流水总帐】并停用它吗？\x0a这将允许您开始一段全新的历史记录。')){const _0x14311c=await archiveCurrentLedger();_0x14311c&&_0x96d273();}}),_0x475be3['addEventListener'](_0x10cc7e(0x11f),_0x96d273),_0x2ca2db[_0x10cc7e(0x161)](_0x10cc7e(0x11f),async()=>{const _0x106ba3=_0x10cc7e,_0x39aaf2=_0xb9b59[_0x106ba3(0x137)];if(!_0x39aaf2){toastr['warning'](_0x106ba3(0x14f),_0x106ba3(0x163));return;}confirm('确定要回溯选中的史册吗？\x0a当前的活跃史册（如果有）将被自动归档。')&&(await restoreArchivedLedger(_0x39aaf2),_0x96d273());});const _0x204793=document[_0x10cc7e(0x132)](_0x10cc7e(0xfd)),_0x4bafaa=document['getElementById'](_0x10cc7e(0x157)),_0x30a212=document[_0x10cc7e(0x132)](_0x10cc7e(0x12d)),_0x1f3f8e=document[_0x10cc7e(0x132)]('amily2_mhb_large_refresh_lores'),_0x193aae=document[_0x10cc7e(0x132)](_0x10cc7e(0x139)),_0x17b71a=async()=>{const _0x365db4=_0x10cc7e;_0x204793[_0x365db4(0x103)]='<option\x20value=\x22\x22>正在遍览帝国疆域...</option>';const _0x1582c6=await getAvailableWorldbooks();_0x204793[_0x365db4(0x103)]='',_0x1582c6&&_0x1582c6[_0x365db4(0x14c)]>0x0?(_0x1582c6[_0x365db4(0x15f)](_0x42115e=>{const _0x591f0f=_0x365db4,_0x448cbe=document[_0x591f0f(0xbc)](_0x591f0f(0x16d));_0x448cbe[_0x591f0f(0x137)]=_0x42115e,_0x448cbe[_0x591f0f(0xc7)]=_0x42115e,_0x204793[_0x591f0f(0x13b)](_0x448cbe);}),_0x204793[_0x365db4(0x130)](new Event(_0x365db4(0xfa)))):_0x204793[_0x365db4(0x103)]=_0x365db4(0xf0);},_0x8553d=async()=>{const _0xe10a2e=_0x10cc7e,_0x545bf5=_0x204793['value'];if(!_0x545bf5){_0x4bafaa['innerHTML']=_0xe10a2e(0xc6);return;}_0x4bafaa[_0xe10a2e(0x103)]=_0xe10a2e(0x135);const _0x57ee86=await getLoresForWorldbook(_0x545bf5);_0x4bafaa[_0xe10a2e(0x103)]='',_0x57ee86&&_0x57ee86[_0xe10a2e(0x14c)]>0x0?_0x57ee86['forEach'](_0x565142=>{const _0x286bf0=_0xe10a2e,_0x5e0da6=document['createElement'](_0x286bf0(0x16d));_0x5e0da6['value']=_0x565142[_0x286bf0(0x15e)],_0x5e0da6['textContent']='['+_0x565142['key']+']\x20'+_0x565142[_0x286bf0(0x105)],_0x4bafaa['appendChild'](_0x5e0da6);}):_0x4bafaa[_0xe10a2e(0x103)]=_0xe10a2e(0xe9);};_0x30a212[_0x10cc7e(0x161)](_0x10cc7e(0x11f),_0x17b71a),_0x204793[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x8553d),_0x1f3f8e['addEventListener'](_0x10cc7e(0x11f),_0x8553d),_0x193aae[_0x10cc7e(0x161)](_0x10cc7e(0x11f),()=>{const _0x3901f1=_0x10cc7e,_0x1e82f7=_0x204793['value'],_0x434138=_0x4bafaa[_0x3901f1(0x137)];if(!_0x1e82f7||!_0x434138){toastr['error'](_0x3901f1(0x114),_0x3901f1(0xc1));return;}executeRefinement(_0x1e82f7,_0x434138);});const _0x54ce9b=document[_0x10cc7e(0x132)](_0x10cc7e(0x10f));_0x54ce9b['checked']=extension_settings[extensionName][_0x10cc7e(0xed)]??![],_0x54ce9b[_0x10cc7e(0x161)](_0x10cc7e(0xfa),_0x863884=>{const _0x50f026=_0x10cc7e;extension_settings[extensionName][_0x50f026(0xed)]=_0x863884[_0x50f026(0xe5)]['checked'],saveSettings();});}function bindNgmsApiEvents(){const _0x94cd31=_0x3c62;console[_0x94cd31(0xea)](_0x94cd31(0xdc));const _0x464106=(_0x3b4622,_0xf96c73)=>{const _0x4bb96b=_0x94cd31;console['log'](_0x4bb96b(0x13e)+_0x3b4622+_0x4bb96b(0x118),_0xf96c73),!extension_settings[extensionName]&&(extension_settings[extensionName]={}),extension_settings[extensionName][_0x3b4622]=_0xf96c73,saveSettings(),console['log'](_0x4bb96b(0x14e)+_0x3b4622+_0x4bb96b(0x120));},_0x5bf9cf=document[_0x94cd31(0x132)]('amily2_ngms_enabled'),_0x26703d=document['getElementById'](_0x94cd31(0x11c));_0x5bf9cf&&_0x26703d&&(_0x5bf9cf[_0x94cd31(0x134)]=extension_settings[extensionName][_0x94cd31(0xe4)]??![],_0x26703d[_0x94cd31(0x138)][_0x94cd31(0x166)]=_0x5bf9cf[_0x94cd31(0x134)]?_0x94cd31(0xca):_0x94cd31(0x101),_0x5bf9cf[_0x94cd31(0x161)](_0x94cd31(0xfa),function(){const _0x309bf5=_0x94cd31,_0x476aab=this[_0x309bf5(0x134)];_0x464106(_0x309bf5(0xe4),_0x476aab),_0x26703d[_0x309bf5(0x138)][_0x309bf5(0x166)]=_0x476aab?_0x309bf5(0xca):_0x309bf5(0x101);}));const _0x15072c=document[_0x94cd31(0x132)](_0x94cd31(0x12f)),_0x4d717a=document['getElementById'](_0x94cd31(0xf3)),_0x296456=document['getElementById'](_0x94cd31(0x13f));if(_0x15072c&&_0x4d717a&&_0x296456){_0x15072c['value']=extension_settings[extensionName]['ngmsApiMode']||_0x94cd31(0xd8);const _0x59f538=_0x24d4c6=>{const _0x337db6=_0x94cd31;_0x24d4c6===_0x337db6(0x123)?(_0x4d717a[_0x337db6(0x138)]['display']=_0x337db6(0x101),_0x296456['style']['display']=_0x337db6(0xca),loadNgmsTavernPresets()):(_0x4d717a['style'][_0x337db6(0x166)]='block',_0x296456[_0x337db6(0x138)][_0x337db6(0x166)]=_0x337db6(0x101));};_0x59f538(_0x15072c[_0x94cd31(0x137)]),_0x15072c['addEventListener']('change',function(){const _0x52b4a7=_0x94cd31;_0x464106(_0x52b4a7(0x145),this[_0x52b4a7(0x137)]),_0x59f538(this['value']);});}const _0x524eea=[{'id':'amily2_ngms_api_url','key':_0x94cd31(0xbe)},{'id':_0x94cd31(0xf6),'key':_0x94cd31(0x15c)},{'id':_0x94cd31(0x102),'key':'ngmsModel'}];_0x524eea[_0x94cd31(0x15f)](_0x320b80=>{const _0x2558e9=_0x94cd31,_0x38aa2c=document[_0x2558e9(0x132)](_0x320b80['id']);_0x38aa2c&&(_0x38aa2c['value']=extension_settings[extensionName][_0x320b80[_0x2558e9(0x15e)]]||'',_0x38aa2c['addEventListener'](_0x2558e9(0xfa),function(){const _0x4b192e=_0x2558e9;_0x464106(_0x320b80[_0x4b192e(0x15e)],this[_0x4b192e(0x137)]);}));});const _0xd26c3f=[{'id':_0x94cd31(0xc8),'key':_0x94cd31(0x146),'defaultValue':0xfa0},{'id':'amily2_ngms_temperature','key':_0x94cd31(0xe3),'defaultValue':0.7}];_0xd26c3f[_0x94cd31(0x15f)](_0x46d795=>{const _0x1b2d43=_0x94cd31,_0x26e31c=document['getElementById'](_0x46d795['id']),_0x35612d=document[_0x1b2d43(0x132)](_0x46d795['id']+_0x1b2d43(0x155));if(_0x26e31c&&_0x35612d){const _0x27f465=extension_settings[extensionName][_0x46d795['key']]||_0x46d795[_0x1b2d43(0x133)];_0x26e31c['value']=_0x27f465,_0x35612d[_0x1b2d43(0xc7)]=_0x27f465,_0x26e31c[_0x1b2d43(0x161)]('input',function(){const _0x5eb682=_0x1b2d43,_0x4d1dad=parseFloat(this[_0x5eb682(0x137)]);_0x35612d['textContent']=_0x4d1dad,_0x464106(_0x46d795['key'],_0x4d1dad);});}});const _0x6efb7c=document[_0x94cd31(0x132)](_0x94cd31(0xd7));_0x6efb7c&&(_0x6efb7c[_0x94cd31(0x137)]=extension_settings[extensionName][_0x94cd31(0x148)]||'',_0x6efb7c['addEventListener'](_0x94cd31(0xfa),function(){const _0x42a9ec=_0x94cd31;_0x464106(_0x42a9ec(0x148),this[_0x42a9ec(0x137)]);}));const _0xff00d=document['getElementById'](_0x94cd31(0x11e));_0xff00d&&_0xff00d[_0x94cd31(0x161)]('click',async function(){const _0x414e80=_0x94cd31,_0x43737f=$(this),_0xe3b759=_0x43737f[_0x414e80(0x151)]();_0x43737f[_0x414e80(0xfe)](_0x414e80(0x113),!![])[_0x414e80(0x151)](_0x414e80(0x16a));try{await testNgmsApiConnection();}catch(_0x7ea21b){console['error'](_0x414e80(0xcc),_0x7ea21b);}finally{_0x43737f['prop'](_0x414e80(0x113),![])[_0x414e80(0x151)](_0xe3b759);}});const _0x4475c9=document[_0x94cd31(0x132)](_0x94cd31(0x12b)),_0x11009e=document['getElementById'](_0x94cd31(0x164)),_0x574134=document[_0x94cd31(0x132)](_0x94cd31(0x102));_0x4475c9&&_0x11009e&&_0x574134&&_0x4475c9['addEventListener'](_0x94cd31(0x11f),async function(){const _0x7b6bf3=_0x94cd31,_0x361838=$(this),_0x2cb194=_0x361838[_0x7b6bf3(0x151)]();_0x361838[_0x7b6bf3(0xfe)]('disabled',!![])[_0x7b6bf3(0x151)](_0x7b6bf3(0x122));try{const _0x1687b9=await fetchNgmsModels();_0x1687b9&&_0x1687b9[_0x7b6bf3(0x14c)]>0x0?(_0x11009e[_0x7b6bf3(0x103)]='<option\x20value=\x22\x22>--\x20请选择模型\x20--</option>',_0x1687b9[_0x7b6bf3(0x15f)](_0x58f5e2=>{const _0x4008f0=_0x7b6bf3,_0x12e5f0=document[_0x4008f0(0xbc)](_0x4008f0(0x16d));_0x12e5f0[_0x4008f0(0x137)]=_0x58f5e2['id']||_0x58f5e2['name']||_0x58f5e2,_0x12e5f0[_0x4008f0(0xc7)]=_0x58f5e2[_0x4008f0(0xef)]||_0x58f5e2['id']||_0x58f5e2,_0x11009e[_0x4008f0(0x13b)](_0x12e5f0);}),_0x11009e[_0x7b6bf3(0x138)]['display']=_0x7b6bf3(0xca),_0x574134[_0x7b6bf3(0x138)][_0x7b6bf3(0x166)]=_0x7b6bf3(0x101),_0x11009e[_0x7b6bf3(0x161)](_0x7b6bf3(0xfa),function(){const _0x4ec4fa=_0x7b6bf3,_0x369bbc=this[_0x4ec4fa(0x137)];_0x574134['value']=_0x369bbc,_0x464106(_0x4ec4fa(0x142),_0x369bbc),console[_0x4ec4fa(0xea)](_0x4ec4fa(0x15d)+_0x369bbc);}),toastr['success'](_0x7b6bf3(0x15b)+_0x1687b9['length']+_0x7b6bf3(0x10a),'Ngms\x20模型获取')):toastr[_0x7b6bf3(0x121)]('未获取到任何模型',_0x7b6bf3(0xbf));}catch(_0x2e0cab){console[_0x7b6bf3(0xf1)](_0x7b6bf3(0xd4),_0x2e0cab),toastr[_0x7b6bf3(0xf1)](_0x7b6bf3(0x159)+_0x2e0cab['message'],_0x7b6bf3(0xbf));}finally{_0x361838['prop'](_0x7b6bf3(0x113),![])[_0x7b6bf3(0x151)](_0x2cb194);}});}async function loadNgmsTavernPresets(){const _0x5d0b4f=_0x3c62,_0x114d0c=document[_0x5d0b4f(0x132)]('amily2_ngms_tavern_profile');if(!_0x114d0c)return;const _0x366c43=_0x114d0c[_0x5d0b4f(0x137)];_0x114d0c[_0x5d0b4f(0x103)]=_0x5d0b4f(0x124);try{const _0x50b3f6=getContext(),_0xea1458=_0x50b3f6[_0x5d0b4f(0xd6)]?.['connectionManager']?.['profiles']||[];_0x114d0c[_0x5d0b4f(0x103)]='<option\x20value=\x22\x22>--\x20请选择预设\x20--</option>',_0xea1458[_0x5d0b4f(0x14c)]>0x0?_0xea1458[_0x5d0b4f(0x15f)](_0x72fc00=>{const _0x34ac7e=_0x5d0b4f;if(_0x72fc00[_0x34ac7e(0x12c)]&&_0x72fc00[_0x34ac7e(0x14d)]){const _0x3301d0=document['createElement'](_0x34ac7e(0x16d));_0x3301d0[_0x34ac7e(0x137)]=_0x72fc00['id'],_0x3301d0[_0x34ac7e(0xc7)]=_0x72fc00[_0x34ac7e(0xef)]||_0x72fc00['id'],_0x72fc00['id']===_0x366c43&&(_0x3301d0[_0x34ac7e(0x152)]=!![]),_0x114d0c[_0x34ac7e(0x13b)](_0x3301d0);}}):_0x114d0c[_0x5d0b4f(0x103)]='<option\x20value=\x22\x22>未找到可用预设</option>';}catch(_0x259847){console[_0x5d0b4f(0xf1)](_0x5d0b4f(0xff),_0x259847),_0x114d0c[_0x5d0b4f(0x103)]=_0x5d0b4f(0xf9);}}function showHistoriographyExclusionRulesModal(){const _0x454641=_0x3c62,_0x2ce1ce=extension_settings[extensionName][_0x454641(0x125)]||[],_0x4c9eb3=(_0x1f7afd={'start':'','end':''},_0x15143f)=>_0x454641(0xe1)+_0x15143f+_0x454641(0x14a)+_0x1f7afd[_0x454641(0xd3)]+'\x22\x20placeholder=\x22开始字符,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22'+_0x1f7afd['end']+'\x22\x20placeholder=\x22结束字符,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-delete-rule-btn\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20',_0x40200e=_0x2ce1ce[_0x454641(0x14b)](_0x4c9eb3)['join'](''),_0x381b69=_0x454641(0x15a)+_0x40200e+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22historiography-add-rule-btn\x22\x20class=\x22hly-action-button\x22\x20style=\x22margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20{\x20display:\x20flex;\x20align-items:\x20center;\x20gap:\x2010px;\x20margin-bottom:\x2010px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20input\x20{\x20flex-grow:\x201;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-delete-rule-btn\x20{\x20background:\x20#c0392b;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x2050%;\x20width:\x2024px;\x20height:\x2024px;\x20cursor:\x20pointer;\x20font-size:\x2016px;\x20line-height:\x2024px;\x20text-align:\x20center;\x20padding:\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20';showHtmlModal(_0x454641(0x16c),_0x381b69,{'okText':'保存规则','onOk':_0x4b524d=>{const _0x2baf07=_0x454641,_0x52e2c8=[];_0x4b524d['find']('.hly-exclusion-rule-row')['each'](function(){const _0x2734b9=_0x3c62,_0x140cd5=$(this)[_0x2734b9(0xbd)](_0x2734b9(0x150))['eq'](0x0)['val']()[_0x2734b9(0x10c)](),_0x8f0f26=$(this)[_0x2734b9(0xbd)](_0x2734b9(0x150))['eq'](0x1)[_0x2734b9(0x156)]()[_0x2734b9(0x10c)]();_0x140cd5&&_0x8f0f26&&_0x52e2c8[_0x2734b9(0xce)]({'start':_0x140cd5,'end':_0x8f0f26});}),extension_settings[extensionName][_0x2baf07(0x125)]=_0x52e2c8,saveSettings(),toastr[_0x2baf07(0xf2)](_0x2baf07(0x109),_0x2baf07(0xf8));},'onShow':_0x3af03e=>{const _0x51da14=_0x454641,_0x3a964e=_0x3af03e[_0x51da14(0xbd)]('#historiography-rules-list');_0x3af03e[_0x51da14(0xbd)](_0x51da14(0x110))['on'](_0x51da14(0x11f),()=>{const _0x57f05c=_0x51da14,_0x3e0464=_0x3a964e['children']()['length'],_0x5ad8c0=_0x4c9eb3({'start':'','end':''},_0x3e0464);_0x3a964e[_0x57f05c(0x158)](_0x5ad8c0);}),_0x3a964e['on'](_0x51da14(0x11f),_0x51da14(0xc9),function(){const _0x1976cb=_0x51da14;$(this)[_0x1976cb(0xd0)](_0x1976cb(0x162))['remove']();});}});}
