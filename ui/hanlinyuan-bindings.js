const _0x15063a=_0x1493;(function(_0x34aeee,_0x57ca71){const _0xd13f55=_0x1493,_0x5679d6=_0x34aeee();while(!![]){try{const _0x1bcd02=-parseInt(_0xd13f55(0x179))/0x1*(parseInt(_0xd13f55(0x1e5))/0x2)+-parseInt(_0xd13f55(0x27c))/0x3+parseInt(_0xd13f55(0x320))/0x4*(parseInt(_0xd13f55(0x23b))/0x5)+parseInt(_0xd13f55(0x28d))/0x6+parseInt(_0xd13f55(0x2a0))/0x7*(parseInt(_0xd13f55(0x325))/0x8)+parseInt(_0xd13f55(0x307))/0x9+-parseInt(_0xd13f55(0x276))/0xa;if(_0x1bcd02===_0x57ca71)break;else _0x5679d6['push'](_0x5679d6['shift']());}catch(_0x4b1d3d){_0x5679d6['push'](_0x5679d6['shift']());}}}(_0x4662,0x4d9d8));import{getContext}from'/scripts/extensions.js';import*as _0x4b5037 from'../core/rag-processor.js';import*as _0x337832 from'../core/historiographer.js';import*as _0x535b3f from'../core/utils/context-utils.js';import*as _0x405f63 from'../core/ingestion-manager.js';import{showContentModal,showHtmlModal}from'./page-window.js';import{extractBlocksByTags,applyExclusionRules}from'../core/utils/rag-tag-extractor.js';import{filterWorldbooks,filterWorldbookEntries,highlightSearchMatch,debounce}from'../core/rag-processor.js';_0x15063a(0x235);function setupGlobalEventHandlers(){const _0x6c22d1=_0x15063a;window[_0x6c22d1(0x196)]=()=>saveSettingsFromUI(![]),window[_0x6c22d1(0x1dd)]=resetSettingsToUI,window[_0x6c22d1(0x25d)]=testApi,window['fetchHLYEmbeddingModels']=fetchHLYEmbeddingModels,window['fetchHLYRerankModels']=fetchHLYRerankModels,window['updateHLYMemoryCount']=updatePanelStatus,window[_0x6c22d1(0x1ea)]=purgeStorage,window[_0x6c22d1(0x20c)]=startCondensation,window[_0x6c22d1(0x2f8)]=previewCondensation,window[_0x6c22d1(0x30e)]=ingestManualText,window[_0x6c22d1(0x18e)]=log,window[_0x6c22d1(0x223)]=showStats,window['startHLYHistoriography']=startHistoriography;}function updateAndSaveSetting(_0x1b4d0d,_0x6b43af){const _0x32e269=_0x15063a,_0x57337f=_0x4b5037['getSettings']();if(!_0x57337f)return;const _0x169b53=_0x1b4d0d['split']('.');let _0x1fc950=_0x57337f;for(let _0x323e66=0x0;_0x323e66<_0x169b53[_0x32e269(0x30f)]-0x1;_0x323e66++){_0x1fc950=_0x1fc950[_0x169b53[_0x323e66]]=_0x1fc950[_0x169b53[_0x323e66]]||{};}_0x1fc950[_0x169b53[_0x169b53[_0x32e269(0x30f)]-0x1]]=_0x6b43af,_0x4b5037[_0x32e269(0x347)](),log('[自动保存]\x20设置项\x20\x27'+_0x1b4d0d+_0x32e269(0x168)+JSON[_0x32e269(0x187)](_0x6b43af),_0x32e269(0x336));}function bindAutoSaveEvents(){const _0x2dceed=_0x15063a,_0x41bfbe=document[_0x2dceed(0x220)](_0x2dceed(0x1cf));if(!_0x41bfbe)return;_0x41bfbe['addEventListener'](_0x2dceed(0x1c5),_0xd4f9f0=>{const _0x121712=_0x2dceed,_0x4d06bd=_0xd4f9f0[_0x121712(0x2a7)],_0x5878ad=_0x4d06bd[_0x121712(0x193)][_0x121712(0x360)];if(!_0x5878ad)return;let _0x5374ad;const _0x33a129=_0x4d06bd[_0x121712(0x193)][_0x121712(0x2f3)]||'string';if(_0x4d06bd[_0x121712(0x2f3)]===_0x121712(0x353))_0x5374ad=_0x4d06bd[_0x121712(0x2d8)];else{if(_0x4d06bd[_0x121712(0x2f3)]===_0x121712(0x2b9)){if(_0x4d06bd['checked']){const _0x9e2027=_0x41bfbe[_0x121712(0x1f3)](_0x121712(0x2c9)+_0x4d06bd[_0x121712(0x265)]+'\x22]'),_0x5c3e78=Array[_0x121712(0x173)](_0x9e2027)[_0x121712(0x210)](_0x214dff=>_0x214dff[_0x121712(0x2d8)]);_0x5374ad=_0x5c3e78[_0x121712(0x314)];}else return;}else _0x5374ad=_0x4d06bd['value'];}switch(_0x33a129){case _0x121712(0x190):_0x5374ad=parseInt(_0x5374ad,0xa);break;case _0x121712(0x340):_0x5374ad=parseFloat(_0x5374ad);break;case _0x121712(0x1f4):typeof _0x5374ad!==_0x121712(0x1f4)&&(_0x5374ad=_0x5374ad===_0x121712(0x275));break;}if(_0x4d06bd[_0x121712(0x2f3)]===_0x121712(0x2b9)&&!_0x4d06bd['checked'])return;updateAndSaveSetting(_0x5878ad,_0x5374ad),_0x5878ad==='retrieval.independentChatMemoryEnabled'&&updatePanelStatus();});}export function bindHanlinyuanEvents(){const _0x513356=_0x15063a,_0x49ddcc=getContext();if(!_0x49ddcc){console[_0x513356(0x2f5)](_0x513356(0x2e9));return;}setupGlobalEventHandlers(),bindPanelToggleEvents(),bindInternalUIEvents(),bindTutorialEvents(),bindAutoSaveEvents(),bindSessionLockEvent(),initializeUnifiedInjectionEditor();if(_0x4b5037[_0x513356(0x2c0)])_0x4b5037['initialize']();else{console[_0x513356(0x2f5)]('[翰林院-枢纽]\x20核心法典未能提供初始化圣旨！');return;}loadSettingsToUI(),loadWorldbookList(),log(_0x513356(0x35a),'info');const _0x4dce75=document[_0x513356(0x220)](_0x513356(0x1b7)),_0x3111b5=document[_0x513356(0x220)](_0x513356(0x1cd)),_0x131295=document[_0x513356(0x220)](_0x513356(0x2e2)),_0x37f902=document[_0x513356(0x220)](_0x513356(0x2b6)),_0x204cbe=document[_0x513356(0x220)](_0x513356(0x234)),_0x17069e=document[_0x513356(0x220)]('hanlinyuan-ingest-progress-bar'),_0xcbbbbe=document['getElementById'](_0x513356(0x37b)),_0x20c66e=document[_0x513356(0x220)](_0x513356(0x212));let _0x30c9ae=null,_0x58fa0e=null;_0x4dce75['addEventListener'](_0x513356(0x1c5),_0x3ecb7f=>{const _0x190dab=_0x513356;_0x30c9ae=_0x3ecb7f['target'][_0x190dab(0x1bd)][0x0],_0x30c9ae?(_0x3111b5['textContent']=_0x30c9ae[_0x190dab(0x265)],_0x3111b5['title']=_0x30c9ae['name']):_0x3111b5[_0x190dab(0x17b)]=_0x190dab(0x2cf);}),_0x131295['addEventListener']('click',async()=>{const _0x540cec=_0x513356;if(!_0x30c9ae){toastr[_0x540cec(0x181)](_0x540cec(0x24d));return;}let _0x52461f=0x0;const _0x17d79a=_0x405f63['generateJobId'](_0x30c9ae),_0x42b33f=_0x405f63[_0x540cec(0x249)](_0x17d79a);if(_0x42b33f){const _0x2dfce5=(_0x42b33f['processedChunks']/_0x42b33f[_0x540cec(0x1d9)]*0x64)[_0x540cec(0x22e)](0x1),_0x559a2e=confirm(_0x540cec(0x31e)+_0x2dfce5+'%。是否从上次中断之处继续？');_0x559a2e?(_0x52461f=_0x42b33f[_0x540cec(0x24c)],toastr[_0x540cec(0x1d7)](_0x540cec(0x2ef)+(_0x52461f+0x1)+_0x540cec(0x35d),'圣旨已达'),log('[断点续传]\x20用户选择继续任务\x20'+_0x17d79a+_0x540cec(0x301)+_0x52461f+_0x540cec(0x2dc),_0x540cec(0x1d7))):(_0x405f63[_0x540cec(0x1a7)](_0x17d79a),toastr[_0x540cec(0x1d7)](_0x540cec(0x17f),_0x540cec(0x369)),log('[断点续传]\x20用户选择放弃旧任务\x20'+_0x17d79a+_0x540cec(0x18a),_0x540cec(0x195)));}_0x58fa0e=new AbortController();const _0x5ce50b=_0x58fa0e[_0x540cec(0x244)];_0x20c66e[_0x540cec(0x2f6)][_0x540cec(0x208)]='none',_0x204cbe[_0x540cec(0x2f6)][_0x540cec(0x208)]=_0x540cec(0x2b5),_0xcbbbbe[_0x540cec(0x17b)]=_0x540cec(0x32c),_0x17069e['value']=0x0;try{const _0x552cdb=await _0x30c9ae[_0x540cec(0x293)](),_0x989ca8=_0x6501=>{const _0x1b3530=_0x540cec;_0xcbbbbe[_0x1b3530(0x17b)]=_0x1b3530(0x32a)+_0x6501[_0x1b3530(0x2fd)]+'\x20('+_0x6501[_0x1b3530(0x248)]+'/'+_0x6501[_0x1b3530(0x1fc)]+')',_0x17069e[_0x1b3530(0x314)]=_0x6501[_0x1b3530(0x248)]/_0x6501['total']*0x64;},_0x54d4f0=()=>{const _0x149147=_0x540cec;updatePanelStatus(),log('[实时刷新]\x20批次完成，忆识总数已更新。',_0x149147(0x1d7));},_0x6d1b44=await _0x4b5037[_0x540cec(0x344)](_0x552cdb,_0x540cec(0x21e),{'sourceName':_0x30c9ae[_0x540cec(0x265)]},_0x989ca8,_0x5ce50b,log,_0x54d4f0,_0x17d79a,_0x52461f);if(_0x6d1b44[_0x540cec(0x336)])toastr['success'](_0x540cec(0x27f)+_0x6d1b44[_0x540cec(0x310)]+'\x20个知识块'),_0xcbbbbe[_0x540cec(0x17b)]=_0x540cec(0x183)+_0x6d1b44[_0x540cec(0x310)]+_0x540cec(0x171),_0x17069e[_0x540cec(0x314)]=0x64,updatePanelStatus();else throw new Error(_0x6d1b44[_0x540cec(0x2f5)]||_0x540cec(0x297));}catch(_0x60a7ad){_0x60a7ad['name']==='AbortError'?(toastr['info']('任务已由用户中止。进度已保存，可随时继续。'),_0xcbbbbe[_0x540cec(0x17b)]=_0x540cec(0x1fb)):(toastr['error']('录入失败:\x20'+_0x60a7ad[_0x540cec(0x2fd)]+_0x540cec(0x206)),_0xcbbbbe[_0x540cec(0x17b)]='错误:\x20'+_0x60a7ad[_0x540cec(0x2fd)]);}finally{setTimeout(()=>{const _0x132dc5=_0x540cec;_0x20c66e['style'][_0x132dc5(0x208)]=_0x132dc5(0x26f),_0x204cbe['style'][_0x132dc5(0x208)]=_0x132dc5(0x222),_0x4dce75[_0x132dc5(0x314)]='',_0x30c9ae=null,_0x3111b5[_0x132dc5(0x17b)]=_0x132dc5(0x2cf);},0xbb8);}}),_0x37f902['addEventListener'](_0x513356(0x1c6),()=>{const _0x1037da=_0x513356;_0x58fa0e&&_0x58fa0e[_0x1037da(0x20d)]();});}function bindSessionLockEvent(){const _0x38511b=_0x15063a,_0x1cb385=document[_0x38511b(0x220)]('hly-session-lock-btn');if(!_0x1cb385)return;_0x1cb385[_0x38511b(0x23f)]('click',async()=>{const _0x99a514=_0x38511b,_0x4f7f05=await _0x4b5037[_0x99a514(0x1d8)]();updateSessionLockUI(_0x4f7f05);if(_0x4f7f05){const _0x1f77b6=_0x4b5037['getLockedSessionInfo']();_0x1f77b6&&(toastr['success'](_0x99a514(0x292)+_0x1f77b6['id'],_0x99a514(0x26d)),log(_0x99a514(0x1b9)+_0x1f77b6['id'],'success'));}else toastr['info'](_0x99a514(0x1f1),'诏曰'),log('会话已解锁。',_0x99a514(0x1d7));updatePanelStatus();}),updateSessionLockUI(_0x4b5037[_0x38511b(0x2d7)]());}function updateSessionLockUI(_0x57406e){const _0x2e044a=_0x15063a,_0x2c65ee=document[_0x2e044a(0x220)](_0x2e044a(0x263));if(!_0x2c65ee)return;const _0x8248eb=_0x2c65ee[_0x2e044a(0x267)]('i'),_0x1715b5=_0x2c65ee[_0x2e044a(0x267)](_0x2e044a(0x191));_0x57406e?(_0x2c65ee[_0x2e044a(0x29e)][_0x2e044a(0x1ca)](_0x2e044a(0x229)),_0x8248eb[_0x2e044a(0x366)]='fas\x20fa-lock',_0x1715b5[_0x2e044a(0x17b)]=_0x2e044a(0x2be),_0x2c65ee['title']=_0x2e044a(0x2b8)):(_0x2c65ee[_0x2e044a(0x29e)][_0x2e044a(0x371)]('active'),_0x8248eb[_0x2e044a(0x366)]=_0x2e044a(0x277),_0x1715b5[_0x2e044a(0x17b)]=_0x2e044a(0x2cc),_0x2c65ee['title']=_0x2e044a(0x377));}function bindPanelToggleEvents(){const _0x498667=_0x15063a,_0x1cd151=document['getElementById'](_0x498667(0x1e4));if(_0x1cd151){}}function bindTutorialEvents(){const _0x4fb183=_0x15063a,_0x3bbf24=document[_0x4fb183(0x220)](_0x4fb183(0x271));_0x3bbf24&&_0x3bbf24['addEventListener']('click',()=>{const _0x398ab1=_0x4fb183;showContentModal(_0x398ab1(0x28e),'scripts/extensions/third-party/ST-Amily2-Chat-Optimisation/HanLin.md');});}function bindInternalUIEvents(){const _0x5e6894=_0x15063a,_0x14e4a3=document[_0x5e6894(0x1f3)](_0x5e6894(0x170));_0x14e4a3[_0x5e6894(0x19b)](_0x570d60=>{const _0x1da4d6=_0x5e6894;_0x570d60[_0x1da4d6(0x23f)](_0x1da4d6(0x1c6),()=>{const _0x18f995=_0x1da4d6,_0x1efcb3=_0x570d60[_0x18f995(0x193)][_0x18f995(0x16b)],_0xff5b4b=_0x18f995(0x355)+_0x1efcb3+'-tab';document['querySelectorAll'](_0x18f995(0x376))[_0x18f995(0x19b)](_0x55ac83=>{const _0x5da533=_0x18f995;_0x55ac83['classList']['toggle'](_0x5da533(0x229),_0x55ac83['id']===_0xff5b4b);}),_0x14e4a3[_0x18f995(0x19b)](_0xbb3f45=>_0xbb3f45['classList'][_0x18f995(0x207)](_0x18f995(0x229),_0xbb3f45===_0x570d60));});});const _0x5b2642=document[_0x5e6894(0x220)](_0x5e6894(0x339));_0x5b2642&&_0x5b2642[_0x5e6894(0x23f)](_0x5e6894(0x1c5),handleApiModeChange);const _0x3c631f=document[_0x5e6894(0x220)](_0x5e6894(0x2e5)),_0x29ed01=document['getElementById'](_0x5e6894(0x22f));_0x3c631f&&_0x29ed01&&_0x3c631f['addEventListener'](_0x5e6894(0x1c5),()=>{const _0x4da4ed=_0x5e6894;_0x29ed01[_0x4da4ed(0x2f6)][_0x4da4ed(0x208)]=_0x3c631f[_0x4da4ed(0x2d8)]?_0x4da4ed(0x2b5):_0x4da4ed(0x222);});const _0x21dcd3=document[_0x5e6894(0x220)]('hly-hist-select-library');_0x21dcd3&&_0x21dcd3['addEventListener'](_0x5e6894(0x1c5),handleWorldbookSelectionChange);const _0x5f357f=document[_0x5e6894(0x220)](_0x5e6894(0x266));_0x5f357f&&_0x5f357f[_0x5e6894(0x23f)]('click',()=>showRulesModal('condensation'));const _0x78e230=document[_0x5e6894(0x220)]('hly-query-preprocessing-rules-btn');_0x78e230&&_0x78e230[_0x5e6894(0x23f)](_0x5e6894(0x1c6),()=>showRulesModal(_0x5e6894(0x2d4)));const _0x520da4=document[_0x5e6894(0x220)]('hly-hist-entry-multiselect-btn'),_0x5032f3=document['getElementById']('hly-hist-entry-multiselect-options');_0x520da4&&_0x5032f3&&(_0x520da4['addEventListener'](_0x5e6894(0x1c6),_0xb24f2c=>{const _0xfbaafd=_0x5e6894;_0xb24f2c[_0xfbaafd(0x316)]();const _0x265df2=_0x5032f3[_0xfbaafd(0x2f6)][_0xfbaafd(0x208)]===_0xfbaafd(0x2b5);_0x5032f3[_0xfbaafd(0x2f6)][_0xfbaafd(0x208)]=_0x265df2?_0xfbaafd(0x222):'block';}),_0x5032f3[_0x5e6894(0x23f)](_0x5e6894(0x1c5),_0xaf842d=>{const _0x6a1fdd=_0x5e6894,_0x2c7851=_0xaf842d['target'];if(_0x2c7851['type']!==_0x6a1fdd(0x353))return;const _0x2541b3=_0x5032f3[_0x6a1fdd(0x1f3)]('.hly-hist-entry-checkbox'),_0x4accaf=document[_0x6a1fdd(0x220)](_0x6a1fdd(0x237));if(_0x2c7851['id']===_0x6a1fdd(0x237))_0x2541b3[_0x6a1fdd(0x19b)](_0x2dbd15=>_0x2dbd15['checked']=_0x2c7851[_0x6a1fdd(0x2d8)]);else{const _0x5578f6=Array['from'](_0x2541b3)[_0x6a1fdd(0x29b)](_0x10dffa=>_0x10dffa[_0x6a1fdd(0x2d8)]);_0x4accaf['checked']=_0x5578f6;}const _0xa74060=_0x5032f3[_0x6a1fdd(0x1f3)](_0x6a1fdd(0x28b))[_0x6a1fdd(0x30f)],_0x4fa187=_0x2541b3['length'];_0x520da4[_0x6a1fdd(0x267)]('span')['textContent']='已选择\x20'+_0xa74060+_0x6a1fdd(0x16e)+_0x4fa187+_0x6a1fdd(0x36c);}),document[_0x5e6894(0x23f)]('click',_0xf7f376=>{const _0x52de9e=_0x5e6894;!_0x520da4[_0x52de9e(0x312)](_0xf7f376['target'])&&!_0x5032f3[_0x52de9e(0x312)](_0xf7f376['target'])&&(_0x5032f3[_0x52de9e(0x2f6)]['display']=_0x52de9e(0x222));}));const _0x5b7e35=document[_0x5e6894(0x220)](_0x5e6894(0x250));_0x5b7e35&&_0x5b7e35[_0x5e6894(0x23f)](_0x5e6894(0x1c6),deleteAllLocalKnowledgeBases);const _0x10fb46=document[_0x5e6894(0x220)](_0x5e6894(0x2c8));_0x10fb46&&_0x10fb46['addEventListener'](_0x5e6894(0x1c6),()=>moveAllKnowledgeBases(_0x5e6894(0x17a)));const _0x119b1a=document[_0x5e6894(0x220)](_0x5e6894(0x270));_0x119b1a&&_0x119b1a[_0x5e6894(0x23f)]('click',()=>moveAllKnowledgeBases(_0x5e6894(0x2ff)));const _0x297877=['hly-kb-list-local','hly-kb-list-global'];_0x297877[_0x5e6894(0x19b)](_0x4ca3f5=>{const _0x1584f6=_0x5e6894,_0x21d63b=document[_0x1584f6(0x220)](_0x4ca3f5);_0x21d63b&&(_0x21d63b[_0x1584f6(0x23f)]('click',handleKbAction),_0x21d63b['addEventListener']('change',handleKbAction));}),document['getElementById'](_0x5e6894(0x34b))[_0x5e6894(0x23f)](_0x5e6894(0x1c5),_0x432233=>handleSelectAll(_0x432233,_0x5e6894(0x285))),document[_0x5e6894(0x220)](_0x5e6894(0x330))[_0x5e6894(0x23f)](_0x5e6894(0x1c5),_0x1b54e7=>handleSelectAll(_0x1b54e7,'local')),document[_0x5e6894(0x220)](_0x5e6894(0x321))[_0x5e6894(0x23f)](_0x5e6894(0x1c6),_0x402faf=>handleBulkAction(_0x402faf,_0x5e6894(0x285))),document['getElementById'](_0x5e6894(0x33f))[_0x5e6894(0x23f)]('click',_0x45270a=>handleBulkAction(_0x45270a,_0x5e6894(0x251)));}function initializeUnifiedInjectionEditor(){const _0xebe17d=_0x15063a,_0x1233f0=document[_0xebe17d(0x220)]('hly-injection-source-selector'),_0x3ec990=document[_0xebe17d(0x220)]('hly-unified-template-editor'),_0xac1592=document[_0xebe17d(0x220)](_0xebe17d(0x2ee)),_0x5cacca=document[_0xebe17d(0x1f3)]('input[name=\x22hly-unified-injection-position\x22]'),_0x27e5ce=document[_0xebe17d(0x220)](_0xebe17d(0x1ef)),_0x2286e0=document[_0xebe17d(0x220)](_0xebe17d(0x2a5));if(!_0x1233f0)return;const _0x26fd34={'novel':'{{novel_text}}','chat':_0xebe17d(0x203),'lorebook':_0xebe17d(0x1b1),'manual':_0xebe17d(0x2ce)};function _0x3f2b38(){const _0x17c3aa=_0xebe17d,_0x36de2b=_0x1233f0[_0x17c3aa(0x314)],_0x460ea5=_0x4b5037[_0x17c3aa(0x2d1)](),_0x527f6d=_0x460ea5[_0x17c3aa(0x1aa)+_0x36de2b]||{};_0x3ec990[_0x17c3aa(0x314)]=_0x527f6d[_0x17c3aa(0x338)]||'',_0xac1592['textContent']='以\x20'+(_0x26fd34[_0x36de2b]||_0x17c3aa(0x2c4))+_0x17c3aa(0x1ba);const _0x4397bb=_0x527f6d[_0x17c3aa(0x202)]!==undefined?String(_0x527f6d[_0x17c3aa(0x202)]):'2';_0x5cacca[_0x17c3aa(0x19b)](_0x28a5d1=>_0x28a5d1['checked']=_0x28a5d1[_0x17c3aa(0x314)]===_0x4397bb),_0x27e5ce[_0x17c3aa(0x314)]=_0x527f6d['depth']||0x0,_0x2286e0[_0x17c3aa(0x314)]=_0x527f6d[_0x17c3aa(0x37f)]!==undefined?String(_0x527f6d[_0x17c3aa(0x37f)]):'0';const _0x22bac3=_0x4397bb==='1';_0x27e5ce[_0x17c3aa(0x2a6)]=!_0x22bac3,_0x2286e0['disabled']=!_0x22bac3;}function _0x2a9ed8(){const _0xe7fcbc=_0xebe17d,_0x2e8e18=_0x1233f0['value'];updateAndSaveSetting(_0xe7fcbc(0x1aa)+_0x2e8e18+_0xe7fcbc(0x31c),_0x3ec990[_0xe7fcbc(0x314)]);const _0x197749=document[_0xe7fcbc(0x267)](_0xe7fcbc(0x317));_0x197749&&updateAndSaveSetting(_0xe7fcbc(0x1aa)+_0x2e8e18+_0xe7fcbc(0x2e8),parseInt(_0x197749[_0xe7fcbc(0x314)],0xa)),updateAndSaveSetting(_0xe7fcbc(0x1aa)+_0x2e8e18+'.depth',parseInt(_0x27e5ce[_0xe7fcbc(0x314)],0xa)),updateAndSaveSetting(_0xe7fcbc(0x1aa)+_0x2e8e18+'.depth_role',parseInt(_0x2286e0[_0xe7fcbc(0x314)],0xa));}_0x1233f0[_0xebe17d(0x23f)](_0xebe17d(0x1c5),_0x3f2b38);const _0x14bbde=debounce(_0x2a9ed8,0x12c);_0x3ec990[_0xebe17d(0x23f)]('input',_0x14bbde),_0x27e5ce[_0xebe17d(0x23f)](_0xebe17d(0x1c5),_0x2a9ed8),_0x2286e0[_0xebe17d(0x23f)](_0xebe17d(0x1c5),_0x2a9ed8),_0x5cacca['forEach'](_0x4d9d55=>_0x4d9d55[_0xebe17d(0x23f)]('change',()=>{const _0xd2d4ae=_0xebe17d;_0x2a9ed8();const _0x52d02f=_0x4d9d55['value']==='1'&&_0x4d9d55[_0xd2d4ae(0x2d8)];_0x27e5ce[_0xd2d4ae(0x2a6)]=!_0x52d02f,_0x2286e0[_0xd2d4ae(0x2a6)]=!_0x52d02f;})),_0x3f2b38();}function _0x4662(){const _0xb530e7=['\x20个知识库的启用状态吗？','position','{{chat_text}}','hly-kb-select-all-','\x20操作失败:\x20','。进度已保存，可稍后重试。','toggle','display','移动失败:\x20','local_proxy','log-error','startHLYCondensation','abort','翰林院设定已重置为初始状态。','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</details>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-preview-delete-btn-v2\x22\x20data-target=\x22','find','hly-overlap-size','hanlinyuan-ingest-novel-controls','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22slider\x22></span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-modal-tag-input-container\x22\x20class=\x22hly-control-block\x22\x20style=\x22display:\x20','[翰林院-枢纽]\x20编纂过程发生严重错误:','此书库为空','chat','placeholder','\x20个局部知识库吗？此操作无法恢复！','知识库【','收到手动录入请求，文本长度:\x20','正在加载条目...','kbScope','kbId','novel','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22\x20title=\x22','getElementById','options','none','showHLYStats','删除失败:\x20','开始获取模型列表...','\x20移动到\x20','</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20id=\x22hly-add-rule-btn\x22\x20class=\x22hly-action-button\x22\x20style=\x22margin-top:\x2010px;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<i\x20class=\x22fas\x20fa-plus\x22></i>\x20添加新规则\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</fieldset>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<style>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20{\x20display:\x20flex;\x20align-items:\x20center;\x20gap:\x2010px;\x20margin-bottom:\x2010px;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-exclusion-rule-row\x20input\x20{\x20flex-grow:\x201;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20.hly-delete-rule-btn\x20{\x20background:\x20#c0392b;\x20color:\x20white;\x20border:\x20none;\x20border-radius:\x2050%;\x20width:\x2024px;\x20height:\x2024px;\x20cursor:\x20pointer;\x20font-size:\x2016px;\x20line-height:\x2024px;\x20text-align:\x20center;\x20padding:\x200;\x20flex-shrink:\x200;\x20}\x0a\x20\x20\x20\x20\x20\x20\x20\x20</style>\x0a\x20\x20\x20\x20','\x20个知识库。','active','请至少选择一个知识库进行操作。','》的批量编纂任务已完成。成功:\x20','通行令牌\x20(API\x20Key):','label','toFixed','hly-tag-input-container','hly-worldbook-search','所有\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-kb-name-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-item-checkbox\x22\x20data-kb-id=\x22','hly-kb-item-checkbox','hanlinyuan-ingest-progress-container','use\x20strict','查询宝库状态失败:\x20','hly-hist-select-all-entries','hly-custom-api-url','val','messageTypes','5IUZTtJ','删除知识库\x20','\x20个条目进行编纂...','hly-retrieval-notify','addEventListener','findIndex','未找到符合条件的消息。','.hly-exclusion-rule-row','<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22下移到局部\x22><i\x20class=\x22fas\x20fa-arrow-down\x22></i></button>','signal','queryMessageCount','\x20状态失败:\x20','closest','processed','loadProgress','createElement','appendChild','processedChunks','请先选择一个\x20.txt\x20文件','hly-current-character-name','hly-include-user','hly-kb-delete-local-btn','local','.count\x22]','未找到符合条件的消息可供凝识。','获取模型失败:\x20','.hly-kb-item-checkbox','<option>未找到模型</option>','hly-match-threshold','成功删除了\x20','#hly-modal-tag-input-container','hly-kb-toggle','\x20个模型。','\x20个知识库从\x20','testHLYApi','getCollectionId','您确定要永久删除知识库【','[翰林院-枢纽]\x20手动录入过程发生错误:','condensation','翰林院设定已存档封印。','hly-session-lock-btn','\x20楼:\x20[','name','hly-exclusion-rules-btn','querySelector','.hly-kb-list-item','N/A','matchThreshold','\x20楼。</i></p>','renameKnowledgeBase','圣旨已下','includes','flex','hly-kb-move-all-to-global','amily2_open_hanlin_tutorial','\x20个知识库执行批量操作...','\x20个知识库吗？此操作无法恢复！','录入内容不能为空。','true','9657320kdzLaf','fas\x20fa-lock-open','\x20失败:\x20','\x20个Rerank模型。','准备对《','batchSize','324894jFmEVF','removeEventListener','data','成功录入\x20','lorebook','hly-log-entry\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<fieldset\x20class=\x22hly-settings-group\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<legend><i\x20class=\x22fas\x20fa-ban\x22></i>\x20内容排除规则</legend>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22hly-notes\x22>在这里定义需要从提取内容中排除的文本片段。例如，排除HTML注释，可以设置开始字符串为\x20`<!--`，结束字符串为\x20`-->`。</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-rules-list\x22>','moveKnowledgeBase','开始对《','global','成功加载\x20','\x0a所用模型:\x20','independentChatMemoryEnabled','html','<p\x20class=\x22hly-record-hint\x22><i>上次已从第\x20','.hly-hist-entry-checkbox:checked','hly-super-sort-enabled','2350428eAxUuY','翰林院使用教程','preventDefault','未能获取到任何模型。','user','会话已锁定到:\x20','text','hly-local-kb-char-name','此操作将彻底清空当前角色的所有忆识（向量），且无法恢复。您确定要继续吗？','\x22\x20title=\x22删除此条\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','未知错误','批量编纂任务已开始...','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-kb-name\x22\x20title=\x22ID:\x20','each','every','.hly-kb-move-btn','编辑凝识内容排除规则','classList','当前角色没有任何局部知识库可供删除。','1197zFTiTq','map','批量操作失败:\x20','翰林院启奏','hly-kb-list-','hly-unified-injection-role','disabled','target','[data-setting-key]','请输入知识库的新名称:','title','手动录入失败:\x20','top_n','getLoresForWorldbook','replace','getGlobalKnowledgeBases','hly-tag-input','宝库已清空。','\x20个条目进行批量编纂...','文书已成功录入宝库，新增\x20','removeKnowledgeBase','block','hanlinyuan-ingest-abort','当前角色','点击以解锁，让翰林院跟随当前角色','radio','<option>正在获取...</option>','您确定要将选中的\x20','[翰林院-枢纽]\x20渲染知识库列表失败:','hly-embedding-model','解锁会话','hly-rerank-enabled','initialize','成功移动了\x20','未能获取到任何Rerank模型。','hly-log-output','{{text}}','本地代理地址:','mes','清空宝库失败。','hly-kb-move-all-to-local','input[name=\x22','移动知识库\x20','hly-rerank-api-key','锁定会话','批量\x20','{{manual_text}}','未选择文件','floor','getSettings','.enabled\x22]','hly-condensation-enabled','queryPreprocessing','allWorldbooks','hly-kb-list-global-placeholder','isSessionLocked','checked','advanced','hly-hist-entry-multiselect-options','previousElementSibling','\x20块开始。','正在对\x20','manual','url','innerHTML','processCondensation','hanlinyuan-ingest-novel-start','getVectorCount','正在为《','hly-tag-extraction-toggle','<p\x20class=\x22hly-record-hint\x22>可在此预览凝识结果。</p>','all','.position','[翰林院-枢纽]\x20未能获取SillyTavern上下文，绑定失败。','hly-query-message-count','embeddingModel','hly-layer-end','hly-rerank-notify','hly-unified-template-notes','遵命，将从第\x20','start','exclusionRules','getLockedSessionInfo','type','>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22hly-toggle-slider\x22></span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-kb-delete-btn\x22\x20title=\x22删除此知识库\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','error','style',')\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-hist-entry-checkbox\x22\x20value=\x22','previewHLYCondensation','\x20楼的内容（共\x20','hly-rerank-model','手动录入','批量移动失败:\x20','message','切换知识库\x20','localToGlobal','[翰林院-枢纽]\x20更新忆识数量失败:','，从第\x20','fa-times-circle','<i\x20class=\x22fa-solid\x20','hly-api-key','hly-layer-start','#hly-add-rule-btn','1763109mbQvBg','当前所有操作都将指向这个锁定的宝库：','请先选择一个书库并至少选择一个要编纂的条目。','log-warn','condensationHistory',',\x20失败:\x20','\x20条有效条目），请点击“开始凝识”进入自动向量化流程。','ingestHLYManualText','length','count','\x0a</pre>\x0a\x20\x20\x20\x20\x20\x20\x20\x20','contains','[data-setting-key=\x22rerank.priorityRetrieval.sources.','value','您确定要将所有设定恢复为出厂默认值吗？','stopPropagation','input[name=\x22hly-unified-injection-position\x22]:checked',')\x20已被删除','_searchHandler','enabled','totalVectors','.template','hly-hist-entry-multiselect-btn','启禀大人，发现此书上次录入已完成\x20','.hly-log-placeholder','2517464ZkscmA','hly-kb-bulk-actions-global','selectedIndex',')\x20执行批量\x20','未找到匹配的条目','17504GJzkGF','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-item-v2\x22\x20id=\x22','\x20楼到\x20','sources','.hly-kb-name','处理中:\x20','move','正在读取文件...','知识库\x20','<option\x20value=\x22\x22>未找到匹配的书库</option>','[翰林院-枢纽]\x20查询宝库状态失败:','hly-kb-select-all-local','\x20条消息，开始凝识...','#hly-modal-tag-input',',\x20忆识总数=','getMessagesForCondensation','会话已锁定','success','开始将\x20','template','hly-api-endpoint','\x20操作成功。','hly-rerank-hybrid-alpha','hly-historiography-results','append','\x20楼凝识至第\x20','hly-kb-bulk-actions-local','float','content','批量移动过程中发生错误:\x20','end','ingestTextToHanlinyuan','input','圣谕不明','saveSettings','加载书库列表失败:\x20','无法获取总数:\x20','is-user','hly-kb-select-all-global','批量移动完成。','已选择\x20','hly-entry-search','toLocaleTimeString','保存规则','finalText','\x20个局部知识库...','checkbox','hly-kb-list-global','hly-','正在处理您提交的文书...','\x20条忆识。','rerank','神力连接通畅！','[翰林院-枢纽]\x20已成功连接各部，政令畅通。','tags','fa-exclamation-triangle','\x20块继续录入。','神力连接失败:\x20','comment','settingKey','请先选择书库','.hly-kb-rename-btn','priorityRetrieval','</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</label>','hly-chunk-size','className','layerStart',':checked','圣旨已达','split','您确定要将知识库【','\x20个条目','join','maxResults','成功切换了\x20','\x20(Key:\x20','remove','hly-query-preprocessing-enabled','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-is-user=\x22','indeterminate','\x20操作...','.hly-tab-pane','点击以锁定，让翰林院固定操作当前角色的宝库','notify','</textarea>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</fieldset>\x0a\x20\x20\x20\x20','insertAdjacentHTML','hanlinyuan-ingest-status','<div\x20class=\x22hly-no-results\x22>未找到匹配的条目</div>','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-exclusion-rule-row\x22\x20data-index=\x22','\x20个知识库移动到【','depth_role','\x27\x20已更新为:\x20','开始批量删除\x20','resetSettings','tab','\x0a<pre>\x0a翰林院宝库状态\x0a--------------------\x0a集合ID:\x20','custom','\x20/\x20','trim','.hly-nav-item','\x20个知识块。','getChatId','from','检测到预览后待处理的消息对象，开始精确凝识...','hly-hist-select-library','\x20楼到第\x20','正在清空宝库...','预览内容已更新，可随时开始凝识。','1VYGKzK','globalToLocal','textContent','加载失败','编纂失败:\x20','】吗？','遵命，将从头开始录入此书。','您确定要永久删除【当前角色】的全部\x20','warning','局部知识库批量删除完成。成功:\x20','任务完成！成功录入\x20','\x20(ID:\x20','.hly-delete-rule-btn','delete','stringify','已采集\x20','entries','，重新开始。','.hly-kb-item-checkbox:checked','is_user','宝库状态','hlyLog','chunkSize','integer','span','allEntries','dataset','toggleKnowledgeBase','warn','saveHLYSettings','getCharacterName','apiEndpoint','[翰林院-枢纽]\x20预览过程发生错误:','filter','forEach','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<fieldset\x20class=\x22hly-settings-group\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<legend><i\x20class=\x22fas\x20fa-tags\x22></i>\x20标签提取</legend>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-control-block\x22\x20style=\x22flex-direction:\x20row;\x20justify-content:\x20space-between;\x20align-items:\x20center;\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22hly-modal-tag-extraction-enabled\x22>启用标签提取</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-toggle-switch\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22hly-modal-tag-extraction-enabled\x22\x20','apiKey','hly-condensation-results','hly-custom-endpoint-docket','\x0a忆识总数:\x20','\x20个知识库均已成功移动。','scrollTop','[翰林院-枢纽]\x20获取模型列表失败:','成功获取\x20','hly-retrieval-enabled','<div\x20class=\x22hly-preview-container-v2\x22>','clearJob','getAvailableWorldbooks','您确定要永久删除选中的\x20','injection_','#hly-rules-list','hly-independent-chat-memory-enabled','已选择\x200\x20/\x20','凝识完成！新增\x20','凝识失败:\x20','hly-kb-list-local-placeholder','{{lorebook_text}}','自定义路径:','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22','<p\x20class=\x22hly-notes\x20log-error\x22><i>加载失败:\x20','send_date','删除局部知识库\x20','hanlinyuan-ingest-novel-file-input','.hly-preview-item-v2','会话已锁定到宝库:\x20','\x20为占位符。','hly-locked-status','executeCompilation','files','Google\x20API\x20Key:','\x0a\x20\x20\x20\x20\x20\x20\x20\x20<div\x20id=\x22hly-rules-modal-container\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','重命名失败:\x20','testApiConnection','log-success','finalMessages','例如\x20http://127.0.0.1:8000/v1','change','click','beforeend','正在删除\x20','children','add',',\x20向量:\x20','tagExtractionEnabled','hanlinyuan-ingest-novel-file-name','css','hly-modal-container','hly-include-ai','hly-rerank-top-n','fa-check-circle','）没有任何知识库可供移动。','option','...','google_direct','info','toggleSessionLock','totalChunks','.hly-preview-textarea','<option\x20value=\x22\x22>未找到任何书库</option>','keys','resetHLYSettings','preview-item-','》获取条目列表...','开始获取Rerank模型列表...','重命名知识库\x20','严重错误','</i></p>','amily2_open_rag_palace','398422Ylaorf','[翰林院-枢纽]\x20凝识过程发生错误:','#hly-modal-tag-extraction-enabled','retrieval','获取Rerank模型失败:\x20','purgeHLYStorage','model','\x20个知识库删除失败。','[翰林院-枢纽]\x20获取Rerank模型列表失败:',';\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20for=\x22hly-modal-tag-input\x22>输入标签\x20(以逗号分隔):</label>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20id=\x22hly-modal-tag-input\x22\x20class=\x22hly-imperial-brush\x22\x20rows=\x222\x22\x20placeholder=\x22例如:\x20content,details,摘要\x22>','hly-unified-injection-depth','getLocalKnowledgeBases','会话已解锁，将跟随当前角色。','加载条目失败:\x20','querySelectorAll','boolean','.hly-preview-delete-btn-v2','根据标签提取或内容排除条件，未找到任何有效内容。','\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-send-date=\x22','\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<details\x20class=\x22hly-preview-details\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<summary\x20class=\x22hly-preview-summary\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20第\x20','[翰林院-枢纽]\x20未找到类型为\x20\x22','开始对\x20','任务已中止。','total','】移动到【','\x22></i>\x20[','大功告成','<option\x20value=\x22\x22>请选择一个书库...</option>'];_0x4662=function(){return _0xb530e7;};return _0x4662();}function handleApiModeChange(){const _0xf7300e=_0x15063a,_0x468c46=document['getElementById'](_0xf7300e(0x339))[_0xf7300e(0x314)],_0xc42ee9=document[_0xf7300e(0x220)](_0xf7300e(0x19f)),_0x4f4672=document[_0xf7300e(0x220)]('hly-api-key-group'),_0x39f536=document['getElementById'](_0xf7300e(0x2bd)),_0x2e6f24=_0x39f536[_0xf7300e(0x2db)];if(!_0xc42ee9||!_0x4f4672)return;_0xc42ee9[_0xf7300e(0x2f6)][_0xf7300e(0x208)]=_0xf7300e(0x2b5),_0x4f4672['style']['display']=_0xf7300e(0x2b5);switch(_0x468c46){case _0xf7300e(0x1d6):_0xc42ee9[_0xf7300e(0x2f6)][_0xf7300e(0x208)]='none',_0x4f4672[_0xf7300e(0x267)](_0xf7300e(0x22d))[_0xf7300e(0x17b)]=_0xf7300e(0x1be),_0x4f4672[_0xf7300e(0x267)](_0xf7300e(0x345))[_0xf7300e(0x217)]='请输入您的Google\x20API\x20Key';break;case _0xf7300e(0x20a):_0xc42ee9[_0xf7300e(0x267)]('label')[_0xf7300e(0x17b)]=_0xf7300e(0x2c5),_0xc42ee9[_0xf7300e(0x267)](_0xf7300e(0x345))[_0xf7300e(0x217)]=_0xf7300e(0x1c4),_0x4f4672[_0xf7300e(0x2f6)]['display']=_0xf7300e(0x222);break;case _0xf7300e(0x16d):default:_0xc42ee9[_0xf7300e(0x267)](_0xf7300e(0x22d))[_0xf7300e(0x17b)]=_0xf7300e(0x1b2),_0xc42ee9['querySelector'](_0xf7300e(0x345))[_0xf7300e(0x217)]='输入兼容OpenAI的embeddings端点',_0x4f4672[_0xf7300e(0x267)]('label')['textContent']=_0xf7300e(0x22c);break;}}function loadSettingsToUI(){const _0x48a0e2=_0x15063a,_0x2fc55a=_0x4b5037[_0x48a0e2(0x2d1)]();if(!_0x2fc55a)return;document[_0x48a0e2(0x220)](_0x48a0e2(0x1a5))['checked']=_0x2fc55a[_0x48a0e2(0x1e8)]['enabled'],document['getElementById']('hly-api-endpoint')[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x1e8)][_0x48a0e2(0x198)],document[_0x48a0e2(0x220)](_0x48a0e2(0x238))[_0x48a0e2(0x314)]=_0x2fc55a['retrieval']['customApiUrl'],document[_0x48a0e2(0x220)](_0x48a0e2(0x304))['value']=_0x2fc55a['retrieval'][_0x48a0e2(0x19d)];const _0x45ac7b=document[_0x48a0e2(0x220)](_0x48a0e2(0x2bd));if(_0x45ac7b[_0x48a0e2(0x221)][_0x48a0e2(0x30f)]===0x0){const _0x160a31=_0x2fc55a[_0x48a0e2(0x1e8)][_0x48a0e2(0x2eb)],_0x5ec88e=new Option(_0x160a31,_0x160a31,!![],!![]);_0x45ac7b[_0x48a0e2(0x1ca)](_0x5ec88e);}_0x45ac7b[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x1e8)]['embeddingModel'],document[_0x48a0e2(0x220)](_0x48a0e2(0x23e))[_0x48a0e2(0x2d8)]=_0x2fc55a[_0x48a0e2(0x1e8)][_0x48a0e2(0x378)],document[_0x48a0e2(0x220)](_0x48a0e2(0x365))[_0x48a0e2(0x314)]=_0x2fc55a['advanced'][_0x48a0e2(0x18f)],document[_0x48a0e2(0x220)](_0x48a0e2(0x211))[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x2d9)]['overlap'],document['getElementById'](_0x48a0e2(0x257))[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x2d9)][_0x48a0e2(0x26a)],document[_0x48a0e2(0x220)](_0x48a0e2(0x2ea))[_0x48a0e2(0x314)]=_0x2fc55a['advanced'][_0x48a0e2(0x245)],document[_0x48a0e2(0x220)]('hly-max-results')[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x2d9)][_0x48a0e2(0x36e)],document[_0x48a0e2(0x220)]('hly-batch-size')['value']=_0x2fc55a[_0x48a0e2(0x1e8)][_0x48a0e2(0x27b)],handleApiModeChange(),document[_0x48a0e2(0x220)](_0x48a0e2(0x2d3))[_0x48a0e2(0x2d8)]=_0x2fc55a['condensation'][_0x48a0e2(0x31a)],document[_0x48a0e2(0x220)](_0x48a0e2(0x305))['value']=_0x2fc55a[_0x48a0e2(0x261)][_0x48a0e2(0x367)],document[_0x48a0e2(0x220)]('hly-layer-end')[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x261)]['layerEnd'],document[_0x48a0e2(0x220)](_0x48a0e2(0x24f))['checked']=_0x2fc55a[_0x48a0e2(0x261)][_0x48a0e2(0x23a)][_0x48a0e2(0x291)],document['getElementById'](_0x48a0e2(0x1d0))[_0x48a0e2(0x2d8)]=_0x2fc55a[_0x48a0e2(0x261)][_0x48a0e2(0x23a)]['ai'];const _0x19e786=document[_0x48a0e2(0x220)](_0x48a0e2(0x2e5)),_0x3f8e3a=document['getElementById'](_0x48a0e2(0x2b0)),_0x179acf=document[_0x48a0e2(0x220)]('hly-tag-input-container');_0x19e786[_0x48a0e2(0x2d8)]=_0x2fc55a[_0x48a0e2(0x261)][_0x48a0e2(0x1cc)],_0x3f8e3a[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x261)][_0x48a0e2(0x35b)],_0x179acf['style'][_0x48a0e2(0x208)]=_0x19e786['checked']?_0x48a0e2(0x2b5):_0x48a0e2(0x222),document[_0x48a0e2(0x220)](_0x48a0e2(0x2bf))[_0x48a0e2(0x2d8)]=_0x2fc55a[_0x48a0e2(0x358)][_0x48a0e2(0x31a)],document['getElementById']('hly-rerank-url')['value']=_0x2fc55a['rerank'][_0x48a0e2(0x2df)],document[_0x48a0e2(0x220)](_0x48a0e2(0x2cb))[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x358)][_0x48a0e2(0x19d)];const _0x2bdb95=document[_0x48a0e2(0x220)](_0x48a0e2(0x2fa));if(_0x2bdb95[_0x48a0e2(0x221)][_0x48a0e2(0x30f)]===0x0){const _0x151d63=_0x2fc55a['rerank'][_0x48a0e2(0x1eb)];if(_0x151d63){const _0x2978b9=new Option(_0x151d63,_0x151d63,!![],!![]);_0x2bdb95[_0x48a0e2(0x1ca)](_0x2978b9);}}_0x2bdb95[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x358)][_0x48a0e2(0x1eb)],document[_0x48a0e2(0x220)](_0x48a0e2(0x1d1))[_0x48a0e2(0x314)]=_0x2fc55a[_0x48a0e2(0x358)][_0x48a0e2(0x2ac)],document[_0x48a0e2(0x220)](_0x48a0e2(0x33b))['value']=_0x2fc55a[_0x48a0e2(0x358)]['hybrid_alpha'],document[_0x48a0e2(0x220)](_0x48a0e2(0x2ed))[_0x48a0e2(0x2d8)]=_0x2fc55a[_0x48a0e2(0x358)]['notify'],document[_0x48a0e2(0x220)](_0x48a0e2(0x28c))[_0x48a0e2(0x2d8)]=_0x2fc55a[_0x48a0e2(0x358)]['superSortEnabled'];const _0x4249c8=_0x2fc55a[_0x48a0e2(0x358)][_0x48a0e2(0x363)];if(_0x4249c8){document[_0x48a0e2(0x220)]('hly-priority-retrieval-enabled')[_0x48a0e2(0x2d8)]=_0x4249c8[_0x48a0e2(0x31a)];const _0x4dbc41=[_0x48a0e2(0x21e),'chat_history',_0x48a0e2(0x280),_0x48a0e2(0x2de)];_0x4dbc41[_0x48a0e2(0x19b)](_0x1a3fad=>{const _0x3a7436=_0x48a0e2,_0x5ae7cb=_0x4249c8[_0x3a7436(0x328)][_0x1a3fad];if(_0x5ae7cb){const _0x21ceb2=document[_0x3a7436(0x267)](_0x3a7436(0x313)+_0x1a3fad+_0x3a7436(0x2d2)),_0x4e0168=document[_0x3a7436(0x267)]('[data-setting-key=\x22rerank.priorityRetrieval.sources.'+_0x1a3fad+_0x3a7436(0x252));if(_0x21ceb2)_0x21ceb2[_0x3a7436(0x2d8)]=_0x5ae7cb['enabled'];if(_0x4e0168)_0x4e0168[_0x3a7436(0x314)]=_0x5ae7cb['count'];}});}_0x2fc55a[_0x48a0e2(0x2d4)]&&(document[_0x48a0e2(0x220)](_0x48a0e2(0x372))['checked']=_0x2fc55a[_0x48a0e2(0x2d4)][_0x48a0e2(0x31a)]),_0x2fc55a[_0x48a0e2(0x1e8)][_0x48a0e2(0x288)]!==undefined&&(document[_0x48a0e2(0x220)](_0x48a0e2(0x1ac))[_0x48a0e2(0x2d8)]=_0x2fc55a['retrieval']['independentChatMemoryEnabled']);}function saveSettingsFromUI(_0x4e7740=!![]){const _0x112101=_0x15063a,_0x1ec81e=document['getElementById']('hly-modal-container');if(!_0x1ec81e)return;const _0x44fd28=_0x1ec81e[_0x112101(0x1f3)](_0x112101(0x2a8));_0x44fd28[_0x112101(0x19b)](_0xd1625b=>{const _0x467755=_0x112101,_0x1e6a9c=_0xd1625b['dataset']['settingKey'];if(!_0x1e6a9c)return;let _0x250678;const _0x1b9975=_0xd1625b[_0x467755(0x193)][_0x467755(0x2f3)]||'string';if(_0xd1625b[_0x467755(0x2f3)]===_0x467755(0x353))_0x250678=_0xd1625b[_0x467755(0x2d8)];else{if(_0xd1625b[_0x467755(0x2f3)]===_0x467755(0x2b9)){if(!_0xd1625b['checked'])return;_0x250678=_0xd1625b[_0x467755(0x314)];}else _0x250678=_0xd1625b['value'];}switch(_0x1b9975){case _0x467755(0x190):_0x250678=parseInt(_0x250678,0xa);break;case _0x467755(0x340):_0x250678=parseFloat(_0x250678);break;case _0x467755(0x1f4):if(typeof _0x250678!==_0x467755(0x1f4))_0x250678=_0x250678==='true';break;}const _0xf404cb=_0x4b5037[_0x467755(0x2d1)](),_0x3e1f5a=_0x1e6a9c[_0x467755(0x36a)]('.');let _0x15bf34=_0xf404cb;for(let _0x508628=0x0;_0x508628<_0x3e1f5a[_0x467755(0x30f)]-0x1;_0x508628++){_0x15bf34=_0x15bf34[_0x3e1f5a[_0x508628]]=_0x15bf34[_0x3e1f5a[_0x508628]]||{};}_0x15bf34[_0x3e1f5a[_0x3e1f5a[_0x467755(0x30f)]-0x1]]=_0x250678;}),_0x4b5037[_0x112101(0x347)](),!_0x4e7740&&(log('【手动存档】所有设定已存档封印。','success'),toastr[_0x112101(0x336)](_0x112101(0x262),_0x112101(0x369)));}function resetSettingsToUI(){const _0x812b80=_0x15063a;confirm(_0x812b80(0x315))&&(_0x4b5037[_0x812b80(0x16a)](),loadSettingsToUI(),toastr[_0x812b80(0x1d7)](_0x812b80(0x20e),'诏曰'));}async function updatePanelStatus(){const _0x51612e=_0x15063a,_0x7543dc=_0x4b5037[_0x51612e(0x2d7)](),_0x1ecfa7=document['getElementById'](_0x51612e(0x24e)),_0x50ec7d=document[_0x51612e(0x220)]('hly-current-chat-id');if(_0x7543dc){const _0x508d92=_0x4b5037[_0x51612e(0x2f2)]();_0x508d92&&(_0x1ecfa7[_0x51612e(0x17b)]=_0x51612e(0x335),_0x50ec7d[_0x51612e(0x17b)]=_0x508d92['id'],_0x50ec7d[_0x51612e(0x2aa)]=_0x51612e(0x308)+_0x508d92['id'],_0x1ecfa7[_0x51612e(0x29e)][_0x51612e(0x1ca)](_0x51612e(0x1bb)),_0x50ec7d[_0x51612e(0x29e)]['add'](_0x51612e(0x1bb)));}else _0x1ecfa7[_0x51612e(0x17b)]=_0x535b3f[_0x51612e(0x197)](),_0x50ec7d['textContent']=_0x535b3f[_0x51612e(0x172)]()||'无',_0x50ec7d['title']='',_0x1ecfa7['classList']['remove']('hly-locked-status'),_0x50ec7d[_0x51612e(0x29e)]['remove'](_0x51612e(0x1bb));const _0x3d26e4=document[_0x51612e(0x220)]('hly-current-vector-count');_0x3d26e4[_0x51612e(0x17b)]=_0x51612e(0x1d5);try{const _0x423904=await _0x4b5037['getVectorCount']();_0x3d26e4[_0x51612e(0x17b)]=_0x423904;}catch(_0x275a28){console['error'](_0x51612e(0x300),_0x275a28),_0x3d26e4['textContent']=_0x51612e(0x269),_0x3d26e4[_0x51612e(0x2aa)]=_0x51612e(0x349)+_0x275a28[_0x51612e(0x2fd)];}const _0x157691=document['getElementById'](_0x51612e(0x19e));if(_0x157691&&!_0x157691[_0x51612e(0x193)][_0x51612e(0x351)]){const _0x12652c=_0x4b5037['getSettings'](),_0x3a50da=await _0x4b5037[_0x51612e(0x25e)]();if(_0x12652c[_0x51612e(0x30b)]&&_0x12652c[_0x51612e(0x30b)][_0x3a50da]){const _0x11ce4c=_0x12652c['condensationHistory'][_0x3a50da];_0x157691[_0x51612e(0x2e0)]=_0x51612e(0x28a)+_0x11ce4c[_0x51612e(0x2f0)]+_0x51612e(0x33e)+_0x11ce4c[_0x51612e(0x343)]+_0x51612e(0x26b);}else _0x157691['innerHTML']=_0x51612e(0x2e6);}renderKnowledgeBases();}async function moveAllKnowledgeBases(_0x57ba30){const _0x3dfee4=_0x15063a,_0x3b35c8=_0x57ba30===_0x3dfee4(0x17a),_0x32b4b5=_0x3b35c8?'global':_0x3dfee4(0x251),_0x1ac964=_0x3b35c8?'局部':'全局',_0x15ef02=_0x3b35c8?_0x4b5037[_0x3dfee4(0x2af)]():_0x4b5037[_0x3dfee4(0x1f0)](),_0x525158=Object[_0x3dfee4(0x1dc)](_0x15ef02);if(_0x525158[_0x3dfee4(0x30f)]===0x0){toastr['info']('源区域（'+(_0x3b35c8?'全局':'局部')+_0x3dfee4(0x1d3),'圣谕');return;}if(!confirm('您确定要将\x20'+_0x525158[_0x3dfee4(0x30f)]+'\x20个知识库从【'+(_0x3b35c8?'全局':'局部')+_0x3dfee4(0x1fd)+_0x1ac964+_0x3dfee4(0x17e)))return;log(_0x3dfee4(0x337)+_0x525158[_0x3dfee4(0x30f)]+_0x3dfee4(0x25c)+_0x32b4b5+_0x3dfee4(0x226)+(_0x3b35c8?_0x3dfee4(0x251):'global')+_0x3dfee4(0x1d5),'info');const _0x2a0cd9=_0x525158[_0x3dfee4(0x2a1)](_0x58e8c6=>_0x4b5037[_0x3dfee4(0x283)](_0x58e8c6,_0x32b4b5));try{await Promise[_0x3dfee4(0x2e7)](_0x2a0cd9),toastr[_0x3dfee4(0x336)](_0x3dfee4(0x231)+_0x525158[_0x3dfee4(0x30f)]+_0x3dfee4(0x1a1),'大功告成'),log(_0x3dfee4(0x34c),_0x3dfee4(0x336));}catch(_0x2465e5){toastr[_0x3dfee4(0x2f5)](_0x3dfee4(0x342)+_0x2465e5['message'],'警报'),log(_0x3dfee4(0x2fc)+_0x2465e5[_0x3dfee4(0x2fd)],_0x3dfee4(0x2f5));}finally{await updatePanelStatus();}}async function deleteAllLocalKnowledgeBases(){const _0x50aed0=_0x15063a,_0x277461=_0x4b5037[_0x50aed0(0x1f0)](),_0xea8212=Object[_0x50aed0(0x1dc)](_0x277461);if(_0xea8212[_0x50aed0(0x30f)]===0x0){toastr[_0x50aed0(0x1d7)](_0x50aed0(0x29f),'圣谕');return;}if(!confirm(_0x50aed0(0x180)+_0xea8212[_0x50aed0(0x30f)]+_0x50aed0(0x218)))return;toastr[_0x50aed0(0x1d7)](_0x50aed0(0x1c8)+_0xea8212[_0x50aed0(0x30f)]+'\x20个局部知识库...','圣旨'),log(_0x50aed0(0x169)+_0xea8212[_0x50aed0(0x30f)]+_0x50aed0(0x352),_0x50aed0(0x195));let _0x174b54=0x0,_0x5d1998=0x0;for(const _0x3b86fe of _0xea8212){try{await _0x4b5037['removeKnowledgeBase'](_0x3b86fe,_0x50aed0(0x251)),_0x174b54++;}catch(_0x5f2dce){_0x5d1998++,log(_0x50aed0(0x1b6)+_0x3b86fe+_0x50aed0(0x278)+_0x5f2dce[_0x50aed0(0x2fd)],_0x50aed0(0x2f5));}}_0x5d1998>0x0?toastr[_0x50aed0(0x2f5)]('操作完成，但有\x20'+_0x5d1998+_0x50aed0(0x1ec),'警报'):toastr[_0x50aed0(0x336)](_0x50aed0(0x231)+_0x174b54+'\x20个局部知识库均已成功删除。',_0x50aed0(0x1ff)),log(_0x50aed0(0x182)+_0x174b54+_0x50aed0(0x30c)+_0x5d1998,_0x50aed0(0x1d7)),await updatePanelStatus();}async function renderKnowledgeBases(){const _0x545044=_0x15063a,_0x5615ae=document[_0x545044(0x220)]('hly-kb-list-local'),_0x473117=document[_0x545044(0x220)](_0x545044(0x354)),_0x149d5d=document['getElementById'](_0x545044(0x294));if(!_0x5615ae||!_0x473117||!_0x149d5d)return;_0x149d5d[_0x545044(0x17b)]=_0x535b3f[_0x545044(0x197)]()||_0x545044(0x2b7);try{const _0x25e8f7=_0x4b5037[_0x545044(0x1f0)](),_0xa84874=_0x4b5037['getGlobalKnowledgeBases']();await _renderKbList(_0x25e8f7,_0x5615ae,_0x545044(0x251),_0x545044(0x1b0)),await _renderKbList(_0xa84874,_0x473117,_0x545044(0x285),_0x545044(0x2d6));}catch(_0x42d8c3){console[_0x545044(0x2f5)](_0x545044(0x2bc),_0x42d8c3),_0x5615ae[_0x545044(0x2e0)]=_0x545044(0x1b4)+_0x42d8c3[_0x545044(0x2fd)]+_0x545044(0x1e3),_0x473117['innerHTML']=_0x545044(0x1b4)+_0x42d8c3[_0x545044(0x2fd)]+_0x545044(0x1e3);}}async function _renderKbList(_0x2b4708,_0x53480e,_0x19eb68,_0x786fb3){const _0x252cca=_0x15063a,_0x3e1dc8=document[_0x252cca(0x220)](_0x786fb3);_0x53480e['innerHTML']='',_0x53480e['appendChild'](_0x3e1dc8);if(Object[_0x252cca(0x1dc)](_0x2b4708)[_0x252cca(0x30f)]===0x0){_0x3e1dc8[_0x252cca(0x2f6)][_0x252cca(0x208)]=_0x252cca(0x2b5);return;}_0x3e1dc8['style'][_0x252cca(0x208)]=_0x252cca(0x222);for(const [_0x21e2b5,_0x3919ca]of Object[_0x252cca(0x189)](_0x2b4708)){const _0x34acec=document[_0x252cca(0x24a)]('div');_0x34acec[_0x252cca(0x366)]='hly-kb-list-item',_0x34acec[_0x252cca(0x193)][_0x252cca(0x21d)]=_0x21e2b5,_0x34acec[_0x252cca(0x193)][_0x252cca(0x21c)]=_0x19eb68;const _0x441197=await _0x4b5037['getVectorCount'](_0x21e2b5,_0x19eb68),_0x444f20=_0x19eb68===_0x252cca(0x251)?'<button\x20class=\x22hly-kb-move-btn\x22\x20title=\x22上移到全局\x22><i\x20class=\x22fas\x20fa-arrow-up\x22></i></button>':_0x252cca(0x243);_0x34acec[_0x252cca(0x2e0)]=_0x252cca(0x232)+_0x21e2b5+_0x252cca(0x299)+_0x21e2b5+'\x22>'+_0x3919ca[_0x252cca(0x265)]+'\x20('+_0x441197+'条)</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-kb-actions\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x444f20+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-kb-rename-btn\x22\x20title=\x22重命名\x22><i\x20class=\x22fas\x20fa-pen-to-square\x22></i></button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-toggle-switch\x22\x20title=\x22启用/禁用此知识库\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20class=\x22hly-kb-toggle\x22\x20'+(_0x3919ca[_0x252cca(0x31a)]?_0x252cca(0x2d8):'')+_0x252cca(0x2f4),_0x53480e['appendChild'](_0x34acec);}}async function handleKbAction(_0x289b42){const _0x5406af=_0x15063a,_0x2ff76f=_0x289b42[_0x5406af(0x2a7)],_0x585574=_0x2ff76f[_0x5406af(0x247)](_0x5406af(0x268));if(!_0x585574)return;const _0x3a7658=_0x585574[_0x5406af(0x193)][_0x5406af(0x21d)],_0x24e69a=_0x585574['dataset'][_0x5406af(0x21c)],_0x530599=_0x585574['querySelector'](_0x5406af(0x329))[_0x5406af(0x17b)][_0x5406af(0x36a)]('\x20(')[0x0];if(_0x2ff76f[_0x5406af(0x247)](_0x5406af(0x362))){const _0x8c604a=_0x585574[_0x5406af(0x267)](_0x5406af(0x329))[_0x5406af(0x17b)]['split']('\x20(')[0x0],_0xad20f1=prompt(_0x5406af(0x2a9),_0x8c604a);if(_0xad20f1&&_0xad20f1[_0x5406af(0x16f)]()&&_0xad20f1[_0x5406af(0x16f)]()!==_0x8c604a)try{await _0x4b5037[_0x5406af(0x26c)](_0x3a7658,_0xad20f1,_0x24e69a),await updatePanelStatus();}catch(_0x594bcb){log(_0x5406af(0x1e1)+_0x8c604a+_0x5406af(0x278)+_0x594bcb[_0x5406af(0x2fd)],_0x5406af(0x2f5)),toastr[_0x5406af(0x2f5)](_0x5406af(0x1c0)+_0x594bcb[_0x5406af(0x2fd)]);}return;}if(_0x2ff76f['classList'][_0x5406af(0x312)]('hly-kb-delete-btn')){if(confirm(_0x5406af(0x25f)+_0x530599+'】吗？此操作无法恢复！'))try{await _0x4b5037['removeKnowledgeBase'](_0x3a7658,_0x24e69a),log('知识库\x20'+_0x530599+_0x5406af(0x184)+_0x3a7658+_0x5406af(0x318),'success'),toastr[_0x5406af(0x336)](_0x5406af(0x219)+_0x530599+'】已删除。'),await updatePanelStatus();}catch(_0x11a13b){log(_0x5406af(0x23c)+_0x530599+'\x20失败:\x20'+_0x11a13b[_0x5406af(0x2fd)],_0x5406af(0x2f5)),toastr[_0x5406af(0x2f5)](_0x5406af(0x224)+_0x11a13b[_0x5406af(0x2fd)]);}}if(_0x2ff76f[_0x5406af(0x247)](_0x5406af(0x29c))){const _0x264bd1=_0x24e69a===_0x5406af(0x251)?'全局':'局部';if(confirm(_0x5406af(0x36b)+_0x530599+_0x5406af(0x1fd)+_0x264bd1+_0x5406af(0x17e)))try{await _0x4b5037[_0x5406af(0x283)](_0x3a7658,_0x24e69a),await updatePanelStatus();}catch(_0xe606aa){log(_0x5406af(0x2ca)+_0x530599+_0x5406af(0x278)+_0xe606aa['message'],_0x5406af(0x2f5)),toastr[_0x5406af(0x2f5)](_0x5406af(0x209)+_0xe606aa[_0x5406af(0x2fd)]);}}if(_0x2ff76f['classList'][_0x5406af(0x312)](_0x5406af(0x25a))&&_0x289b42[_0x5406af(0x2f3)]===_0x5406af(0x1c5))try{await _0x4b5037[_0x5406af(0x194)](_0x3a7658,_0x24e69a),log(_0x5406af(0x32d)+_0x530599+'\x20的状态已切换',_0x5406af(0x336));}catch(_0x3fa13e){log(_0x5406af(0x2fe)+_0x530599+_0x5406af(0x246)+_0x3fa13e[_0x5406af(0x2fd)],_0x5406af(0x2f5)),toastr['error']('切换状态失败:\x20'+_0x3fa13e[_0x5406af(0x2fd)]),_0x2ff76f[_0x5406af(0x2d8)]=!_0x2ff76f[_0x5406af(0x2d8)];}_0x2ff76f[_0x5406af(0x29e)]['contains'](_0x5406af(0x233))&&_0x289b42['type']===_0x5406af(0x1c5)&&updateBulkActionUI(_0x24e69a);}function handleSelectAll(_0x4aa16b,_0x4d13b4){const _0x54f530=_0x15063a,_0x376234=_0x4aa16b[_0x54f530(0x2a7)][_0x54f530(0x2d8)],_0x223e89=document[_0x54f530(0x220)](_0x54f530(0x2a4)+_0x4d13b4),_0x2c4a84=_0x223e89[_0x54f530(0x1f3)](_0x54f530(0x255));_0x2c4a84['forEach'](_0x5a56d6=>_0x5a56d6[_0x54f530(0x2d8)]=_0x376234),updateBulkActionUI(_0x4d13b4);}function updateBulkActionUI(_0x2fa2e4){const _0x4c935c=_0x15063a,_0x5dffc4=document['getElementById']('hly-kb-list-'+_0x2fa2e4),_0x10747f=document[_0x4c935c(0x220)]('hly-kb-bulk-actions-'+_0x2fa2e4),_0x1a7812=document[_0x4c935c(0x220)](_0x4c935c(0x204)+_0x2fa2e4),_0x1dcd13=_0x5dffc4['querySelectorAll'](_0x4c935c(0x255)),_0x483a25=_0x5dffc4[_0x4c935c(0x1f3)](_0x4c935c(0x18b)),_0x55e7e6=_0x483a25[_0x4c935c(0x30f)],_0x326eb0=_0x1dcd13['length'];_0x55e7e6>0x0?_0x10747f[_0x4c935c(0x2f6)][_0x4c935c(0x208)]=_0x4c935c(0x26f):_0x10747f[_0x4c935c(0x2f6)][_0x4c935c(0x208)]=_0x4c935c(0x222);if(_0x326eb0===0x0)_0x1a7812[_0x4c935c(0x2d8)]=![],_0x1a7812[_0x4c935c(0x374)]=![];else{if(_0x55e7e6===_0x326eb0)_0x1a7812[_0x4c935c(0x2d8)]=!![],_0x1a7812[_0x4c935c(0x374)]=![];else _0x55e7e6>0x0?(_0x1a7812['checked']=![],_0x1a7812[_0x4c935c(0x374)]=!![]):(_0x1a7812[_0x4c935c(0x2d8)]=![],_0x1a7812['indeterminate']=![]);}}async function handleBulkAction(_0x3fe9cc,_0x381e2){const _0x4b20ff=_0x15063a,_0x5355c8=_0x3fe9cc[_0x4b20ff(0x2a7)][_0x4b20ff(0x193)]['action'];if(!_0x5355c8)return;const _0x510e59=document['getElementById']('hly-kb-list-'+_0x381e2),_0x122b5a=_0x510e59[_0x4b20ff(0x1f3)](_0x4b20ff(0x18b)),_0x399711=Array[_0x4b20ff(0x173)](_0x122b5a)[_0x4b20ff(0x2a1)](_0x224ade=>_0x224ade[_0x4b20ff(0x193)][_0x4b20ff(0x21d)]);if(_0x399711[_0x4b20ff(0x30f)]===0x0){toastr[_0x4b20ff(0x181)](_0x4b20ff(0x22a),'圣谕');return;}let _0x6e451b='',_0x236cde,_0xff07dd='';switch(_0x5355c8){case _0x4b20ff(0x186):_0x6e451b=_0x4b20ff(0x1a9)+_0x399711[_0x4b20ff(0x30f)]+_0x4b20ff(0x273),_0x236cde=_0x54c9bd=>_0x4b5037[_0x4b20ff(0x2b4)](_0x54c9bd,_0x381e2),_0xff07dd=_0x4b20ff(0x258)+_0x399711[_0x4b20ff(0x30f)]+_0x4b20ff(0x228);break;case _0x4b20ff(0x32b):const _0x155018=_0x381e2===_0x4b20ff(0x251)?'全局':'局部';_0x6e451b=_0x4b20ff(0x2bb)+_0x399711[_0x4b20ff(0x30f)]+_0x4b20ff(0x37e)+_0x155018+_0x4b20ff(0x17e),_0x236cde=_0x344f3b=>_0x4b5037[_0x4b20ff(0x283)](_0x344f3b,_0x381e2),_0xff07dd=_0x4b20ff(0x2c1)+_0x399711[_0x4b20ff(0x30f)]+'\x20个知识库。';break;case _0x4b20ff(0x207):_0x6e451b='您确定要切换选中的\x20'+_0x399711[_0x4b20ff(0x30f)]+_0x4b20ff(0x201),_0x236cde=_0x1d3aca=>_0x4b5037['toggleKnowledgeBase'](_0x1d3aca,_0x381e2),_0xff07dd=_0x4b20ff(0x36f)+_0x399711[_0x4b20ff(0x30f)]+'\x20个知识库的状态。';break;default:return;}if(!confirm(_0x6e451b))return;toastr[_0x4b20ff(0x1d7)](_0x4b20ff(0x2dd)+_0x399711[_0x4b20ff(0x30f)]+_0x4b20ff(0x272),'圣旨'),log(_0x4b20ff(0x1fa)+_0x399711['length']+'\x20个知识库\x20(范围:\x20'+_0x381e2+_0x4b20ff(0x323)+_0x5355c8+_0x4b20ff(0x375),'info');try{const _0x5a4b31=_0x399711[_0x4b20ff(0x2a1)](_0x5897a5=>_0x236cde(_0x5897a5));await Promise[_0x4b20ff(0x2e7)](_0x5a4b31),toastr['success'](_0xff07dd,_0x4b20ff(0x1ff)),log(_0x4b20ff(0x2cd)+_0x5355c8+_0x4b20ff(0x33a),_0x4b20ff(0x336));}catch(_0x36445a){toastr[_0x4b20ff(0x2f5)](_0x4b20ff(0x2a2)+_0x36445a['message'],'警报'),log(_0x4b20ff(0x2cd)+_0x5355c8+_0x4b20ff(0x205)+_0x36445a[_0x4b20ff(0x2fd)],_0x4b20ff(0x2f5));}finally{await updatePanelStatus();}}async function testApi(){const _0x51c804=_0x15063a;toastr['info']('正在测试神力连接...','圣旨');try{await _0x4b5037[_0x51c804(0x1c1)](),toastr[_0x51c804(0x336)](_0x51c804(0x359),'圣意');}catch(_0x3d17aa){toastr[_0x51c804(0x2f5)](_0x51c804(0x35e)+_0x3d17aa[_0x51c804(0x2fd)],'警报');}}async function fetchHLYEmbeddingModels(){const _0x58a8ff=_0x15063a,_0x56bc74=document[_0x58a8ff(0x220)](_0x58a8ff(0x2bd)),_0x1ecc67=_0x56bc74[_0x58a8ff(0x314)];_0x56bc74[_0x58a8ff(0x2e0)]=_0x58a8ff(0x2ba),_0x56bc74[_0x58a8ff(0x2a6)]=!![];try{log(_0x58a8ff(0x225),'info');const _0x242344=await _0x4b5037['fetchEmbeddingModels']();_0x56bc74[_0x58a8ff(0x2e0)]='';if(_0x242344[_0x58a8ff(0x30f)]===0x0){_0x56bc74[_0x58a8ff(0x2e0)]=_0x58a8ff(0x256),toastr[_0x58a8ff(0x195)](_0x58a8ff(0x290),_0x58a8ff(0x2a3)),log('未能获取到任何模型。',_0x58a8ff(0x195));return;}_0x242344[_0x58a8ff(0x19b)](_0x7a9949=>{const _0x3a67b9=_0x58a8ff,_0x50bd70=new Option(_0x7a9949,_0x7a9949);_0x56bc74[_0x3a67b9(0x1ca)](_0x50bd70);}),_0x242344[_0x58a8ff(0x26e)](_0x1ecc67)?_0x56bc74[_0x58a8ff(0x314)]=_0x1ecc67:_0x56bc74[_0x58a8ff(0x322)]=0x0,toastr[_0x58a8ff(0x336)]('成功获取\x20'+_0x242344[_0x58a8ff(0x30f)]+'\x20个模型。','圣意'),log(_0x58a8ff(0x1a4)+_0x242344[_0x58a8ff(0x30f)]+_0x58a8ff(0x25b),_0x58a8ff(0x336));}catch(_0x7aca38){console[_0x58a8ff(0x2f5)](_0x58a8ff(0x1a3),_0x7aca38),toastr['error'](_0x58a8ff(0x254)+_0x7aca38['message'],_0x58a8ff(0x1e2)),log(_0x58a8ff(0x254)+_0x7aca38[_0x58a8ff(0x2fd)],'error'),_0x56bc74['innerHTML']='<option>获取失败</option>';}finally{_0x56bc74[_0x58a8ff(0x2a6)]=![];}}async function fetchHLYRerankModels(){const _0x120cf3=_0x15063a,_0x26a78f=document[_0x120cf3(0x220)]('hly-rerank-model'),_0x57b4dd=_0x26a78f['value'];_0x26a78f[_0x120cf3(0x2e0)]='<option>正在获取...</option>',_0x26a78f[_0x120cf3(0x2a6)]=!![];try{log(_0x120cf3(0x1e0),'info');const _0x5f28a0=await _0x4b5037['fetchRerankModels']();_0x26a78f[_0x120cf3(0x2e0)]='';if(_0x5f28a0['length']===0x0){_0x26a78f[_0x120cf3(0x2e0)]=_0x120cf3(0x256),toastr['warn'](_0x120cf3(0x2c2),_0x120cf3(0x2a3)),log(_0x120cf3(0x2c2),_0x120cf3(0x195));return;}_0x5f28a0[_0x120cf3(0x19b)](_0x3f13b5=>{const _0x5ddadb=new Option(_0x3f13b5,_0x3f13b5);_0x26a78f['add'](_0x5ddadb);}),_0x5f28a0[_0x120cf3(0x26e)](_0x57b4dd)?_0x26a78f[_0x120cf3(0x314)]=_0x57b4dd:_0x26a78f[_0x120cf3(0x322)]=0x0,toastr['success'](_0x120cf3(0x1a4)+_0x5f28a0[_0x120cf3(0x30f)]+_0x120cf3(0x279),'圣意'),log(_0x120cf3(0x1a4)+_0x5f28a0[_0x120cf3(0x30f)]+_0x120cf3(0x279),_0x120cf3(0x336));}catch(_0x2ddfc4){console['error'](_0x120cf3(0x1ed),_0x2ddfc4),toastr[_0x120cf3(0x2f5)]('获取Rerank模型失败:\x20'+_0x2ddfc4[_0x120cf3(0x2fd)],_0x120cf3(0x1e2)),log(_0x120cf3(0x1e9)+_0x2ddfc4[_0x120cf3(0x2fd)],_0x120cf3(0x2f5)),_0x26a78f[_0x120cf3(0x2e0)]='<option>获取失败</option>';}finally{_0x26a78f[_0x120cf3(0x2a6)]=![];}}async function purgeStorage(){const _0x39ee6f=_0x15063a;if(confirm(_0x39ee6f(0x295))){toastr[_0x39ee6f(0x1d7)](_0x39ee6f(0x177),'圣旨');const _0x4b4dac=await _0x4b5037['purgeStorage']();_0x4b4dac?toastr[_0x39ee6f(0x336)](_0x39ee6f(0x2b1),'圣意'):toastr[_0x39ee6f(0x2f5)](_0x39ee6f(0x2c7),'警报'),await updatePanelStatus();}}async function startCondensation(){const _0x4ef3cd=_0x15063a,_0x49801d=document['getElementById']('hly-condensation-results'),_0x141e5f=_0x49801d['dataset'][_0x4ef3cd(0x1c3)],_0x238942=document['getElementById'](_0x4ef3cd(0x305))['value'],_0x4ed14f=document['getElementById'](_0x4ef3cd(0x2ec))['value'],_0x3095de={'start':parseInt(_0x238942),'end':parseInt(_0x4ed14f)};try{let _0x146571;_0x141e5f?(log(_0x4ef3cd(0x174),_0x4ef3cd(0x1d7)),toastr[_0x4ef3cd(0x1d7)]('正在处理您确认后的文书...','圣旨'),_0x146571=JSON['parse'](_0x141e5f),delete _0x49801d[_0x4ef3cd(0x193)][_0x4ef3cd(0x1c3)]):(log('未检测到预览文本，按标准流程采集消息...',_0x4ef3cd(0x1d7)),toastr[_0x4ef3cd(0x1d7)]('正在准备凝识...','圣旨'),_0x146571=_0x4b5037[_0x4ef3cd(0x334)]());if(!_0x146571||_0x146571[_0x4ef3cd(0x30f)]===0x0){toastr['warning'](_0x4ef3cd(0x253),_0x4ef3cd(0x2a3)),_0x49801d[_0x4ef3cd(0x17b)]=_0x4ef3cd(0x241);return;}_0x49801d['textContent']=_0x4ef3cd(0x188)+_0x146571[_0x4ef3cd(0x30f)]+_0x4ef3cd(0x331),toastr[_0x4ef3cd(0x1d7)](_0x4ef3cd(0x188)+_0x146571[_0x4ef3cd(0x30f)]+'\x20条消息，开始凝识...',_0x4ef3cd(0x2a3));const _0x261252=await _0x4b5037[_0x4ef3cd(0x2e1)](_0x146571,log,_0x3095de);if(_0x261252[_0x4ef3cd(0x336)]){toastr[_0x4ef3cd(0x336)](_0x4ef3cd(0x1ae)+_0x261252[_0x4ef3cd(0x310)]+_0x4ef3cd(0x357),_0x4ef3cd(0x1ff));const _0x4b1d51=_0x3095de[_0x4ef3cd(0x343)]===0x0?getContext()[_0x4ef3cd(0x216)][_0x4ef3cd(0x30f)]:_0x3095de[_0x4ef3cd(0x343)];_0x49801d[_0x4ef3cd(0x17b)]='聊天记录从第\x20'+_0x3095de[_0x4ef3cd(0x2f0)]+_0x4ef3cd(0x176)+_0x4b1d51+'\x20楼已成功凝识，新增\x20'+_0x261252[_0x4ef3cd(0x310)]+_0x4ef3cd(0x357);}else throw new Error(_0x261252[_0x4ef3cd(0x2f5)]||'未知错误');}catch(_0x317456){console['error'](_0x4ef3cd(0x1e6),_0x317456),toastr['error'](_0x4ef3cd(0x1af)+_0x317456[_0x4ef3cd(0x2fd)],_0x4ef3cd(0x1e2)),_0x49801d[_0x4ef3cd(0x17b)]=_0x4ef3cd(0x1af)+_0x317456[_0x4ef3cd(0x2fd)];}finally{await updatePanelStatus();}}async function loadWorldbookList(){const _0x4c51a6=_0x15063a,_0x45f9f1=document[_0x4c51a6(0x220)](_0x4c51a6(0x175)),_0x4cc109=document[_0x4c51a6(0x220)](_0x4c51a6(0x230));if(!_0x45f9f1)return;try{log('正在获取可用书库列表...',_0x4c51a6(0x1d7));const _0x2d93a4=await _0x337832[_0x4c51a6(0x1a8)]();window[_0x4c51a6(0x2d5)]=_0x2d93a4,updateWorldbookOptions(_0x45f9f1,'',_0x2d93a4);if(_0x4cc109){const _0x3fe15a=debounce(_0x4d94be=>{updateWorldbookOptions(_0x45f9f1,_0x4d94be,_0x2d93a4);},0x12c);_0x4cc109[_0x4c51a6(0x23f)]('input',_0x38d7c4=>{const _0x1fa619=_0x4c51a6;_0x3fe15a(_0x38d7c4['target'][_0x1fa619(0x314)]);});}log(_0x4c51a6(0x286)+_0x2d93a4[_0x4c51a6(0x30f)]+'\x20个书库。',_0x4c51a6(0x336));}catch(_0x2af16a){console[_0x4c51a6(0x2f5)]('[翰林院-枢纽]\x20加载书库列表失败:',_0x2af16a),log(_0x4c51a6(0x348)+_0x2af16a[_0x4c51a6(0x2fd)],_0x4c51a6(0x2f5)),_0x45f9f1&&(_0x45f9f1['innerHTML']='<option\x20value=\x22\x22>加载失败</option>');}}function updateWorldbookOptions(_0x2ee94b,_0x20f70e,_0x70e4d5){const _0x9be578=_0x15063a,_0x539c9e=filterWorldbooks(_0x20f70e,_0x70e4d5),_0x33a5ee=_0x2ee94b[_0x9be578(0x314)];_0x2ee94b['innerHTML']=_0x9be578(0x200);if(_0x539c9e[_0x9be578(0x30f)]===0x0){_0x2ee94b['innerHTML']=_0x20f70e['trim']()?_0x9be578(0x32e):_0x9be578(0x1db);return;}_0x539c9e[_0x9be578(0x19b)](_0x58e077=>{const _0x55c463=_0x9be578,_0x7a16ab=document[_0x55c463(0x24a)](_0x55c463(0x1d4));_0x7a16ab[_0x55c463(0x314)]=_0x58e077,_0x7a16ab[_0x55c463(0x17b)]=_0x58e077,_0x2ee94b[_0x55c463(0x24b)](_0x7a16ab);}),_0x33a5ee&&_0x539c9e[_0x9be578(0x26e)](_0x33a5ee)&&(_0x2ee94b['value']=_0x33a5ee);}async function handleWorldbookSelectionChange(){const _0x43169b=_0x15063a,_0x5b15d4=document[_0x43169b(0x220)]('hly-hist-select-library'),_0x124182=document[_0x43169b(0x220)]('hly-hist-entry-multiselect-btn'),_0x4df83c=document['getElementById']('hly-hist-entry-multiselect-options'),_0x43860a=document[_0x43169b(0x220)](_0x43169b(0x34e)),_0x1e52d6=_0x5b15d4[_0x43169b(0x314)];_0x124182[_0x43169b(0x2a6)]=!![],_0x124182[_0x43169b(0x267)]('span')['textContent']=_0x43169b(0x21b),_0x4df83c['innerHTML']='',_0x4df83c[_0x43169b(0x2f6)][_0x43169b(0x208)]=_0x43169b(0x222);_0x43860a&&(_0x43860a[_0x43169b(0x314)]='');if(!_0x1e52d6){_0x124182[_0x43169b(0x267)]('span')[_0x43169b(0x17b)]=_0x43169b(0x361);return;}try{log(_0x43169b(0x2e4)+_0x1e52d6+_0x43169b(0x1df),_0x43169b(0x1d7));const _0x26f88c=await _0x337832[_0x43169b(0x2ad)](_0x1e52d6);if(_0x26f88c[_0x43169b(0x30f)]===0x0){_0x124182[_0x43169b(0x267)]('span')[_0x43169b(0x17b)]=_0x43169b(0x215);return;}window[_0x43169b(0x192)]=_0x26f88c,updateEntryOptions('',_0x26f88c);if(_0x43860a){_0x43860a[_0x43169b(0x27d)](_0x43169b(0x345),_0x43860a[_0x43169b(0x319)]);const _0x42d9a8=debounce(_0x22f83e=>{updateEntryOptions(_0x22f83e,_0x26f88c);},0x12c);_0x43860a[_0x43169b(0x319)]=_0x32b3ef=>{const _0x419901=_0x43169b;_0x42d9a8(_0x32b3ef['target'][_0x419901(0x314)]);},_0x43860a[_0x43169b(0x23f)](_0x43169b(0x345),_0x43860a[_0x43169b(0x319)]);}log(_0x43169b(0x286)+_0x26f88c[_0x43169b(0x30f)]+'\x20个条目。',_0x43169b(0x336));}catch(_0x347fa0){console['error']('[翰林院-枢纽]\x20加载《'+_0x1e52d6+'》的条目失败:',_0x347fa0),log(_0x43169b(0x1f2)+_0x347fa0[_0x43169b(0x2fd)],_0x43169b(0x2f5)),_0x124182[_0x43169b(0x267)](_0x43169b(0x191))[_0x43169b(0x17b)]=_0x43169b(0x17c);}finally{_0x124182[_0x43169b(0x2a6)]=![];}}function updateEntryOptions(_0xc1a57b,_0x1eb300){const _0x563b8f=_0x15063a,_0x3c1a75=document[_0x563b8f(0x220)](_0x563b8f(0x2da)),_0x123a23=document[_0x563b8f(0x220)](_0x563b8f(0x31d)),_0xf3a4fd=filterWorldbookEntries(_0xc1a57b,_0x1eb300);_0x3c1a75[_0x563b8f(0x2e0)]='';const _0x4a13d9='\x0a\x20\x20\x20\x20\x20\x20\x20\x20<label\x20class=\x22hly-multiselect-option\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22checkbox\x22\x20id=\x22hly-hist-select-all-entries\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<strong>全选/全不选</strong>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</label>';_0x3c1a75['insertAdjacentHTML'](_0x563b8f(0x1c7),_0x4a13d9);if(_0xf3a4fd['length']===0x0){const _0x2d7b56=_0x563b8f(0x37c);_0x3c1a75[_0x563b8f(0x37a)](_0x563b8f(0x1c7),_0x2d7b56),_0x123a23[_0x563b8f(0x267)]('span')[_0x563b8f(0x17b)]=_0x563b8f(0x324);return;}_0xf3a4fd[_0x563b8f(0x19b)](_0x4c6560=>{const _0x2db439=_0x563b8f,_0x41d785=_0xc1a57b?highlightSearchMatch(_0x4c6560['comment'],_0xc1a57b):_0x4c6560[_0x2db439(0x35f)],_0x3e091c=_0x2db439(0x21f)+_0x4c6560[_0x2db439(0x35f)]+_0x2db439(0x370)+_0x4c6560['key']+_0x2db439(0x2f7)+_0x4c6560['key']+'\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span>'+_0x41d785+_0x2db439(0x364);_0x3c1a75['insertAdjacentHTML']('beforeend',_0x3e091c);}),_0x123a23['querySelector'](_0x563b8f(0x191))['textContent']=_0x563b8f(0x1ad)+_0xf3a4fd[_0x563b8f(0x30f)]+_0x563b8f(0x36c);}async function startHistoriography(){const _0x31d6a5=_0x15063a,_0x279987=document['getElementById'](_0x31d6a5(0x175))['value'],_0x46578b=document[_0x31d6a5(0x220)](_0x31d6a5(0x2da)),_0xf67df5=document[_0x31d6a5(0x220)](_0x31d6a5(0x33c)),_0x47c686=Array[_0x31d6a5(0x173)](_0x46578b[_0x31d6a5(0x1f3)](_0x31d6a5(0x28b)))['map'](_0x2b3732=>_0x2b3732[_0x31d6a5(0x314)]);if(!_0x279987||_0x47c686[_0x31d6a5(0x30f)]===0x0){toastr['warning'](_0x31d6a5(0x309),_0x31d6a5(0x346));return;}_0xf67df5[_0x31d6a5(0x17b)]=_0x31d6a5(0x27a)+_0x279987+'》中的\x20'+_0x47c686['length']+_0x31d6a5(0x2b2),toastr[_0x31d6a5(0x1d7)](_0x31d6a5(0x298),'圣旨'),log(_0x31d6a5(0x284)+_0x279987+'》中的\x20'+_0x47c686[_0x31d6a5(0x30f)]+_0x31d6a5(0x23d),'info');try{const _0x2cff07=await _0x337832[_0x31d6a5(0x1bc)](_0x279987,_0x47c686);_0xf67df5[_0x31d6a5(0x17b)]=_0x2cff07[_0x31d6a5(0x341)],_0x2cff07['success']?toastr[_0x31d6a5(0x336)]('批量编纂任务已完成。','大功告成'):toastr[_0x31d6a5(0x181)]('批量编纂任务已完成，但有部分错误。','圣谕'),log('对《'+_0x279987+_0x31d6a5(0x22b)+_0x2cff07['totalSuccess']+_0x31d6a5(0x1cb)+_0x2cff07[_0x31d6a5(0x31b)],_0x31d6a5(0x336));}catch(_0x476c6c){console[_0x31d6a5(0x2f5)](_0x31d6a5(0x214),_0x476c6c),toastr[_0x31d6a5(0x2f5)]('编纂失败:\x20'+_0x476c6c[_0x31d6a5(0x2fd)],_0x31d6a5(0x1e2)),_0xf67df5[_0x31d6a5(0x17b)]=_0x31d6a5(0x17d)+_0x476c6c['message'];}finally{await updatePanelStatus();}}function _0x1493(_0x50dca1,_0x4f35f8){const _0x46629b=_0x4662();return _0x1493=function(_0x1493ad,_0x1fef35){_0x1493ad=_0x1493ad-0x168;let _0x2d261c=_0x46629b[_0x1493ad];return _0x2d261c;},_0x1493(_0x50dca1,_0x4f35f8);}async function showStats(){const _0x3bc917=_0x15063a;try{log('用户请求查看宝库状态。','info'),toastr[_0x3bc917(0x1d7)]('正在查询宝库状态...','圣旨');const _0x3e15c9=await _0x4b5037[_0x3bc917(0x2e3)](),_0x5185ae=await _0x4b5037['getCollectionId'](),_0x420f63=_0x4b5037['getSettings'](),_0x379047=_0x3bc917(0x16c)+_0x5185ae+_0x3bc917(0x1a0)+_0x3e15c9+'\x0a--------------------\x0aAPI端点:\x20'+_0x420f63['retrieval']['apiEndpoint']+_0x3bc917(0x287)+_0x420f63[_0x3bc917(0x1e8)][_0x3bc917(0x2eb)]+_0x3bc917(0x311);toastr[_0x3bc917(0x1d7)](_0x379047,_0x3bc917(0x18d),{'timeOut':0x3a98,'extendedTimeOut':0x1388,'tapToDismiss':!![],'closeButton':!![]}),log('查看宝库状态成功：集合ID='+_0x5185ae+_0x3bc917(0x333)+_0x3e15c9,'success');}catch(_0x407c45){console['error'](_0x3bc917(0x32f),_0x407c45),toastr[_0x3bc917(0x2f5)](_0x3bc917(0x236)+_0x407c45[_0x3bc917(0x2fd)],'严重错误'),log(_0x3bc917(0x236)+_0x407c45[_0x3bc917(0x2fd)],_0x3bc917(0x2f5));}}function showRulesModal(_0x5ac04c){const _0x1b56d3=_0x15063a,_0x1ba971=_0x4b5037[_0x1b56d3(0x2d1)](),_0x2d354f=_0x1ba971[_0x5ac04c];if(!_0x2d354f){console[_0x1b56d3(0x2f5)](_0x1b56d3(0x1f9)+_0x5ac04c+'\x22\x20的配置项。');return;}const _0x28773e=_0x5ac04c==='condensation'?_0x1b56d3(0x29d):'编辑检索内容排除规则',_0x1cdd83=_0x2d354f[_0x1b56d3(0x2f1)]||[],_0xfb0978=(_0x4e74f9={'start':'','end':''},_0x559375)=>_0x1b56d3(0x37d)+_0x559375+_0x1b56d3(0x1b3)+(_0x4e74f9[_0x1b56d3(0x2f0)]||'')['replace'](/"/g,'\x22')+'\x22\x20placeholder=\x22开始字符串,\x20如\x20<!--\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20style=\x22margin:\x200\x205px;\x22>到</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<input\x20type=\x22text\x22\x20class=\x22hly-imperial-brush\x22\x20value=\x22'+(_0x4e74f9['end']||'')[_0x1b56d3(0x2ae)](/"/g,'\x22')+'\x22\x20placeholder=\x22结束字符串,\x20如\x20-->\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20class=\x22hly-delete-rule-btn\x22\x20title=\x22删除此规则\x22>&times;</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20',_0x29cab1=_0x1cdd83[_0x1b56d3(0x2a1)](_0xfb0978)[_0x1b56d3(0x36d)](''),_0x59ee92=_0x5ac04c==='queryPreprocessing'?_0x1b56d3(0x19c)+(_0x2d354f[_0x1b56d3(0x1cc)]?_0x1b56d3(0x2d8):'')+_0x1b56d3(0x213)+(_0x2d354f[_0x1b56d3(0x1cc)]?'block':_0x1b56d3(0x222))+_0x1b56d3(0x1ee)+(_0x2d354f[_0x1b56d3(0x35b)]||'')+_0x1b56d3(0x379):'',_0x134b96=_0x1b56d3(0x1bf)+_0x59ee92+_0x1b56d3(0x282)+(_0x29cab1[_0x1b56d3(0x30f)]>0x0?_0x29cab1:'<p\x20class=\x22hly-notes\x22\x20style=\x22text-align:center;\x22>暂无规则</p>')+_0x1b56d3(0x227);showHtmlModal(_0x28773e,_0x134b96,{'okText':_0x1b56d3(0x350),'onOk':_0x1a19e5=>{const _0x5f015d=_0x1b56d3,_0x2f9e25=[];_0x1a19e5['find'](_0x5f015d(0x242))[_0x5f015d(0x29a)](function(){const _0x4f32c5=_0x5f015d,_0x595b5b=$(this)[_0x4f32c5(0x210)]('input')['eq'](0x0)[_0x4f32c5(0x239)]()[_0x4f32c5(0x16f)](),_0x4b1b72=$(this)[_0x4f32c5(0x210)](_0x4f32c5(0x345))['eq'](0x1)[_0x4f32c5(0x239)]()[_0x4f32c5(0x16f)]();_0x595b5b&&_0x2f9e25['push']({'start':_0x595b5b,'end':_0x4b1b72});});const _0x17a36d={..._0x2d354f,'exclusionRules':_0x2f9e25};_0x5ac04c===_0x5f015d(0x2d4)&&(_0x17a36d[_0x5f015d(0x1cc)]=_0x1a19e5[_0x5f015d(0x210)](_0x5f015d(0x1e7))['is'](':checked'),_0x17a36d[_0x5f015d(0x35b)]=_0x1a19e5['find'](_0x5f015d(0x332))[_0x5f015d(0x239)]()),updateAndSaveSetting(_0x5ac04c,_0x17a36d),toastr[_0x5f015d(0x336)]('规则已保存。',_0x5f015d(0x369));},'onShow':_0x447a82=>{const _0x2323b6=_0x1b56d3,_0x239bda=_0x447a82[_0x2323b6(0x210)](_0x2323b6(0x1ab));_0x447a82[_0x2323b6(0x210)](_0x2323b6(0x306))['on'](_0x2323b6(0x1c6),()=>{const _0x3c90e9=_0x2323b6,_0x21429b=_0x239bda[_0x3c90e9(0x1c9)](_0x3c90e9(0x242))[_0x3c90e9(0x30f)],_0x2d800d=_0xfb0978(undefined,_0x21429b);_0x239bda[_0x3c90e9(0x210)]('p')['length']>0x0?_0x239bda[_0x3c90e9(0x289)](_0x2d800d):_0x239bda[_0x3c90e9(0x33d)](_0x2d800d);}),_0x239bda['on'](_0x2323b6(0x1c6),_0x2323b6(0x185),function(){const _0x2a3cc5=_0x2323b6;$(this)[_0x2a3cc5(0x247)]('.hly-exclusion-rule-row')['remove'](),_0x239bda[_0x2a3cc5(0x1c9)]()[_0x2a3cc5(0x30f)]===0x0&&_0x239bda[_0x2a3cc5(0x289)]('<p\x20class=\x22hly-notes\x22\x20style=\x22text-align:center;\x22>暂无规则</p>');});if(_0x5ac04c===_0x2323b6(0x2d4)){const _0x567434=_0x447a82[_0x2323b6(0x210)](_0x2323b6(0x1e7)),_0x4c513d=_0x447a82['find'](_0x2323b6(0x259));_0x567434['on'](_0x2323b6(0x1c5),()=>{const _0xd1e5f=_0x2323b6;_0x4c513d[_0xd1e5f(0x1ce)](_0xd1e5f(0x208),_0x567434['is'](_0xd1e5f(0x368))?_0xd1e5f(0x2b5):'none');});}}});}function previewCondensation(){const _0x4be9d3=_0x15063a,_0xc4e9f2=document[_0x4be9d3(0x220)]('hly-condensation-results');try{const _0x3c3bb7=_0x4b5037[_0x4be9d3(0x2d1)](),_0x2f81da=_0x3c3bb7[_0x4be9d3(0x261)][_0x4be9d3(0x2f1)]||[],_0x4f4139={'user':document[_0x4be9d3(0x220)](_0x4be9d3(0x24f))[_0x4be9d3(0x2d8)],'ai':document[_0x4be9d3(0x220)](_0x4be9d3(0x1d0))[_0x4be9d3(0x2d8)]},_0x3f0e53=document['getElementById'](_0x4be9d3(0x2e5))[_0x4be9d3(0x2d8)],_0x4acdc1=_0x3f0e53?document[_0x4be9d3(0x220)](_0x4be9d3(0x2b0))[_0x4be9d3(0x314)][_0x4be9d3(0x36a)](',')[_0x4be9d3(0x2a1)](_0x272004=>_0x272004[_0x4be9d3(0x16f)]())[_0x4be9d3(0x19a)](Boolean):[],_0x2f6263=_0x4b5037['getMessagesForCondensation'](_0x4f4139);if(!_0x2f6263||_0x2f6263['length']===0x0){_0xc4e9f2['textContent']='根据当前勾选条件，未找到符合的消息可供预览。',toastr['warning'](_0x4be9d3(0x241),_0x4be9d3(0x2a3));return;}const _0xf6bd62=getContext()[_0x4be9d3(0x216)],_0x14410a=_0x2f6263['map']((_0x3b618f,_0x151c8f)=>{const _0x2ce44a=_0x4be9d3;let _0x1458d1;if(_0x3b618f['is_user'])_0x1458d1=_0x3b618f['mes'];else{if(_0x3f0e53&&_0x4acdc1['length']>0x0){const _0x4b2951=extractBlocksByTags(_0x3b618f[_0x2ce44a(0x2c6)],_0x4acdc1);_0x4b2951['length']>0x0?_0x1458d1=_0x4b2951[_0x2ce44a(0x36d)]('\x0a\x0a'):_0x1458d1=_0x3b618f['mes'];}else _0x1458d1=_0x3b618f[_0x2ce44a(0x2c6)];_0x1458d1=applyExclusionRules(_0x1458d1,_0x2f81da);}const _0x4eb868=_0xf6bd62[_0x2ce44a(0x240)](_0x89d390=>_0x89d390===_0x3b618f),_0x50aff7=_0x4eb868!==-0x1?_0x4eb868+0x1:-0x1;return{'id':_0x2ce44a(0x1de)+_0x151c8f,'name':_0x3b618f[_0x2ce44a(0x265)],'content':_0x1458d1[_0x2ce44a(0x16f)](),'floor':_0x50aff7,'is_user':_0x3b618f[_0x2ce44a(0x18c)],'send_date':_0x3b618f[_0x2ce44a(0x1b5)]};})[_0x4be9d3(0x19a)](_0x212c38=>_0x212c38['content']);if(_0x14410a[_0x4be9d3(0x30f)]===0x0){_0xc4e9f2[_0x4be9d3(0x17b)]=_0x4be9d3(0x1f6),toastr['warning'](_0x4be9d3(0x1f6),_0x4be9d3(0x2a3));return;}const _0x58a465=_0x14410a[_0x4be9d3(0x2a1)]((_0x1bf1f3,_0x87ec56)=>_0x4be9d3(0x326)+_0x1bf1f3['id']+_0x4be9d3(0x1f8)+_0x1bf1f3['floor']+_0x4be9d3(0x264)+_0x1bf1f3[_0x4be9d3(0x265)]+']\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</summary>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22hly-preview-content\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<textarea\x20class=\x22hly-preview-textarea\x22\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20data-floor=\x22'+_0x1bf1f3[_0x4be9d3(0x2d0)]+_0x4be9d3(0x373)+_0x1bf1f3[_0x4be9d3(0x18c)]+_0x4be9d3(0x1f7)+_0x1bf1f3[_0x4be9d3(0x1b5)]+'\x22>'+_0x1bf1f3[_0x4be9d3(0x341)]+_0x4be9d3(0x20f)+_0x1bf1f3['id']+_0x4be9d3(0x296))[_0x4be9d3(0x36d)]('');showHtmlModal('预览并编辑凝识内容',_0x4be9d3(0x1a6)+_0x58a465+'</div>',{'okText':'确认并更新预览','onOk':_0xc674c5=>{const _0x1f96ed=_0x4be9d3,_0x1c1501=[];_0xc674c5[_0x1f96ed(0x210)](_0x1f96ed(0x1b8))[_0x1f96ed(0x29a)](function(){const _0x495a73=_0x1f96ed,_0x41d3ce=$(this)[_0x495a73(0x210)](_0x495a73(0x1da)),_0x234872=_0x41d3ce[_0x495a73(0x239)]();_0x234872[_0x495a73(0x16f)]()&&_0x1c1501['push']({'mes':_0x234872,'is_user':_0x41d3ce['data'](_0x495a73(0x34a)),'send_date':_0x41d3ce[_0x495a73(0x27e)]('send-date'),'floor':_0x41d3ce['data'](_0x495a73(0x2d0))});}),_0xc4e9f2['dataset']['finalMessages']=JSON[_0x1f96ed(0x187)](_0x1c1501);const _0x1c521b=document[_0x1f96ed(0x220)]('hly-layer-start')[_0x1f96ed(0x314)],_0x544c81=document[_0x1f96ed(0x220)](_0x1f96ed(0x2ec))[_0x1f96ed(0x314)];_0xc4e9f2[_0x1f96ed(0x17b)]=_0x1f96ed(0x34d)+_0x1c521b+_0x1f96ed(0x327)+_0x544c81+_0x1f96ed(0x2f9)+_0x1c1501['length']+_0x1f96ed(0x30d),toastr['success'](_0x1f96ed(0x178),'圣旨已达');}}),$(_0x4be9d3(0x1f5))['on'](_0x4be9d3(0x1c6),function(_0x323c1c){const _0x1873dd=_0x4be9d3;_0x323c1c[_0x1873dd(0x28f)]();const _0x317d89=$(this)['data'](_0x1873dd(0x2a7));$('#'+_0x317d89)[_0x1873dd(0x371)]();});}catch(_0x10886b){console[_0x4be9d3(0x2f5)](_0x4be9d3(0x199),_0x10886b),_0xc4e9f2['textContent']='预览失败:\x20'+_0x10886b[_0x4be9d3(0x2fd)],toastr[_0x4be9d3(0x2f5)]('预览失败:\x20'+_0x10886b[_0x4be9d3(0x2fd)],_0x4be9d3(0x1e2));}}function log(_0x319dac,_0x203739='info'){const _0x42c98b=_0x15063a,_0x4f5728=document[_0x42c98b(0x220)](_0x42c98b(0x2c3));if(!_0x4f5728)return;const _0x55a16a=document['createElement']('p'),_0x2fd4b8=new Date()[_0x42c98b(0x34f)]();let _0x3c0197='fa-circle-info',_0x257e7d='log-info';switch(_0x203739){case _0x42c98b(0x336):_0x3c0197=_0x42c98b(0x1d2),_0x257e7d=_0x42c98b(0x1c2);break;case _0x42c98b(0x2f5):_0x3c0197=_0x42c98b(0x302),_0x257e7d=_0x42c98b(0x20b);break;case _0x42c98b(0x195):_0x3c0197=_0x42c98b(0x35c),_0x257e7d=_0x42c98b(0x30a);break;}_0x55a16a[_0x42c98b(0x366)]=_0x42c98b(0x281)+_0x257e7d,_0x55a16a[_0x42c98b(0x2e0)]=_0x42c98b(0x303)+_0x3c0197+_0x42c98b(0x1fe)+_0x2fd4b8+']\x20'+_0x319dac;const _0x13f854=_0x4f5728[_0x42c98b(0x267)](_0x42c98b(0x31f));_0x13f854&&_0x13f854[_0x42c98b(0x371)](),_0x4f5728[_0x42c98b(0x24b)](_0x55a16a),_0x4f5728[_0x42c98b(0x1a2)]=_0x4f5728['scrollHeight'];}async function ingestManualText(){const _0x360c14=_0x15063a,_0x5b5301=document[_0x360c14(0x220)]('hly-manual-text'),_0x286211=_0x5b5301['value']['trim']();if(!_0x286211){toastr['warning'](_0x360c14(0x274),_0x360c14(0x2a3)),log('用户尝试录入空文本。',_0x360c14(0x195));return;}log(_0x360c14(0x21a)+_0x286211[_0x360c14(0x30f)],'info'),toastr[_0x360c14(0x1d7)](_0x360c14(0x356),'圣旨');try{const _0xe4852b=await _0x4b5037['ingestTextToHanlinyuan'](_0x286211,_0x360c14(0x2de),{'sourceName':_0x360c14(0x2fb)});if(_0xe4852b[_0x360c14(0x336)])toastr[_0x360c14(0x336)](_0x360c14(0x2b3)+_0xe4852b['count']+_0x360c14(0x357),'大功告成'),log('手动录入成功，新增\x20'+_0xe4852b[_0x360c14(0x310)]+'\x20条忆识。',_0x360c14(0x336)),_0x5b5301['value']='';else throw new Error(_0xe4852b[_0x360c14(0x2f5)]||_0x360c14(0x297));}catch(_0x36bcc4){console[_0x360c14(0x2f5)](_0x360c14(0x260),_0x36bcc4),toastr[_0x360c14(0x2f5)]('文书录入失败:\x20'+_0x36bcc4[_0x360c14(0x2fd)],_0x360c14(0x1e2)),log(_0x360c14(0x2ab)+_0x36bcc4['message'],_0x360c14(0x2f5));}finally{await updatePanelStatus();}}
