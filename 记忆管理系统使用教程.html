<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>记忆管理系统使用手册</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=ZCOOL+XiaoWei&display=swap');

        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --accent-color: #e74c3c;
            --code-bg: #f0f0f0;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --font-main: 'Noto Sans SC', sans-serif;
            --font-art: 'ZCOOL XiaoWei', serif;
        }

        body {
            font-family: var(--font-main);
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }

        h1 {
            font-family: var(--font-art);
            text-align: center;
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        h2 {
            font-family: var(--font-art);
            color: #34495e;
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
            margin-top: 40px;
            background: linear-gradient(to right, #f9f9f9, transparent);
            padding-top: 10px;
            padding-bottom: 10px;
        }

        h3 {
            color: #555;
            margin-top: 25px;
        }

        p {
            margin-bottom: 15px;
        }

        /* 模拟“文转图”卡片样式 */
        .card-note {
            background: #fff;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .card-note::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--primary-color);
        }

        .warning-box {
            background-color: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .warning-box::before {
            content: '⚠️ 重要警告';
            display: block;
            font-weight: bold;
            color: #c53030;
            margin-bottom: 10px;
            font-family: var(--font-art);
            font-size: 1.1em;
        }

        code {
            background-color: var(--code-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', monospace;
            color: #c7254e;
            font-size: 0.9em;
        }

        .path-badge {
            display: inline-block;
            background-color: #e1f0ff;
            color: #0366d6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            margin: 0 2px;
            border: 1px solid #b4d5fe;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background-color: #fbfbfb;
        }

        .step-list {
            counter-reset: step;
            list-style: none;
            padding: 0;
        }

        .step-list > li {
            position: relative;
            padding-left: 40px;
            margin-bottom: 15px;
        }

        .step-list > li::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            top: 0;
            width: 28px;
            height: 28px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            font-size: 14px;
        }

        .switch-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status-on {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-off {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            color: #888;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        /* 视觉强化区域 */
        .visual-block {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .visual-block h3 {
            color: #ecf0f1;
            margin-top: 0;
        }
        .visual-block code {
            background-color: rgba(255,255,255,0.1);
            color: #f1c40f;
        }

        .credits {
            text-align: center;
            margin-top: -10px;
            margin-bottom: 30px;
            font-family: var(--font-art);
            font-size: 1.1em;
        }
        
        .credits-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: inline-block;
            margin-left: 10px;
        }

        .credits-badge.pink {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
        }

    </style>
</head>
<body>

<div class="container">
    <h1>记忆管理系统使用手册</h1>
    
    <div class="credits">
        记忆系统设计老师：<span class="credits-badge">繁华</span> and<span class="credits-badge pink">可乐</span>
    </div>

    <div class="card-note">
        <p><strong>前言：</strong> 记忆管理系统，基于 Amily2 插件中的 <code>记忆管理</code>、<code>总结模块</code>、<code>表格模块</code> 功能进行联动实现。</p>
        <p><strong>定位：</strong> 本系统不是 Amily2 的 <code>超级记忆功能</code>，而是其替代方案。</p>
        <p><strong>优势：</strong> 在记忆的细节（如曾经的心动瞬间、铭记一生的誓言）上表现优异。</p>
        <p><strong>兼容性：</strong> 两者可以兼容！可以单独使用，也可以配合使用。</p>
    </div>

    <div class="warning-box">
        <p>当你按照本教程使用记忆系统功能并按照本教程进行设置后，<strong>原来的剧情优化实际功能将被改变</strong>（即大家理解的剧情推进被改为记忆管理等）。</p>
        <p>请不要再根据 Amily2 谷歌文档教程进行理解设置，请以本教程为准。</p>
        <hr style="border: 0; border-top: 1px dashed #feb2b2; margin: 10px 0;">
        <p style="font-size: 0.9em;"><strong>如何恢复？</strong><br>
        若后续不想使用本 <code>记忆管理系统</code> 功能，或想恢复原本的 <code>剧情优化</code> 功能，只需要：<br>
        1. 切换 <code>剧情优化预设</code>（路径：剧情优化功能页面 <span class="path-badge">提示词指令</span> → <span class="path-badge">提示词管理</span>）<br>
        2. 或分别点击 <code>恢复主提示词</code>、<code>恢复拦截任务</code>、<code>恢复注入指令</code> 三个按钮即可。</p>
    </div>

    <h2>一、前置通用设置</h2>
    <p>无论使用 <code>总结流</code> 还是 <code>超级记忆</code> 适配，<strong>必须</strong>进行以下设置。</p>

    <ol class="step-list">
        <li>
            <strong>导入预设</strong><br>
            请在群文件下载 <code>记忆管理系统可乐版-v1.17.2</code> 或 <code>剧情优化功能-记忆管理系统.json</code> 预设文件。<br>
            导入路径：<span class="path-badge">amily2插件</span> → <span class="path-badge">剧情优化功能</span> → <span class="path-badge">提示词指令</span> → <span class="path-badge">提示词管理</span> → <span class="path-badge">导入预设</span>
        </li>
        <li>
            <strong>参数设置</strong>
            <table>
                <thead>
                    <tr>
                        <th>参数项</th>
                        <th>对应设置</th>
                        <th>建议值</th>
                        <th>说明</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>主线剧情 (sulv1)</td>
                        <td>单次输出最大回忆记录数</td>
                        <td><strong>5 - 20</strong></td>
                        <td>控制每次返回的回忆条数 (范围: 0-无限)</td>
                    </tr>
                    <tr>
                        <td>个人线 (sulv2)</td>
                        <td>记忆关联性阈值</td>
                        <td><strong>0.3 - 0.5</strong></td>
                        <td>控制回忆的关联性 (范围: 0.1-1)<br>0.1最准确/直接相关；1包含间接相关</td>
                    </tr>
                </tbody>
            </table>
        </li>
        <li>
            <strong>标签提取与内容排除</strong><br>
            设置路径：<span class="path-badge">amily2插件</span> → <span class="path-badge">总结模块</span> → <span class="path-badge">标签提取/内容排除</span>
            <div class="visual-block" style="background: #f8f9fa; color: #333; border: 1px solid #ddd;">
                <p><strong>1. 提取 <code>正文标签</code>：</strong> 填写你的正文内包裹标签。</p>
                <p><strong>2. 内容排除：</strong></p>
                <ul>
                    <li><code>< Plot_progression ></code> 到 <code>< /Plot_progression ></code> (注意：不要复制反引号)</li>
                    <li><code>正文标签内</code> 可能出现的 <code>非正文内容标签</code>（例如用了正文优化后的思维连或者某些预设奇奇怪怪的功能）</li>
                    <li><em>若是可乐版</em>：<code>< details ></code> 到 <code>< /details ></code></li>
                </ul>
            </div>
        </li>
    </ol>

    <h2>二、记忆管理功能设置</h2>
    <p>请按照以下配置调整 <code>记忆管理功能</code> 页面：</p>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="card-note" style="margin-top: 0;">
            <h3>基础开关</h3>
            <p>剧情优化开关：<span class="switch-status status-off">关闭</span> (防笨蛋，设置完全部后再开启)</p>
            <p>EJS预处理：<span class="switch-status status-off">关闭</span></p>
            <p>启用世界书：<span class="switch-status status-on">开启</span></p>
            <p>启用表格：<span class="switch-status status-on">开启</span></p>
        </div>
        <div class="card-note" style="margin-top: 0;">
            <h3>上下文与模型</h3>
            <p>上下文条数：<code>5</code> (建议设置单数 1、3、5)</p>
            <p>世界书最大字符数：<code>120000</code> (DS V3或V3.2模型推荐此数值)</p>
            <p>最大 Tokens：<code>4000</code> (建议默认)</p>
            <p>温度：<code>1</code> (越小越准，建议1)</p>
        </div>
    </div>

    <div class="visual-block">
        <h3>🤖 模型推荐</h3>
        <p><strong>DS V3</strong>：稳定、聪明、简洁、快。</p>
        <p><strong>DS V3.2</strong>：（推荐）需额外设置 <span class="path-badge">魔法棒</span> → <span class="path-badge">提示词链</span> → <span class="path-badge">剧情推进提示词</span> → <span class="path-badge">恢复默认</span> → <span class="path-badge">保存</span>。</p>
        <p><em>注：不建议使用其他快速模型。</em></p>
    </div>

    <h2>三、总结使用方式</h2>
    <ol class="step-list">
        <li>
            <strong>提示词恢复默认</strong><br>
            插件版本达到 v1.7.4 版本及以上，总结模块中，大小总结的 <code>主要提示词</code> 与 <code>任务提示词</code> 需恢复默认并保存。<br>
            操作路径：<span class="path-badge">amily2插件</span> → <span class="path-badge">总结模块</span> → <span class="path-badge">小总结功能（微言录）</span> / <span class="path-badge">大总结功能（宏史卷）</span><br>
            操作：分别点击 <code>恢复默认</code> 按钮，并点击 <strong>保存</strong>。
            <div class="visual-block" style="background: #e8f4f8; color: #2c3e50; border: 1px solid #b6e0ee; margin-top: 10px; padding: 15px;">
                <p style="margin-top: 0; font-weight: bold; color: #0366d6;">💡 建议操作：重新总结</p>
                <p>恢复提示词后，最好进行一次重新总结。</p>
                <ul style="margin-bottom: 0;">
                    <li><strong>推荐设置：</strong> 模型 2.5pro，温度 1，最大 Tokens 30000，总结阈值 50。</li>
                    <li><strong>操作：</strong> 一次性批量总结完旧楼层。</li>
                    <li><strong>注意：</strong> 中途若世界书字符数过多，可使用一次大总结后继续。</li>
                </ul>
            </div>
        </li>
        <li>
            <strong>总结设置</strong>
            <ul>
                <li><strong>大总结：</strong> 当世界书 <code>【敕史局】对话流水总账</code> 对话流水总账达到了 4 万以上字符数。</li>
                <li><strong>小总结设置：</strong></li>
                <ul>
                    <li>交互式巡录：<span class="switch-status status-on">开启</span></li>
                    <li>静默总结：<span class="switch-status status-on">开启</span></li>
                    <li>存世界书：<span class="switch-status status-on">开启</span></li>
                    <li>上传向量：<span class="switch-status status-off">关闭</span></li>
                    <li>总结阈值和保留层数：按个人情况或默认。（推荐10-20）</li>
                    <li><strong>模型推荐：</strong> 哈基米2.5p。</li>
                </ul>
            </ul>
        </li>
        <li>
            <strong>设置总结世界书</strong><br>
            路径：<span class="path-badge">amily2插件</span> → <span class="path-badge">插件首页下拉</span> → <span class="path-badge">总结与法律</span><br>
            配置：选择 <code>写入独立档案</code>、选择 <code>激活模式蓝灯</code>
        </li>
        <li>
            <strong>初始化与启动</strong><br>
            <p>1. <strong>生成总结：</strong> 开始玩卡触发一次自动总结，已有聊天的直接手动总结一次（开始远征）。</p>
            <p>2. <strong>开启功能：</strong> 回到插件的 <code>剧情优化功能</code>，将 <code>剧情优化开关</code> 切换为 <span class="switch-status status-on">开启</span>。</p>
            <p>3. <strong>关联世界书：</strong> 点击 <code>上下文设置</code> (启用世界书)，将世界书来源选择 <code>自定</code>，选择名为 <code>Amily2-Lore-char-...</code> 的世界书，勾选总结出来的世界书条目 <code>【敕史局】对话流水总帐</code>，并且 <strong>勾选全选</strong>（务必确认，世界书中就只有 <code>【敕史局】对话流水总帐</code> 这个条目）。</p>
        </li>
        <li>
            <strong>隐藏楼层</strong><br>
            <p>1. <strong>开启功能：</strong> 总结模块上方的 <code>皇家史册管理员</code>。</p>
            <p>2. 将 <code>按阈值隐藏</code> 切换为 <span class="switch-status status-on">开启</span>。</p>
            <p>3. 下方数字设置为 <code>10及以下</code>。（此处推荐带摘要的预设，并且有X楼前只发送摘要。）</p>
        </li>
        <li>
            <strong>测试方式 (可选)</strong><br>
            开启 <code>密折司</code> 功能 → 发送一条消息 → 等待 <code>剧情优化提示</code> 完成，自动弹出 <code>密折司</code> 页面 → 点击取消，查看 <code>用户消息</code> 确认效果。
        </li>
    </ol>

    <h2>四、搭配表格(必须)</h2>
    <div class="card-note">
        <h3>1. 开启表格支持</h3>
        <p>路径：剧情优化功能 → <code>上下文设置</code> → <code>启用表格</code></p>
        
        <h3>2. 表格模块设置</h3>
        <p>路径：<span class="path-badge">amily2插件</span> → <span class="path-badge">表格模块</span> → <span class="path-badge">操作中心</span></p>
        <ul style="list-style: none; padding-left: 0;">
            <li>✅ 表格系统总开关：<span class="switch-status status-on">开启</span></li>
            <li>❌ 启用表格注入：<span class="switch-status status-off">关闭</span></li>
            <li>✅ 启用上下文优化 (合并世界书)：<span class="switch-status status-on">开启</span></li>
            <li>⚙️ 上下文深度：<code>3</code> (建议设置单数 1、3、5)</li>
            <li>⚙️ 填表批次：<code>4</code> (若无总结表则使用0)</li>
            <li>⚙️ 保留楼层：<code>2</code> (若无总结表则使用0)</li>
        </ul>
        
        <h3>3. 注意事项</h3>
        <p>正常游玩即可。</p>
        <p style="color: #c53030;"><strong>重要：</strong> 使用表格时，请注意每次填表后检查填写的准确性，否则回忆出来的内容也会是错误的。</p>
    </div>

    <div class="footer">
        <p>Designed for Amily2 Chat Optimisation</p>
    </div>
</div>

</body>
</html>
